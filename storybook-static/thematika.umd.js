!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-geo"),require("@turf/turf"),require("geotiff")):"function"==typeof define&&define.amd?define(["exports","d3-selection","d3-geo","@turf/turf","geotiff"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Thematika={},t.d3,t.d3,t.turf,t.GeoTIFF)}(this,function(t,e,r,n,i){"use strict";function o(t){var e=Object.create(null);return t&&Object.keys(t).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}}),e.default=t,Object.freeze(e)}var a=o(n);class s{constructor(){this.layerInstances=new Map}setContext(t,e){this.svgContainer=t,this.projection=e}addLayer(t,e){if(!this.svgContainer)throw new Error("SVG container not set. Call setContext() first.");this.projection&&this.isGeojsonLayer(e)&&e.setProjection(this.projection),e.zIndex=this.getNextZIndex(),e.render(this.svgContainer),this.layerInstances.set(t,e)}removeLayer(t){const e=this.layerInstances.get(t);e&&(e.destroy(),this.layerInstances.delete(t))}setLayerVisibility(t,e){const r=this.layerInstances.get(t);r&&r.setVisible(e)}setLayerZIndex(t,e){const r=this.layerInstances.get(t);if(r){const t=r.zIndex;r.setZIndex(e),t!==e&&this.reorderLayersOptimized()}}getLayer(t){return this.layerInstances.get(t)}getLayerIds(){return Array.from(this.layerInstances.keys())}clearAllLayers(){this.layerInstances.forEach(t=>t.destroy()),this.layerInstances.clear()}rerenderAllLayers(){if(this.svgContainer){Array.from(this.layerInstances.values()).sort((t,e)=>t.zIndex-e.zIndex).forEach(t=>{t.destroy(),this.projection&&this.isGeojsonLayer(t)&&t.setProjection(this.projection),t.render(this.svgContainer)})}}reorderLayersOptimized(){const t=[];if(Array.from(this.layerInstances.values()).filter(t=>t.isRendered()).forEach(e=>{const r=this.getLayerElement(e);r&&t.push({element:r,zIndex:e.zIndex})}),0===t.length)return;t.sort((t,e)=>t.zIndex-e.zIndex);const e=t[0].element.parentNode;e&&t.forEach(({element:t})=>{e.appendChild(t)})}updateProjection(t){this.projection=t,this.layerInstances.forEach(e=>{this.isGeojsonLayer(e)&&e.setProjection(t)})}getNextZIndex(){if(0===this.layerInstances.size)return 0;return Math.max(...Array.from(this.layerInstances.values()).map(t=>t.zIndex))+1}isGeojsonLayer(t){return"setProjection"in t}getLayerElement(t){if("element"in t)return t.element}}class l{constructor(t,e={},r){this.visible=!0,this.zIndex=0,this.id=t,this.attr={fill:"#cccccc",stroke:"#333333",strokeWidth:.5,opacity:1,...e},this.style=r}destroy(){this.element&&(this.element.remove(),this.element=void 0)}setVisible(t){this.visible=t,this.updateVisibility()}setZIndex(t){this.zIndex=t}isRendered(){return void 0!==this.element}getLayerGroup(){return this.element?e.select(this.element):null}updateVisibility(){if(!this.element)return;e.select(this.element).style("display",this.visible?"":"none")}createLayerGroup(t){const e=t.append("g").attr("class",`thematika-layer thematika-layer--${this.id}`).style("display",this.visible?"":"none");return this.element=e.node(),e}applyAttributesToElement(t,e){Object.entries(this.attr).forEach(([t,r])=>{if(void 0!==r){const n="function"==typeof r?r({},0):r;e.attr(t,n)}})}applyStylesToElement(t,e){this.style&&Object.entries(this.style).forEach(([t,r])=>{if(void 0!==r){const n="function"==typeof r?r({},0):r;e.style(t,n)}})}applyAllStylesToElement(t,e){this.applyAttributesToElement(t,e),this.applyStylesToElement(t,e)}applyAttributesToElements(t,e){Object.entries(this.attr).forEach(([r,n])=>{void 0!==n&&("function"==typeof n?t.attr(r,(t,e)=>n(t,e)):e.attr(r,n))})}applyStylesToElements(t,e){this.style&&Object.entries(this.style).forEach(([r,n])=>{void 0!==n&&("function"==typeof n?t.style(r,(t,e)=>n(t,e)):e.style(r,n))})}applyAllStylesToElements(t,e){this.applyAttributesToElements(t,e),this.applyStylesToElements(t,e)}}var c={value:()=>{}};function h(){for(var t,e=0,r=arguments.length,n={};e<r;++e){if(!(t=arguments[e]+"")||t in n||/[\s.]/.test(t))throw new Error("illegal type: "+t);n[t]=[]}return new u(n)}function u(t){this._=t}function d(t,e){for(var r,n=0,i=t.length;n<i;++n)if((r=t[n]).name===e)return r.value}function p(t,e,r){for(var n=0,i=t.length;n<i;++n)if(t[n].name===e){t[n]=c,t=t.slice(0,n).concat(t.slice(n+1));break}return null!=r&&t.push({name:e,value:r}),t}u.prototype=h.prototype={constructor:u,on:function(t,e){var r,n,i=this._,o=(n=i,(t+"").trim().split(/^|\s+/).map(function(t){var e="",r=t.indexOf(".");if(r>=0&&(e=t.slice(r+1),t=t.slice(0,r)),t&&!n.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:e}})),a=-1,s=o.length;if(!(arguments.length<2)){if(null!=e&&"function"!=typeof e)throw new Error("invalid callback: "+e);for(;++a<s;)if(r=(t=o[a]).type)i[r]=p(i[r],t.name,e);else if(null==e)for(r in i)i[r]=p(i[r],t.name,null);return this}for(;++a<s;)if((r=(t=o[a]).type)&&(r=d(i[r],t.name)))return r},copy:function(){var t={},e=this._;for(var r in e)t[r]=e[r].slice();return new u(t)},call:function(t,e){if((r=arguments.length-2)>0)for(var r,n,i=new Array(r),o=0;o<r;++o)i[o]=arguments[o+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(o=0,r=(n=this._[t]).length;o<r;++o)n[o].value.apply(e,i)},apply:function(t,e,r){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var n=this._[t],i=0,o=n.length;i<o;++i)n[i].value.apply(e,r)}};const f={passive:!1},g={capture:!0,passive:!1};function y(t){t.stopImmediatePropagation()}function m(t){t.preventDefault(),t.stopImmediatePropagation()}var x=t=>()=>t;function w(t,{sourceEvent:e,subject:r,target:n,identifier:i,active:o,x:a,y:s,dx:l,dy:c,dispatch:h}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},subject:{value:r,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},identifier:{value:i,enumerable:!0,configurable:!0},active:{value:o,enumerable:!0,configurable:!0},x:{value:a,enumerable:!0,configurable:!0},y:{value:s,enumerable:!0,configurable:!0},dx:{value:l,enumerable:!0,configurable:!0},dy:{value:c,enumerable:!0,configurable:!0},_:{value:h}})}function _(t){return!t.ctrlKey&&!t.button}function b(){return this.parentNode}function k(t,e){return null==e?{x:t.x,y:t.y}:e}function v(){return navigator.maxTouchPoints||"ontouchstart"in this}function S(){var t,r,n,i,o=_,a=b,s=k,l=v,c={},u=h("start","drag","end"),d=0,p=0;function S(t){t.on("mousedown.drag",M).filter(l).on("touchstart.drag",z).on("touchmove.drag",E,f).on("touchend.drag touchcancel.drag",L).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function M(s,l){if(!i&&o.call(this,s,l)){var c,h,u,d=A(this,a.call(this,s,l),s,l,"mouse");if(d)e.select(s.view).on("mousemove.drag",j,g).on("mouseup.drag",$,g),c=s.view,h=c.document.documentElement,u=e.select(c).on("dragstart.drag",m,g),"onselectstart"in h?u.on("selectstart.drag",m,g):(h.__noselect=h.style.MozUserSelect,h.style.MozUserSelect="none"),y(s),n=!1,t=s.clientX,r=s.clientY,d("start",s)}}function j(e){if(m(e),!n){var i=e.clientX-t,o=e.clientY-r;n=i*i+o*o>p}c.mouse("drag",e)}function $(t){var r,i,o,a;e.select(t.view).on("mousemove.drag mouseup.drag",null),r=t.view,i=n,o=r.document.documentElement,a=e.select(r).on("dragstart.drag",null),i&&(a.on("click.drag",m,g),setTimeout(function(){a.on("click.drag",null)},0)),"onselectstart"in o?a.on("selectstart.drag",null):(o.style.MozUserSelect=o.__noselect,delete o.__noselect),m(t),c.mouse("end",t)}function z(t,e){if(o.call(this,t,e)){var r,n,i=t.changedTouches,s=a.call(this,t,e),l=i.length;for(r=0;r<l;++r)(n=A(this,s,t,e,i[r].identifier,i[r]))&&(y(t),n("start",t,i[r]))}}function E(t){var e,r,n=t.changedTouches,i=n.length;for(e=0;e<i;++e)(r=c[n[e].identifier])&&(m(t),r("drag",t,n[e]))}function L(t){var e,r,n=t.changedTouches,o=n.length;for(i&&clearTimeout(i),i=setTimeout(function(){i=null},500),e=0;e<o;++e)(r=c[n[e].identifier])&&(y(t),r("end",t,n[e]))}function A(t,r,n,i,o,a){var l,h,p,f=u.copy(),g=e.pointer(a||n,r);if(null!=(p=s.call(t,new w("beforestart",{sourceEvent:n,target:S,identifier:o,active:d,x:g[0],y:g[1],dx:0,dy:0,dispatch:f}),i)))return l=p.x-g[0]||0,h=p.y-g[1]||0,function n(a,s,u){var y,m=g;switch(a){case"start":c[o]=n,y=d++;break;case"end":delete c[o],--d;case"drag":g=e.pointer(u||s,r),y=d}f.call(a,t,new w(a,{sourceEvent:s,subject:p,target:S,identifier:o,active:y,x:g[0]+l,y:g[1]+h,dx:g[0]-m[0],dy:g[1]-m[1],dispatch:f}),i)}}return S.filter=function(t){return arguments.length?(o="function"==typeof t?t:x(!!t),S):o},S.container=function(t){return arguments.length?(a="function"==typeof t?t:x(t),S):a},S.subject=function(t){return arguments.length?(s="function"==typeof t?t:x(t),S):s},S.touchable=function(t){return arguments.length?(l="function"==typeof t?t:x(!!t),S):l},S.on=function(){var t=u.on.apply(u,arguments);return t===u?S:t},S.clickDistance=function(t){return arguments.length?(p=(t=+t)*t,S):Math.sqrt(p)},S}w.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};function M(t){const e=[];switch(t.type){case"Point":e.push(t.coordinates);break;case"LineString":case"MultiPoint":e.push(...t.coordinates);break;case"Polygon":t.coordinates.forEach(t=>e.push(...t));break;case"MultiLineString":t.coordinates.forEach(t=>e.push(...t));break;case"MultiPolygon":t.coordinates.forEach(t=>t.forEach(t=>e.push(...t)));break;case"GeometryCollection":t.geometries.forEach(t=>e.push(...M(t)))}return e}function j(t){const e=[];if("Feature"===t.type?e.push(...M(t.geometry)):"FeatureCollection"===t.type?t.features.forEach(t=>{e.push(...M(t.geometry))}):("coordinates"in t||"geometries"in t)&&e.push(...M(t)),0===e.length)return{x:0,y:0};let r=0,n=0;for(const[t,i]of e)r+=t,n+=i;return{x:r/e.length,y:n/e.length}}function $(t){return{width:t.maxX-t.minX,height:t.maxY-t.minY}}function z(t){return function(){return t}}const E=Math.PI,L=2*E,A=1e-6,T=L-A;function G(t){this._+=t[0];for(let e=1,r=t.length;e<r;++e)this._+=arguments[e]+t[e]}class P{constructor(t){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=null==t?G:function(t){let e=Math.floor(t);if(!(e>=0))throw new Error(`invalid digits: ${t}`);if(e>15)return G;const r=10**e;return function(t){this._+=t[0];for(let e=1,n=t.length;e<n;++e)this._+=Math.round(arguments[e]*r)/r+t[e]}}(t)}moveTo(t,e){this._append`M${this._x0=this._x1=+t},${this._y0=this._y1=+e}`}closePath(){null!==this._x1&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(t,e){this._append`L${this._x1=+t},${this._y1=+e}`}quadraticCurveTo(t,e,r,n){this._append`Q${+t},${+e},${this._x1=+r},${this._y1=+n}`}bezierCurveTo(t,e,r,n,i,o){this._append`C${+t},${+e},${+r},${+n},${this._x1=+i},${this._y1=+o}`}arcTo(t,e,r,n,i){if(t=+t,e=+e,r=+r,n=+n,(i=+i)<0)throw new Error(`negative radius: ${i}`);let o=this._x1,a=this._y1,s=r-t,l=n-e,c=o-t,h=a-e,u=c*c+h*h;if(null===this._x1)this._append`M${this._x1=t},${this._y1=e}`;else if(u>A)if(Math.abs(h*s-l*c)>A&&i){let d=r-o,p=n-a,f=s*s+l*l,g=d*d+p*p,y=Math.sqrt(f),m=Math.sqrt(u),x=i*Math.tan((E-Math.acos((f+u-g)/(2*y*m)))/2),w=x/m,_=x/y;Math.abs(w-1)>A&&this._append`L${t+w*c},${e+w*h}`,this._append`A${i},${i},0,0,${+(h*d>c*p)},${this._x1=t+_*s},${this._y1=e+_*l}`}else this._append`L${this._x1=t},${this._y1=e}`;else;}arc(t,e,r,n,i,o){if(t=+t,e=+e,o=!!o,(r=+r)<0)throw new Error(`negative radius: ${r}`);let a=r*Math.cos(n),s=r*Math.sin(n),l=t+a,c=e+s,h=1^o,u=o?n-i:i-n;null===this._x1?this._append`M${l},${c}`:(Math.abs(this._x1-l)>A||Math.abs(this._y1-c)>A)&&this._append`L${l},${c}`,r&&(u<0&&(u=u%L+L),u>T?this._append`A${r},${r},0,1,${h},${t-a},${e-s}A${r},${r},0,1,${h},${this._x1=l},${this._y1=c}`:u>A&&this._append`A${r},${r},0,${+(u>=E)},${h},${this._x1=t+r*Math.cos(i)},${this._y1=e+r*Math.sin(i)}`)}rect(t,e,r,n){this._append`M${this._x0=this._x1=+t},${this._y0=this._y1=+e}h${r=+r}v${+n}h${-r}Z`}toString(){return this._}}function C(t){this._context=t}function I(t){return new C(t)}function F(t){return t[0]}function O(t){return t[1]}function B(t,e){var r=z(!0),n=null,i=I,o=null,a=function(t){let e=3;return t.digits=function(r){if(!arguments.length)return e;if(null==r)e=null;else{const t=Math.floor(r);if(!(t>=0))throw new RangeError(`invalid digits: ${r}`);e=t}return t},()=>new P(e)}(s);function s(s){var l,c,h,u=(s=function(t){return"object"==typeof t&&"length"in t?t:Array.from(t)}(s)).length,d=!1;for(null==n&&(o=i(h=a())),l=0;l<=u;++l)!(l<u&&r(c=s[l],l,s))===d&&((d=!d)?o.lineStart():o.lineEnd()),d&&o.point(+t(c,l,s),+e(c,l,s));if(h)return o=null,h+""||null}return t="function"==typeof t?t:void 0===t?F:z(t),e="function"==typeof e?e:void 0===e?O:z(e),s.x=function(e){return arguments.length?(t="function"==typeof e?e:z(+e),s):t},s.y=function(t){return arguments.length?(e="function"==typeof t?t:z(+t),s):e},s.defined=function(t){return arguments.length?(r="function"==typeof t?t:z(!!t),s):r},s.curve=function(t){return arguments.length?(i=t,null!=n&&(o=i(n)),s):i},s.context=function(t){return arguments.length?(null==t?n=o=null:o=i(n=t),s):n},s}function D(t,e,r){t._context.bezierCurveTo((2*t._x0+t._x1)/3,(2*t._y0+t._y1)/3,(t._x0+2*t._x1)/3,(t._y0+2*t._y1)/3,(t._x0+4*t._x1+e)/6,(t._y0+4*t._y1+r)/6)}function W(t){this._context=t}function R(t){return new W(t)}function N(t,e,r){t._context.bezierCurveTo(t._x1+t._k*(t._x2-t._x0),t._y1+t._k*(t._y2-t._y0),t._x2+t._k*(t._x1-e),t._y2+t._k*(t._y1-r),t._x2,t._y2)}function q(t,e){this._context=t,this._k=(1-e)/6}C.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;default:this._context.lineTo(t,e)}}},W.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){switch(this._point){case 3:D(this,this._x1,this._y1);case 2:this._context.lineTo(this._x1,this._y1)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;break;case 2:this._point=3,this._context.lineTo((5*this._x0+this._x1)/6,(5*this._y0+this._y1)/6);default:D(this,t,e)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=e}},q.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:N(this,this._x1,this._y1)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2,this._x1=t,this._y1=e;break;case 2:this._point=3;default:N(this,t,e)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=e}};var V=function t(e){function r(t){return new q(t,e)}return r.tension=function(e){return t(+e)},r}(0);function U(t,e){this._context=t,this._alpha=e}U.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:this.point(this._x2,this._y2)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){if(t=+t,e=+e,this._point){var r=this._x2-t,n=this._y2-e;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(r*r+n*n,this._alpha))}switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;break;case 2:this._point=3;default:!function(t,e,r){var n=t._x1,i=t._y1,o=t._x2,a=t._y2;if(t._l01_a>1e-12){var s=2*t._l01_2a+3*t._l01_a*t._l12_a+t._l12_2a,l=3*t._l01_a*(t._l01_a+t._l12_a);n=(n*s-t._x0*t._l12_2a+t._x2*t._l01_2a)/l,i=(i*s-t._y0*t._l12_2a+t._y2*t._l01_2a)/l}if(t._l23_a>1e-12){var c=2*t._l23_2a+3*t._l23_a*t._l12_a+t._l12_2a,h=3*t._l23_a*(t._l23_a+t._l12_a);o=(o*c+t._x1*t._l23_2a-e*t._l12_2a)/h,a=(a*c+t._y1*t._l23_2a-r*t._l12_2a)/h}t._context.bezierCurveTo(n,i,o,a,t._x2,t._y2)}(this,t,e)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=e}};var Y=function t(e){function r(t){return e?new U(t,e):new q(t,0)}return r.alpha=function(e){return t(+e)},r}(.5);function X(t){return t<0?-1:1}function Z(t,e,r){var n=t._x1-t._x0,i=e-t._x1,o=(t._y1-t._y0)/(n||i<0&&-0),a=(r-t._y1)/(i||n<0&&-0),s=(o*i+a*n)/(n+i);return(X(o)+X(a))*Math.min(Math.abs(o),Math.abs(a),.5*Math.abs(s))||0}function H(t,e){var r=t._x1-t._x0;return r?(3*(t._y1-t._y0)/r-e)/2:e}function Q(t,e,r){var n=t._x0,i=t._y0,o=t._x1,a=t._y1,s=(o-n)/3;t._context.bezierCurveTo(n+s,i+s*e,o-s,a-s*r,o,a)}function K(t){this._context=t}function J(t){this._context=new tt(t)}function tt(t){this._context=t}function et(t){return new K(t)}function rt(t){return new J(t)}function nt(t){this._context=t}function it(t){var e,r,n=t.length-1,i=new Array(n),o=new Array(n),a=new Array(n);for(i[0]=0,o[0]=2,a[0]=t[0]+2*t[1],e=1;e<n-1;++e)i[e]=1,o[e]=4,a[e]=4*t[e]+2*t[e+1];for(i[n-1]=2,o[n-1]=7,a[n-1]=8*t[n-1]+t[n],e=1;e<n;++e)r=i[e]/o[e-1],o[e]-=r,a[e]-=r*a[e-1];for(i[n-1]=a[n-1]/o[n-1],e=n-2;e>=0;--e)i[e]=(a[e]-i[e+1])/o[e];for(o[n-1]=(t[n]+i[n-1])/2,e=0;e<n-1;++e)o[e]=2*t[e+1]-i[e+1];return[i,o]}function ot(t){return new nt(t)}function at(t,e){this._context=t,this._t=e}function st(t){return new at(t,.5)}function lt(t){return new at(t,0)}function ct(t){return new at(t,1)}K.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:Q(this,this._t0,H(this,this._t0))}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){var r=NaN;if(e=+e,(t=+t)!==this._x1||e!==this._y1){switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;break;case 2:this._point=3,Q(this,H(this,r=Z(this,t,e)),r);break;default:Q(this,this._t0,r=Z(this,t,e))}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=e,this._t0=r}}},(J.prototype=Object.create(K.prototype)).point=function(t,e){K.prototype.point.call(this,e,t)},tt.prototype={moveTo:function(t,e){this._context.moveTo(e,t)},closePath:function(){this._context.closePath()},lineTo:function(t,e){this._context.lineTo(e,t)},bezierCurveTo:function(t,e,r,n,i,o){this._context.bezierCurveTo(e,t,n,r,o,i)}},nt.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=[],this._y=[]},lineEnd:function(){var t=this._x,e=this._y,r=t.length;if(r)if(this._line?this._context.lineTo(t[0],e[0]):this._context.moveTo(t[0],e[0]),2===r)this._context.lineTo(t[1],e[1]);else for(var n=it(t),i=it(e),o=0,a=1;a<r;++o,++a)this._context.bezierCurveTo(n[0][o],i[0][o],n[1][o],i[1][o],t[a],e[a]);(this._line||0!==this._line&&1===r)&&this._context.closePath(),this._line=1-this._line,this._x=this._y=null},point:function(t,e){this._x.push(+t),this._y.push(+e)}},at.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=this._y=NaN,this._point=0},lineEnd:function(){0<this._t&&this._t<1&&2===this._point&&this._context.lineTo(this._x,this._y),(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line>=0&&(this._t=1-this._t,this._line=1-this._line)},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;default:if(this._t<=0)this._context.lineTo(this._x,e),this._context.lineTo(t,e);else{var r=this._x*(1-this._t)+t*this._t;this._context.lineTo(r,this._y),this._context.lineTo(r,e)}}this._x=t,this._y=e}};function ht(t){const e=e=>{const r=e.append("filter").attr("id",t.id);t.x&&r.attr("x",t.x),t.y&&r.attr("y",t.y),t.width&&r.attr("width",t.width),t.height&&r.attr("height",t.height),r.append("feGaussianBlur").attr("stdDeviation",t.stdDeviation)};return e.url=()=>ft(t.id),e}function ut(t){const e=e=>{const r=e.append("defs").append("filter").attr("id",t.id).append("feDropShadow").attr("dx",t.dx).attr("dy",t.dy).attr("stdDeviation",t.stdDeviation);t.floodColor&&r.attr("flood-color",t.floodColor),void 0!==t.floodOpacity&&r.attr("flood-opacity",t.floodOpacity)};return e.url=()=>ft(t.id),e}function dt(t){const e=e=>{const r=e.append("defs").append("filter").attr("id",t.id).attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%");if(void 0!==t.threshold){const e=[.2126,.7152,.0722,0,t.threshold,.2126,.7152,.0722,0,t.threshold,.2126,.7152,.0722,0,t.threshold,0,0,0,1,0].join(" ");r.append("feColorMatrix").attr("values",e).attr("result","bright")}r.append("feGaussianBlur").attr("in",void 0!==t.threshold?"bright":"SourceGraphic").attr("stdDeviation",t.intensity).attr("result","bloom"),t.color&&(r.append("feFlood").attr("flood-color",t.color).attr("result","color"),r.append("feComposite").attr("in","color").attr("in2","bloom").attr("operator","in").attr("result","coloredBloom")),r.append("feMerge").selectAll("feMergeNode").data(["SourceGraphic",t.color?"coloredBloom":"bloom"]).enter().append("feMergeNode").attr("in",t=>t)};return e.url=()=>ft(t.id),e}const pt={lightBlur:()=>ht({id:"lightBlur",stdDeviation:2}),strongBlur:()=>ht({id:"strongBlur",stdDeviation:8}),standardDropShadow:()=>ut({id:"standardDropShadow",dx:3,dy:3,stdDeviation:2,floodColor:"#000000",floodOpacity:.3}),softDropShadow:()=>ut({id:"softDropShadow",dx:2,dy:2,stdDeviation:4,floodColor:"#000000",floodOpacity:.2}),standardBloom:()=>dt({id:"standardBloom",intensity:4,threshold:.8}),strongBloom:()=>dt({id:"strongBloom",intensity:8,threshold:.6,color:"#ffffff"})};function ft(t){return`url(#${t})`}
/*!
     * Textures.js v1.2.3 (ESM)
     * SVG patterns for Data Visualization
     * https://github.com/riccardoscalco/textures
     * 
     * Copyright (c) Riccardo Scalco
     * Licensed under the MIT License
     * 
     * Included in d3-thematika under MIT License terms
     */
function gt(){return"".concat(Math.random().toString(36),"00000000000000000").replace(/[^a-z]+/g,"").slice(0,5)}function yt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function mt(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return yt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?yt(t,e):void 0}}(t))||e){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}var xt={circles:function(){var t=20,e="",r=2,n=!1,i="#343434",o="#343434",a=0,s=gt(),l=function(l){var c=l.append("defs").append("pattern").attr("id",s).attr("patternUnits","userSpaceOnUse").attr("width",t).attr("height",t);if(e&&c.append("rect").attr("width",t).attr("height",t).attr("fill",e),c.append("circle").attr("cx",t/2).attr("cy",t/2).attr("r",r).attr("fill",i).attr("stroke",o).attr("stroke-width",a),n)for(var h=0,u=[[0,0],[0,t],[t,0],[t,t]];h<u.length;h++){var d=u[h];c.append("circle").attr("cx",d[0]).attr("cy",d[1]).attr("r",r).attr("fill",i).attr("stroke",o).attr("stroke-width",a)}};return l.heavier=function(t){return r*=0===arguments.length?2:2*t,l},l.lighter=function(t){return r/=0===arguments.length?2:2*t,l},l.thinner=function(e){return t*=0===arguments.length?2:2*e,l},l.thicker=function(e){return t/=0===arguments.length?2:2*e,l},l.background=function(t){return e=t,l},l.size=function(e){return t=e,l},l.complement=function(t){return n=0===arguments.length||t,l},l.radius=function(t){return r=t,l},l.fill=function(t){return i=t,l},l.stroke=function(t){return o=t,l},l.strokeWidth=function(t){return a=t,l},l.id=function(t){return 0===arguments.length?s:(s=t,l)},l.url=function(){return"url(#".concat(s,")")},l},lines:function(){var t=20,e="#343434",r=2,n="",i=gt(),o=["diagonal"],a="auto",s=function(e){var r=t;switch(e){case"0/8":case"vertical":default:return"M ".concat(r/2,", 0 l 0, ").concat(r);case"1/8":return"M ".concat(-r/4,",").concat(r," l ").concat(r/2,",").concat(-r," M ").concat(r/4,",").concat(r," l ").concat(r/2,",").concat(-r," M ").concat(3*r/4,",").concat(r," l ").concat(r/2,",").concat(-r);case"2/8":case"diagonal":return"M 0,".concat(r," l ").concat(r,",").concat(-r," M ").concat(-r/4,",").concat(r/4," l ").concat(r/2,",").concat(-r/2," M ").concat(3/4*r,",").concat(5/4*r," l ").concat(r/2,",").concat(-r/2);case"3/8":return"M 0,".concat(3/4*r," l ").concat(r,",").concat(-r/2," M 0,").concat(r/4," l ").concat(r,",").concat(-r/2," M 0,").concat(5*r/4," l ").concat(r,",").concat(-r/2);case"4/8":case"horizontal":return"M 0,".concat(r/2," l ").concat(r,",0");case"5/8":return"M 0,".concat(-r/4," l ").concat(r,",").concat(r/2,"M 0,").concat(r/4," l ").concat(r,",").concat(r/2," M 0,").concat(3*r/4," l ").concat(r,",").concat(r/2);case"6/8":return"M 0,0 l ".concat(r,",").concat(r," M ").concat(-r/4,",").concat(3/4*r," l ").concat(r/2,",").concat(r/2," M ").concat(3*r/4,",").concat(-r/4," l ").concat(r/2,",").concat(r/2);case"7/8":return"M ".concat(-r/4,",0 l ").concat(r/2,",").concat(r," M ").concat(r/4,",0 l ").concat(r/2,",").concat(r," M ").concat(3*r/4,",0 l ").concat(r/2,",").concat(r)}},l=function(l){var c=l.append("defs").append("pattern").attr("id",i).attr("patternUnits","userSpaceOnUse").attr("width",t).attr("height",t);n&&c.append("rect").attr("width",t).attr("height",t).attr("fill",n);var h,u=mt(o);try{for(u.s();!(h=u.n()).done;){var d=h.value;c.append("path").attr("d",s(d)).attr("stroke-width",r).attr("shape-rendering",a).attr("stroke",e).attr("stroke-linecap","square")}}catch(t){u.e(t)}finally{u.f()}};return l.heavier=function(t){return r*=0===arguments.length?2:2*t,l},l.lighter=function(t){return r/=0===arguments.length?2:2*t,l},l.thinner=function(e){return t*=0===arguments.length?2:2*e,l},l.thicker=function(e){return t/=0===arguments.length?2:2*e,l},l.background=function(t){return n=t,l},l.size=function(e){return t=e,l},l.orientation=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return 0===arguments.length||(o=e),l},l.shapeRendering=function(t){return a=t,l},l.stroke=function(t){return e=t,l},l.strokeWidth=function(t){return r=t,l},l.id=function(t){return 0===arguments.length?i:(i=t,l)},l.url=function(){return"url(#".concat(i,")")},l},paths:function(){var t=1,e=1,r=20,n="#343434",i=2,o="",a=function(t){return"M ".concat(t/4,",").concat(3*t/4,"l").concat(t/4,",").concat(-t/2,"l").concat(t/4,",").concat(t/2)},s=gt(),l="transparent",c="auto",h=function(h){var u=function(n){var i=r;switch(n){case"squares":return"M ".concat(i/4," ").concat(i/4," l ").concat(i/2," 0 l 0 ").concat(i/2," l ").concat(-i/2," 0 Z");case"nylon":return"M 0 ".concat(i/4," l ").concat(i/4," 0 l 0 ").concat(-i/4," M ").concat(3*i/4," ").concat(i," l 0 ").concat(-i/4," l ").concat(i/4," 0 M ").concat(i/4," ").concat(i/2," l 0 ").concat(i/4," l ").concat(i/4," 0 M ").concat(i/2," ").concat(i/4," l ").concat(i/4," 0 l 0 ").concat(i/4);case"waves":return"M 0 ".concat(i/2," c ").concat(i/8," ").concat(-i/4," , ").concat(3*i/8," ").concat(-i/4," , ").concat(i/2," 0 c ").concat(i/8," ").concat(i/4," , ").concat(3*i/8," ").concat(i/4," , ").concat(i/2," 0 M ").concat(-i/2," ").concat(i/2," c ").concat(i/8," ").concat(i/4," , ").concat(3*i/8," ").concat(i/4," , ").concat(i/2," 0 M ").concat(i," ").concat(i/2," c ").concat(i/8," ").concat(-i/4," , ").concat(3*i/8," ").concat(-i/4," , ").concat(i/2," 0");case"woven":return"M ".concat(i/4,",").concat(i/4,"l").concat(i/2,",").concat(i/2,"M").concat(3*i/4,",").concat(i/4,"l").concat(i/2,",").concat(-i/2," M").concat(i/4,",").concat(3*i/4,"l").concat(-i/2,",").concat(i/2,"M").concat(3*i/4,",").concat(5*i/4,"l").concat(i/2,",").concat(-i/2," M").concat(-i/4,",").concat(i/4,"l").concat(i/2,",").concat(-i/2);case"crosses":return"M ".concat(i/4,",").concat(i/4,"l").concat(i/2,",").concat(i/2,"M").concat(i/4,",").concat(3*i/4,"l").concat(i/2,",").concat(-i/2);case"caps":return"M ".concat(i/4,",").concat(3*i/4,"l").concat(i/4,",").concat(-i/2,"l").concat(i/4,",").concat(i/2);case"hexagons":return t=3,e=Math.sqrt(3),"M ".concat(i,",0 l ").concat(i,",0 l ").concat(i/2,",").concat(i*Math.sqrt(3)/2," l ").concat(-i/2,",").concat(i*Math.sqrt(3)/2," l ").concat(-i,",0 l ").concat(-i/2,",").concat(-i*Math.sqrt(3)/2," Z M 0,").concat(i*Math.sqrt(3)/2," l ").concat(i/2,",0 M ").concat(3*i,",").concat(i*Math.sqrt(3)/2," l ").concat(-i/2,",0");default:return n(i)}}(a),d=h.append("defs").append("pattern").attr("id",s).attr("patternUnits","userSpaceOnUse").attr("width",r*t).attr("height",r*e);o&&d.append("rect").attr("width",r*t).attr("height",r*e).attr("fill",o),d.append("path").attr("d",u).attr("fill",l).attr("stroke",n).attr("stroke-width",i).attr("stroke-linecap","square").attr("shape-rendering",c)};return h.heavier=function(t){return i*=0===arguments.length?2:2*t,h},h.lighter=function(t){return i/=0===arguments.length?2:2*t,h},h.thinner=function(t){return r*=0===arguments.length?2:2*t,h},h.thicker=function(t){return r/=0===arguments.length?2:2*t,h},h.background=function(t){return o=t,h},h.shapeRendering=function(t){return c=t,h},h.size=function(t){return r=t,h},h.d=function(t){return a=t,h},h.fill=function(t){return l=t,h},h.stroke=function(t){return n=t,h},h.strokeWidth=function(t){return i=t,h},h.id=function(t){return 0===arguments.length?s:(s=t,h)},h.url=function(){return"url(#".concat(s,")")},h}};function wt(t){const e=xt.circles().radius(t.radius||1).fill(t.fill||"#000").background(t.background||"#ffffff").size(t.size||4).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function _t(t){const e=xt.lines().orientation(...t.orientation||["diagonal"]).stroke(t.stroke||"#000").strokeWidth(t.strokeWidth||1).background(t.background||"#ffffff").size(t.size||4).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function bt(t){const e=xt.paths().d(t.d||"M 0,0 l 10,10 M 10,0 l -10,10").size(t.size||10).background(t.background||"#ffffff").fill(t.fill||"none").stroke(t.stroke||"#000").strokeWidth(t.strokeWidth||1).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function kt(t={id:"ocean"}){const{intensity:e="medium"}=t,r={light:{size:6,strokeWidth:.5,background:"#e3f2fd"},medium:{size:4,strokeWidth:.8,background:"#bbdefb"},heavy:{size:3,strokeWidth:1.2,background:"#90caf9"}}[e];return _t({id:t.id,orientation:["horizontal"],stroke:"#1976d2",strokeWidth:r.strokeWidth,background:r.background,size:r.size})}function vt(t={id:"forest"}){const{density:e="medium"}=t,r={sparse:{size:8,radius:1,background:"#e8f5e8"},medium:{size:6,radius:1.5,background:"#c8e6c9"},dense:{size:4,radius:2,background:"#a5d6a7"}}[e];return wt({id:t.id,radius:r.radius,fill:"#2e7d32",background:r.background,size:r.size})}function St(t={id:"desert"}){return bt({id:t.id,d:"M 0,5 Q 5,0 10,5 Q 15,10 20,5",size:20,background:"#fff8e1",fill:"none",stroke:"#ff8f00",strokeWidth:.8})}function Mt(t={id:"mountain"}){return bt({id:t.id,d:"M 0,10 L 5,0 L 10,10 Z",size:10,background:"#efebe9",fill:"#5d4037",stroke:"#3e2723",strokeWidth:.5})}const jt={lightOcean:()=>kt({id:"lightOcean",intensity:"light"}),standardOcean:()=>kt({id:"standardOcean",intensity:"medium"}),heavyOcean:()=>kt({id:"heavyOcean",intensity:"heavy"}),sparseForest:()=>vt({id:"sparseForest",density:"sparse"}),standardForest:()=>vt({id:"standardForest",density:"medium"}),denseForest:()=>vt({id:"denseForest",density:"dense"}),desert:()=>St({id:"desert"}),mountain:()=>Mt({id:"mountain"}),simpleDots:()=>wt({id:"simpleDots",background:"#ffffff",fill:"#000000",size:4}),simpleLines:()=>_t({id:"simpleLines",background:"#ffffff",stroke:"#000000",orientation:["diagonal"]})};function $t(t,e,r,n,i,o){switch(t.type){case"Point":o(t.coordinates,e,r,n,i);break;case"LineString":case"MultiPoint":t.coordinates.forEach(t=>{o(t,e,r,n,i)});break;case"Polygon":t.coordinates.forEach(t=>{t.forEach(t=>{o(t,e,r,n,i)})});break;case"MultiLineString":t.coordinates.forEach(t=>{t.forEach(t=>{o(t,e,r,n,i)})});break;case"MultiPolygon":t.coordinates.forEach(t=>{t.forEach(t=>{t.forEach(t=>{o(t,e,r,n,i)})})});break;case"GeometryCollection":t.geometries.forEach(t=>{$t(t,e,r,n,i,o)})}}const zt=40075016.686;function Et(t,e,r){try{if(!isFinite(t)||!isFinite(e)||!isFinite(r))throw new Error("無効な座標またはズームレベルが指定されました");if(t<-180||t>180)throw new Error(`経度は-180から180の範囲で指定してください: ${t}`);if(e<-85.051128779807||e>85.051128779807)throw new Error(`緯度はWeb Mercator投影法の有効範囲（-85.05〜85.05度）で指定してください: ${e}`);if(r<0||r>30)throw new Error(`ズームレベルは0から30の範囲で指定してください: ${r}`);const n=Math.pow(2,r),i=Math.floor((t+180)/360*n),o=e*Math.PI/180;return{x:i,y:Math.floor((1-Math.log(Math.tan(o)+1/Math.cos(o))/Math.PI)/2*n),z:r}}catch(t){throw new Error(`タイル座標の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}}function Lt(t,e,r){try{if(!Number.isInteger(t)||!Number.isInteger(e)||!Number.isInteger(r))throw new Error("タイル座標は整数で指定してください");if(r<0||r>30)throw new Error(`ズームレベルは0から30の範囲で指定してください: ${r}`);const n=Math.pow(2,r);if(t<0||t>=n||e<0||e>=n)throw new Error(`タイル座標がズームレベル${r}の有効範囲外です: x=${t}, y=${e}`);const i=t/n*360-180,o=(t+1)/n*360-180,a=180*Math.atan(Math.sinh(Math.PI*(1-2*e/n)))/Math.PI,s=180*Math.atan(Math.sinh(Math.PI*(1-2*(e+1)/n)))/Math.PI;return{west:i,south:s,east:o,north:a,bounds:[i,s,o,a]}}catch(t){throw new Error(`タイル境界の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}}t.BaseLayer=l,t.FilterPresets=pt,t.GeojsonLayer=class extends l{constructor(t){super(`geojson-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderFeatures())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderFeatures()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("path").on(t,function(t,r){e(t,r)})}renderFeatures(){if(!this.layerGroup||!this.path)return;const t=this.layerGroup.append("g").attr("class","thematika-geojson-layer").selectAll("path").data(this.data.features).enter().append("path").attr("d",this.path).attr("class",t=>["thematika-feature",this.attr.className||"",t.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(t,this.layerGroup)}getData(){return this.data}},t.GraticuleLayer=class extends l{constructor(t={}){super(`graticule-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,{fill:"none",stroke:"#cccccc",strokeWidth:.5,opacity:.7,...t.attr||{}},t.style||{}),this.step=t.step||[10,10],this.extent=t.extent}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderGraticule())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderGraticule()}renderGraticule(){if(!this.layerGroup||!this.path)return;const t=r.geoGraticule().step(this.step);this.extent&&t.extent(this.extent);const e=t(),n=this.layerGroup.append("g").attr("class","thematika-graticule-layer").append("path").datum(e).attr("d",this.path).attr("class",()=>["thematika-graticule",this.attr.className||""].filter(Boolean).join(" "));this.applyAllStylesToElement(n,this.layerGroup)}},t.ImageLayer=class extends l{constructor(t,e){super(t,e.attr,e.style),this.useAdvancedReprojection=!0,this.useMask=!0,this.src=e.src,this.bounds=e.bounds,this.showBboxMarkers=e.showBboxMarkers??!1,this.useAdvancedReprojection=e.useAdvancedReprojection??!0,this.useMask=e.useMask??!0}setProjection(t){if(this.projection=t,this.isRendered()){if(!this.element||!this.projection)return;const t=e.select(this.element);t.selectAll("image").remove(),t.selectAll(".bbox-marker").remove(),t.selectAll(".bbox-marker-label").remove(),this.loadImage(this.src).then(t=>{const e=this.projection&&this.isWebMercatorCompatible(this.projection),r=this.projection&&this.isEquirectangularProjection(this.projection);console.log("=== setProjection - 投影法判定結果 ==="),console.log("  isWebMercatorCompatible:",e),console.log("  isEquirectangular:",r),console.log("  useAdvancedReprojection:",this.useAdvancedReprojection),console.log("  Current projection:",this.projection?.toString()),e?(console.log("→ setProjection実行パス: renderSimpleImage (Web Mercator互換)"),this.renderSimpleImage(t)):r?(console.log("→ setProjection実行パス: renderSimpleImage (Equirectangular高速描画)"),this.renderSimpleImage(t)):this.useAdvancedReprojection?(console.log("→ setProjection実行パス: renderAdvancedReprojection (他の投影法)"),this.renderAdvancedReprojection(t)):(console.log("→ setProjection実行パス: renderSimpleImage (フォールバック)"),this.renderSimpleImage(t))}).catch(t=>{console.error("ImageLayer: 更新に失敗しました",t)})}}async render(t){if(!this.projection)return void console.warn("ImageLayer: 投影法が設定されていません");const e=t.append("g").attr("class",`image-layer ${this.attr.className||""}`).attr("id",`layer-${this.id}`);this.visible||e.style("display","none"),this.element=e.node();try{console.log("=== ImageLayer render() 開始 ==="),console.log("Image src:",this.src),console.log("Image bounds:",this.bounds),console.log("useAdvancedReprojection:",this.useAdvancedReprojection),console.log("Projection:",this.projection);const t=await this.loadImage(this.src);console.log("画像読み込み完了:",{width:t.width,height:t.height,src:t.src});const e=this.projection&&this.isWebMercatorCompatible(this.projection),r=this.projection&&this.isEquirectangularProjection(this.projection);console.log("投影法判定結果:"),console.log("  isWebMercatorCompatible:",e),console.log("  isEquirectangular:",r),console.log("  useAdvancedReprojection:",this.useAdvancedReprojection),e?(console.log("→ 実行パス: renderSimpleImage (Web Mercator互換)"),await this.renderSimpleImage(t)):r?(console.log("→ 実行パス: renderSimpleImage (Equirectangular高速描画)"),await this.renderSimpleImage(t)):this.useAdvancedReprojection?(console.log("→ 実行パス: renderAdvancedReprojection (他の投影法)"),await this.renderAdvancedReprojection(t)):(console.log("→ 実行パス: renderSimpleImage (フォールバック)"),await this.renderSimpleImage(t)),console.log("=== ImageLayer render() 完了 ===")}catch(t){console.error("ImageLayer: 画像の描画に失敗しました",t)}}loadImage(t){return new Promise((e,r)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>e(n),n.onerror=()=>r(new Error(`画像の読み込みに失敗しました: ${t}`)),n.src=t})}isEquirectangularProjection(t){const e=t.toString?t.toString():"";return e.includes("equirectangular")||e.includes("Equirectangular")}isWebMercatorCompatible(t){const e=t.toString?t.toString():"";if(console.log("=== Web Mercator compatibility check ==="),console.log("Projection toString:",e),e.includes("mercator")||e.includes("Mercator"))return console.log("→ Detected as Mercator projection by string match"),!0;if("function"==typeof t.scale&&"function"==typeof t.translate&&"function"==typeof t.center){const r=t.scale(),n=t.translate();if(console.log("Projection details for compatibility check:",{scale:r,translate:n}),!(e.includes("equirectangular")||e.includes("Equirectangular")||e.includes("naturalEarth")||e.includes("orthographic")))return console.log("→ Detected as Mercator-compatible by feature analysis"),!0}return console.log("→ Not Web Mercator compatible"),!1}saveProjectionState(t){return{scale:t.scale(),translate:t.translate(),center:t.center()}}restoreProjectionState(t,e){t.scale(e.scale),t.translate(e.translate),t.center(e.center)}createImageProjection(t){const e=t.toString?t.toString():"";if(console.log("=== Creating image-specific projection ==="),console.log("Base projection:",e),this.isEquirectangularProjection(t)){const[t,e,n,i]=this.bounds,o=r.geoEquirectangular().center([(t+n)/2,(e+i)/2]).scale(1).translate([0,0]);return console.log("→ Created optimized Equirectangular projection for image"),console.log("→ Image center:",[(t+n)/2,(e+i)/2]),o}return console.log("→ Using base projection with state management"),t}renderSimpleImage(t){if(!this.element||!this.projection)return;const[r,n,i,o]=this.bounds,a=this.saveProjectionState(this.projection);console.log("=== renderSimpleImage with projection state management ==="),console.log("Original projection state:",a);let s=this.projection,l=!1;if(this.isEquirectangularProjection(this.projection)){s=this.createImageProjection(this.projection),l=!0;const t=i-r,e=o-n,c=.8*Math.min(2*a.translate[0]/t,2*a.translate[1]/e);s.scale(c).translate(a.translate).center([(r+i)/2,(n+o)/2]),console.log("→ Using optimized image projection"),console.log("→ Image projection scale:",c),console.log("→ Image projection center:",[(r+i)/2,(n+o)/2])}else console.log("→ Using original projection as-is");const c=s([r,o]),h=s([i,o]),u=s([r,n]),d=s([i,n]);console.log("=== ImageLayer bbox projection ==="),console.log("Original bbox coordinates:"),console.log("  West (left):",r),console.log("  South (bottom):",n),console.log("  East (right):",i),console.log("  North (top):",o),console.log("Original bbox:",{west:r,south:n,east:i,north:o}),console.log("Image size:",{width:t.width,height:t.height}),console.log(""),console.log("Working projection details:"),s&&"function"==typeof s.scale&&(console.log("  Working projection scale:",s.scale()),console.log("  Working projection translate:",s.translate()),console.log("  Working projection center:",s.center())),console.log(""),console.log("Input coordinates for projection:"),console.log("  Top-left input: [",r,",",o,"]"),console.log("  Top-right input: [",i,",",o,"]"),console.log("  Bottom-left input: [",r,",",n,"]"),console.log("  Bottom-right input: [",i,",",n,"]"),console.log(""),console.log("Projected coordinates (output):"),console.log("  Top-left (west, north):",c),console.log("  Top-right (east, north):",h),console.log("  Bottom-left (west, south):",u),console.log("  Bottom-right (east, south):",d),console.log(""),console.log("Projection details:"),console.log("  Projection function:",this.projection?.toString()),this.projection&&"function"==typeof this.projection.scale&&console.log("  Scale:",this.projection.scale()),this.projection&&"function"==typeof this.projection.translate&&console.log("  Translate:",this.projection.translate());let p=c,f=h,g=u,y=d;if(l&&!this.isEquirectangularProjection(this.projection)&&(console.log("→ Converting coordinates to original projection space"),s.invert&&c&&d)){const t=s.invert(c),e=s.invert(d);t&&e&&(p=this.projection(t),y=this.projection(e),console.log("→ Converted coordinates:",{topLeft:p,bottomRight:y}))}if(!p||!y)return void console.warn("ImageLayer: 境界が投影範囲外です");const m=p[0],x=p[1],w=Math.abs(y[0]-p[0]),_=Math.abs(y[1]-p[1]);console.log("Projected position (top-left):",{x:m,y:x}),console.log("Projected size:",{width:w,height:_}),console.log("Original image size:",{width:t.width,height:t.height}),console.log("Size scaling factor:",{x:w/t.width,y:_/t.height});const b=i-r,k=o-n;console.log("Geographic size:",{width:b,height:k}),console.log("Geographic aspect ratio:",b/k),console.log("Projected aspect ratio:",w/_),console.log("Image aspect ratio:",t.width/t.height),console.log("====================================="),console.log("=== DOM要素作成開始 ==="),console.log("元画像URL:",t.src);const v=e.select(this.element);this.imageElement=v.append("image").attr("x",m).attr("y",x).attr("width",w).attr("height",_).attr("href",t.src).attr("preserveAspectRatio","none"),console.log("image要素作成直後のhref:",this.imageElement.attr("href")),console.log("image要素作成直後の属性:",{x:this.imageElement.attr("x"),y:this.imageElement.attr("y"),width:this.imageElement.attr("width"),height:this.imageElement.attr("height")}),this.showBboxMarkers&&this.addBboxMarkers(v,[p,f,g,y]),console.log("applyAllStylesToElement実行前のhref:",this.imageElement.attr("href")),this.imageElement&&(this.applyAllStylesToElement(this.imageElement,this.getLayerGroup()),console.log("applyAllStylesToElement実行後のhref:",this.imageElement.attr("href"))),this.isEquirectangularProjection(this.projection)||(this.restoreProjectionState(this.projection,a),console.log("→ Restored original projection state")),console.log("=== DOM要素作成完了 ===")}async renderTransformedImage(t){if(!this.element||!this.projection)return;if(t.width>1e3||t.height>1e3)throw new Error("ImageLayer: 投影変換を行う場合、画像サイズは1000×1000ピクセル以下にしてください");const r=await this.transformRasterImage(t),n=await this.loadImage(r),i=e.select(this.element);this.imageElement=i.append("image").attr("x",0).attr("y",0).attr("width",n.width).attr("height",n.height).attr("href",r).attr("preserveAspectRatio","none"),this.imageElement&&this.applyAllStylesToElement(this.imageElement,this.getLayerGroup())}async transformRasterImage(t){if(!this.projection)throw new Error("投影法が設定されていません");const[e,r,n,i]=this.bounds,o=document.createElement("canvas"),a=o.getContext("2d");if(!a)throw new Error("Canvas contextの取得に失敗しました");o.width=t.width,o.height=t.height,a.drawImage(t,0,0);const s=a.getImageData(0,0,t.width,t.height),l=[[e,i],[n,i],[n,r],[e,r],[(e+n)/2,i],[(e+n)/2,r],[e,(i+r)/2],[n,(i+r)/2]].map(t=>this.projection(t)).filter(t=>null!==t);if(0===l.length)throw new Error("ImageLayer: 画像が投影範囲外です");const c=Math.floor(Math.min(...l.map(t=>t[0]))),h=Math.ceil(Math.max(...l.map(t=>t[0]))),u=Math.floor(Math.min(...l.map(t=>t[1]))),d=Math.ceil(Math.max(...l.map(t=>t[1]))),p=document.createElement("canvas"),f=p.getContext("2d");if(!f)throw new Error("Canvas contextの取得に失敗しました");p.width=h-c,p.height=d-u;const g=f.createImageData(p.width,p.height),y=g.data;for(let o=0;o<p.height;o++)for(let a=0;a<p.width;a++){const l=a+c,h=o+u,d=this.approximateInverseProjection(l,h,e,r,n,i);if(d){const[l,c]=d,h=Math.round((l-e)/(n-e)*(t.width-1)),u=Math.round((i-c)/(i-r)*(t.height-1));if(h>=0&&h<t.width&&u>=0&&u<t.height){const e=4*(u*t.width+h),r=4*(o*p.width+a);y[r]=s.data[e],y[r+1]=s.data[e+1],y[r+2]=s.data[e+2],y[r+3]=s.data[e+3]}}}return f.putImageData(g,0,0),p.toDataURL()}approximateInverseProjection(t,e,r,n,i,o){if(!this.projection)return null;let a=r,s=i,l=n,c=o;for(let r=0;r<20;r++){const r=(a+s)/2,n=(l+c)/2,i=this.projection([r,n]);if(!i)return null;const[o,h]=i;if(Math.abs(o-t)<.5&&Math.abs(h-e)<.5)return[r,n];o<t?a=r:s=r,h<e?c=n:l=n}return[(a+s)/2,(l+c)/2]}addBboxMarkers(t,e){const r=e.filter(t=>null!==t),n=["#e74c3c","#3498db","#2ecc71","#f39c12"],i=["NW","NE","SW","SE"];r.forEach((e,r)=>{const o=t.append("g").attr("class","bbox-marker").attr("transform",`translate(${e[0]}, ${e[1]})`);o.append("circle").attr("r",6).attr("fill","white").attr("stroke",n[r]||"#9b59b6").attr("stroke-width",2),o.append("circle").attr("r",4).attr("fill",n[r]||"#9b59b6"),o.append("text").attr("x",10).attr("y",4).attr("font-size","11px").attr("font-family","Arial, sans-serif").attr("fill",n[r]||"#9b59b6").attr("font-weight","bold").attr("class","bbox-marker-label").text(i[r]||`${r+1}`)})}async renderAdvancedReprojection(t){if(this.element&&this.projection)try{const r=await this.advancedTransformRasterImage(t),n=(await this.loadImage(r.dataUrl),e.select(this.element));if(this.imageElement=n.append("image").attr("x",r.x).attr("y",r.y).attr("width",r.width).attr("height",r.height).attr("href",r.dataUrl).attr("preserveAspectRatio","none"),this.imageElement&&this.applyAllStylesToElement(this.imageElement,this.getLayerGroup()),this.showBboxMarkers){const[t,e,r,i]=this.bounds,o=this.projection([t,i]),a=this.projection([r,i]),s=this.projection([t,e]),l=this.projection([r,e]);this.addBboxMarkers(n,[o,a,s,l])}}catch(e){console.warn("高度な再投影に失敗しました。単純な描画にフォールバックします。",e),this.renderSimpleImage(t)}}async advancedTransformRasterImage(t){if(!this.projection)throw new Error("投影法が設定されていません");const[e,n,i,o]=this.bounds,a=document.createElement("canvas"),s=a.getContext("2d");if(!s)throw new Error("Canvas contextの取得に失敗しました");a.width=t.width,a.height=t.height,s.drawImage(t,0,0);const l=s.getImageData(0,0,t.width,t.height);r.geoEquirectangular().scale(1).translate([0,0]);const c=this.calculateOutputBounds();if(!c)throw new Error("出力範囲の計算に失敗しました");const{minX:h,minY:u,width:d,height:p}=c,f=document.createElement("canvas"),g=f.getContext("2d");if(!g)throw new Error("Canvas contextの取得に失敗しました");f.width=d,f.height=p;const y=document.createElement("canvas"),m=y.getContext("2d");if(!m)throw new Error("Mask contextの取得に失敗しました");y.width=d,y.height=p,m.fillStyle="#fff";const x=t=>{const e=this.projection(t);return e?[e[0]-h,e[1]-u]:null};m.beginPath();const w=[],_=50;console.log("=== Advanced reprojection mask creation ==="),console.log("Image bounds:",{west:e,south:n,east:i,north:o});for(let t=0;t<=_;t++){const r=x([e+(i-e)*t/_,o]);r&&w.push(r)}for(let t=0;t<=_;t++){const e=x([i,o-(o-n)*t/_]);e&&w.push(e)}for(let t=0;t<=_;t++){const r=x([i-(i-e)*t/_,n]);r&&w.push(r)}for(let t=0;t<=_;t++){const r=x([e,n+(o-n)*t/_]);r&&w.push(r)}if(console.log("Generated boundary points:",w.length),w.length>0){m.moveTo(w[0][0],w[0][1]);for(let t=1;t<w.length;t++)m.lineTo(w[t][0],w[t][1]);m.closePath(),m.fill()}const b=m.getImageData(0,0,d,p),k=g.createImageData(d,p);console.log("=== Pixel transformation started ==="),console.log("Output canvas size:",{width:d,height:p}),console.log("Source image size:",{width:t.width,height:t.height});let v=0,S=0;const M=d*p,j=Math.floor(M/10);for(let r=0;r<p;r++)for(let a=0;a<d;a++){if(v++,v%j===0){const t=Math.floor(v/M*100);console.log(`Transformation progress: ${t}% (${v}/${M})`)}if(this.useMask){const t=4*(r*d+a);if(0===b.data[t+3])continue}const s=a+h+.5,c=r+u+.5,p=this.inverseProjectWithFallback(s,c,e,n,i,o);if(p){const s=(p[0]-e)/(i-e)*(t.width-1),c=(o-p[1])/(o-n)*(t.height-1),h=this.bilinearInterpolate(l,s,c),u=4*(r*d+a);k.data[u]=h[0],k.data[u+1]=h[1],k.data[u+2]=h[2],k.data[u+3]=h[3],S++}}return console.log("=== Pixel transformation completed ==="),console.log("Successful transforms:",S,"/",M),console.log("Success rate:",Math.round(S/M*100),"%"),g.putImageData(k,0,0),{dataUrl:f.toDataURL(),x:h,y:u,width:d,height:p}}calculateOutputBounds(){if(!this.projection)return null;const[t,e,r,n]=this.bounds,i=[];for(let o=0;o<=20;o++){const a=o/20;i.push([t+(r-t)*a,n],[t+(r-t)*a,e],[t,e+(n-e)*a],[r,e+(n-e)*a])}const o=i.map(t=>this.projection(t)).filter(t=>null!==t);if(0===o.length)return null;const a=o.map(t=>t[0]),s=o.map(t=>t[1]),l=Math.floor(Math.min(...a)),c=Math.ceil(Math.max(...a)),h=Math.floor(Math.min(...s));return{minX:l,minY:h,width:c-l,height:Math.ceil(Math.max(...s))-h}}inverseProjectWithFallback(t,e,r,n,i,o){if(!this.projection)return null;if("function"==typeof this.projection.invert)try{const a=this.projection.invert([t,e]);if(a&&a[0]>=r&&a[0]<=i&&a[1]>=n&&a[1]<=o)return a}catch(t){}return this.approximateInverseProjection(t,e,r,n,i,o)}bilinearInterpolate(t,e,r){const n=Math.floor(e),i=Math.min(n+1,t.width-1),o=Math.floor(r),a=Math.min(o+1,t.height-1),s=e-n,l=r-o,c=(e,r)=>{const n=4*(r*t.width+e);return[t.data[n],t.data[n+1],t.data[n+2],t.data[n+3]]},h=c(n,o),u=c(i,o),d=c(n,a),p=c(i,a),f=[0,0,0,0];for(let t=0;t<4;t++){const e=h[t]*(1-s)+u[t]*s,r=d[t]*(1-s)+p[t]*s;f[t]=Math.round(e*(1-l)+r*l)}return f}},t.LayerManager=s,t.LegendLayer=class extends l{constructor(t){super(`legend-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.scale=t.scale,this.position=t.position,this.title=t.title,this.orientation=t.orientation||"vertical",this.itemSpacing=t.itemSpacing||20,this.fontSize=t.fontSize||12,this.width=t.width,this.height=t.height,this.symbolType=t.symbolType||this.inferSymbolType(),this.symbolSize=t.symbolSize||{fixed:16},this.sizeScale=t.sizeScale,this.gradientSteps=t.gradientSteps||256,this.enableDrag=!1!==t.enableDrag,this.showBackground=!1!==t.showBackground,this.overlapping=t.overlapping||!1,this.backgroundStyle={fill:"#ffffff",stroke:"#cccccc",strokeWidth:1,opacity:.9,rx:4,ry:4,padding:8,...t.backgroundStyle}}inferSymbolType(){return"continuous"===this.detectScaleType()?"gradient":"cell"}hasSizeScale(){return!!this.sizeScale}render(t){this.parentContainer=t,this.layerGroup=this.createLayerGroup(t),this.renderLegend(),this.renderBackground(),this.updatePositionTransform(),this.enableDrag&&this.setupDragBehavior(),this.setupResizeListener()}detectScaleType(){const t=this.scale;return"function"==typeof t.invertExtent?"quantized":"function"==typeof t.ticks?"continuous":"ordinal"}isColorValue(t){return"string"==typeof t&&(!!/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(t)||(!!/^rgba?\(/.test(t)||(!!/^hsla?\(/.test(t)||!!/^(red|green|blue|black|white|yellow|cyan|magenta|gray|grey|orange|purple|brown|pink)$/i.test(t))))}generateLegendData(){const t=this.detectScaleType();switch(t){case"continuous":return this.generateContinuousLegend();case"quantized":return this.generateQuantizedLegend();case"ordinal":return this.generateOrdinalLegend();default:throw new Error(`Unsupported scale type: ${t}`)}}generateContinuousLegend(){const t=this.scale,e=t.domain(),r=t.ticks?t.ticks(5):e;return{data:r,labels:r.map(t=>t.toString()),colors:r.map(e=>t(e))}}generateQuantizedLegend(){const t=this.scale,e=t.range(),r=e.length>0&&"number"==typeof e[0],n={data:e,labels:e.map(e=>{const r=t.invertExtent(e);return null!=r[0]&&null!=r[1]?`${r[0]} - ${r[1]}`:e.toString()}),colors:r?e.map(()=>"#0066cc"):e};return r&&(n.sizes=e),n}generateOrdinalLegend(){const t=this.scale,e=t.domain(),r=t.range(),n=r.length>0&&"number"==typeof r[0],i={data:e,labels:e.map(t=>t.toString()),colors:n?e.map(()=>"#0066cc"):e.map(e=>t(e))};return n&&(i.sizes=e.map(e=>t(e))),i}generateSizeScaleLegendData(){if(!this.sizeScale)throw new Error("Size scale is not defined");const t=this.sizeScale,e=t.domain(),r=t.range(),n=this.scale;return{data:e,labels:e.map(t=>t.toString()),colors:e.map(()=>{if("function"==typeof n)try{const t=n.domain();return n(t[0])||"#0066cc"}catch{return"#0066cc"}return"#0066cc"}),sizes:r}}renderLegend(){if(this.layerGroup)if(this.title&&this.renderTitle(),this.hasSizeScale())this.renderSizeScaleLegend();else switch(this.symbolType){case"cell":this.renderCellLegend();break;case"circle":this.renderCircleLegend();break;case"line":this.renderLineLegend();break;case"gradient":this.renderGradientLegend();break;default:throw new Error(`Unsupported symbol type: ${this.symbolType}`)}}renderTitle(){this.layerGroup&&this.title&&this.layerGroup.append("text").attr("class","thematika-legend-title").attr("x",0).attr("y",0).style("font-size",`${this.fontSize+2}px`).style("font-weight","bold").style("fill","#333").text(this.title)}renderCellLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),n=this.symbolSize.fixed||16;r.append("rect").attr("x",0).attr("y",0).attr("width",n).attr("height",n).attr("fill",(e,r)=>t.colors[r]).attr("stroke","#333").attr("stroke-width",.5),r.append("text").attr("x",n+4).attr("y",n/2).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderCircleLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),n=(this.symbolSize.fixed||16)/2;r.append("circle").attr("cx",n).attr("cy",n).attr("r",n).attr("fill",(e,r)=>t.colors[r]).attr("stroke","#333").attr("stroke-width",.5),r.append("text").attr("x",2*n+4).attr("y",n).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderLineLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),n=this.symbolSize.fixed||24;r.append("line").attr("x1",0).attr("y1",8).attr("x2",n).attr("y2",8).attr("stroke",(e,r)=>t.colors[r]).attr("stroke-width",2),r.append("text").attr("x",n+4).attr("y",8).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderGradientLegend(){if(!this.layerGroup)return;const t=this.scale,e=t.domain(),r=`gradient-${this.id}`,n=this.layerGroup.append("defs").append("linearGradient").attr("id",r).attr("x1","0%").attr("y1","0%").attr("x2","horizontal"===this.orientation?"100%":"0%").attr("y2","horizontal"===this.orientation?"0%":"100%"),i=this.gradientSteps;for(let r=0;r<=i;r++){const o=r/i,a=e[0]+o*(e[1]-e[0]);n.append("stop").attr("offset",100*o+"%").attr("stop-color",t(a))}const o=this.title?this.fontSize+10:0,a=this.width||200,s=this.height||20;this.layerGroup.append("rect").attr("x",0).attr("y",o).attr("width","horizontal"===this.orientation?a:s).attr("height","horizontal"===this.orientation?s:a).attr("fill",`url(#${r})`).attr("stroke","#333").attr("stroke-width",.5);const l=t.ticks?t.ticks(5):e,c=this.layerGroup.append("g").attr("transform",`translate(0, ${o})`);l.forEach((t,r)=>{const n=(t-e[0])/(e[1]-e[0]);c.append("text").attr("x","horizontal"===this.orientation?n*a:s+4).attr("y","horizontal"===this.orientation?s+16:n*a).attr("text-anchor","horizontal"===this.orientation?"middle":"start").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.toString())})}renderSizeScaleLegend(){if(!this.layerGroup)return;const t=this.generateSizeScaleLegendData(),e=this.title?this.fontSize+10:0;this.overlapping?this.renderOverlappingSizeScale(t,e):this.renderRegularSizeScale(t,e)}renderOverlappingSizeScale(t,e){if(!this.layerGroup||!t.sizes||0===t.sizes.length)return;const r=Math.max(...t.sizes);switch(this.symbolType){case"circle":default:this.renderOverlappingCircles(t,e,r);break;case"cell":this.renderOverlappingCells(t,e,r);break;case"line":this.renderOverlappingLines(t,e,r)}}renderOverlappingCircles(t,e,r){if(!this.layerGroup||!t.sizes)return;const n=r,i=n,o=e+2*n,a=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),s=this.layerGroup.append("g").attr("class","thematika-legend-symbols");a.forEach((t,e)=>{const r=o-t.size;s.append("circle").attr("cx",i).attr("cy",r).attr("r",t.size).attr("fill","none").attr("stroke","#333").attr("stroke-width",1)});const l=this.layerGroup.append("g").attr("class","thematika-legend-guidelines"),c=i+n+20,h=c-4;a.forEach((t,e)=>{const r=o-t.size-t.size,n=i;l.append("line").attr("x1",n).attr("y1",r).attr("x2",h).attr("y2",r).attr("stroke","#333").attr("stroke-width",1).attr("stroke-dasharray","3,3")});const u=this.layerGroup.append("g").attr("class","thematika-legend-labels");a.forEach((t,e)=>{const r=o-t.size-t.size;u.append("text").attr("x",c).attr("y",r).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderOverlappingCells(t,e,r){if(!this.layerGroup||!t.sizes)return;const n=Math.sqrt(r),i=n/2,o=e+n,a=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),s=this.layerGroup.append("g").attr("class","thematika-legend-symbols");a.forEach((t,e)=>{const r=Math.sqrt(t.size),n=o-r;s.append("rect").attr("x",i-r/2).attr("y",n).attr("width",r).attr("height",r).attr("fill","none").attr("stroke","#333").attr("stroke-width",1)});const l=this.layerGroup.append("g").attr("class","thematika-legend-guidelines"),c=i+n/2+20,h=c-4;a.forEach((t,e)=>{const r=Math.sqrt(t.size),n=o-r,a=i;l.append("line").attr("x1",a).attr("y1",n).attr("x2",h).attr("y2",n).attr("stroke","#333").attr("stroke-width",1).attr("stroke-dasharray","3,3")});const u=this.layerGroup.append("g").attr("class","thematika-legend-labels");a.forEach((t,e)=>{const r=Math.sqrt(t.size),n=o-r;u.append("text").attr("x",c).attr("y",n).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderOverlappingLines(t,e,r){if(!this.layerGroup||!t.sizes)return;const n=e+r/2+10,i=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),o=this.layerGroup.append("g").attr("class","thematika-legend-symbols");i.forEach((t,e)=>{o.append("line").attr("x1",0).attr("y1",n).attr("x2",30).attr("y2",n).attr("stroke",t.color).attr("stroke-width",t.size).attr("opacity",.8)});const a=this.layerGroup.append("g").attr("class","thematika-legend-labels"),s=this.fontSize+4;i.forEach((t,e)=>{a.append("text").attr("x",40).attr("y",n-r/2+e*s+this.fontSize).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderRegularSizeScale(t,e){if(!this.layerGroup||!t.sizes)return;const r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item");switch(this.symbolType){case"circle":default:this.renderRegularSizeCircles(r,t,e);break;case"cell":this.renderRegularSizeCells(r,t,e);break;case"line":this.renderRegularSizeLines(r,t,e)}}renderRegularSizeCircles(t,e,r){e.sizes&&(t.append("circle").attr("cx",(t,r)=>e.sizes[r]).attr("cy",(t,r)=>e.sizes[r]).attr("r",(t,r)=>e.sizes[r]).attr("fill",(t,r)=>e.colors[r]).attr("stroke","#333").attr("stroke-width",.5),t.append("text").attr("x",(t,r)=>2*e.sizes[r]+4).attr("y",(t,r)=>"horizontal"===this.orientation?0:e.sizes[r]).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes))}renderRegularSizeCells(t,e,r){e.sizes&&(t.append("rect").attr("x",0).attr("y",0).attr("width",(t,r)=>Math.sqrt(e.sizes[r])).attr("height",(t,r)=>Math.sqrt(e.sizes[r])).attr("fill",(t,r)=>e.colors[r]).attr("stroke","#333").attr("stroke-width",.5),t.append("text").attr("x",(t,r)=>Math.sqrt(e.sizes[r])+4).attr("y",(t,r)=>"horizontal"===this.orientation?0:Math.sqrt(e.sizes[r])/2).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes))}renderRegularSizeLines(t,e,r){if(!e.sizes)return;t.append("line").attr("x1",0).attr("y1",8).attr("x2",24).attr("y2",8).attr("stroke",(t,r)=>e.colors[r]).attr("stroke-width",(t,r)=>e.sizes[r]),t.append("text").attr("x",28).attr("y",(t,e)=>"horizontal"===this.orientation?0:8).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes)}positionItems(t,e,r){if("vertical"===this.orientation)t.attr("transform",(t,r)=>`translate(0, ${e+r*this.itemSpacing})`);else if(r&&this.hasSizeScale()){const n=Math.max(...r);t.attr("transform",(t,i)=>{const o=r[i];let a=0;return"circle"===this.symbolType?a=n-o:"cell"===this.symbolType&&(a=Math.sqrt(n)-Math.sqrt(o)),`translate(${i*this.itemSpacing}, ${e+a})`})}else t.attr("transform",(t,r)=>`translate(${r*this.itemSpacing}, ${e})`)}renderBackground(){if(!this.layerGroup)return;const t=this.calculateLegendBounds(),e=this.backgroundStyle.padding||8,r=this.showBackground?this.backgroundStyle.opacity||.9:0,n=this.layerGroup.insert("rect",":first-child").attr("class","thematika-legend-background").attr("x",t.x-e).attr("y",t.y-e).attr("width",t.width+2*e).attr("height",t.height+2*e).attr("fill",this.backgroundStyle.fill||"#ffffff").attr("stroke",this.backgroundStyle.stroke||"#cccccc").attr("stroke-width",this.backgroundStyle.strokeWidth||1).attr("opacity",r);this.backgroundStyle.rx&&n.attr("rx",this.backgroundStyle.rx),this.backgroundStyle.ry&&n.attr("ry",this.backgroundStyle.ry)}calculateLegendBounds(){if(!this.layerGroup)return{x:0,y:0,width:100,height:50};try{const t=this.layerGroup.node().getBBox();return{x:t.x,y:t.y,width:t.width,height:t.height}}catch(t){const e=this.generateLegendData().data.length,r=this.title?this.fontSize+10:0;return"vertical"===this.orientation?{x:0,y:0,width:150,height:r+e*this.itemSpacing}:{x:0,y:0,width:100*e,height:r+30}}}updatePositionTransform(){if(!this.layerGroup)return;const t=this.position.left,e=this.position.top;this.layerGroup.attr("transform",`translate(${t}, ${e})`)}setupDragBehavior(){if(!this.layerGroup)return;const t=S().on("start",()=>{this.layerGroup&&this.layerGroup.style("cursor","grabbing")}).on("drag",t=>{this.position.left+=t.dx,this.position.top+=t.dy,this.updatePositionTransform(),this.updateSliders()}).on("end",()=>{this.layerGroup&&this.layerGroup.style("cursor","grab")});this.layerGroup.style("cursor","grab").call(t)}updateSliders(){if("undefined"!=typeof window&&"undefined"!=typeof document){const t=document.getElementById("legend-x-slider"),e=document.getElementById("legend-y-slider"),r=document.getElementById("legend-x-value"),n=document.getElementById("legend-y-value");t&&e&&r&&n&&(t.value=this.position.left.toString(),e.value=this.position.top.toString(),r.textContent=this.position.left.toString(),n.textContent=this.position.top.toString())}}updateBackgroundOpacity(){if(!this.layerGroup)return;const t=this.layerGroup.select(".thematika-legend-background");if(!t.empty()){const e=this.showBackground?this.backgroundStyle.opacity||.9:0;t.attr("opacity",e)}}updateBackgroundStyles(){if(!this.layerGroup)return;const t=this.layerGroup.select(".thematika-legend-background");if(!t.empty()){const e=this.showBackground?this.backgroundStyle.opacity||.9:0;t.attr("fill",this.backgroundStyle.fill||"#ffffff").attr("stroke",this.backgroundStyle.stroke||"#cccccc").attr("stroke-width",this.backgroundStyle.strokeWidth||1).attr("opacity",e).attr("rx",this.backgroundStyle.rx||null).attr("ry",this.backgroundStyle.ry||null)}}setupResizeListener(){}},t.LineConnectionLayer=class extends l{constructor(t){super(`line-connection-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),Array.isArray(t.data)?this.data={type:"FeatureCollection",features:t.data}:"Feature"===t.data.type?this.data={type:"FeatureCollection",features:[t.data]}:this.data=t.data,this.validateData(this.data),this.lineType=t.lineType||"straight",this.arcHeight=t.arcHeight||.3,this.arcControlPoint=t.arcControlPoint||"center",this.arcOffset=t.arcOffset||"perpendicular",this.startArrow=t.startArrow||!1,this.endArrow=t.endArrow||!1,this.arrowSize=t.arrowSize||10,this.smoothType=t.smoothType||"curveBasis"}validateData(t){if(!t||"FeatureCollection"!==t.type)throw new Error("LineConnectionLayer: データはFeatureCollectionである必要があります");if(!Array.isArray(t.features))throw new Error("LineConnectionLayer: featuresが配列ではありません");t.features.forEach((t,e)=>{if(!t.geometry)throw new Error(`LineConnectionLayer: フィーチャー[${e}]にgeometryが存在しません`);const r=t.geometry,{type:n,coordinates:i}=r;if("LineString"!==n&&"MultiLineString"!==n)throw new Error(`LineConnectionLayer: フィーチャー[${e}]は'LineString'または'MultiLineString'である必要があります`);"LineString"===n?this.validateCoordinates(i,e):"MultiLineString"===n&&i.forEach((t,r)=>{this.validateCoordinates(t,e,r)})})}validateCoordinates(t,e,r){const n=void 0!==r?`[${e}]のライン[${r}]`:`[${e}]`;if(!Array.isArray(t)||t.length<2)throw new Error(`LineConnectionLayer: フィーチャー${n}は少なくとも2点の座標が必要です`);t.forEach((t,e)=>{if(!Array.isArray(t)||t.length<2)throw new Error(`LineConnectionLayer: フィーチャー${n}の座標[${e}]は[経度, 緯度]の配列である必要があります`);const[r,i]=t;if(r<-180||r>180)throw new Error(`LineConnectionLayer: フィーチャー${n}の座標[${e}]の経度は-180から180の範囲である必要があります`);if(i<-90||i>90)throw new Error(`LineConnectionLayer: フィーチャー${n}の座標[${e}]の緯度は-90から90の範囲である必要があります`)})}setProjection(t){this.projection=t,this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.layerGroup.selectAll("defs").remove(),this.createArrowMarkers(),this.renderLines())}render(t){this.layerGroup=this.createLayerGroup(t),this.createArrowMarkers(),this.renderLines()}createArrowMarkers(){if(!this.layerGroup||!this.startArrow&&!this.endArrow)return;const t=`arrow-${this.id}`,e=this.layerGroup.append("defs").attr("class","thematika-line-connection-defs");this.startArrow&&e.append("marker").attr("id",`${t}-start`).attr("viewBox","0 0 10 10").attr("refX",0).attr("refY",5).attr("markerWidth",this.arrowSize/2).attr("markerHeight",this.arrowSize/2).attr("orient","auto-start-reverse").append("path").attr("d","M 0 0 L 10 5 L 0 10 z").style("fill",("function"==typeof this.attr.stroke?"#333":this.attr.stroke)||"#333"),this.endArrow&&e.append("marker").attr("id",`${t}-end`).attr("viewBox","0 0 10 10").attr("refX",10).attr("refY",5).attr("markerWidth",this.arrowSize/2).attr("markerHeight",this.arrowSize/2).attr("orient","auto").append("path").attr("d","M 0 0 L 10 5 L 0 10 z").style("fill",("function"==typeof this.attr.stroke?"#333":this.attr.stroke)||"#333")}renderLines(){if(!this.layerGroup||!this.path||!this.projection)return;const t=this.layerGroup.append("g").attr("class","thematika-line-connection-layer");this.data.features.forEach((e,r)=>{const n=e.geometry;"LineString"===n.type?this.renderLineString(t,n.coordinates,e,r):"MultiLineString"===n.type&&n.coordinates.forEach((n,i)=>{this.renderLineString(t,n,e,r,i)})})}renderLineString(t,e,r,n,i){if("smooth"===this.lineType)this.renderSmoothLineString(t,e,r,n,i);else for(let n=0;n<e.length-1;n++){const o={start:e[n],end:e[n+1],feature:r,segmentIndex:n,isFirst:0===n,isLast:n===e.length-2},a=t.append("path").datum(o).attr("d",t=>this.generateSegmentPath(t.start,t.end)).attr("class",()=>["thematika-connection-line",this.attr.className||"",r.properties?.class||"",`segment-${n}`,void 0!==i?`line-${i}`:""].filter(Boolean).join(" ")).style("fill","none"),s=`arrow-${this.id}`;this.startArrow&&o.isFirst&&a.attr("marker-start",`url(#${s}-start)`),this.endArrow&&o.isLast&&a.attr("marker-end",`url(#${s}-end)`),super.applyAllStylesToElement(a,this.layerGroup)}}generateSegmentPath(t,e){if(!this.projection)return"";const r=this.projection(t),n=this.projection(e);return r&&n?"straight"===this.lineType?`M${r[0]},${r[1]}L${n[0]},${n[1]}`:"arc"===this.lineType?this.generateArcPath(t,e,r,n):(this.lineType,`M${r[0]},${r[1]}L${n[0]},${n[1]}`):""}generateArcPath(t,e,r,n){if(!this.projection)return"";const i=this.calculateBaseControlPoint(t,e,r,n);if(!i)return"";const o=this.applyArcOffset(i,r,n);return`M${r[0]},${r[1]}Q${o[0]},${o[1]} ${n[0]},${n[1]}`}calculateBaseControlPoint(t,e,r,n){if(!this.projection)return null;switch(this.arcControlPoint){case"center":const r=[(t[0]+e[0])/2,(t[1]+e[1])/2];return this.projection(r);case"weighted":const n=.5,i=[t[0]+(e[0]-t[0])*n,t[1]+(e[1]-t[1])*n];return this.projection(i);default:return Array.isArray(this.arcControlPoint)?this.projection(this.arcControlPoint):null}}applyArcOffset(t,e,r){const n=r[0]-e[0],i=r[1]-e[1],o=Math.sqrt(n*n+i*i);let a=0,s=0;switch(this.arcOffset){case"perpendicular":a=-i/o*this.arcHeight*o,s=n/o*this.arcHeight*o;break;case"north":s=-this.arcHeight*o;break;case"south":s=this.arcHeight*o;break;case"east":a=this.arcHeight*o;break;case"west":a=-this.arcHeight*o;break;default:Array.isArray(this.arcOffset)&&(a=this.arcOffset[0]*o,s=this.arcOffset[1]*o)}return[t[0]+a,t[1]+s]}renderSmoothLineString(t,e,r,n,i){if(!this.projection)return;const o=this.geoSmoothPath(e);if(!o)return;const a={coordinates:e,feature:r,featureIndex:n,lineIndex:i},s=t.append("path").datum(a).attr("d",o).attr("class",()=>["thematika-connection-line",this.attr.className||"",r.properties?.class||"",void 0!==i?`line-${i}`:""].filter(Boolean).join(" ")).style("fill","none"),l=`arrow-${this.id}`;this.startArrow&&s.attr("marker-start",`url(#${l}-start)`),this.endArrow&&s.attr("marker-end",`url(#${l}-end)`),super.applyAllStylesToElement(s,this.layerGroup)}geoSmoothPath(t){if(!this.projection)return"";const e=t.map(t=>this.projection([t[0],t[1]])).filter(t=>null!==t);if(e.length<2)return"";const r=this.getCurveFunction();return B().x(t=>t[0]).y(t=>t[1]).curve(r)(e)||""}getCurveFunction(){switch(this.smoothType){case"curveBasis":default:return R;case"curveCardinal":return V;case"curveCatmullRom":return Y;case"curveLinear":return I;case"curveMonotoneX":return et;case"curveMonotoneY":return rt;case"curveNatural":return ot;case"curveStep":return st;case"curveStepAfter":return ct;case"curveStepBefore":return lt}}on(t,e){this.layerGroup&&this.layerGroup.selectAll("path").on(t,function(t,r){r.coordinates?e(t,{feature:r.feature,coordinates:r.coordinates,featureIndex:r.featureIndex,lineIndex:r.lineIndex}):e(t,{feature:r.feature,segmentIndex:r.segmentIndex,start:r.start,end:r.end,isFirst:r.isFirst,isLast:r.isLast})})}},t.LineTextLayer=class extends l{constructor(t){if(super(`line-text-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,this.validateData(this.data),this.textProperty=t.textProperty||"text",this.position=t.position||"middle",this.placement=t.placement||"along",this.usePercentage=!1!==t.usePercentage,this.multiplePositions=t.multiplePositions,"function"==typeof t.dx)this.dxFunction=t.dx;else{const e=t.dx||0;this.dxFunction=()=>e}if("function"==typeof t.dy)this.dyFunction=t.dy;else{const e=t.dy||0;this.dyFunction=()=>e}if("function"==typeof t.rotate)this.rotateFunction=t.rotate;else{const e=t.rotate||0;this.rotateFunction=()=>e}if(this.lengthAdjust=t.lengthAdjust||"spacing",this.alignmentBaseline=t.alignmentBaseline||"middle",this.textAnchor=t.textAnchor||"middle","function"==typeof t.fontFamily)this.fontFamilyFunction=t.fontFamily;else{const e=t.fontFamily||"メイリオ, Meiryo, 'ＭＳ Ｐゴシック', MS Gothic, sans-serif";this.fontFamilyFunction=()=>e}if("function"==typeof t.fontSize)this.fontSizeFunction=t.fontSize;else{const e=t.fontSize||16;this.fontSizeFunction=()=>e}if("function"==typeof t.fontWeight)this.fontWeightFunction=t.fontWeight;else{const e=t.fontWeight||"normal";this.fontWeightFunction=()=>e}}validateData(t){if(!t||"FeatureCollection"!==t.type)throw new Error("LineTextLayer: データはFeatureCollectionである必要があります");if(!Array.isArray(t.features))throw new Error("LineTextLayer: featuresが配列ではありません");t.features.forEach((t,e)=>{if(!t.geometry)throw new Error(`LineTextLayer: フィーチャー[${e}]にgeometryが存在しません`);const r=t.geometry;if("LineString"!==r.type&&"MultiLineString"!==r.type)throw new Error(`LineTextLayer: フィーチャー[${e}]は'LineString'または'MultiLineString'である必要があります`)})}render(t){this.layerGroup=this.createLayerGroup(t),this.renderTexts()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("text").on(t,function(t,r){e(t,r)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderTexts()}renderTexts(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-line-text-layer").remove();const t=[];this.data.features.forEach((e,r)=>{let n="";if(e.properties&&(n=e.properties[this.textProperty]||e.properties.name||""),!n)return;(this.multiplePositions||[this.position]).forEach((i,o)=>{const a=this.calculateTextPositions(e,r,i,n,o);a&&t.push(a)})});const e=this.layerGroup.append("g").attr("class","thematika-line-text-layer").selectAll("text").data(t).enter().append("text").attr("x",t=>t.x).attr("y",t=>t.y).attr("dx",t=>t.dx).attr("dy",t=>t.dy).attr("transform",t=>0!==t.rotation?`rotate(${t.rotation}, ${t.x}, ${t.y})`:null).attr("lengthAdjust",this.lengthAdjust).attr("alignment-baseline",this.alignmentBaseline).attr("text-anchor",this.textAnchor).attr("font-family",t=>t.fontFamily).attr("font-size",t=>t.fontSize).attr("font-weight",t=>t.fontWeight).attr("class",t=>["thematika-line-text",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" ")).text(t=>t.text);this.applyAllStylesToElements(e,this.layerGroup)}calculateTextPositions(t,e,r,n,i){const o=t.geometry;if("LineString"===o.type)return this.calculateLineStringTextPosition(o.coordinates,t,e,r,n,i);if("MultiLineString"===o.type){const a=o.coordinates[0];return this.calculateLineStringTextPosition(a,t,e,r,n,i)}return null}calculateLineStringTextPosition(t,e,r,n,i,o){if(t.length<2)return null;try{const s=a.lineString(t);let l;if("start"===n)l=0;else if("middle"===n)l=.5;else if("end"===n)l=1;else if("number"==typeof n)if(this.usePercentage)l=Math.max(0,Math.min(1,n));else{const t=a.length(s,{units:"kilometers"});l=Math.max(0,Math.min(1,n/t))}else l=.5;const c=a.along(s,l*a.length(s,{units:"kilometers"}),{units:"kilometers"}).geometry.coordinates,h=this.projection?this.projection(c):null;if(!h)return null;let u=0;return"along"===this.placement?u=this.calculateLineRotation(t,l):"perpendicular"===this.placement&&(u=this.calculateLineRotation(t,l)+90),u+=this.rotateFunction(e,r),{feature:e,featureIndex:r,positionIndex:o,text:String(i),x:h[0],y:h[1],dx:this.dxFunction(e,r),dy:this.dyFunction(e,r),rotation:u,fontFamily:this.fontFamilyFunction(e,r),fontSize:this.fontSizeFunction(e,r),fontWeight:this.fontWeightFunction(e,r)}}catch(t){return console.warn("LineTextLayer: テキスト位置の計算でエラーが発生しました:",t),null}}calculateLineRotation(t,e){if(t.length<2)return 0;try{const r=a.lineString(t),n=a.length(r,{units:"kilometers"}),i=.001,o=Math.max(0,e-i),s=Math.min(1,e+i),l=a.along(r,o*n,{units:"kilometers"}),c=a.along(r,s*n,{units:"kilometers"}),h=l.geometry.coordinates,u=c.geometry.coordinates,d=this.projection?this.projection(h):null,p=this.projection?this.projection(u):null;if(!d||!p)return 0;const f=p[0]-d[0],g=p[1]-d[1];return 180*Math.atan2(g,f)/Math.PI}catch(t){return console.warn("LineTextLayer: 回転角度の計算でエラーが発生しました:",t),0}}getData(){return this.data}},t.Map=class{constructor(t){if(this.width=t.width,this.height=t.height,this.container=e.select(t.container),this.container.empty())throw new Error(`Container not found: ${t.container}`);this.container.selectAll("svg.thematika-map").remove(),this.svg=this.container.append("svg").attr("width","100%").attr("height","100%").attr("class","thematika-map").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("preserveAspectRatio","xMidYMid meet"),this.initializeDefs(t.defs),this.svg.append("rect").attr("width","100%").attr("height","100%").attr("fill",t.backgroundColor||"#ffffff").attr("class","thematika-background"),this.svgGroup=this.svg.append("g").attr("class","thematika-main-group"),this.projection=t.projection,this.layerManager=new s,this.layerManager.setContext(this.svgGroup,this.projection)}addLayer(t,e){this.layerManager.addLayer(t,e)}removeLayer(t){this.layerManager.removeLayer(t)}setLayerVisibility(t,e){this.layerManager.setLayerVisibility(t,e)}setLayerZIndex(t,e){this.layerManager.setLayerZIndex(t,e)}setProjection(t){this.projection=t,this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}resize(t,e){this.width=t,this.height=e,this.svg.attr("width",t).attr("height",e),this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}fitBounds(t,e=20){const[[r,n],[i,o]]=this.projection.invert?[this.projection([t[0],t[3]]),this.projection([t[2],t[1]])]:[[0,0],[this.width,this.height]],a=Math.min((this.width-2*e)/Math.abs(i-r),(this.height-2*e)/Math.abs(o-n)),s=[this.width/2-a*(r+i)/2,this.height/2-a*(n+o)/2];this.projection.scale(a).translate(s),this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}clearAllLayers(){this.layerManager.clearAllLayers()}getSVG(){return this.svg.node()}getProjection(){return this.projection}getLayerManager(){return this.layerManager}getSize(){return[this.width,this.height]}getLayerIds(){return this.layerManager.getLayerIds()}initializeDefs(t){t&&t.forEach(t=>{this.svg.call(t)})}},t.OutlineLayer=class extends l{constructor(t={}){super(`outline-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,{fill:"none",stroke:"#333333",strokeWidth:1,opacity:1,...t.attr},t.style||{}),this.createClipPath=t.createClipPath??!1,this.clipPathId=t.clipPathId||`outline-clip-${this.id}`}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderOutline())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderOutline()}renderOutline(){if(!this.layerGroup||!this.path)return;const t={type:"Sphere"},r=this.path(t);if(this.createClipPath&&r){const t=this.layerGroup.node()?.closest("svg");if(t){const n=e.select(t);n.insert("defs",":first-child").append("clipPath").attr("id",this.clipPathId).append("path").attr("d",r);const i=n.select(".thematika-main-group");i.empty()||i.attr("clip-path",this.getClipPathUrl())}}const n=this.layerGroup.append("g").attr("class","thematika-outline-layer").append("path").datum(t).attr("d",this.path).attr("class",()=>["thematika-outline",this.attr.className||""].filter(Boolean).join(" "));this.applyAllStylesToElement(n,this.layerGroup)}getClipPathId(){return this.clipPathId}getClipPathUrl(){return`url(#${this.clipPathId})`}},t.PointAnnotationLayer=class extends l{constructor(t){super(`point-annotation-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,this.annotationType=t.annotationType||"callout",this.textAccessor=t.textAccessor||this.getDefaultTextAccessor(),this.titleAccessor=t.titleAccessor,this.offsetAccessor=t.offsetAccessor,this.subjectOptions=t.subjectOptions||{},this.connectorOptions=t.connectorOptions||{},this.noteOptions=t.noteOptions||{wrap:100,align:"dynamic"}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderAnnotations()}on(t,e){this.layerGroup&&this.layerGroup.selectAll(".annotation").on(t,function(t,r){e(t,r.feature)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderAnnotations()}getData(){return this.data}getDefaultTextAccessor(){return(t,e)=>{if(t.properties)for(const[e,r]of Object.entries(t.properties))if("string"==typeof r&&r.trim())return r;return`Point ${e+1}`}}getTextValue(t,e){return"string"==typeof this.textAccessor?t.properties?.[this.textAccessor]||`Point ${e+1}`:this.textAccessor(t,e)}getTitleValue(t,e){if(this.titleAccessor)return"string"==typeof this.titleAccessor?t.properties?.[this.titleAccessor]:this.titleAccessor(t,e)}getOffsetValue(t,e){return this.offsetAccessor?this.offsetAccessor(t,e):[30,-20]}resolveStyleValue(t,e,r,n){return void 0===t?n:"function"==typeof t?t(e,r):t}getSubjectType(){if(this.subjectOptions.type)return this.subjectOptions.type;switch(this.annotationType){case"calloutCircle":case"badge":return"circle";case"calloutRect":return"rect";default:return"point"}}prepareAnnotationData(){if(!this.projection)return[];return this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=j(t);r=[e.x,e.y]}const n=this.projection(r);if(!n)return null;const[i,o]=this.getOffsetValue(t,e),a=this.getTextValue(t,e),s=this.getTitleValue(t,e);return{feature:t,index:e,x:n[0],y:n[1],text:a,title:s,dx:i,dy:o}}).filter(t=>null!==t)}renderAnnotations(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("*").remove();this.prepareAnnotationData().forEach((t,e)=>{this.drawSingleAnnotation(t,e)});const t=this.layerGroup.selectAll(".annotation");this.applyAllStylesToElement(t,this.layerGroup)}drawSingleAnnotation(t,e){const r=this.layerGroup.append("g").attr("class","annotation thematika-point-annotation").attr("transform",`translate(${t.x}, ${t.y})`);switch(this.drawSubject(r,t),this.annotationType){case"callout":case"calloutCircle":case"calloutRect":default:this.drawConnector(r,t,"line"),this.drawNote(r,t);break;case"calloutElbow":this.drawConnector(r,t,"elbow"),this.drawNote(r,t);break;case"calloutCurve":this.drawConnector(r,t,"curve"),this.drawNote(r,t);break;case"label":this.drawLabel(r,t);break;case"badge":this.drawBadgeText(r,t)}}drawSubject(t,e){const r=this.getSubjectType(),n=e.feature,i=e.index,o=this.resolveStyleValue(this.subjectOptions.fill,n,i,"#e74c3c"),a=this.resolveStyleValue(this.subjectOptions.stroke,n,i,"white"),s=this.resolveStyleValue(this.subjectOptions.strokeWidth,n,i,1),l=this.resolveStyleValue(this.subjectOptions.strokeDasharray,n,i,"none");switch(r){case"point":this.drawPointSubject(t,e,{fill:o,stroke:a,strokeWidth:s,strokeDasharray:l});break;case"circle":this.drawCircleSubject(t,e,{fill:o,stroke:a,strokeWidth:s,strokeDasharray:l});break;case"rect":this.drawRectSubject(t,e,{fill:o,stroke:a,strokeWidth:s,strokeDasharray:l})}}drawPointSubject(t,e,r){const n=this.resolveStyleValue(this.subjectOptions.r,e.feature,e.index,3);t.append("circle").attr("class","annotation-subject").attr("r",n).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawCircleSubject(t,e,r){const n=this.resolveStyleValue(this.subjectOptions.r,e.feature,e.index,this.subjectOptions.radius||8);t.append("circle").attr("class","annotation-subject").attr("r",n).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawRectSubject(t,e,r){const n=this.resolveStyleValue(this.subjectOptions.width,e.feature,e.index,16),i=this.resolveStyleValue(this.subjectOptions.height,e.feature,e.index,16);t.append("rect").attr("class","annotation-subject").attr("x",-n/2).attr("y",-i/2).attr("width",n).attr("height",i).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawConnector(t,e,r){const n=this.resolveStyleValue(this.connectorOptions.stroke,e.feature,e.index,"#666"),i=this.resolveStyleValue(this.connectorOptions.strokeWidth,e.feature,e.index,1),o=this.resolveStyleValue(this.connectorOptions.strokeDasharray,e.feature,e.index,"none");switch(r){case"line":t.append("line").attr("class","annotation-connector").attr("x1",0).attr("y1",0).attr("x2",e.dx).attr("y2",e.dy).attr("stroke",n).attr("stroke-width",i).attr("stroke-dasharray",o);break;case"elbow":const r=`M 0,0 L ${e.dx,e.dx},${e.dy>0?0:e.dy} L ${e.dx},${e.dy}`;t.append("path").attr("class","annotation-connector").attr("d",r).attr("fill","none").attr("stroke",n).attr("stroke-width",i).attr("stroke-dasharray",o);break;case"curve":const a=`M 0,0 Q ${.5*e.dx},${0} ${e.dx},${e.dy}`;t.append("path").attr("class","annotation-connector").attr("d",a).attr("fill","none").attr("stroke",n).attr("stroke-width",i).attr("stroke-dasharray",o)}}drawLabel(t,e){t.append("text").attr("class","annotation-note-text").attr("x",0).attr("y",e.dy).attr("text-anchor","middle").attr("dominant-baseline","central").style("font-size",this.noteOptions.fontSize||"12px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("fill",this.noteOptions.textColor||"black").html(e.text)}drawBadgeText(t,e){t.append("text").attr("class","annotation-badge-text").attr("text-anchor","middle").attr("dominant-baseline","central").style("font-size",this.noteOptions.fontSize||"10px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("font-weight","bold").style("fill",this.noteOptions.textColor||"white").html(e.text.substring(0,3))}drawNote(t,e){const r=this.noteOptions.padding||4,n=t.append("rect").attr("class","annotation-note-bg").attr("fill",this.noteOptions.backgroundColor||"white").attr("stroke",this.noteOptions.borderColor||"#ccc").attr("stroke-width",this.noteOptions.borderWidth||1).attr("rx",this.noteOptions.borderRadius||2),i=t.append("text").attr("class","annotation-note-text").attr("x",e.dx).attr("y",e.dy).attr("text-anchor",this.getTextAnchor(e.dx)).attr("dominant-baseline",this.getBaseline(e.dy)).style("font-size",this.noteOptions.fontSize||"12px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("fill",this.noteOptions.textColor||"black");e.title?(i.append("tspan").attr("x",e.dx).attr("dy",0).style("font-weight","bold").html(e.title),i.append("tspan").attr("x",e.dx).attr("dy","1.2em").html(e.text)):i.html(e.text),setTimeout(()=>{const t=i.node()?.getBBox();t&&n.attr("x",t.x-r).attr("y",t.y-r).attr("width",t.width+2*r).attr("height",t.height+2*r)},0)}getTextAnchor(t){return t>0?"start":t<0?"end":"middle"}getBaseline(t){return t>0?"hanging":t<0?"alphabetic":"central"}},t.PointCircleLayer=class extends l{constructor(t){if(super(`point-circle-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,"function"==typeof t.r)this.radiusFunction=t.r;else{const e=t.r||5;this.radiusFunction=()=>e}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderCircles()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("circle").on(t,function(t,r){e(t,r)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderCircles()}renderCircles(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-circle-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=j(t);r=[e.x,e.y]}const n=this.projection(r);return{feature:t,index:e,x:n?n[0]:0,y:n?n[1]:0,r:this.radiusFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y),e=this.layerGroup.append("g").attr("class","thematika-point-circle-layer").selectAll("circle").data(t).enter().append("circle").attr("cx",t=>t.x).attr("cy",t=>t.y).attr("r",t=>t.r).attr("class",t=>["thematika-point-circle",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(e,this.layerGroup)}getData(){return this.data}},t.PointSpikeLayer=class extends l{constructor(t){if(super(`point-spike-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,"function"==typeof t.length)this.lengthFunction=t.length;else{const e=t.length||50;this.lengthFunction=()=>e}this.direction=t.direction||"up"}render(t){this.layerGroup=this.createLayerGroup(t),this.renderSpikes()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("path").on(t,function(t,r){e(t,r)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderSpikes()}renderSpikes(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-spike-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=j(t);r=[e.x,e.y]}const n=this.projection(r);return{feature:t,index:e,x:n?n[0]:0,y:n?n[1]:0,length:this.lengthFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y),e=this.layerGroup.append("g").attr("class","thematika-point-spike-layer").selectAll("path").data(t).enter().append("path").attr("transform",t=>`translate(${t.x},${t.y})`).attr("d",t=>this.generateSpikePath(t.length)).attr("class",t=>["thematika-point-spike",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(e,this.layerGroup)}generateSpikePath(t){const e=.2*t;switch(this.direction){case"up":default:return`M 0,0 L ${-e/2},0 L 0,${-t} L ${e/2},0 Z`;case"down":return`M 0,0 L ${-e/2},0 L 0,${t} L ${e/2},0 Z`;case"left":return`M 0,0 L 0,${-e/2} L ${-t},0 L 0,${e/2} Z`;case"right":return`M 0,0 L 0,${-e/2} L ${t},0 L 0,${e/2} Z`}}getData(){return this.data}},t.PointTextLayer=class extends l{constructor(t){if(super(`point-text-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,this.textProperty=t.textProperty||"text","function"==typeof t.dx)this.dxFunction=t.dx;else{const e=t.dx||0;this.dxFunction=()=>e}if("function"==typeof t.dy)this.dyFunction=t.dy;else{const e=t.dy||0;this.dyFunction=()=>e}if("function"==typeof t.rotate)this.rotateFunction=t.rotate;else{const e=t.rotate||0;this.rotateFunction=()=>e}if(this.lengthAdjust=t.lengthAdjust||"spacing",this.alignmentBaseline=t.alignmentBaseline||"middle",this.textAnchor=t.textAnchor||"start","function"==typeof t.fontFamily)this.fontFamilyFunction=t.fontFamily;else{const e=t.fontFamily||"メイリオ, Meiryo, 'ＭＳ Ｐゴシック', MS Gothic, sans-serif";this.fontFamilyFunction=()=>e}if("function"==typeof t.fontSize)this.fontSizeFunction=t.fontSize;else{const e=t.fontSize||16;this.fontSizeFunction=()=>e}if("function"==typeof t.fontWeight)this.fontWeightFunction=t.fontWeight;else{const e=t.fontWeight||"normal";this.fontWeightFunction=()=>e}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderTexts()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("text").on(t,function(t,r){e(t,r)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderTexts()}renderTexts(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-text-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=j(t);r=[e.x,e.y]}const n=this.projection?this.projection(r):null;let i="";return t.properties&&(i=t.properties[this.textProperty]||t.properties.name||""),{feature:t,index:e,text:String(i),x:n?n[0]:0,y:n?n[1]:0,dx:this.dxFunction(t,e),dy:this.dyFunction(t,e),rotate:this.rotateFunction(t,e),fontFamily:this.fontFamilyFunction(t,e),fontSize:this.fontSizeFunction(t,e),fontWeight:this.fontWeightFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y&&""!==t.text),e=this.layerGroup.append("g").attr("class","thematika-point-text-layer").selectAll("text").data(t).enter().append("text").attr("x",t=>t.x).attr("y",t=>t.y).attr("dx",t=>t.dx).attr("dy",t=>t.dy).attr("transform",t=>0!==t.rotate?`rotate(${t.rotate}, ${t.x}, ${t.y})`:null).attr("lengthAdjust",this.lengthAdjust).attr("alignment-baseline",this.alignmentBaseline).attr("text-anchor",this.textAnchor).attr("font-family",t=>t.fontFamily).attr("font-size",t=>t.fontSize).attr("font-weight",t=>t.fontWeight).attr("class",t=>["thematika-point-text",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" ")).text(t=>t.text);this.applyAllStylesToElements(e,this.layerGroup)}getData(){return this.data}},t.TexturePresets=jt,t.calculateOptimalZoom=function(t,e,r,n={}){try{const[i,o,a,s]=t;if(!Array.isArray(t)||4!==t.length)throw new Error("boundsは[west, south, east, north]の形式で指定してください");if(!t.every(t=>isFinite(t)))throw new Error("boundsの値は有効な数値で指定してください");if(i>=a||o>=s)throw new Error("無効な境界が指定されました（west < east, south < northである必要があります）");if(!isFinite(e)||!isFinite(r)||e<=0||r<=0)throw new Error("地図のサイズは正の数値で指定してください");const l=n.minZoom??0,c=n.maxZoom??18,h=n.tileSize??256,u=a-i,d=s-o,p=(s+o)/2*Math.PI/180,f=zt*Math.cos(p)/360,g=u*f,y=d*111319.49079444444;let m=l;for(let t=l;t<=c;t++){const n=zt/(h*Math.pow(2,t));if(!(g/n<=e&&y/n<=r))break;m=t}return Math.max(l,Math.min(c,m))}catch(t){throw new Error(`最適ズームレベルの計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.chainFilters=function(t){return t.map(t=>`url(#${t})`).join(" ")},t.createBloom=dt,t.createClipPolygon=function(t){const e=e=>{const n=r.geoPath(t.projection),i=e.append("clipPath").attr("id",t.id);if("Feature"===t.polygon.type){const e=n(t.polygon);e&&i.append("path").attr("d",e)}else"FeatureCollection"===t.polygon.type&&t.polygon.features.forEach((t,e)=>{const r=n(t);r&&i.append("path").attr("d",r).attr("class",`clip-path-${e}`)})};return e.url=()=>ft(t.id),e},t.createCustomFilter=function(t,e){return r=>{r.append("g").html(`<filter id="${t}">${e}</filter>`)}},t.createDesertTexture=St,t.createDotsTexture=wt,t.createDropShadow=ut,t.createForestTexture=vt,t.createGaussianBlur=ht,t.createLinesTexture=_t,t.createMountainTexture=Mt,t.createOceanTexture=kt,t.createPathsTexture=bt,t.expandBbox=function(t,e=.1){const{width:r,height:n}=$(t),i=r*e,o=n*e;return{minX:t.minX-i,minY:t.minY-o,maxX:t.maxX+i,maxY:t.maxY+o}},t.generateTileUrls=function(t,e,r){try{const[n,i,o,a]=t;if(!Array.isArray(t)||4!==t.length)throw new Error("boundsは[west, south, east, north]の形式で指定してください");if(!t.every(t=>isFinite(t)))throw new Error("boundsの値は有効な数値で指定してください");if(n>=o||i>=a)throw new Error("無効な境界が指定されました（west < east, south < northである必要があります）");if(!(r.urlTemplate&&r.urlTemplate.includes("{x}")&&r.urlTemplate.includes("{y}")&&r.urlTemplate.includes("{z}")))throw new Error("URLテンプレートには{x}, {y}, {z}のプレースホルダーを含める必要があります");const s=r.minZoom??0,l=r.maxZoom??18,c=r.clampToBounds??!0;if(e<s||e>l)throw new Error(`ズームレベル${e}は許可範囲（${s}〜${l}）外です`);const h=Et(n,a,e),u=Et(o,i,e),d=Math.min(h.x,u.x),p=Math.max(h.x,u.x),f=Math.min(h.y,u.y),g=Math.max(h.y,u.y),y=[];for(let t=d;t<=p;t++)for(let s=f;s<=g;s++)try{const l=Lt(t,s,e);if(c){const t=l.west,e=l.east,r=l.south,s=l.north;if(e<=n||t>=o||s<=i||r>=a)continue}const h=r.urlTemplate.replace("{x}",t.toString()).replace("{y}",s.toString()).replace("{z}",e.toString());y.push({coordinate:{x:t,y:s,z:e},url:h,bounds:l})}catch(r){console.warn(`タイル(${t}, ${s}, ${e})の生成をスキップしました:`,r)}return 0===y.length&&console.warn("指定された範囲に有効なタイルが見つかりませんでした"),y}catch(t){throw new Error(`タイルURL生成に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.getBbox=function(t){const e=[];if("Feature"===t.type?e.push(...M(t.geometry)):"FeatureCollection"===t.type?t.features.forEach(t=>{e.push(...M(t.geometry))}):("coordinates"in t||"geometries"in t)&&e.push(...M(t)),0===e.length)return{minX:0,minY:0,maxX:0,maxY:0};const[r,n,i,o]=function(t){let e=1/0,r=1/0,n=-1/0,i=-1/0;for(const[o,a]of t)e=Math.min(e,o),r=Math.min(r,a),n=Math.max(n,o),i=Math.max(i,a);return[e,r,n,i]}(e);return{minX:r,minY:n,maxX:i,maxY:o}},t.getBboxCenter=function(t){return{x:(t.minX+t.maxX)/2,y:(t.minY+t.maxY)/2}},t.getBboxDimensions=$,t.getCentroid=j,t.getFilterUrl=ft,t.getResolution=function(t,e=0,r=256){try{if(!isFinite(t)||t<0)throw new Error("無効なズームレベルが指定されました");if(!isFinite(e)||e<-90||e>90)throw new Error("無効な緯度が指定されました");if(!isFinite(r)||r<=0)throw new Error("無効なタイルサイズが指定されました");const n=e*Math.PI/180,i=zt/(r*Math.pow(2,t));return i*Math.cos(n)}catch(t){throw new Error(`解像度の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.getTileBounds=Lt,t.getTileXYZ=Et,t.isValidGeoJSON=function(t){try{if(!t||"object"!=typeof t)return!1;return["Feature","FeatureCollection","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"].includes(t.type)}catch{return!1}},t.isValidTileCoordinate=function(t,e,r){if(!Number.isInteger(t)||!Number.isInteger(e)||!Number.isInteger(r))return!1;if(r<0||r>30)return!1;const n=Math.pow(2,r);return t>=0&&t<n&&e>=0&&e<n},t.logTestResult=function(t,e=!1){console.log("=== 座標変換テスト結果 ==="),console.log(`総座標数: ${t.totalCoords}`),console.log(`正常座標数: ${t.normalCoords}`),console.log(`異常座標数: ${t.abnormalCoords}`),console.log(t.summary),e&&t.abnormalCoords>0&&(console.warn("異常値の詳細:"),t.abnormalDetails.forEach((t,e)=>{console.warn(`  ${e+1}. ${t.featureName}: [${t.originalCoord}] → [${t.projectedCoord.map(t=>t.toFixed(2))}] (${t.outOfBounds.x}, ${t.outOfBounds.y})`)}))},t.merge=function(t){const e=[];return t.forEach(t=>{"Feature"===t.type?e.push(t):"FeatureCollection"===t.type?e.push(...t.features):("coordinates"in t||"geometries"in t)&&e.push({type:"Feature",properties:{},geometry:t})}),{type:"FeatureCollection",features:e}},t.mergeBbox=function(t,e){return{minX:Math.min(t.minX,e.minX),minY:Math.min(t.minY,e.minY),maxX:Math.max(t.maxX,e.maxX),maxY:Math.max(t.maxY,e.maxY)}},t.readCOG=async function(t,e={}){const{resampleMethod:r="nearest",imageIndex:n=0,samples:o=[0,1,2],pool:a,sizeLimit:s={maxWidth:512,maxHeight:512,onExceed:"resample"},outputWidth:l,outputHeight:c,bbox:h}=e,u=s.maxWidth??512,d=s.maxHeight??512,p=s.onExceed??"resample";try{const e=await i.fromUrl(t),s=await e.getImageCount();if(n>=s)throw new Error(`画像インデックス ${n} は範囲外です。利用可能なインデックス: 0-${s-1}`);const f=await e.getImage(n),g=f.getWidth(),y=f.getHeight();let m,x;try{m=f.getBoundingBox(),x=[m[0],m[1],m[2],m[3]]}catch(t){m=(await e.getImage(0)).getBoundingBox(),x=[m[0],m[1],m[2],m[3]]}let w=l??g,_=c??y,b=!1;if(w>u||_>d){if("error"===p)throw new Error(`画像サイズ（${g}x${y}）が制限（${u}x${d}）を超えています`);const t=g/y;w/_>t?(_=d,w=Math.floor(_*t)):(w=u,_=Math.floor(w/t)),b=!0}(l||c)&&(b=!0);const k={samples:o,pool:a,interleave:!0};if(h){const[t,e,r,n]=h,[i,o,a,s]=m,l=Math.floor((t-i)/(a-i)*g),c=Math.ceil((r-i)/(a-i)*g),u=Math.floor((s-n)/(s-o)*y),d=Math.ceil((s-e)/(s-o)*y);k.window=[Math.max(0,l),Math.max(0,u),Math.min(g,c),Math.min(y,d)],w=k.window[2]-k.window[0],_=k.window[3]-k.window[1];const p=i+k.window[0]/g*(a-i),f=i+k.window[2]/g*(a-i),b=s-k.window[1]/y*(s-o);x=[p,s-k.window[3]/y*(s-o),f,b]}if(b||w>u||_>d){const t=w/_;(w>u||_>d)&&(w/_>t?(_=d,w=Math.floor(_*t)):(w=u,_=Math.floor(w/t)),b=!0),k.width=w,k.height=_,k.resampleMethod=r}let v,S,M;try{v=await f.readRGB(k),S=v.width,M=v.height}catch(t){if(v=await f.readRasters(k),S=v.width,M=v.height,Array.isArray(v)){const t=Math.min(3,v.length),e=S*M,r=new Uint8Array(3*e);for(let n=0;n<e;n++){for(let e=0;e<t;e++)r[3*n+e]=v[e][n]||0;for(let e=t;e<3;e++)r[3*n+e]=0}v=r}}const j=document.createElement("canvas");j.width=S,j.height=M;const $=j.getContext("2d");if(!$)throw new Error("Canvas contextの取得に失敗しました");const z=$.createImageData(S,M),E=z.data,L=v,A=S*M;for(let t=0;t<A;t++){const e=4*t,r=3*t;if(r+2<L.length)E[e]=L[r]||0,E[e+1]=L[r+1]||0,E[e+2]=L[r+2]||0;else{const r=L[t]||0;E[e]=r,E[e+1]=r,E[e+2]=r}E[e+3]=255}$.putImageData(z,0,0);return{dataUri:j.toDataURL("image/png"),bounds:x,width:S,height:M,originalWidth:g,originalHeight:y,wasResampled:b}}catch(t){throw new Error(`COGの読み込みに失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.testProjectionBounds=function(t,e){try{let r=1/0,n=-1/0,i=1/0,o=-1/0;e.features.forEach(e=>{$t(e.geometry,"",t,0,0,t=>{const[e,a]=t;r=Math.min(r,e),n=Math.max(n,e),i=Math.min(i,a),o=Math.max(o,a)})});const a=[[r,i],[n,i],[n,o],[r,o]],s=a.map(e=>t(e)).filter(t=>null!==t);return s.length===a.length?{isValid:!0,message:"✅ 投影法の境界設定は正常です"}:{isValid:!1,message:`⚠️ 投影法で変換できない座標があります (${a.length-s.length}個)`}}catch(t){return{isValid:!1,message:`❌ 境界テスト中にエラーが発生しました: ${t instanceof Error?t.message:"Unknown error"}`}}},t.testProjectionTransform=function(t,e,r,n){let i=0,o=0;const a=[];n.features.forEach(n=>{const s=n.properties?.name||`Feature ${n.id||"unknown"}`;$t(n.geometry,s,r,t,e,(t,e,r,n,s)=>{const l=r([t[0],t[1]]);l&&(i++,(l[0]<0||l[0]>n||l[1]<0||l[1]>s)&&(o++,a.push({featureName:e,originalCoord:[t[0],t[1]],projectedCoord:[l[0],l[1]],outOfBounds:{x:l[0]<0?"x < 0":l[0]>n?`x > ${n}`:"x OK",y:l[1]<0?"y < 0":l[1]>s?`y > ${s}`:"y OK"}})))})});const s=0===o;return{totalCoords:i,normalCoords:i-o,abnormalCoords:o,abnormalDetails:a,isValid:s,summary:s?`✅ すべての座標が正常範囲内です (0-${t} × 0-${e})`:`⚠️ ${o}個の座標が範囲外です`}},t.textures=xt});
//# sourceMappingURL=thematika.umd.js.map
