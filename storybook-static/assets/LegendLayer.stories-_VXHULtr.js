import{B as rt,c as nt,M as at,G as it}from"./story-helpers-DJRNUMPK.js";import{select as I,pointer as U}from"d3-selection";import{P as E}from"./point-circle-layer-B8uqri2T.js";import*as ot from"d3-geo";import{i as st,b as lt,l as H,s as ct,a as ut,o as pt}from"./Blues-CiT2pB3o.js";import"./gis-utils-Dz9V2CcG.js";function K(){var i=[.5],t=[0,1],e,n=1;function r(a){return a!=null&&a<=a?t[lt(i,a,0,n)]:e}return r.domain=function(a){return arguments.length?(i=Array.from(a),n=Math.min(i.length,t.length-1),r):i.slice()},r.range=function(a){return arguments.length?(t=Array.from(a),n=Math.min(i.length,t.length-1),r):t.slice()},r.invertExtent=function(a){var s=t.indexOf(a);return[i[s-1],i[s]]},r.unknown=function(a){return arguments.length?(e=a,r):e},r.copy=function(){return K().domain(i).range(t).unknown(e)},st.apply(r,arguments)}var dt={value:()=>{}};function J(){for(var i=0,t=arguments.length,e={},n;i<t;++i){if(!(n=arguments[i]+"")||n in e||/[\s.]/.test(n))throw new Error("illegal type: "+n);e[n]=[]}return new Y(e)}function Y(i){this._=i}function ht(i,t){return i.trim().split(/^|\s+/).map(function(e){var n="",r=e.indexOf(".");if(r>=0&&(n=e.slice(r+1),e=e.slice(0,r)),e&&!t.hasOwnProperty(e))throw new Error("unknown type: "+e);return{type:e,name:n}})}Y.prototype=J.prototype={constructor:Y,on:function(i,t){var e=this._,n=ht(i+"",e),r,a=-1,s=n.length;if(arguments.length<2){for(;++a<s;)if((r=(i=n[a]).type)&&(r=gt(e[r],i.name)))return r;return}if(t!=null&&typeof t!="function")throw new Error("invalid callback: "+t);for(;++a<s;)if(r=(i=n[a]).type)e[r]=Q(e[r],i.name,t);else if(t==null)for(r in e)e[r]=Q(e[r],i.name,null);return this},copy:function(){var i={},t=this._;for(var e in t)i[e]=t[e].slice();return new Y(i)},call:function(i,t){if((r=arguments.length-2)>0)for(var e=new Array(r),n=0,r,a;n<r;++n)e[n]=arguments[n+2];if(!this._.hasOwnProperty(i))throw new Error("unknown type: "+i);for(a=this._[i],n=0,r=a.length;n<r;++n)a[n].value.apply(t,e)},apply:function(i,t,e){if(!this._.hasOwnProperty(i))throw new Error("unknown type: "+i);for(var n=this._[i],r=0,a=n.length;r<a;++r)n[r].value.apply(t,e)}};function gt(i,t){for(var e=0,n=i.length,r;e<n;++e)if((r=i[e]).name===t)return r.value}function Q(i,t,e){for(var n=0,r=i.length;n<r;++n)if(i[n].name===t){i[n]=dt,i=i.slice(0,n).concat(i.slice(n+1));break}return e!=null&&i.push({name:t,value:e}),i}const ft={passive:!1},G={capture:!0,passive:!1};function W(i){i.stopImmediatePropagation()}function T(i){i.preventDefault(),i.stopImmediatePropagation()}function yt(i){var t=i.document.documentElement,e=I(i).on("dragstart.drag",T,G);"onselectstart"in t?e.on("selectstart.drag",T,G):(t.__noselect=t.style.MozUserSelect,t.style.MozUserSelect="none")}function mt(i,t){var e=i.document.documentElement,n=I(i).on("dragstart.drag",null);t&&(n.on("click.drag",T,G),setTimeout(function(){n.on("click.drag",null)},0)),"onselectstart"in e?n.on("selectstart.drag",null):(e.style.MozUserSelect=e.__noselect,delete e.__noselect)}const C=i=>()=>i;function X(i,{sourceEvent:t,subject:e,target:n,identifier:r,active:a,x:s,y:p,dx:u,dy:h,dispatch:m}){Object.defineProperties(this,{type:{value:i,enumerable:!0,configurable:!0},sourceEvent:{value:t,enumerable:!0,configurable:!0},subject:{value:e,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},identifier:{value:r,enumerable:!0,configurable:!0},active:{value:a,enumerable:!0,configurable:!0},x:{value:s,enumerable:!0,configurable:!0},y:{value:p,enumerable:!0,configurable:!0},dx:{value:u,enumerable:!0,configurable:!0},dy:{value:h,enumerable:!0,configurable:!0},_:{value:m}})}X.prototype.on=function(){var i=this._.on.apply(this._,arguments);return i===this._?this:i};function bt(i){return!i.ctrlKey&&!i.button}function St(){return this.parentNode}function zt(i,t){return t??{x:i.x,y:i.y}}function kt(){return navigator.maxTouchPoints||"ontouchstart"in this}function xt(){var i=bt,t=St,e=zt,n=kt,r={},a=J("start","drag","end"),s=0,p,u,h,m,g=0;function c(o){o.on("mousedown.drag",l).filter(n).on("touchstart.drag",z).on("touchmove.drag",L,ft).on("touchend.drag touchcancel.drag",Z).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function l(o,y){if(!(m||!i.call(this,o,y))){var b=A(this,t.call(this,o,y),o,y,"mouse");b&&(I(o.view).on("mousemove.drag",d,G).on("mouseup.drag",f,G),yt(o.view),W(o),h=!1,p=o.clientX,u=o.clientY,b("start",o))}}function d(o){if(T(o),!h){var y=o.clientX-p,b=o.clientY-u;h=y*y+b*b>g}r.mouse("drag",o)}function f(o){I(o.view).on("mousemove.drag mouseup.drag",null),mt(o.view,h),T(o),r.mouse("end",o)}function z(o,y){if(i.call(this,o,y)){var b=o.changedTouches,S=t.call(this,o,y),k=b.length,w,v;for(w=0;w<k;++w)(v=A(this,S,o,y,b[w].identifier,b[w]))&&(W(o),v("start",o,b[w]))}}function L(o){var y=o.changedTouches,b=y.length,S,k;for(S=0;S<b;++S)(k=r[y[S].identifier])&&(T(o),k("drag",o,y[S]))}function Z(o){var y=o.changedTouches,b=y.length,S,k;for(m&&clearTimeout(m),m=setTimeout(function(){m=null},500),S=0;S<b;++S)(k=r[y[S].identifier])&&(W(o),k("end",o,y[S]))}function A(o,y,b,S,k,w){var v=a.copy(),x=U(w||b,y),_,j,B;if((B=e.call(o,new X("beforestart",{sourceEvent:b,target:c,identifier:k,active:s,x:x[0],y:x[1],dx:0,dy:0,dispatch:v}),S))!=null)return _=B.x-x[0]||0,j=B.y-x[1]||0,function tt(V,D,et){var N=x,F;switch(V){case"start":r[k]=tt,F=s++;break;case"end":delete r[k],--s;case"drag":x=U(et||D,y),F=s;break}v.call(V,o,new X(V,{sourceEvent:D,subject:B,target:c,identifier:k,active:F,x:x[0]+_,y:x[1]+j,dx:x[0]-N[0],dy:x[1]-N[1],dispatch:v}),S)}}return c.filter=function(o){return arguments.length?(i=typeof o=="function"?o:C(!!o),c):i},c.container=function(o){return arguments.length?(t=typeof o=="function"?o:C(o),c):t},c.subject=function(o){return arguments.length?(e=typeof o=="function"?o:C(o),c):e},c.touchable=function(o){return arguments.length?(n=typeof o=="function"?o:C(!!o),c):n},c.on=function(){var o=a.on.apply(a,arguments);return o===a?c:o},c.clickDistance=function(o){return arguments.length?(g=(o=+o)*o,c):Math.sqrt(g)},c}class wt extends rt{constructor(t){super(`legend-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.scale=t.scale,this.position=t.position,this.title=t.title,this.orientation=t.orientation||"vertical",this.itemSpacing=t.itemSpacing||20,this.fontSize=t.fontSize||12,this.width=t.width,this.height=t.height,this.symbolType=t.symbolType||this.inferSymbolType(),this.symbolSize=t.symbolSize||{fixed:16},this.sizeScale=t.sizeScale,this.gradientSteps=t.gradientSteps||256,this.enableDrag=t.enableDrag!==!1,this.showBackground=t.showBackground!==!1,this.overlapping=t.overlapping||!1,this.backgroundStyle={fill:"#ffffff",stroke:"#cccccc",strokeWidth:1,opacity:.9,rx:4,ry:4,padding:8,...t.backgroundStyle}}inferSymbolType(){switch(this.detectScaleType()){case"continuous":return"gradient";case"quantized":case"ordinal":default:return"cell"}}hasSizeScale(){return!!this.sizeScale}render(t){this.parentContainer=t,this.layerGroup=this.createLayerGroup(t),this.renderLegend(),this.renderBackground(),this.updatePositionTransform(),this.enableDrag&&this.setupDragBehavior(),this.setupResizeListener()}detectScaleType(){const t=this.scale;return typeof t.invertExtent=="function"?"quantized":typeof t.ticks=="function"?"continuous":"ordinal"}isColorValue(t){return typeof t!="string"?!1:!!(/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(t)||/^rgba?\(/.test(t)||/^hsla?\(/.test(t)||/^(red|green|blue|black|white|yellow|cyan|magenta|gray|grey|orange|purple|brown|pink)$/i.test(t))}generateLegendData(){const t=this.detectScaleType();switch(t){case"continuous":return this.generateContinuousLegend();case"quantized":return this.generateQuantizedLegend();case"ordinal":return this.generateOrdinalLegend();default:throw new Error(`Unsupported scale type: ${t}`)}}generateContinuousLegend(){const t=this.scale,e=t.domain(),n=t.ticks?t.ticks(5):e;return{data:n,labels:n.map(r=>r.toString()),colors:n.map(r=>t(r))}}generateQuantizedLegend(){const t=this.scale,e=t.range(),n=e.length>0&&typeof e[0]=="number",r={data:e,labels:e.map(a=>{const s=t.invertExtent(a);return s[0]!=null&&s[1]!=null?`${s[0]} - ${s[1]}`:a.toString()}),colors:n?e.map(()=>"#0066cc"):e};return n&&(r.sizes=e),r}generateOrdinalLegend(){const t=this.scale,e=t.domain(),n=t.range(),r=n.length>0&&typeof n[0]=="number",a={data:e,labels:e.map(s=>s.toString()),colors:r?e.map(()=>"#0066cc"):e.map(s=>t(s))};return r&&(a.sizes=e.map(s=>t(s))),a}generateSizeScaleLegendData(){if(!this.sizeScale)throw new Error("Size scale is not defined");const t=this.sizeScale,e=t.domain(),n=t.range(),r=this.scale;return{data:e,labels:e.map(a=>a.toString()),colors:e.map(()=>{if(typeof r=="function")try{const a=r.domain();return r(a[0])||"#0066cc"}catch{return"#0066cc"}return"#0066cc"}),sizes:n}}renderLegend(){if(this.layerGroup)if(this.title&&this.renderTitle(),this.hasSizeScale())this.renderSizeScaleLegend();else switch(this.symbolType){case"cell":this.renderCellLegend();break;case"circle":this.renderCircleLegend();break;case"line":this.renderLineLegend();break;case"gradient":this.renderGradientLegend();break;default:throw new Error(`Unsupported symbol type: ${this.symbolType}`)}}renderTitle(){!this.layerGroup||!this.title||this.layerGroup.append("text").attr("class","thematika-legend-title").attr("x",0).attr("y",0).style("font-size",`${this.fontSize+2}px`).style("font-weight","bold").style("fill","#333").text(this.title)}renderCellLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,n=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),r=this.symbolSize.fixed||16;n.append("rect").attr("x",0).attr("y",0).attr("width",r).attr("height",r).attr("fill",(a,s)=>t.colors[s]).attr("stroke","#333").attr("stroke-width",.5),n.append("text").attr("x",r+4).attr("y",r/2).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((a,s)=>t.labels[s]),this.positionItems(n,e,t.sizes)}renderCircleLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,n=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),r=(this.symbolSize.fixed||16)/2;n.append("circle").attr("cx",r).attr("cy",r).attr("r",r).attr("fill",(a,s)=>t.colors[s]).attr("stroke","#333").attr("stroke-width",.5),n.append("text").attr("x",r*2+4).attr("y",r).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((a,s)=>t.labels[s]),this.positionItems(n,e,t.sizes)}renderLineLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,n=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),r=this.symbolSize.fixed||24;n.append("line").attr("x1",0).attr("y1",8).attr("x2",r).attr("y2",8).attr("stroke",(s,p)=>t.colors[p]).attr("stroke-width",2),n.append("text").attr("x",r+4).attr("y",8).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((s,p)=>t.labels[p]),this.positionItems(n,e,t.sizes)}renderGradientLegend(){if(!this.layerGroup)return;const t=this.scale,e=t.domain(),n=`gradient-${this.id}`,a=this.layerGroup.append("defs").append("linearGradient").attr("id",n).attr("x1","0%").attr("y1","0%").attr("x2",this.orientation==="horizontal"?"100%":"0%").attr("y2",this.orientation==="horizontal"?"0%":"100%"),s=this.gradientSteps;for(let c=0;c<=s;c++){const l=c/s,d=e[0]+l*(e[1]-e[0]);a.append("stop").attr("offset",`${l*100}%`).attr("stop-color",t(d))}const p=this.title?this.fontSize+10:0,u=this.width||200,h=this.height||20;this.layerGroup.append("rect").attr("x",0).attr("y",p).attr("width",this.orientation==="horizontal"?u:h).attr("height",this.orientation==="horizontal"?h:u).attr("fill",`url(#${n})`).attr("stroke","#333").attr("stroke-width",.5);const m=t.ticks?t.ticks(5):e,g=this.layerGroup.append("g").attr("transform",`translate(0, ${p})`);m.forEach((c,l)=>{const d=(c-e[0])/(e[1]-e[0]);g.append("text").attr("x",this.orientation==="horizontal"?d*u:h+4).attr("y",this.orientation==="horizontal"?h+16:d*u).attr("text-anchor",this.orientation==="horizontal"?"middle":"start").style("font-size",`${this.fontSize}px`).style("fill","#333").text(c.toString())})}renderSizeScaleLegend(){if(!this.layerGroup)return;const t=this.generateSizeScaleLegendData(),e=this.title?this.fontSize+10:0;this.overlapping?this.renderOverlappingSizeScale(t,e):this.renderRegularSizeScale(t,e)}renderOverlappingSizeScale(t,e){if(!this.layerGroup||!t.sizes||t.sizes.length===0)return;const n=Math.max(...t.sizes);switch(this.symbolType){case"circle":this.renderOverlappingCircles(t,e,n);break;case"cell":this.renderOverlappingCells(t,e,n);break;case"line":this.renderOverlappingLines(t,e,n);break;default:this.renderOverlappingCircles(t,e,n);break}}renderOverlappingCircles(t,e,n){if(!this.layerGroup||!t.sizes)return;const r=n,a=r,s=e+r*2,p=t.data.map((l,d)=>({data:l,label:t.labels[d],color:t.colors[d],size:t.sizes[d]})).sort((l,d)=>d.size-l.size),u=this.layerGroup.append("g").attr("class","thematika-legend-symbols");p.forEach((l,d)=>{const f=s-l.size;u.append("circle").attr("cx",a).attr("cy",f).attr("r",l.size).attr("fill","none").attr("stroke","#333").attr("stroke-width",1)});const h=this.layerGroup.append("g").attr("class","thematika-legend-guidelines"),m=a+r+20,g=m-4;p.forEach((l,d)=>{const z=s-l.size-l.size,L=a;h.append("line").attr("x1",L).attr("y1",z).attr("x2",g).attr("y2",z).attr("stroke","#333").attr("stroke-width",1).attr("stroke-dasharray","3,3")});const c=this.layerGroup.append("g").attr("class","thematika-legend-labels");p.forEach((l,d)=>{const z=s-l.size-l.size;c.append("text").attr("x",m).attr("y",z).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(l.label)})}renderOverlappingCells(t,e,n){if(!this.layerGroup||!t.sizes)return;const r=Math.sqrt(n),a=r/2,s=e+r,p=t.data.map((l,d)=>({data:l,label:t.labels[d],color:t.colors[d],size:t.sizes[d]})).sort((l,d)=>d.size-l.size),u=this.layerGroup.append("g").attr("class","thematika-legend-symbols");p.forEach((l,d)=>{const f=Math.sqrt(l.size),z=s-f;u.append("rect").attr("x",a-f/2).attr("y",z).attr("width",f).attr("height",f).attr("fill","none").attr("stroke","#333").attr("stroke-width",1)});const h=this.layerGroup.append("g").attr("class","thematika-legend-guidelines"),m=a+r/2+20,g=m-4;p.forEach((l,d)=>{const f=Math.sqrt(l.size),z=s-f,L=a;h.append("line").attr("x1",L).attr("y1",z).attr("x2",g).attr("y2",z).attr("stroke","#333").attr("stroke-width",1).attr("stroke-dasharray","3,3")});const c=this.layerGroup.append("g").attr("class","thematika-legend-labels");p.forEach((l,d)=>{const f=Math.sqrt(l.size),z=s-f;c.append("text").attr("x",m).attr("y",z).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(l.label)})}renderOverlappingLines(t,e,n){if(!this.layerGroup||!t.sizes)return;const r=30,a=e+n/2+10,s=t.data.map((g,c)=>({data:g,label:t.labels[c],color:t.colors[c],size:t.sizes[c]})).sort((g,c)=>c.size-g.size),p=this.layerGroup.append("g").attr("class","thematika-legend-symbols");s.forEach((g,c)=>{p.append("line").attr("x1",0).attr("y1",a).attr("x2",r).attr("y2",a).attr("stroke",g.color).attr("stroke-width",g.size).attr("opacity",.8)});const u=this.layerGroup.append("g").attr("class","thematika-legend-labels"),h=r+10,m=this.fontSize+4;s.forEach((g,c)=>{u.append("text").attr("x",h).attr("y",a-n/2+c*m+this.fontSize).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(g.label)})}renderRegularSizeScale(t,e){if(!this.layerGroup||!t.sizes)return;const n=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item");switch(this.symbolType){case"circle":this.renderRegularSizeCircles(n,t,e);break;case"cell":this.renderRegularSizeCells(n,t,e);break;case"line":this.renderRegularSizeLines(n,t,e);break;default:this.renderRegularSizeCircles(n,t,e);break}}renderRegularSizeCircles(t,e,n){e.sizes&&(t.append("circle").attr("cx",(r,a)=>e.sizes[a]).attr("cy",(r,a)=>e.sizes[a]).attr("r",(r,a)=>e.sizes[a]).attr("fill",(r,a)=>e.colors[a]).attr("stroke","#333").attr("stroke-width",.5),t.append("text").attr("x",(r,a)=>e.sizes[a]*2+4).attr("y",(r,a)=>this.orientation==="horizontal"?0:e.sizes[a]).attr("dy",(r,a)=>this.orientation==="horizontal"?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((r,a)=>e.labels[a]),this.positionItems(t,n,e.sizes))}renderRegularSizeCells(t,e,n){e.sizes&&(t.append("rect").attr("x",0).attr("y",0).attr("width",(r,a)=>Math.sqrt(e.sizes[a])).attr("height",(r,a)=>Math.sqrt(e.sizes[a])).attr("fill",(r,a)=>e.colors[a]).attr("stroke","#333").attr("stroke-width",.5),t.append("text").attr("x",(r,a)=>Math.sqrt(e.sizes[a])+4).attr("y",(r,a)=>this.orientation==="horizontal"?0:Math.sqrt(e.sizes[a])/2).attr("dy",(r,a)=>this.orientation==="horizontal"?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((r,a)=>e.labels[a]),this.positionItems(t,n,e.sizes))}renderRegularSizeLines(t,e,n){if(!e.sizes)return;const r=24;t.append("line").attr("x1",0).attr("y1",8).attr("x2",r).attr("y2",8).attr("stroke",(a,s)=>e.colors[s]).attr("stroke-width",(a,s)=>e.sizes[s]),t.append("text").attr("x",r+4).attr("y",(a,s)=>this.orientation==="horizontal"?0:8).attr("dy",(a,s)=>this.orientation==="horizontal"?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((a,s)=>e.labels[s]),this.positionItems(t,n,e.sizes)}positionItems(t,e,n){if(this.orientation==="vertical")t.attr("transform",(r,a)=>`translate(0, ${e+a*this.itemSpacing})`);else if(n&&this.hasSizeScale()){const r=Math.max(...n);t.attr("transform",(a,s)=>{const p=n[s];let u=0;return this.symbolType==="circle"?u=r-p:this.symbolType==="cell"&&(u=Math.sqrt(r)-Math.sqrt(p)),`translate(${s*this.itemSpacing}, ${e+u})`})}else t.attr("transform",(r,a)=>`translate(${a*this.itemSpacing}, ${e})`)}renderBackground(){if(!this.layerGroup)return;const t=this.calculateLegendBounds(),e=this.backgroundStyle.padding||8,n=this.showBackground?this.backgroundStyle.opacity||.9:0,r=this.layerGroup.insert("rect",":first-child").attr("class","thematika-legend-background").attr("x",t.x-e).attr("y",t.y-e).attr("width",t.width+e*2).attr("height",t.height+e*2).attr("fill",this.backgroundStyle.fill||"#ffffff").attr("stroke",this.backgroundStyle.stroke||"#cccccc").attr("stroke-width",this.backgroundStyle.strokeWidth||1).attr("opacity",n);this.backgroundStyle.rx&&r.attr("rx",this.backgroundStyle.rx),this.backgroundStyle.ry&&r.attr("ry",this.backgroundStyle.ry)}calculateLegendBounds(){if(!this.layerGroup)return{x:0,y:0,width:100,height:50};try{const t=this.layerGroup.node().getBBox();return{x:t.x,y:t.y,width:t.width,height:t.height}}catch{const e=this.generateLegendData().data.length,n=this.title?this.fontSize+10:0;return this.orientation==="vertical"?{x:0,y:0,width:150,height:n+e*this.itemSpacing}:{x:0,y:0,width:e*100,height:n+30}}}updatePositionTransform(){if(!this.layerGroup)return;const t=this.position.left,e=this.position.top;this.layerGroup.attr("transform",`translate(${t}, ${e})`)}setupDragBehavior(){if(!this.layerGroup)return;const t=xt().on("start",()=>{this.layerGroup&&this.layerGroup.style("cursor","grabbing")}).on("drag",e=>{this.position.left+=e.dx,this.position.top+=e.dy,this.updatePositionTransform(),this.updateSliders()}).on("end",()=>{this.layerGroup&&this.layerGroup.style("cursor","grab")});this.layerGroup.style("cursor","grab").call(t)}updateSliders(){if(typeof window<"u"&&typeof document<"u"){const t=document.getElementById("legend-x-slider"),e=document.getElementById("legend-y-slider"),n=document.getElementById("legend-x-value"),r=document.getElementById("legend-y-value");t&&e&&n&&r&&(t.value=this.position.left.toString(),e.value=this.position.top.toString(),n.textContent=this.position.left.toString(),r.textContent=this.position.top.toString())}}updateBackgroundOpacity(){if(!this.layerGroup)return;const t=this.layerGroup.select(".thematika-legend-background");if(!t.empty()){const e=this.showBackground?this.backgroundStyle.opacity||.9:0;t.attr("opacity",e)}}updateBackgroundStyles(){if(!this.layerGroup)return;const t=this.layerGroup.select(".thematika-legend-background");if(!t.empty()){const e=this.showBackground?this.backgroundStyle.opacity||.9:0;t.attr("fill",this.backgroundStyle.fill||"#ffffff").attr("stroke",this.backgroundStyle.stroke||"#cccccc").attr("stroke-width",this.backgroundStyle.strokeWidth||1).attr("opacity",e).attr("rx",this.backgroundStyle.rx||null).attr("ry",this.backgroundStyle.ry||null)}}setupResizeListener(){}}const Ct={title:"Layers/LegendLayer",tags:["autodocs"],parameters:{docs:{description:{component:"D3スケールから凡例を自動生成して表示するレイヤー。カテゴリ、連続値、閾値、サイズスケールに対応し、ドラッグ機能も提供します。"}}},argTypes:{scaleType:{control:{type:"select"},options:["ordinal","sequential","threshold","size"],description:"スケールの種類",defaultValue:"ordinal"},symbolType:{control:{type:"select"},options:["cell","circle","line","gradient"],description:"シンボルの表現タイプ",defaultValue:"cell"},orientation:{control:{type:"radio"},options:["vertical","horizontal"],description:"配置の向き",defaultValue:"vertical"},position:{control:{type:"select"},options:["top-left","top-right","bottom-left","bottom-right"],description:"凡例の位置",defaultValue:"top-right"},showBackground:{control:{type:"boolean"},description:"背景ボックスを表示",defaultValue:!0},enableDrag:{control:{type:"boolean"},description:"ドラッグ機能を有効",defaultValue:!0},title:{control:{type:"text"},description:"凡例のタイトル",defaultValue:"凡例"},fontSize:{control:{type:"range",min:8,max:20,step:2},description:"フォントサイズ",defaultValue:12},itemSpacing:{control:{type:"range",min:10,max:40,step:5},description:"アイテム間のスペース",defaultValue:20},showMap:{control:{type:"boolean"},description:"地図データも表示",defaultValue:!0},overlapping:{control:{type:"boolean"},description:"重ね表示モード（サイズスケール用）",defaultValue:!1}}};function vt(i,t,e){switch(i){case"top-left":return{top:20,left:20};case"top-right":return{top:20,left:t-200};case"bottom-left":return{top:e-200,left:20};case"bottom-right":return{top:e-200,left:t-200};default:return{top:20,left:t-200}}}function Tt(){return{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[139.6917,35.6895]},properties:{name:"東京",category:"首都",population:1396e4,size:10}},{type:"Feature",geometry:{type:"Point",coordinates:[135.5023,34.6937]},properties:{name:"大阪",category:"大都市",population:2691e3,size:8}},{type:"Feature",geometry:{type:"Point",coordinates:[-74.006,40.7128]},properties:{name:"NYC",category:"大都市",population:8336e3,size:9}},{type:"Feature",geometry:{type:"Point",coordinates:[-.1276,51.5074]},properties:{name:"ロンドン",category:"首都",population:8982e3,size:9}},{type:"Feature",geometry:{type:"Point",coordinates:[2.3522,48.8566]},properties:{name:"パリ",category:"首都",population:2161e3,size:7}},{type:"Feature",geometry:{type:"Point",coordinates:[116.4074,39.9042]},properties:{name:"北京",category:"首都",population:2154e4,size:12}}]}}function M(i){const t=nt(),e=800,n=500,r=ot.geoNaturalEarth1().scale(120).translate([e/2,n/2]),a=new at({container:"#map",width:e,height:n,projection:r,backgroundColor:"#f0f8ff"}),s=new it({step:[30,30],attr:{fill:"none",stroke:"#eee",strokeWidth:.5,strokeDasharray:"2,2",opacity:.7}});a.addLayer("graticule",s);const p=Tt();let u,h=null;switch(i.scaleType){case"ordinal":u=pt().domain(["首都","大都市"]).range(["#ff6b6b","#4ecdc4"]),i.showMap&&(h=new E({data:p,r:8,attr:{fill:f=>u(f.properties.category),stroke:"#333",strokeWidth:1}}));break;case"sequential":u=ct(ut[9]).domain([0,25e6]),i.showMap&&(h=new E({data:p,r:8,attr:{fill:f=>u(f.properties.population),stroke:"#333",strokeWidth:1}}));break;case"threshold":u=K().domain([5e6,1e7,2e7]).range(["#fee5d9","#fcae91","#fb6a4a","#cb181d"]),i.showMap&&(h=new E({data:p,r:8,attr:{fill:f=>u(f.properties.population),stroke:"#333",strokeWidth:1}}));break;case"size":u=H().domain([5,15]).range([0,1]);const d=H().domain([5,15]).range([4,16]);i.showMap&&(h=new E({data:p,r:f=>d(f.properties.size),attr:{fill:"#3498db",stroke:"#2980b9",strokeWidth:1}})),u.sizeScale=d;break}h&&a.addLayer("data",h);const m=vt(i.position,e,n),g={scale:u,position:m,title:i.title,orientation:i.orientation,symbolType:i.symbolType,fontSize:i.fontSize,itemSpacing:i.itemSpacing,showBackground:i.showBackground,enableDrag:i.enableDrag,overlapping:i.overlapping};i.scaleType==="size"&&u.sizeScale&&(g.sizeScale=u.sizeScale,g.symbolType="circle");const c=new wt(g);a.addLayer("legend",c);const l=document.createElement("div");return l.innerHTML=`
    <p><strong>凡例レイヤーデモ</strong></p>
    <p>スケール: ${i.scaleType}</p>
    <p>シンボル: ${i.symbolType}</p>
    <p>向き: ${i.orientation}</p>
    ${i.enableDrag?'<p style="color: blue;">💡 凡例はドラッグで移動できます</p>':""}
  `,l.style.position="absolute",l.style.top="10px",l.style.left="10px",l.style.background="rgba(255,255,255,0.9)",l.style.padding="10px",l.style.borderRadius="4px",l.style.fontSize="12px",l.style.pointerEvents="none",t.appendChild(l),t}const $={args:{scaleType:"ordinal",symbolType:"cell",orientation:"vertical",position:"top-right",showBackground:!0,enableDrag:!0,title:"カテゴリ",fontSize:12,itemSpacing:20,showMap:!0,overlapping:!1},render:M},O={args:{scaleType:"sequential",symbolType:"gradient",orientation:"vertical",position:"top-right",showBackground:!0,enableDrag:!0,title:"人口（百万人）",fontSize:12,itemSpacing:20,showMap:!0,overlapping:!1},render:M},q={args:{scaleType:"threshold",symbolType:"cell",orientation:"horizontal",position:"bottom-left",showBackground:!0,enableDrag:!0,title:"人口規模",fontSize:10,itemSpacing:15,showMap:!0,overlapping:!1},render:M},P={args:{scaleType:"size",symbolType:"circle",orientation:"vertical",position:"top-left",showBackground:!0,enableDrag:!0,title:"サイズ",fontSize:12,itemSpacing:25,showMap:!0,overlapping:!1},render:M},R={args:{scaleType:"size",symbolType:"circle",orientation:"vertical",position:"bottom-right",showBackground:!1,enableDrag:!1,title:"サイズ（重ね表示）",fontSize:11,itemSpacing:30,showMap:!1,overlapping:!0},render:M};$.parameters={...$.parameters,docs:{...$.parameters?.docs,source:{originalSource:`{
  args: {
    scaleType: 'ordinal',
    symbolType: 'cell',
    orientation: 'vertical',
    position: 'top-right',
    showBackground: true,
    enableDrag: true,
    title: 'カテゴリ',
    fontSize: 12,
    itemSpacing: 20,
    showMap: true,
    overlapping: false
  },
  render: createLegendStory
}`,...$.parameters?.docs?.source}}};O.parameters={...O.parameters,docs:{...O.parameters?.docs,source:{originalSource:`{
  args: {
    scaleType: 'sequential',
    symbolType: 'gradient',
    orientation: 'vertical',
    position: 'top-right',
    showBackground: true,
    enableDrag: true,
    title: '人口（百万人）',
    fontSize: 12,
    itemSpacing: 20,
    showMap: true,
    overlapping: false
  },
  render: createLegendStory
}`,...O.parameters?.docs?.source}}};q.parameters={...q.parameters,docs:{...q.parameters?.docs,source:{originalSource:`{
  args: {
    scaleType: 'threshold',
    symbolType: 'cell',
    orientation: 'horizontal',
    position: 'bottom-left',
    showBackground: true,
    enableDrag: true,
    title: '人口規模',
    fontSize: 10,
    itemSpacing: 15,
    showMap: true,
    overlapping: false
  },
  render: createLegendStory
}`,...q.parameters?.docs?.source}}};P.parameters={...P.parameters,docs:{...P.parameters?.docs,source:{originalSource:`{
  args: {
    scaleType: 'size',
    symbolType: 'circle',
    orientation: 'vertical',
    position: 'top-left',
    showBackground: true,
    enableDrag: true,
    title: 'サイズ',
    fontSize: 12,
    itemSpacing: 25,
    showMap: true,
    overlapping: false
  },
  render: createLegendStory
}`,...P.parameters?.docs?.source}}};R.parameters={...R.parameters,docs:{...R.parameters?.docs,source:{originalSource:`{
  args: {
    scaleType: 'size',
    symbolType: 'circle',
    orientation: 'vertical',
    position: 'bottom-right',
    showBackground: false,
    enableDrag: false,
    title: 'サイズ（重ね表示）',
    fontSize: 11,
    itemSpacing: 30,
    showMap: false,
    overlapping: true
  },
  render: createLegendStory
}`,...R.parameters?.docs?.source}}};const $t=["OrdinalScale","SequentialScale","ThresholdScale","SizeScale","SizeScaleOverlapping"];export{$ as OrdinalScale,O as SequentialScale,P as SizeScale,R as SizeScaleOverlapping,q as ThresholdScale,$t as __namedExportsOrder,Ct as default};
