import{select as l}from"d3-selection";import{geoPath as c,geoGraticule as y}from"d3-geo";class p{constructor(){this.layerInstances=new Map}setContext(e,t){this.svgContainer=e,this.projection=t}addLayer(e,t){if(!this.svgContainer)throw new Error("SVG container not set. Call setContext() first.");this.projection&&this.isGeojsonLayer(t)&&t.setProjection(this.projection),t.zIndex=this.getNextZIndex(),t.render(this.svgContainer),this.layerInstances.set(e,t)}removeLayer(e){const t=this.layerInstances.get(e);t&&(t.destroy(),this.layerInstances.delete(e))}setLayerVisibility(e,t){const r=this.layerInstances.get(e);r&&r.setVisible(t)}setLayerZIndex(e,t){const r=this.layerInstances.get(e);if(r){const s=r.zIndex;r.setZIndex(t),s!==t&&this.reorderLayersOptimized()}}getLayer(e){return this.layerInstances.get(e)}getLayerIds(){return Array.from(this.layerInstances.keys())}clearAllLayers(){this.layerInstances.forEach(e=>e.destroy()),this.layerInstances.clear()}rerenderAllLayers(){this.svgContainer&&Array.from(this.layerInstances.values()).sort((t,r)=>t.zIndex-r.zIndex).forEach(t=>{t.destroy(),this.projection&&this.isGeojsonLayer(t)&&t.setProjection(this.projection),t.render(this.svgContainer)})}reorderLayersOptimized(){const e=[];if(Array.from(this.layerInstances.values()).filter(r=>r.isRendered()).forEach(r=>{const s=this.getLayerElement(r);s&&e.push({element:s,zIndex:r.zIndex})}),e.length===0)return;e.sort((r,s)=>r.zIndex-s.zIndex);const t=e[0].element.parentNode;t&&e.forEach(({element:r})=>{t.appendChild(r)})}updateProjection(e){this.projection=e,this.layerInstances.forEach(t=>{this.isGeojsonLayer(t)&&t.setProjection(e)})}getNextZIndex(){return this.layerInstances.size===0?0:Math.max(...Array.from(this.layerInstances.values()).map(t=>t.zIndex))+1}isGeojsonLayer(e){return"setProjection"in e}getLayerElement(e){if("element"in e)return e.element}}let f=class{constructor(e){if(this.width=e.width,this.height=e.height,this.container=l(e.container),this.container.empty())throw new Error(`Container not found: ${e.container}`);this.container.selectAll("svg.thematika-map").remove(),this.svg=this.container.append("svg").attr("width","100%").attr("height","100%").attr("class","thematika-map").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("preserveAspectRatio","xMidYMid meet"),this.initializeDefs(e.defs),this.svg.append("rect").attr("width","100%").attr("height","100%").attr("fill",e.backgroundColor||"#ffffff").attr("class","thematika-background"),this.svgGroup=this.svg.append("g").attr("class","thematika-main-group"),this.projection=e.projection,this.layerManager=new p,this.layerManager.setContext(this.svgGroup,this.projection)}addLayer(e,t){this.layerManager.addLayer(e,t)}removeLayer(e){this.layerManager.removeLayer(e)}setLayerVisibility(e,t){this.layerManager.setLayerVisibility(e,t)}setLayerZIndex(e,t){this.layerManager.setLayerZIndex(e,t)}setProjection(e){this.projection=e,this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}resize(e,t){this.width=e,this.height=t,this.svg.attr("width",e).attr("height",t),this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}fitBounds(e,t=20){const[[r,s],[i,n]]=this.projection.invert?[this.projection([e[0],e[3]]),this.projection([e[2],e[1]])]:[[0,0],[this.width,this.height]],o=Math.min((this.width-t*2)/Math.abs(i-r),(this.height-t*2)/Math.abs(n-s)),h=[this.width/2-o*(r+i)/2,this.height/2-o*(s+n)/2];this.projection.scale(o).translate(h),this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}clearAllLayers(){this.layerManager.clearAllLayers()}getSVG(){return this.svg.node()}getProjection(){return this.projection}getLayerManager(){return this.layerManager}getSize(){return[this.width,this.height]}getLayerIds(){return this.layerManager.getLayerIds()}initializeDefs(e){e&&e.forEach(t=>{this.svg.call(t)})}};class d{constructor(e,t={},r){this.visible=!0,this.zIndex=0,this.id=e,this.attr={fill:"#cccccc",stroke:"#333333",strokeWidth:.5,opacity:1,...t},this.style=r}destroy(){this.element&&(this.element.remove(),this.element=void 0)}setVisible(e){this.visible=e,this.updateVisibility()}setZIndex(e){this.zIndex=e}isRendered(){return this.element!==void 0}getLayerGroup(){return this.element?l(this.element):null}updateVisibility(){if(!this.element)return;l(this.element).style("display",this.visible?"":"none")}createLayerGroup(e){const t=e.append("g").attr("class",`thematika-layer thematika-layer--${this.id}`).style("display",this.visible?"":"none");return this.element=t.node(),t}applyAttributesToElement(e,t){Object.entries(this.attr).forEach(([r,s])=>{if(s!==void 0){const i=typeof s=="function"?s({},0):s;t.attr(r,i)}})}applyStylesToElement(e,t){this.style&&Object.entries(this.style).forEach(([r,s])=>{if(s!==void 0){const i=typeof s=="function"?s({},0):s;t.style(r,i)}})}applyAllStylesToElement(e,t){this.applyAttributesToElement(e,t),this.applyStylesToElement(e,t)}applyAttributesToElements(e,t){Object.entries(this.attr).forEach(([r,s])=>{s!==void 0&&(typeof s=="function"?e.attr(r,(i,n)=>s(i,n)):t.attr(r,s))})}applyStylesToElements(e,t){this.style&&Object.entries(this.style).forEach(([r,s])=>{s!==void 0&&(typeof s=="function"?e.style(r,(i,n)=>s(i,n)):t.style(r,s))})}applyAllStylesToElements(e,t){this.applyAttributesToElements(e,t),this.applyStylesToElements(e,t)}}class j extends d{constructor(e={}){const t={fill:"none",stroke:"#cccccc",strokeWidth:.5,opacity:.7};super(`graticule-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,{...t,...e.attr||{}},e.style||{}),this.step=e.step||[10,10],this.extent=e.extent}setProjection(e){this.path=c(e),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderGraticule())}render(e){this.layerGroup=this.createLayerGroup(e),this.renderGraticule()}renderGraticule(){if(!this.layerGroup||!this.path)return;const e=y().step(this.step);this.extent&&e.extent(this.extent);const t=e(),r=this.layerGroup.append("g").attr("class","thematika-graticule-layer").append("path").datum(t).attr("d",this.path).attr("class",()=>{const s="thematika-graticule",i=this.attr.className||"";return[s,i].filter(Boolean).join(" ")});this.applyAllStylesToElement(r,this.layerGroup)}}function I(a=800,e=500){const t=document.createElement("div");t.className="story-container";const r=document.createElement("div");return r.id="map",r.style.width=`${a}px`,r.style.height=`${e}px`,t.appendChild(r),t}function L(a=10){const e=[];for(let t=0;t<a;t++)e.push({type:"Feature",properties:{name:`Point ${t+1}`,value:Math.random()*100,category:t%3===0?"A":t%3===1?"B":"C"},geometry:{type:"Point",coordinates:[-180+Math.random()*360,-90+Math.random()*180]}});return{type:"FeatureCollection",features:e}}async function v(){try{return await(await fetch("./geojson/world.geojson")).json()}catch{return console.warn("World data not found, using sample data"),g()}}function g(){return{type:"FeatureCollection",features:[{type:"Feature",properties:{name:"Sample Region 1",value:75},geometry:{type:"Polygon",coordinates:[[[-120,40],[-100,40],[-100,20],[-120,20],[-120,40]]]}},{type:"Feature",properties:{name:"Sample Region 2",value:50},geometry:{type:"Polygon",coordinates:[[[-80,45],[-60,45],[-60,25],[-80,25],[-80,45]]]}},{type:"Feature",properties:{name:"Sample Region 3",value:25},geometry:{type:"Polygon",coordinates:[[[10,50],[30,50],[30,30],[10,30],[10,50]]]}}]}}export{d as B,j as G,f as M,L as a,I as c,g,v as l};
