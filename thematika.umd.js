!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-geo"),require("d3-shape"),require("d3-force"),require("geotiff")):"function"==typeof define&&define.amd?define(["exports","d3-selection","d3-geo","d3-shape","d3-force","geotiff"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Thematika={},t.d3,t.d3,t.d3,t.d3,t.GeoTIFF)}(this,function(t,e,r,a,n,i){"use strict";class o{constructor(){this.layerInstances=new Map}setContext(t,e){this.svgContainer=t,this.projection=e}addLayer(t,e){if(!this.svgContainer)throw new Error("SVG container not set. Call setContext() first.");this.projection&&this.isGeojsonLayer(e)&&e.setProjection(this.projection),e.zIndex=this.getNextZIndex(),e.render(this.svgContainer),this.layerInstances.set(t,e)}removeLayer(t){const e=this.layerInstances.get(t);e&&(e.destroy(),this.layerInstances.delete(t))}setLayerVisibility(t,e){const r=this.layerInstances.get(t);r&&r.setVisible(e)}setLayerZIndex(t,e){const r=this.layerInstances.get(t);if(r){const t=r.zIndex;r.setZIndex(e),t!==e&&this.reorderLayersOptimized()}}getLayer(t){return this.layerInstances.get(t)}getLayerIds(){return Array.from(this.layerInstances.keys())}clearAllLayers(){this.layerInstances.forEach(t=>t.destroy()),this.layerInstances.clear()}rerenderAllLayers(){if(this.svgContainer){Array.from(this.layerInstances.values()).sort((t,e)=>t.zIndex-e.zIndex).forEach(t=>{t.destroy(),this.projection&&this.isGeojsonLayer(t)&&t.setProjection(this.projection),t.render(this.svgContainer)})}}reorderLayersOptimized(){const t=[];if(Array.from(this.layerInstances.values()).filter(t=>t.isRendered()).forEach(e=>{const r=this.getLayerElement(e);r&&t.push({element:r,zIndex:e.zIndex})}),0===t.length)return;t.sort((t,e)=>t.zIndex-e.zIndex);const e=t[0].element.parentNode;e&&t.forEach(({element:t})=>{e.appendChild(t)})}updateProjection(t){this.projection=t,this.layerInstances.forEach(e=>{this.isGeojsonLayer(e)&&e.setProjection(t)})}getNextZIndex(){if(0===this.layerInstances.size)return 0;return Math.max(...Array.from(this.layerInstances.values()).map(t=>t.zIndex))+1}isGeojsonLayer(t){return"setProjection"in t}getLayerElement(t){if("element"in t)return t.element}}class s{constructor(t,e={},r){this.visible=!0,this.zIndex=0,this.id=t,this.attr={fill:"#cccccc",stroke:"#333333",strokeWidth:.5,opacity:1,...e},this.style=r}destroy(){this.element&&(this.element.remove(),this.element=void 0)}setVisible(t){this.visible=t,this.updateVisibility()}setZIndex(t){this.zIndex=t}isRendered(){return void 0!==this.element}getLayerGroup(){return this.element?e.select(this.element):null}updateVisibility(){if(!this.element)return;e.select(this.element).style("display",this.visible?"":"none")}createLayerGroup(t){const e=t.append("g").attr("class",`thematika-layer thematika-layer--${this.id}`).style("display",this.visible?"":"none");return this.element=e.node(),e}applyAttributesToElement(t,e){Object.entries(this.attr).forEach(([t,r])=>{if(void 0!==r){const a="function"==typeof r?r({},0):r;e.attr(t,a)}})}applyStylesToElement(t,e){this.style&&Object.entries(this.style).forEach(([t,r])=>{if(void 0!==r){const a="function"==typeof r?r({},0):r;e.style(t,a)}})}applyAllStylesToElement(t,e){this.applyAttributesToElement(t,e),this.applyStylesToElement(t,e)}applyAttributesToElements(t,e){Object.entries(this.attr).forEach(([r,a])=>{void 0!==a&&("function"==typeof a?t.attr(r,(t,e)=>a(t,e)):e.attr(r,a))})}applyStylesToElements(t,e){this.style&&Object.entries(this.style).forEach(([r,a])=>{void 0!==a&&("function"==typeof a?t.style(r,(t,e)=>a(t,e)):e.style(r,a))})}applyAllStylesToElements(t,e){this.applyAttributesToElements(t,e),this.applyStylesToElements(t,e)}}var l={value:()=>{}};function c(){for(var t,e=0,r=arguments.length,a={};e<r;++e){if(!(t=arguments[e]+"")||t in a||/[\s.]/.test(t))throw new Error("illegal type: "+t);a[t]=[]}return new h(a)}function h(t){this._=t}function d(t,e){for(var r,a=0,n=t.length;a<n;++a)if((r=t[a]).name===e)return r.value}function u(t,e,r){for(var a=0,n=t.length;a<n;++a)if(t[a].name===e){t[a]=l,t=t.slice(0,a).concat(t.slice(a+1));break}return null!=r&&t.push({name:e,value:r}),t}h.prototype=c.prototype={constructor:h,on:function(t,e){var r,a,n=this._,i=(a=n,(t+"").trim().split(/^|\s+/).map(function(t){var e="",r=t.indexOf(".");if(r>=0&&(e=t.slice(r+1),t=t.slice(0,r)),t&&!a.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:e}})),o=-1,s=i.length;if(!(arguments.length<2)){if(null!=e&&"function"!=typeof e)throw new Error("invalid callback: "+e);for(;++o<s;)if(r=(t=i[o]).type)n[r]=u(n[r],t.name,e);else if(null==e)for(r in n)n[r]=u(n[r],t.name,null);return this}for(;++o<s;)if((r=(t=i[o]).type)&&(r=d(n[r],t.name)))return r},copy:function(){var t={},e=this._;for(var r in e)t[r]=e[r].slice();return new h(t)},call:function(t,e){if((r=arguments.length-2)>0)for(var r,a,n=new Array(r),i=0;i<r;++i)n[i]=arguments[i+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(i=0,r=(a=this._[t]).length;i<r;++i)a[i].value.apply(e,n)},apply:function(t,e,r){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var a=this._[t],n=0,i=a.length;n<i;++n)a[n].value.apply(e,r)}};const p={passive:!1},f={capture:!0,passive:!1};function y(t){t.stopImmediatePropagation()}function g(t){t.preventDefault(),t.stopImmediatePropagation()}var m=t=>()=>t;function x(t,{sourceEvent:e,subject:r,target:a,identifier:n,active:i,x:o,y:s,dx:l,dy:c,dispatch:h}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},subject:{value:r,enumerable:!0,configurable:!0},target:{value:a,enumerable:!0,configurable:!0},identifier:{value:n,enumerable:!0,configurable:!0},active:{value:i,enumerable:!0,configurable:!0},x:{value:o,enumerable:!0,configurable:!0},y:{value:s,enumerable:!0,configurable:!0},dx:{value:l,enumerable:!0,configurable:!0},dy:{value:c,enumerable:!0,configurable:!0},_:{value:h}})}function w(t){return!t.ctrlKey&&!t.button}function b(){return this.parentNode}function S(t,e){return null==e?{x:t.x,y:t.y}:e}function k(){return navigator.maxTouchPoints||"ontouchstart"in this}function v(){var t,r,a,n,i=w,o=b,s=S,l=k,h={},d=c("start","drag","end"),u=0,v=0;function M(t){t.on("mousedown.drag",L).filter(l).on("touchstart.drag",A).on("touchmove.drag",$,p).on("touchend.drag touchcancel.drag",z).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function L(s,l){if(!n&&i.call(this,s,l)){var c,h,d,u=B(this,o.call(this,s,l),s,l,"mouse");if(u)e.select(s.view).on("mousemove.drag",C,f).on("mouseup.drag",E,f),c=s.view,h=c.document.documentElement,d=e.select(c).on("dragstart.drag",g,f),"onselectstart"in h?d.on("selectstart.drag",g,f):(h.__noselect=h.style.MozUserSelect,h.style.MozUserSelect="none"),y(s),a=!1,t=s.clientX,r=s.clientY,u("start",s)}}function C(e){if(g(e),!a){var n=e.clientX-t,i=e.clientY-r;a=n*n+i*i>v}h.mouse("drag",e)}function E(t){var r,n,i,o;e.select(t.view).on("mousemove.drag mouseup.drag",null),r=t.view,n=a,i=r.document.documentElement,o=e.select(r).on("dragstart.drag",null),n&&(o.on("click.drag",g,f),setTimeout(function(){o.on("click.drag",null)},0)),"onselectstart"in i?o.on("selectstart.drag",null):(i.style.MozUserSelect=i.__noselect,delete i.__noselect),g(t),h.mouse("end",t)}function A(t,e){if(i.call(this,t,e)){var r,a,n=t.changedTouches,s=o.call(this,t,e),l=n.length;for(r=0;r<l;++r)(a=B(this,s,t,e,n[r].identifier,n[r]))&&(y(t),a("start",t,n[r]))}}function $(t){var e,r,a=t.changedTouches,n=a.length;for(e=0;e<n;++e)(r=h[a[e].identifier])&&(g(t),r("drag",t,a[e]))}function z(t){var e,r,a=t.changedTouches,i=a.length;for(n&&clearTimeout(n),n=setTimeout(function(){n=null},500),e=0;e<i;++e)(r=h[a[e].identifier])&&(y(t),r("end",t,a[e]))}function B(t,r,a,n,i,o){var l,c,p,f=d.copy(),y=e.pointer(o||a,r);if(null!=(p=s.call(t,new x("beforestart",{sourceEvent:a,target:M,identifier:i,active:u,x:y[0],y:y[1],dx:0,dy:0,dispatch:f}),n)))return l=p.x-y[0]||0,c=p.y-y[1]||0,function a(o,s,d){var g,m=y;switch(o){case"start":h[i]=a,g=u++;break;case"end":delete h[i],--u;case"drag":y=e.pointer(d||s,r),g=u}f.call(o,t,new x(o,{sourceEvent:s,subject:p,target:M,identifier:i,active:g,x:y[0]+l,y:y[1]+c,dx:y[0]-m[0],dy:y[1]-m[1],dispatch:f}),n)}}return M.filter=function(t){return arguments.length?(i="function"==typeof t?t:m(!!t),M):i},M.container=function(t){return arguments.length?(o="function"==typeof t?t:m(t),M):o},M.subject=function(t){return arguments.length?(s="function"==typeof t?t:m(t),M):s},M.touchable=function(t){return arguments.length?(l="function"==typeof t?t:m(!!t),M):l},M.on=function(){var t=d.on.apply(d,arguments);return t===d?M:t},M.clickDistance=function(t){return arguments.length?(v=(t=+t)*t,M):Math.sqrt(v)},M}x.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};function M(t){const e=[];switch(t.type){case"Point":e.push(t.coordinates);break;case"LineString":case"MultiPoint":e.push(...t.coordinates);break;case"Polygon":t.coordinates.forEach(t=>e.push(...t));break;case"MultiLineString":t.coordinates.forEach(t=>e.push(...t));break;case"MultiPolygon":t.coordinates.forEach(t=>t.forEach(t=>e.push(...t)));break;case"GeometryCollection":t.geometries.forEach(t=>e.push(...M(t)))}return e}function L(t){const e=[];if("Feature"===t.type?e.push(...M(t.geometry)):"FeatureCollection"===t.type?t.features.forEach(t=>{e.push(...M(t.geometry))}):("coordinates"in t||"geometries"in t)&&e.push(...M(t)),0===e.length)return{x:0,y:0};let r=0,a=0;for(const[t,n]of e)r+=t,a+=n;return{x:r/e.length,y:a/e.length}}function C(t){return{width:t.maxX-t.minX,height:t.maxY-t.minY}}function E(t){const e=e=>{const r=e.append("filter").attr("id",t.id);t.x&&r.attr("x",t.x),t.y&&r.attr("y",t.y),t.width&&r.attr("width",t.width),t.height&&r.attr("height",t.height),r.append("feGaussianBlur").attr("stdDeviation",t.stdDeviation)};return e.url=()=>B(t.id),e}function A(t){const e=e=>{const r=e.append("defs").append("filter").attr("id",t.id).append("feDropShadow").attr("dx",t.dx).attr("dy",t.dy).attr("stdDeviation",t.stdDeviation);t.floodColor&&r.attr("flood-color",t.floodColor),void 0!==t.floodOpacity&&r.attr("flood-opacity",t.floodOpacity)};return e.url=()=>B(t.id),e}function $(t){const e=e=>{const r=e.append("defs").append("filter").attr("id",t.id).attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%");if(void 0!==t.threshold){const e=[.2126,.7152,.0722,0,t.threshold,.2126,.7152,.0722,0,t.threshold,.2126,.7152,.0722,0,t.threshold,0,0,0,1,0].join(" ");r.append("feColorMatrix").attr("values",e).attr("result","bright")}r.append("feGaussianBlur").attr("in",void 0!==t.threshold?"bright":"SourceGraphic").attr("stdDeviation",t.intensity).attr("result","bloom"),t.color&&(r.append("feFlood").attr("flood-color",t.color).attr("result","color"),r.append("feComposite").attr("in","color").attr("in2","bloom").attr("operator","in").attr("result","coloredBloom")),r.append("feMerge").selectAll("feMergeNode").data(["SourceGraphic",t.color?"coloredBloom":"bloom"]).enter().append("feMergeNode").attr("in",t=>t)};return e.url=()=>B(t.id),e}const z={lightBlur:()=>E({id:"lightBlur",stdDeviation:2}),strongBlur:()=>E({id:"strongBlur",stdDeviation:8}),standardDropShadow:()=>A({id:"standardDropShadow",dx:3,dy:3,stdDeviation:2,floodColor:"#000000",floodOpacity:.3}),softDropShadow:()=>A({id:"softDropShadow",dx:2,dy:2,stdDeviation:4,floodColor:"#000000",floodOpacity:.2}),standardBloom:()=>$({id:"standardBloom",intensity:4,threshold:.8}),strongBloom:()=>$({id:"strongBloom",intensity:8,threshold:.6,color:"#ffffff"})};function B(t){return`url(#${t})`}
/*!
     * Textures.js v1.2.3 (ESM)
     * SVG patterns for Data Visualization
     * https://github.com/riccardoscalco/textures
     * 
     * Copyright (c) Riccardo Scalco
     * Licensed under the MIT License
     * 
     * Included in d3-thematika under MIT License terms
     */
function G(){return"".concat(Math.random().toString(36),"00000000000000000").replace(/[^a-z]+/g,"").slice(0,5)}function j(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,a=new Array(e);r<e;r++)a[r]=t[r];return a}function P(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return j(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?j(t,e):void 0}}(t))||e){r&&(t=r);var a=0,n=function(){};return{s:n,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw i}}}}var F={circles:function(){var t=20,e="",r=2,a=!1,n="#343434",i="#343434",o=0,s=G(),l=function(l){var c=l.append("defs").append("pattern").attr("id",s).attr("patternUnits","userSpaceOnUse").attr("width",t).attr("height",t);if(e&&c.append("rect").attr("width",t).attr("height",t).attr("fill",e),c.append("circle").attr("cx",t/2).attr("cy",t/2).attr("r",r).attr("fill",n).attr("stroke",i).attr("stroke-width",o),a)for(var h=0,d=[[0,0],[0,t],[t,0],[t,t]];h<d.length;h++){var u=d[h];c.append("circle").attr("cx",u[0]).attr("cy",u[1]).attr("r",r).attr("fill",n).attr("stroke",i).attr("stroke-width",o)}};return l.heavier=function(t){return r*=0===arguments.length?2:2*t,l},l.lighter=function(t){return r/=0===arguments.length?2:2*t,l},l.thinner=function(e){return t*=0===arguments.length?2:2*e,l},l.thicker=function(e){return t/=0===arguments.length?2:2*e,l},l.background=function(t){return e=t,l},l.size=function(e){return t=e,l},l.complement=function(t){return a=0===arguments.length||t,l},l.radius=function(t){return r=t,l},l.fill=function(t){return n=t,l},l.stroke=function(t){return i=t,l},l.strokeWidth=function(t){return o=t,l},l.id=function(t){return 0===arguments.length?s:(s=t,l)},l.url=function(){return"url(#".concat(s,")")},l},lines:function(){var t=20,e="#343434",r=2,a="",n=G(),i=["diagonal"],o="auto",s=function(e){var r=t;switch(e){case"0/8":case"vertical":default:return"M ".concat(r/2,", 0 l 0, ").concat(r);case"1/8":return"M ".concat(-r/4,",").concat(r," l ").concat(r/2,",").concat(-r," M ").concat(r/4,",").concat(r," l ").concat(r/2,",").concat(-r," M ").concat(3*r/4,",").concat(r," l ").concat(r/2,",").concat(-r);case"2/8":case"diagonal":return"M 0,".concat(r," l ").concat(r,",").concat(-r," M ").concat(-r/4,",").concat(r/4," l ").concat(r/2,",").concat(-r/2," M ").concat(3/4*r,",").concat(5/4*r," l ").concat(r/2,",").concat(-r/2);case"3/8":return"M 0,".concat(3/4*r," l ").concat(r,",").concat(-r/2," M 0,").concat(r/4," l ").concat(r,",").concat(-r/2," M 0,").concat(5*r/4," l ").concat(r,",").concat(-r/2);case"4/8":case"horizontal":return"M 0,".concat(r/2," l ").concat(r,",0");case"5/8":return"M 0,".concat(-r/4," l ").concat(r,",").concat(r/2,"M 0,").concat(r/4," l ").concat(r,",").concat(r/2," M 0,").concat(3*r/4," l ").concat(r,",").concat(r/2);case"6/8":return"M 0,0 l ".concat(r,",").concat(r," M ").concat(-r/4,",").concat(3/4*r," l ").concat(r/2,",").concat(r/2," M ").concat(3*r/4,",").concat(-r/4," l ").concat(r/2,",").concat(r/2);case"7/8":return"M ".concat(-r/4,",0 l ").concat(r/2,",").concat(r," M ").concat(r/4,",0 l ").concat(r/2,",").concat(r," M ").concat(3*r/4,",0 l ").concat(r/2,",").concat(r)}},l=function(l){var c=l.append("defs").append("pattern").attr("id",n).attr("patternUnits","userSpaceOnUse").attr("width",t).attr("height",t);a&&c.append("rect").attr("width",t).attr("height",t).attr("fill",a);var h,d=P(i);try{for(d.s();!(h=d.n()).done;){var u=h.value;c.append("path").attr("d",s(u)).attr("stroke-width",r).attr("shape-rendering",o).attr("stroke",e).attr("stroke-linecap","square")}}catch(t){d.e(t)}finally{d.f()}};return l.heavier=function(t){return r*=0===arguments.length?2:2*t,l},l.lighter=function(t){return r/=0===arguments.length?2:2*t,l},l.thinner=function(e){return t*=0===arguments.length?2:2*e,l},l.thicker=function(e){return t/=0===arguments.length?2:2*e,l},l.background=function(t){return a=t,l},l.size=function(e){return t=e,l},l.orientation=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return 0===arguments.length||(i=e),l},l.shapeRendering=function(t){return o=t,l},l.stroke=function(t){return e=t,l},l.strokeWidth=function(t){return r=t,l},l.id=function(t){return 0===arguments.length?n:(n=t,l)},l.url=function(){return"url(#".concat(n,")")},l},paths:function(){var t=1,e=1,r=20,a="#343434",n=2,i="",o=function(t){return"M ".concat(t/4,",").concat(3*t/4,"l").concat(t/4,",").concat(-t/2,"l").concat(t/4,",").concat(t/2)},s=G(),l="transparent",c="auto",h=function(h){var d=function(a){var n=r;switch(a){case"squares":return"M ".concat(n/4," ").concat(n/4," l ").concat(n/2," 0 l 0 ").concat(n/2," l ").concat(-n/2," 0 Z");case"nylon":return"M 0 ".concat(n/4," l ").concat(n/4," 0 l 0 ").concat(-n/4," M ").concat(3*n/4," ").concat(n," l 0 ").concat(-n/4," l ").concat(n/4," 0 M ").concat(n/4," ").concat(n/2," l 0 ").concat(n/4," l ").concat(n/4," 0 M ").concat(n/2," ").concat(n/4," l ").concat(n/4," 0 l 0 ").concat(n/4);case"waves":return"M 0 ".concat(n/2," c ").concat(n/8," ").concat(-n/4," , ").concat(3*n/8," ").concat(-n/4," , ").concat(n/2," 0 c ").concat(n/8," ").concat(n/4," , ").concat(3*n/8," ").concat(n/4," , ").concat(n/2," 0 M ").concat(-n/2," ").concat(n/2," c ").concat(n/8," ").concat(n/4," , ").concat(3*n/8," ").concat(n/4," , ").concat(n/2," 0 M ").concat(n," ").concat(n/2," c ").concat(n/8," ").concat(-n/4," , ").concat(3*n/8," ").concat(-n/4," , ").concat(n/2," 0");case"woven":return"M ".concat(n/4,",").concat(n/4,"l").concat(n/2,",").concat(n/2,"M").concat(3*n/4,",").concat(n/4,"l").concat(n/2,",").concat(-n/2," M").concat(n/4,",").concat(3*n/4,"l").concat(-n/2,",").concat(n/2,"M").concat(3*n/4,",").concat(5*n/4,"l").concat(n/2,",").concat(-n/2," M").concat(-n/4,",").concat(n/4,"l").concat(n/2,",").concat(-n/2);case"crosses":return"M ".concat(n/4,",").concat(n/4,"l").concat(n/2,",").concat(n/2,"M").concat(n/4,",").concat(3*n/4,"l").concat(n/2,",").concat(-n/2);case"caps":return"M ".concat(n/4,",").concat(3*n/4,"l").concat(n/4,",").concat(-n/2,"l").concat(n/4,",").concat(n/2);case"hexagons":return t=3,e=Math.sqrt(3),"M ".concat(n,",0 l ").concat(n,",0 l ").concat(n/2,",").concat(n*Math.sqrt(3)/2," l ").concat(-n/2,",").concat(n*Math.sqrt(3)/2," l ").concat(-n,",0 l ").concat(-n/2,",").concat(-n*Math.sqrt(3)/2," Z M 0,").concat(n*Math.sqrt(3)/2," l ").concat(n/2,",0 M ").concat(3*n,",").concat(n*Math.sqrt(3)/2," l ").concat(-n/2,",0");default:return a(n)}}(o),u=h.append("defs").append("pattern").attr("id",s).attr("patternUnits","userSpaceOnUse").attr("width",r*t).attr("height",r*e);i&&u.append("rect").attr("width",r*t).attr("height",r*e).attr("fill",i),u.append("path").attr("d",d).attr("fill",l).attr("stroke",a).attr("stroke-width",n).attr("stroke-linecap","square").attr("shape-rendering",c)};return h.heavier=function(t){return n*=0===arguments.length?2:2*t,h},h.lighter=function(t){return n/=0===arguments.length?2:2*t,h},h.thinner=function(t){return r*=0===arguments.length?2:2*t,h},h.thicker=function(t){return r/=0===arguments.length?2:2*t,h},h.background=function(t){return i=t,h},h.shapeRendering=function(t){return c=t,h},h.size=function(t){return r=t,h},h.d=function(t){return o=t,h},h.fill=function(t){return l=t,h},h.stroke=function(t){return a=t,h},h.strokeWidth=function(t){return n=t,h},h.id=function(t){return 0===arguments.length?s:(s=t,h)},h.url=function(){return"url(#".concat(s,")")},h}};function T(t){const e=F.circles().radius(t.radius||1).fill(t.fill||"#000").background(t.background||"#ffffff").size(t.size||4).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function D(t){const e=F.lines().orientation(...t.orientation||["diagonal"]).stroke(t.stroke||"#000").strokeWidth(t.strokeWidth||1).background(t.background||"#ffffff").size(t.size||4).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function I(t){const e=F.paths().d(t.d||"M 0,0 l 10,10 M 10,0 l -10,10").size(t.size||10).background(t.background||"#ffffff").fill(t.fill||"none").stroke(t.stroke||"#000").strokeWidth(t.strokeWidth||1).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function O(t={id:"ocean"}){const{intensity:e="medium"}=t,r={light:{size:6,strokeWidth:.5,background:"#e3f2fd"},medium:{size:4,strokeWidth:.8,background:"#bbdefb"},heavy:{size:3,strokeWidth:1.2,background:"#90caf9"}}[e];return D({id:t.id,orientation:["horizontal"],stroke:"#1976d2",strokeWidth:r.strokeWidth,background:r.background,size:r.size})}function R(t={id:"forest"}){const{density:e="medium"}=t,r={sparse:{size:8,radius:1,background:"#e8f5e8"},medium:{size:6,radius:1.5,background:"#c8e6c9"},dense:{size:4,radius:2,background:"#a5d6a7"}}[e];return T({id:t.id,radius:r.radius,fill:"#2e7d32",background:r.background,size:r.size})}function W(t={id:"desert"}){return I({id:t.id,d:"M 0,5 Q 5,0 10,5 Q 15,10 20,5",size:20,background:"#fff8e1",fill:"none",stroke:"#ff8f00",strokeWidth:.8})}function q(t={id:"mountain"}){return I({id:t.id,d:"M 0,10 L 5,0 L 10,10 Z",size:10,background:"#efebe9",fill:"#5d4037",stroke:"#3e2723",strokeWidth:.5})}const N={lightOcean:()=>O({id:"lightOcean",intensity:"light"}),standardOcean:()=>O({id:"standardOcean",intensity:"medium"}),heavyOcean:()=>O({id:"heavyOcean",intensity:"heavy"}),sparseForest:()=>R({id:"sparseForest",density:"sparse"}),standardForest:()=>R({id:"standardForest",density:"medium"}),denseForest:()=>R({id:"denseForest",density:"dense"}),desert:()=>W({id:"desert"}),mountain:()=>q({id:"mountain"}),simpleDots:()=>T({id:"simpleDots",background:"#ffffff",fill:"#000000",size:4}),simpleLines:()=>D({id:"simpleLines",background:"#ffffff",stroke:"#000000",orientation:["diagonal"]})};function V(t,e,r,a,n,i){switch(t.type){case"Point":i(t.coordinates,e,r,a,n);break;case"LineString":case"MultiPoint":t.coordinates.forEach(t=>{i(t,e,r,a,n)});break;case"Polygon":t.coordinates.forEach(t=>{t.forEach(t=>{i(t,e,r,a,n)})});break;case"MultiLineString":t.coordinates.forEach(t=>{t.forEach(t=>{i(t,e,r,a,n)})});break;case"MultiPolygon":t.coordinates.forEach(t=>{t.forEach(t=>{t.forEach(t=>{i(t,e,r,a,n)})})});break;case"GeometryCollection":t.geometries.forEach(t=>{V(t,e,r,a,n,i)})}}const U=40075016.686;function Y(t,e,r){try{if(!isFinite(t)||!isFinite(e)||!isFinite(r))throw new Error("無効な座標またはズームレベルが指定されました");if(t<-180||t>180)throw new Error(`経度は-180から180の範囲で指定してください: ${t}`);if(e<-85.051128779807||e>85.051128779807)throw new Error(`緯度はWeb Mercator投影法の有効範囲（-85.05〜85.05度）で指定してください: ${e}`);if(r<0||r>30)throw new Error(`ズームレベルは0から30の範囲で指定してください: ${r}`);const a=Math.pow(2,r),n=Math.floor((t+180)/360*a),i=e*Math.PI/180;return{x:n,y:Math.floor((1-Math.log(Math.tan(i)+1/Math.cos(i))/Math.PI)/2*a),z:r}}catch(t){throw new Error(`タイル座標の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}}function X(t,e,r){try{if(!Number.isInteger(t)||!Number.isInteger(e)||!Number.isInteger(r))throw new Error("タイル座標は整数で指定してください");if(r<0||r>30)throw new Error(`ズームレベルは0から30の範囲で指定してください: ${r}`);const a=Math.pow(2,r);if(t<0||t>=a||e<0||e>=a)throw new Error(`タイル座標がズームレベル${r}の有効範囲外です: x=${t}, y=${e}`);const n=t/a*360-180,i=(t+1)/a*360-180,o=180*Math.atan(Math.sinh(Math.PI*(1-2*e/a)))/Math.PI,s=180*Math.atan(Math.sinh(Math.PI*(1-2*(e+1)/a)))/Math.PI;return{west:n,south:s,east:i,north:o,bounds:[n,s,i,o]}}catch(t){throw new Error(`タイル境界の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}}const H={Set1:{name:"Set1",type:"categorical",colors:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],colorBlindSafe:!1,description:"鮮やかなカテゴリカルカラー（最大9クラス）",maxClasses:9},Set2:{name:"Set2",type:"categorical",colors:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],colorBlindSafe:!0,description:"パステル調カテゴリカルカラー（色覚障害対応、最大8クラス）",maxClasses:8},Set3:{name:"Set3",type:"categorical",colors:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],colorBlindSafe:!1,description:"薄い色調のカテゴリカルカラー（最大12クラス）",maxClasses:12},Blues:{name:"Blues",type:"sequential",colors:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],colorBlindSafe:!0,description:"青系連続カラー（色覚障害対応）",maxClasses:9},Greens:{name:"Greens",type:"sequential",colors:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],colorBlindSafe:!0,description:"緑系連続カラー（色覚障害対応）",maxClasses:9},Oranges:{name:"Oranges",type:"sequential",colors:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],colorBlindSafe:!0,description:"オレンジ系連続カラー（色覚障害対応）",maxClasses:9},YlOrRd:{name:"YlOrRd",type:"sequential",colors:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],colorBlindSafe:!0,description:"黄-オレンジ-赤系連続カラー（色覚障害対応）",maxClasses:9},YlGnBu:{name:"YlGnBu",type:"sequential",colors:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],colorBlindSafe:!0,description:"黄-緑-青系連続カラー（色覚障害対応）",maxClasses:9},RdYlBu:{name:"RdYlBu",type:"diverging",colors:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],colorBlindSafe:!1,description:"赤-黄-青系発散カラー",maxClasses:11},RdBu:{name:"RdBu",type:"diverging",colors:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],colorBlindSafe:!0,description:"赤-青系発散カラー（色覚障害対応）",maxClasses:11},BrBG:{name:"BrBG",type:"diverging",colors:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],colorBlindSafe:!0,description:"茶-緑系発散カラー（色覚障害対応）",maxClasses:11}},Z={Viridis:{name:"Viridis",type:"sequential",colors:["#440154","#482777","#3f4a8a","#31678e","#26838f","#1f9d8a","#6cce5a","#b6de2b","#fee825"],colorBlindSafe:!0,description:"Viridis連続カラー（知覚的均一、色覚障害対応）",maxClasses:9},Plasma:{name:"Plasma",type:"sequential",colors:["#0d0887","#46039f","#7201a8","#9c179e","#bd3786","#d8576b","#ed7953","#fb9f3a","#fdca26","#f0f921"],colorBlindSafe:!0,description:"Plasma連続カラー（知覚的均一、色覚障害対応）",maxClasses:10},Inferno:{name:"Inferno",type:"sequential",colors:["#000004","#1b0c41","#4a0c6b","#781c6d","#a52c60","#cf4446","#ed6925","#fb9b06","#f7d03c","#fcffa4"],colorBlindSafe:!0,description:"Inferno連続カラー（知覚的均一、色覚障害対応）",maxClasses:10},Magma:{name:"Magma",type:"sequential",colors:["#000004","#180f3d","#440f76","#721f81","#9e2f7f","#cd4071","#f1605d","#fd9668","#feca8d","#fcfdbf"],colorBlindSafe:!0,description:"Magma連続カラー（知覚的均一、色覚障害対応）",maxClasses:10}},_={Prism:{name:"Prism",type:"categorical",colors:["#5F4690","#1D6996","#38A6A5","#0F8554","#73AF48","#EDAD08","#E17C05","#CC503E","#94346E","#6F4070","#994E95"],colorBlindSafe:!0,description:"CARTO Prism カテゴリカルカラー（色覚障害対応）",maxClasses:11},Safe:{name:"Safe",type:"categorical",colors:["#88CCEE","#CC6677","#DDCC77","#117733","#332288","#AA4499","#44AA99","#999933","#882255","#661100","#6699CC","#888888"],colorBlindSafe:!0,description:"CARTO Safe カテゴリカルカラー（色覚障害完全対応）",maxClasses:12},Vivid:{name:"Vivid",type:"categorical",colors:["#E58606","#5D69B1","#52BCA3","#99C945","#CC61B0","#24796C","#DAA51B","#2F8AC4","#764E9F","#ED645A","#CC3A8E","#A5AA99"],colorBlindSafe:!1,description:"CARTO Vivid カテゴリカルカラー（鮮やか）",maxClasses:12}},Q={TailwindVivid:{name:"TailwindVivid",type:"categorical",colors:["#3B82F6","#EF4444","#10B981","#F59E0B","#8B5CF6","#EC4899","#06B6D4","#84CC16"],colorBlindSafe:!0,description:"Tailwind CSS ビビッドカラー（500シェード）",maxClasses:8},TailwindRich:{name:"TailwindRich",type:"categorical",colors:["#2563EB","#DC2626","#059669","#D97706","#7C3AED","#DB2777","#0891B2","#65A30D"],colorBlindSafe:!0,description:"Tailwind CSS リッチカラー（600シェード）",maxClasses:8},TailwindDeep:{name:"TailwindDeep",type:"categorical",colors:["#1D4ED8","#B91C1C","#047857","#B45309","#6D28D9","#BE185D","#0E7490","#4D7C0F"],colorBlindSafe:!0,description:"Tailwind CSS ディープカラー（700シェード）",maxClasses:8},TailwindDark:{name:"TailwindDark",type:"categorical",colors:["#1E40AF","#991B1B","#065F46","#92400E","#5B21B6","#9D174D","#155E75","#3F6212"],colorBlindSafe:!0,description:"Tailwind CSS ダークカラー（800シェード）",maxClasses:8},TailwindWarm:{name:"TailwindWarm",type:"categorical",colors:["#F97316","#EF4444","#F59E0B","#EAB308","#EC4899","#F43F5E","#D946EF","#A855F7"],colorBlindSafe:!1,description:"Tailwind CSS 暖色系（オレンジ・レッド・ピンク系）",maxClasses:8},TailwindCool:{name:"TailwindCool",type:"categorical",colors:["#3B82F6","#06B6D4","#0EA5E9","#10B981","#22C55E","#84CC16","#6366F1","#8B5CF6"],colorBlindSafe:!0,description:"Tailwind CSS 寒色系（ブルー・グリーン・パープル系）",maxClasses:8},TailwindNeon:{name:"TailwindNeon",type:"categorical",colors:["#06B6D4","#10B981","#84CC16","#EAB308","#F59E0B","#EC4899","#D946EF","#8B5CF6"],colorBlindSafe:!0,description:"Tailwind CSS ネオンカラー（明るく鮮やかな色調）",maxClasses:8},TailwindBlues:{name:"TailwindBlues",type:"sequential",colors:["#DBEAFE","#BFDBFE","#93C5FD","#60A5FA","#3B82F6","#2563EB","#1D4ED8","#1E40AF","#1E3A8A"],colorBlindSafe:!0,description:"Tailwind CSS ブルー系連続カラー",maxClasses:9},TailwindGreens:{name:"TailwindGreens",type:"sequential",colors:["#D1FAE5","#A7F3D0","#6EE7B7","#34D399","#10B981","#059669","#047857","#065F46","#064E3B"],colorBlindSafe:!0,description:"Tailwind CSS グリーン系連続カラー",maxClasses:9},TailwindPurples:{name:"TailwindPurples",type:"sequential",colors:["#EDE9FE","#DDD6FE","#C4B5FD","#A78BFA","#8B5CF6","#7C3AED","#6D28D9","#5B21B6","#4C1D95"],colorBlindSafe:!0,description:"Tailwind CSS パープル系連続カラー",maxClasses:9}},K={...H,...Z,..._,...Q},J={protanopia:[[.567,.433,0],[.558,.442,0],[0,.242,.758]],deuteranopia:[[.625,.375,0],[.7,.3,0],[0,.3,.7]],tritanopia:[[.95,.05,0],[0,.433,.567],[0,.475,.525]]};function tt(t,e){const r=et(t);if(!r)return t;const a=J[e],n=Math.round(a[0][0]*r.r+a[0][1]*r.g+a[0][2]*r.b),i=Math.round(a[1][0]*r.r+a[1][1]*r.g+a[1][2]*r.b),o=Math.round(a[2][0]*r.r+a[2][1]*r.g+a[2][2]*r.b);return function(t,e,r){return"#"+((1<<24)+(t<<16)+(e<<8)+r).toString(16).slice(1)}(Math.min(255,Math.max(0,n)),Math.min(255,Math.max(0,i)),Math.min(255,Math.max(0,o)))}function et(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function rt(t,e){const r=et(t),a=et(e);return r&&a?Math.sqrt(Math.pow(r.r-a.r,2)+Math.pow(r.g-a.g,2)+Math.pow(r.b-a.b,2)):0}t.AllPalettes=K,t.BaseLayer=s,t.CARTOPalettes=_,t.ColorBrewerPalettes=H,t.FilterPresets=z,t.GeojsonLayer=class extends s{constructor(t){super(`geojson-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderFeatures())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderFeatures()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("path").on(t,function(t,r){e(t,r)})}renderFeatures(){if(!this.layerGroup||!this.path)return;const t=this.layerGroup.append("g").attr("class","thematika-geojson-layer").selectAll("path").data(this.data.features).enter().append("path").attr("d",this.path).attr("class",t=>["thematika-feature",this.attr.className||"",t.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(t,this.layerGroup)}getData(){return this.data}},t.GraticuleLayer=class extends s{constructor(t={}){super(`graticule-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,{fill:"none",stroke:"#cccccc",strokeWidth:.5,opacity:.7,...t.attr||{}},t.style||{}),this.step=t.step||[10,10],this.extent=t.extent}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderGraticule())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderGraticule()}renderGraticule(){if(!this.layerGroup||!this.path)return;const t=r.geoGraticule().step(this.step);this.extent&&t.extent(this.extent);const e=t(),a=this.layerGroup.append("g").attr("class","thematika-graticule-layer").append("path").datum(e).attr("d",this.path).attr("class",()=>["thematika-graticule",this.attr.className||""].filter(Boolean).join(" "));this.applyAllStylesToElement(a,this.layerGroup)}},t.ImageLayer=class extends s{constructor(t,e){super(t,e.attr,e.style),this.src=e.src,this.bounds=e.bounds,this.showBboxMarkers=e.showBboxMarkers??!1}setProjection(t){if(this.projection=t,this.isRendered()){if(!this.element||!this.projection)return;const t=e.select(this.element);t.selectAll("image").remove(),t.selectAll(".bbox-marker").remove(),t.selectAll(".bbox-marker-label").remove(),this.loadImage(this.src).then(t=>{this.canUseDirectRendering(this.projection)?this.renderDirect(t):this.renderReprojected(t)}).catch(t=>{console.error("ImageLayer: 更新に失敗しました",t)})}}async render(t){if(!this.projection)return void console.warn("ImageLayer: 投影法が設定されていません");const e=t.append("g").attr("class",`image-layer ${this.attr.className||""}`).attr("id",`layer-${this.id}`);this.visible||e.style("display","none"),this.element=e.node();try{const t=await this.loadImage(this.src);this.canUseDirectRendering(this.projection)?await this.renderDirect(t):await this.renderReprojected(t)}catch(t){console.error("ImageLayer: 画像の描画に失敗しました",t)}}loadImage(t){return new Promise((e,r)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>e(a),a.onerror=()=>r(new Error(`画像の読み込みに失敗しました: ${t}`)),a.src=t})}canUseDirectRendering(t){return this.isEquirectangularProjection(t)}isEquirectangularProjection(t){const e=t.toString?t.toString():"";return e.includes("equirectangular")||e.includes("Equirectangular")}renderDirect(t){if(!this.element||!this.projection)return;const[r,a,n,i]=this.bounds,o=this.projection([r,i]),s=this.projection([n,i]),l=this.projection([r,a]),c=this.projection([n,a]);if(!o||!c)return void console.warn("ImageLayer: 境界が投影範囲外です");const h=o[0],d=o[1],u=Math.abs(c[0]-o[0]),p=Math.abs(c[1]-o[1]),f=e.select(this.element);this.imageElement=f.append("image").attr("x",h).attr("y",d).attr("width",u).attr("height",p).attr("href",t.src).attr("preserveAspectRatio","none"),this.showBboxMarkers&&this.addBboxMarkers(f,[o,s,l,c]),this.imageElement&&this.applyAllStylesToElement(this.imageElement,this.getLayerGroup())}async renderReprojected(t){if(this.element&&this.projection)try{const r=await this.reprojectImage(t),a=e.select(this.element);if(this.imageElement=a.append("image").attr("x",r.x).attr("y",r.y).attr("width",r.width).attr("height",r.height).attr("href",r.dataUrl).attr("preserveAspectRatio","none"),this.imageElement&&this.applyAllStylesToElement(this.imageElement,this.getLayerGroup()),this.showBboxMarkers){const[t,e,r,n]=this.bounds,i=this.projection([t,n]),o=this.projection([r,n]),s=this.projection([t,e]),l=this.projection([r,e]);this.addBboxMarkers(a,[i,o,s,l])}}catch(t){console.error("ImageLayer: 再投影に失敗しました",t)}}async reprojectImage(t){if(!this.projection)throw new Error("投影法が設定されていません");const[e,r,a,n]=this.bounds,i=this.calculateOutputBounds();if(!i)throw new Error("出力範囲の計算に失敗しました");const{minX:o,minY:s,width:l,height:c}=i,h=document.createElement("canvas"),d=h.getContext("2d");if(!d)throw new Error("Canvas contextの取得に失敗しました");h.width=t.width,h.height=t.height,d.drawImage(t,0,0);const u=d.getImageData(0,0,t.width,t.height),p=document.createElement("canvas"),f=p.getContext("2d");if(!f)throw new Error("Canvas contextの取得に失敗しました");p.width=l,p.height=c;const y=f.createImageData(l,c);for(let i=0;i<c;i++)for(let c=0;c<l;c++){const h=c+o,d=i+s;if(this.projection.invert)try{const o=this.projection.invert([h,d]);if(o&&o[0]>=e&&o[0]<=a&&o[1]>=r&&o[1]<=n){const s=(o[0]-e)/(a-e)*(t.width-1),h=(n-o[1])/(n-r)*(t.height-1),d=this.nearestNeighborInterpolate(u,s,h),p=4*(i*l+c);y.data[p]=d[0],y.data[p+1]=d[1],y.data[p+2]=d[2],y.data[p+3]=d[3]}}catch(t){}}return f.putImageData(y,0,0),{dataUrl:p.toDataURL(),x:o,y:s,width:l,height:c}}nearestNeighborInterpolate(t,e,r){const a=Math.round(e),n=Math.round(r);if(a<0||a>=t.width||n<0||n>=t.height)return[0,0,0,0];const i=4*(n*t.width+a);return[t.data[i],t.data[i+1],t.data[i+2],t.data[i+3]]}calculateOutputBounds(){if(!this.projection)return null;const[t,e,r,a]=this.bounds,n=[];for(let i=0;i<=20;i++){const o=i/20;n.push([t+(r-t)*o,a],[t+(r-t)*o,e],[t,e+(a-e)*o],[r,e+(a-e)*o])}const i=n.map(t=>this.projection(t)).filter(t=>null!==t);if(0===i.length)return null;const o=i.map(t=>t[0]),s=i.map(t=>t[1]),l=Math.floor(Math.min(...o)),c=Math.ceil(Math.max(...o)),h=Math.floor(Math.min(...s));return{minX:l,minY:h,width:c-l,height:Math.ceil(Math.max(...s))-h}}addBboxMarkers(t,e){const r=e.filter(t=>null!==t),a=["#e74c3c","#3498db","#2ecc71","#f39c12"],n=["NW","NE","SW","SE"];r.forEach((e,r)=>{const i=t.append("g").attr("class","bbox-marker").attr("transform",`translate(${e[0]}, ${e[1]})`);i.append("circle").attr("r",6).attr("fill","white").attr("stroke",a[r]||"#9b59b6").attr("stroke-width",2),i.append("circle").attr("r",4).attr("fill",a[r]||"#9b59b6"),i.append("text").attr("x",10).attr("y",4).attr("font-size","11px").attr("font-family","Arial, sans-serif").attr("fill",a[r]||"#9b59b6").attr("font-weight","bold").attr("class","bbox-marker-label").text(n[r]||`${r+1}`)})}},t.LayerManager=o,t.LegendLayer=class extends s{constructor(t){super(`legend-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.scale=t.scale,this.position=t.position,this.title=t.title,this.orientation=t.orientation||"vertical",this.itemSpacing=t.itemSpacing||20,this.fontSize=t.fontSize||12,this.width=t.width,this.height=t.height,this.symbolType=t.symbolType||this.inferSymbolType(),this.symbolSize=t.symbolSize||{fixed:16},this.sizeScale=t.sizeScale,this.gradientSteps=t.gradientSteps||256,this.enableDrag=!1!==t.enableDrag,this.showBackground=!1!==t.showBackground,this.overlapping=t.overlapping||!1,this.backgroundStyle={fill:"#ffffff",stroke:"#cccccc",strokeWidth:1,opacity:.9,rx:4,ry:4,padding:8,...t.backgroundStyle}}inferSymbolType(){return"continuous"===this.detectScaleType()?"gradient":"cell"}hasSizeScale(){return!!this.sizeScale}render(t){this.parentContainer=t,this.layerGroup=this.createLayerGroup(t),this.renderLegend(),this.renderBackground(),this.updatePositionTransform(),this.enableDrag&&this.setupDragBehavior(),this.setupResizeListener()}detectScaleType(){const t=this.scale;return"function"==typeof t.invertExtent?"quantized":"function"==typeof t.ticks?"continuous":"ordinal"}isColorValue(t){return"string"==typeof t&&(!!/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(t)||(!!/^rgba?\(/.test(t)||(!!/^hsla?\(/.test(t)||!!/^(red|green|blue|black|white|yellow|cyan|magenta|gray|grey|orange|purple|brown|pink)$/i.test(t))))}generateLegendData(){const t=this.detectScaleType();switch(t){case"continuous":return this.generateContinuousLegend();case"quantized":return this.generateQuantizedLegend();case"ordinal":return this.generateOrdinalLegend();default:throw new Error(`Unsupported scale type: ${t}`)}}generateContinuousLegend(){const t=this.scale,e=t.domain(),r=t.ticks?t.ticks(5):e;return{data:r,labels:r.map(t=>t.toString()),colors:r.map(e=>t(e))}}generateQuantizedLegend(){const t=this.scale,e=t.range(),r=e.length>0&&"number"==typeof e[0],a={data:e,labels:e.map(e=>{const r=t.invertExtent(e);return null!=r[0]&&null!=r[1]?`${r[0]} - ${r[1]}`:e.toString()}),colors:r?e.map(()=>"#0066cc"):e};return r&&(a.sizes=e),a}generateOrdinalLegend(){const t=this.scale,e=t.domain(),r=t.range(),a=r.length>0&&"number"==typeof r[0],n={data:e,labels:e.map(t=>t.toString()),colors:a?e.map(()=>"#0066cc"):e.map(e=>t(e))};return a&&(n.sizes=e.map(e=>t(e))),n}generateSizeScaleLegendData(){if(!this.sizeScale)throw new Error("Size scale is not defined");const t=this.sizeScale,e=t.domain(),r=t.range(),a=this.scale;return{data:e,labels:e.map(t=>t.toString()),colors:e.map(()=>{if("function"==typeof a)try{const t=a.domain();return a(t[0])||"#0066cc"}catch{return"#0066cc"}return"#0066cc"}),sizes:r}}renderLegend(){if(this.layerGroup)if(this.title&&this.renderTitle(),this.hasSizeScale())this.renderSizeScaleLegend();else switch(this.symbolType){case"cell":this.renderCellLegend();break;case"circle":this.renderCircleLegend();break;case"line":this.renderLineLegend();break;case"gradient":this.renderGradientLegend();break;default:throw new Error(`Unsupported symbol type: ${this.symbolType}`)}}renderTitle(){this.layerGroup&&this.title&&this.layerGroup.append("text").attr("class","thematika-legend-title").attr("x",0).attr("y",0).style("font-size",`${this.fontSize+2}px`).style("font-weight","bold").style("fill","#333").text(this.title)}renderCellLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),a=this.symbolSize.fixed||16;r.append("rect").attr("x",0).attr("y",0).attr("width",a).attr("height",a).attr("fill",(e,r)=>t.colors[r]).attr("stroke","#333").attr("stroke-width",.5),r.append("text").attr("x",a+4).attr("y",a/2).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderCircleLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),a=(this.symbolSize.fixed||16)/2;r.append("circle").attr("cx",a).attr("cy",a).attr("r",a).attr("fill",(e,r)=>t.colors[r]).attr("stroke","#333").attr("stroke-width",.5),r.append("text").attr("x",2*a+4).attr("y",a).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderLineLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),a=this.symbolSize.fixed||24;r.append("line").attr("x1",0).attr("y1",8).attr("x2",a).attr("y2",8).attr("stroke",(e,r)=>t.colors[r]).attr("stroke-width",2),r.append("text").attr("x",a+4).attr("y",8).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderGradientLegend(){if(!this.layerGroup)return;const t=this.scale,e=t.domain(),r=`gradient-${this.id}`,a=this.layerGroup.append("defs").append("linearGradient").attr("id",r).attr("x1","0%").attr("y1","0%").attr("x2","horizontal"===this.orientation?"100%":"0%").attr("y2","horizontal"===this.orientation?"0%":"100%"),n=this.gradientSteps;for(let r=0;r<=n;r++){const i=r/n,o=e[0]+i*(e[1]-e[0]);a.append("stop").attr("offset",100*i+"%").attr("stop-color",t(o))}const i=this.title?this.fontSize+10:0,o=this.width||200,s=this.height||20;this.layerGroup.append("rect").attr("x",0).attr("y",i).attr("width","horizontal"===this.orientation?o:s).attr("height","horizontal"===this.orientation?s:o).attr("fill",`url(#${r})`).attr("stroke","#333").attr("stroke-width",.5);const l=t.ticks?t.ticks(5):e,c=this.layerGroup.append("g").attr("transform",`translate(0, ${i})`);l.forEach((t,r)=>{const a=(t-e[0])/(e[1]-e[0]);c.append("text").attr("x","horizontal"===this.orientation?a*o:s+4).attr("y","horizontal"===this.orientation?s+16:a*o).attr("text-anchor","horizontal"===this.orientation?"middle":"start").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.toString())})}renderSizeScaleLegend(){if(!this.layerGroup)return;const t=this.generateSizeScaleLegendData(),e=this.title?this.fontSize+10:0;this.overlapping?this.renderOverlappingSizeScale(t,e):this.renderRegularSizeScale(t,e)}renderOverlappingSizeScale(t,e){if(!this.layerGroup||!t.sizes||0===t.sizes.length)return;const r=Math.max(...t.sizes);switch(this.symbolType){case"circle":default:this.renderOverlappingCircles(t,e,r);break;case"cell":this.renderOverlappingCells(t,e,r);break;case"line":this.renderOverlappingLines(t,e,r)}}renderOverlappingCircles(t,e,r){if(!this.layerGroup||!t.sizes)return;const a=r,n=a,i=e+2*a,o=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),s=this.layerGroup.append("g").attr("class","thematika-legend-symbols");o.forEach((t,e)=>{const r=i-t.size;s.append("circle").attr("cx",n).attr("cy",r).attr("r",t.size).attr("fill","none").attr("stroke","#333").attr("stroke-width",1)});const l=this.layerGroup.append("g").attr("class","thematika-legend-guidelines"),c=n+a+20,h=c-4;o.forEach((t,e)=>{const r=i-t.size-t.size,a=n;l.append("line").attr("x1",a).attr("y1",r).attr("x2",h).attr("y2",r).attr("stroke","#333").attr("stroke-width",1).attr("stroke-dasharray","3,3")});const d=this.layerGroup.append("g").attr("class","thematika-legend-labels");o.forEach((t,e)=>{const r=i-t.size-t.size;d.append("text").attr("x",c).attr("y",r).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderOverlappingCells(t,e,r){if(!this.layerGroup||!t.sizes)return;const a=Math.sqrt(r),n=a/2,i=e+a,o=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),s=this.layerGroup.append("g").attr("class","thematika-legend-symbols");o.forEach((t,e)=>{const r=Math.sqrt(t.size),a=i-r;s.append("rect").attr("x",n-r/2).attr("y",a).attr("width",r).attr("height",r).attr("fill","none").attr("stroke","#333").attr("stroke-width",1)});const l=this.layerGroup.append("g").attr("class","thematika-legend-guidelines"),c=n+a/2+20,h=c-4;o.forEach((t,e)=>{const r=Math.sqrt(t.size),a=i-r,o=n;l.append("line").attr("x1",o).attr("y1",a).attr("x2",h).attr("y2",a).attr("stroke","#333").attr("stroke-width",1).attr("stroke-dasharray","3,3")});const d=this.layerGroup.append("g").attr("class","thematika-legend-labels");o.forEach((t,e)=>{const r=Math.sqrt(t.size),a=i-r;d.append("text").attr("x",c).attr("y",a).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderOverlappingLines(t,e,r){if(!this.layerGroup||!t.sizes)return;const a=e+r/2+10,n=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),i=this.layerGroup.append("g").attr("class","thematika-legend-symbols");n.forEach((t,e)=>{i.append("line").attr("x1",0).attr("y1",a).attr("x2",30).attr("y2",a).attr("stroke",t.color).attr("stroke-width",t.size).attr("opacity",.8)});const o=this.layerGroup.append("g").attr("class","thematika-legend-labels"),s=this.fontSize+4;n.forEach((t,e)=>{o.append("text").attr("x",40).attr("y",a-r/2+e*s+this.fontSize).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderRegularSizeScale(t,e){if(!this.layerGroup||!t.sizes)return;const r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item");switch(this.symbolType){case"circle":default:this.renderRegularSizeCircles(r,t,e);break;case"cell":this.renderRegularSizeCells(r,t,e);break;case"line":this.renderRegularSizeLines(r,t,e)}}renderRegularSizeCircles(t,e,r){e.sizes&&(t.append("circle").attr("cx",(t,r)=>e.sizes[r]).attr("cy",(t,r)=>e.sizes[r]).attr("r",(t,r)=>e.sizes[r]).attr("fill",(t,r)=>e.colors[r]).attr("stroke","#333").attr("stroke-width",.5),t.append("text").attr("x",(t,r)=>2*e.sizes[r]+4).attr("y",(t,r)=>"horizontal"===this.orientation?0:e.sizes[r]).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes))}renderRegularSizeCells(t,e,r){e.sizes&&(t.append("rect").attr("x",0).attr("y",0).attr("width",(t,r)=>Math.sqrt(e.sizes[r])).attr("height",(t,r)=>Math.sqrt(e.sizes[r])).attr("fill",(t,r)=>e.colors[r]).attr("stroke","#333").attr("stroke-width",.5),t.append("text").attr("x",(t,r)=>Math.sqrt(e.sizes[r])+4).attr("y",(t,r)=>"horizontal"===this.orientation?0:Math.sqrt(e.sizes[r])/2).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes))}renderRegularSizeLines(t,e,r){if(!e.sizes)return;t.append("line").attr("x1",0).attr("y1",8).attr("x2",24).attr("y2",8).attr("stroke",(t,r)=>e.colors[r]).attr("stroke-width",(t,r)=>e.sizes[r]),t.append("text").attr("x",28).attr("y",(t,e)=>"horizontal"===this.orientation?0:8).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes)}positionItems(t,e,r){if("vertical"===this.orientation)t.attr("transform",(t,r)=>`translate(0, ${e+r*this.itemSpacing})`);else if(r&&this.hasSizeScale()){const a=Math.max(...r);t.attr("transform",(t,n)=>{const i=r[n];let o=0;return"circle"===this.symbolType?o=a-i:"cell"===this.symbolType&&(o=Math.sqrt(a)-Math.sqrt(i)),`translate(${n*this.itemSpacing}, ${e+o})`})}else t.attr("transform",(t,r)=>`translate(${r*this.itemSpacing}, ${e})`)}renderBackground(){if(!this.layerGroup)return;const t=this.calculateLegendBounds(),e=this.backgroundStyle.padding||8,r=this.showBackground?this.backgroundStyle.opacity||.9:0,a=this.layerGroup.insert("rect",":first-child").attr("class","thematika-legend-background").attr("x",t.x-e).attr("y",t.y-e).attr("width",t.width+2*e).attr("height",t.height+2*e).attr("fill",this.backgroundStyle.fill||"#ffffff").attr("stroke",this.backgroundStyle.stroke||"#cccccc").attr("stroke-width",this.backgroundStyle.strokeWidth||1).attr("opacity",r);this.backgroundStyle.rx&&a.attr("rx",this.backgroundStyle.rx),this.backgroundStyle.ry&&a.attr("ry",this.backgroundStyle.ry)}calculateLegendBounds(){if(!this.layerGroup)return{x:0,y:0,width:100,height:50};try{const t=this.layerGroup.node().getBBox();return{x:t.x,y:t.y,width:t.width,height:t.height}}catch(t){const e=this.generateLegendData().data.length,r=this.title?this.fontSize+10:0;return"vertical"===this.orientation?{x:0,y:0,width:150,height:r+e*this.itemSpacing}:{x:0,y:0,width:100*e,height:r+30}}}updatePositionTransform(){if(!this.layerGroup)return;const t=this.position.left,e=this.position.top;this.layerGroup.attr("transform",`translate(${t}, ${e})`)}setupDragBehavior(){if(!this.layerGroup)return;const t=v().on("start",()=>{this.layerGroup&&this.layerGroup.style("cursor","grabbing")}).on("drag",t=>{this.position.left+=t.dx,this.position.top+=t.dy,this.updatePositionTransform(),this.updateSliders()}).on("end",()=>{this.layerGroup&&this.layerGroup.style("cursor","grab")});this.layerGroup.style("cursor","grab").call(t)}updateSliders(){if("undefined"!=typeof window&&"undefined"!=typeof document){const t=document.getElementById("legend-x-slider"),e=document.getElementById("legend-y-slider"),r=document.getElementById("legend-x-value"),a=document.getElementById("legend-y-value");t&&e&&r&&a&&(t.value=this.position.left.toString(),e.value=this.position.top.toString(),r.textContent=this.position.left.toString(),a.textContent=this.position.top.toString())}}updateBackgroundOpacity(){if(!this.layerGroup)return;const t=this.layerGroup.select(".thematika-legend-background");if(!t.empty()){const e=this.showBackground?this.backgroundStyle.opacity||.9:0;t.attr("opacity",e)}}updateBackgroundStyles(){if(!this.layerGroup)return;const t=this.layerGroup.select(".thematika-legend-background");if(!t.empty()){const e=this.showBackground?this.backgroundStyle.opacity||.9:0;t.attr("fill",this.backgroundStyle.fill||"#ffffff").attr("stroke",this.backgroundStyle.stroke||"#cccccc").attr("stroke-width",this.backgroundStyle.strokeWidth||1).attr("opacity",e).attr("rx",this.backgroundStyle.rx||null).attr("ry",this.backgroundStyle.ry||null)}}setupResizeListener(){}},t.LineConnectionLayer=class extends s{constructor(t){super(`line-connection-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),Array.isArray(t.data)?this.data={type:"FeatureCollection",features:t.data}:"Feature"===t.data.type?this.data={type:"FeatureCollection",features:[t.data]}:this.data=t.data,this.validateData(this.data),this.lineType=t.lineType||"straight",this.arcHeight=t.arcHeight||.3,this.arcControlPoint=t.arcControlPoint||"center",this.arcOffset=t.arcOffset||"perpendicular",this.startArrow=t.startArrow||!1,this.endArrow=t.endArrow||!1,this.arrowSize=t.arrowSize||10,this.smoothType=t.smoothType||"curveBasis"}validateData(t){if(!t||"FeatureCollection"!==t.type)throw new Error("LineConnectionLayer: データはFeatureCollectionである必要があります");if(!Array.isArray(t.features))throw new Error("LineConnectionLayer: featuresが配列ではありません");t.features.forEach((t,e)=>{if(!t.geometry)throw new Error(`LineConnectionLayer: フィーチャー[${e}]にgeometryが存在しません`);const r=t.geometry,{type:a,coordinates:n}=r;if("LineString"!==a&&"MultiLineString"!==a)throw new Error(`LineConnectionLayer: フィーチャー[${e}]は'LineString'または'MultiLineString'である必要があります`);"LineString"===a?this.validateCoordinates(n,e):"MultiLineString"===a&&n.forEach((t,r)=>{this.validateCoordinates(t,e,r)})})}validateCoordinates(t,e,r){const a=void 0!==r?`[${e}]のライン[${r}]`:`[${e}]`;if(!Array.isArray(t)||t.length<2)throw new Error(`LineConnectionLayer: フィーチャー${a}は少なくとも2点の座標が必要です`);t.forEach((t,e)=>{if(!Array.isArray(t)||t.length<2)throw new Error(`LineConnectionLayer: フィーチャー${a}の座標[${e}]は[経度, 緯度]の配列である必要があります`);const[r,n]=t;if(r<-180||r>180)throw new Error(`LineConnectionLayer: フィーチャー${a}の座標[${e}]の経度は-180から180の範囲である必要があります`);if(n<-90||n>90)throw new Error(`LineConnectionLayer: フィーチャー${a}の座標[${e}]の緯度は-90から90の範囲である必要があります`)})}setProjection(t){this.projection=t,this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.layerGroup.selectAll("defs").remove(),this.createArrowMarkers(),this.renderLines())}render(t){this.layerGroup=this.createLayerGroup(t),this.createArrowMarkers(),this.renderLines()}createArrowMarkers(){if(!this.layerGroup||!this.startArrow&&!this.endArrow)return;const t=`arrow-${this.id}`,e=this.layerGroup.append("defs").attr("class","thematika-line-connection-defs");this.startArrow&&e.append("marker").attr("id",`${t}-start`).attr("viewBox","0 0 10 10").attr("refX",0).attr("refY",5).attr("markerWidth",this.arrowSize/2).attr("markerHeight",this.arrowSize/2).attr("orient","auto-start-reverse").append("path").attr("d","M 0 0 L 10 5 L 0 10 z").style("fill",("function"==typeof this.attr.stroke?"#333":this.attr.stroke)||"#333"),this.endArrow&&e.append("marker").attr("id",`${t}-end`).attr("viewBox","0 0 10 10").attr("refX",10).attr("refY",5).attr("markerWidth",this.arrowSize/2).attr("markerHeight",this.arrowSize/2).attr("orient","auto").append("path").attr("d","M 0 0 L 10 5 L 0 10 z").style("fill",("function"==typeof this.attr.stroke?"#333":this.attr.stroke)||"#333")}renderLines(){if(!this.layerGroup||!this.path||!this.projection)return;const t=this.layerGroup.append("g").attr("class","thematika-line-connection-layer"),e=this.prepareAllLinesData();if(0===e.length)return;const r=t.selectAll(".thematika-line-path").data(e).enter().append("path").attr("class",(t,e)=>["thematika-line-path thematika-connection-line",this.attr.className||"",t.feature.properties?.class||"",void 0!==t.lineIndex?`line-${t.lineIndex}`:"",`global-line-${e}`].filter(Boolean).join(" ")).attr("d",t=>t.pathData).style("fill","none");this.applyArrowMarkers(r),super.applyAllStylesToElements(r,this.layerGroup)}prepareAllLinesData(){const t=[];return this.data.features.forEach((e,r)=>{const a=e.geometry;if("LineString"===a.type){const n=a.coordinates,i=this.generateLinePath(n);i&&t.push({feature:e,featureIndex:r,coordinates:n,pathData:i,needsStartArrow:this.startArrow,needsEndArrow:this.endArrow})}else"MultiLineString"===a.type&&a.coordinates.forEach((a,n)=>{const i=this.generateLinePath(a);i&&t.push({feature:e,featureIndex:r,coordinates:a,lineIndex:n,pathData:i,needsStartArrow:this.startArrow,needsEndArrow:this.endArrow})})}),t}applyArrowMarkers(t){const r=`arrow-${this.id}`;t.each(function(t){const a=e.select(this);t.needsStartArrow&&a.attr("marker-start",`url(#${r}-start)`),t.needsEndArrow&&a.attr("marker-end",`url(#${r}-end)`)})}generateSegmentPath(t,e){if(!this.projection)return"";const r=this.projection(t),a=this.projection(e);return r&&a?"straight"===this.lineType?`M${r[0]},${r[1]}L${a[0]},${a[1]}`:"arc"===this.lineType?this.generateArcPath(t,e,r,a):(this.lineType,`M${r[0]},${r[1]}L${a[0]},${a[1]}`):""}generateArcPath(t,e,r,a){if(!this.projection)return"";const n=this.calculateBaseControlPoint(t,e,r,a);if(!n)return"";const i=this.applyArcOffset(n,r,a);return`M${r[0]},${r[1]}Q${i[0]},${i[1]} ${a[0]},${a[1]}`}calculateBaseControlPoint(t,e,r,a){if(!this.projection)return null;switch(this.arcControlPoint){case"center":const r=[(t[0]+e[0])/2,(t[1]+e[1])/2];return this.projection(r);case"weighted":const a=.5,n=[t[0]+(e[0]-t[0])*a,t[1]+(e[1]-t[1])*a];return this.projection(n);default:return Array.isArray(this.arcControlPoint)?this.projection(this.arcControlPoint):null}}applyArcOffset(t,e,r){const a=r[0]-e[0],n=r[1]-e[1],i=Math.sqrt(a*a+n*n);let o=0,s=0;switch(this.arcOffset){case"perpendicular":o=-n/i*this.arcHeight*i,s=a/i*this.arcHeight*i;break;case"north":s=-this.arcHeight*i;break;case"south":s=this.arcHeight*i;break;case"east":o=this.arcHeight*i;break;case"west":o=-this.arcHeight*i;break;default:Array.isArray(this.arcOffset)&&(o=this.arcOffset[0]*i,s=this.arcOffset[1]*i)}return[t[0]+o,t[1]+s]}geoSmoothPath(t){if(!this.projection)return"";const e=t.map(t=>this.projection([t[0],t[1]])).filter(t=>null!==t);if(e.length<2)return"";const r=this.getCurveFunction();return a.line().x(t=>t[0]).y(t=>t[1]).curve(r)(e)||""}getCurveFunction(){switch(this.smoothType){case"curveBasis":default:return a.curveBasis;case"curveCardinal":return a.curveCardinal;case"curveCatmullRom":return a.curveCatmullRom;case"curveLinear":return a.curveLinear;case"curveMonotoneX":return a.curveMonotoneX;case"curveMonotoneY":return a.curveMonotoneY;case"curveNatural":return a.curveNatural;case"curveStep":return a.curveStep;case"curveStepAfter":return a.curveStepAfter;case"curveStepBefore":return a.curveStepBefore}}on(t,e){this.layerGroup&&this.layerGroup.selectAll(".thematika-line-path").on(t,function(t,r){e(t,{feature:r.feature,featureIndex:r.featureIndex,coordinates:r.coordinates,lineIndex:r.lineIndex})})}generateLinePath(t){if(!this.projection||t.length<2)return"";switch(this.lineType){case"straight":default:return this.generateStraightPath(t);case"arc":return this.generateArcLinePath(t);case"smooth":return this.generateSmoothPath(t)}}generateStraightPath(t){if(!this.projection)return"";const e=t.map(t=>this.projection(t)).filter(t=>null!==t);if(e.length<2)return"";let r=`M${e[0][0]},${e[0][1]}`;for(let t=1;t<e.length;t++)r+=`L${e[t][0]},${e[t][1]}`;return r}generateArcLinePath(t){if(!this.projection||t.length<2)return"";let e="";for(let r=0;r<t.length-1;r++){const a=this.generateSegmentPath(t[r],t[r+1]);if(0===r)e=a;else{e+=a.replace(/^M[^LQ]*/,"")}}return e}generateSmoothPath(t){return this.geoSmoothPath(t)}getData(){return this.data}},t.LineEdgeBundlingLayer=class extends s{constructor(t){super(`line-edgebundling-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),Array.isArray(t.data)?this.data={type:"FeatureCollection",features:t.data}:"Feature"===t.data.type?this.data={type:"FeatureCollection",features:[t.data]}:this.data=t.data,this.validateData(this.data),this.bundlingStrength=t.bundlingStrength??.85,this.forceStrength=t.forceStrength??20,this.segmentSteps=t.segmentSteps??"auto",this.showControlPoints=t.showControlPoints??!1,this.showOriginalLines=t.showOriginalLines??!1,this.animateForce=t.animateForce??!1,this.controlPointSize=t.controlPointSize??3,this.endpointSize=t.endpointSize??6}validateData(t){if(!t||"FeatureCollection"!==t.type)throw new Error("LineEdgeBundlingLayer: データはFeatureCollectionである必要があります");if(!Array.isArray(t.features))throw new Error("LineEdgeBundlingLayer: featuresが配列ではありません");t.features.forEach((t,e)=>{if(!t.geometry)throw new Error(`LineEdgeBundlingLayer: フィーチャー[${e}]にgeometryが存在しません`);const r=t.geometry,{type:a,coordinates:n}=r;if("LineString"!==a&&"MultiLineString"!==a)throw new Error(`LineEdgeBundlingLayer: フィーチャー[${e}]は'LineString'または'MultiLineString'である必要があります`);"LineString"===a?this.validateCoordinates(n,e):"MultiLineString"===a&&n.forEach((t,r)=>{this.validateCoordinates(t,e,r)})})}validateCoordinates(t,e,r){const a=void 0!==r?`[${e}]のライン[${r}]`:`[${e}]`;if(!Array.isArray(t)||t.length<2)throw new Error(`LineEdgeBundlingLayer: フィーチャー${a}は少なくとも2点の座標が必要です`);t.forEach((t,e)=>{if(!Array.isArray(t)||t.length<2)throw new Error(`LineEdgeBundlingLayer: フィーチャー${a}の座標[${e}]は[経度, 緯度]の配列である必要があります`);const[r,n]=t;if(r<-180||r>180)throw new Error(`LineEdgeBundlingLayer: フィーチャー${a}の座標[${e}]の経度は-180から180の範囲である必要があります`);if(n<-90||n>90)throw new Error(`LineEdgeBundlingLayer: フィーチャー${a}の座標[${e}]の緯度は-90から90の範囲である必要があります`)})}setProjection(t){this.projection=t,this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("*").remove(),this.simulation&&this.simulation.stop(),this.renderBundledLines())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderBundledLines()}renderBundledLines(){if(!this.layerGroup||!this.path||!this.projection)return;if(this.bundlingData=this.generateBundlingData(),!this.bundlingData||0===this.bundlingData.paths.length)return;const t=this.layerGroup.append("g").attr("class","thematika-line-edgebundling-layer");this.showOriginalLines&&this.renderOriginalLines(t),this.renderBundledPaths(t),this.showControlPoints&&this.renderControlPoints(t),this.startForceSimulation()}generateBundlingData(){const t={nodes:[],links:[],paths:[]},e=new Map;let r=0;return this.data.features.forEach((a,n)=>{const i=a.geometry;if("LineString"===i.type){const o=this.processLineString(i.coordinates,a,n,t,e,r);o&&(r=o.nextNodeId)}else"MultiLineString"===i.type&&i.coordinates.forEach((i,o)=>{const s=this.processLineString(i,a,n,t,e,r,o);s&&(r=s.nextNodeId)})}),t}processLineString(t,e,r,a,n,i,o){if(!this.projection||t.length<2)return null;const s=[];let l=i;const c=this.projection(t[0]),h=this.projection(t[t.length-1]);if(!c||!h)return null;const d=`${c[0]},${c[1]}`;if(!n.has(d)){const t={id:"node-"+l++,x:c[0],y:c[1],fx:c[0],fy:c[1],type:"endpoint",feature:e,featureIndex:r,lineIndex:o};n.set(d,t),a.nodes.push(t)}s.push(n.get(d));const u=Math.sqrt(Math.pow(h[0]-c[0],2)+Math.pow(h[1]-c[1],2)),p=this.calculateSegmentSteps(u);let f=n.get(d);for(let t=1;t<p;t++){const n=t/p,i={id:"node-"+l++,x:c[0]+n*(h[0]-c[0]),y:c[1]+n*(h[1]-c[1]),type:"control",feature:e,featureIndex:r,lineIndex:o};a.nodes.push(i),s.push(i),a.links.push({source:f.id,target:i.id}),f=i}const y=`${h[0]},${h[1]}`;if(!n.has(y)){const t={id:"node-"+l++,x:h[0],y:h[1],fx:h[0],fy:h[1],type:"endpoint",feature:e,featureIndex:r,lineIndex:o};n.set(y,t),a.nodes.push(t)}return s.push(n.get(y)),a.links.push({source:f.id,target:n.get(y).id}),a.paths.push({nodes:s,feature:e,featureIndex:r,lineIndex:o}),{nextNodeId:l}}calculateSegmentSteps(t){return"auto"===this.segmentSteps?Math.max(3,Math.min(10,Math.floor(t/50))):Math.max(2,this.segmentSteps)}renderOriginalLines(t){if(!this.path)return;t.append("g").attr("class","thematika-original-lines").selectAll("path").data(this.data.features).enter().append("path").attr("d",this.path).attr("class","thematika-line-original").style("fill","none").style("stroke","#999").style("stroke-width",1).style("opacity",.3)}renderBundledPaths(t){if(!this.bundlingData)return;const e=t.append("g").attr("class","thematika-bundled-lines"),r=a.line().curve(a.curveBundle.beta(this.bundlingStrength)).x(t=>t.x).y(t=>t.y),n=e.selectAll("path").data(this.bundlingData.paths).enter().append("path").attr("class",(t,e)=>["thematika-line-bundled",this.attr.className||"",t.feature.properties?.class||"",void 0!==t.lineIndex?`line-${t.lineIndex}`:"",`bundled-line-${e}`].filter(Boolean).join(" ")).attr("d",t=>r(t.nodes)||"").style("fill","none");super.applyAllStylesToElements(n,e)}renderControlPoints(t){if(!this.bundlingData)return;t.append("g").attr("class","thematika-control-points").selectAll("circle").data(this.bundlingData.nodes).enter().append("circle").attr("r",t=>"endpoint"===t.type?this.endpointSize:this.controlPointSize).attr("cx",t=>t.x).attr("cy",t=>t.y).attr("class",t=>"endpoint"===t.type?"thematika-endpoint":"thematika-control-point").style("fill",t=>"endpoint"===t.type?"#2d3436":"#4ecdc4").style("stroke","white").style("stroke-width",t=>"endpoint"===t.type?2:1)}startForceSimulation(){if(this.bundlingData)if(this.simulation&&this.simulation.stop(),this.simulation=n.forceSimulation(this.bundlingData.nodes).force("charge",n.forceManyBody().strength(this.forceStrength).distanceMax(100)).force("link",n.forceLink(this.bundlingData.links).id(t=>t.id).strength(.5).distance(0)).alphaDecay(.02),this.animateForce)this.simulation.on("tick",()=>this.updatePositions()),this.simulation.alpha(.3).restart();else{for(let t=0;t<300&&(this.simulation.tick(),!(this.simulation.alpha()<.01));t++);this.updatePositions()}}updatePositions(){if(!this.layerGroup||!this.bundlingData)return;const t=a.line().curve(a.curveBundle.beta(this.bundlingStrength)).x(t=>t.x).y(t=>t.y);this.layerGroup.selectAll(".thematika-line-bundled").data(this.bundlingData.paths).attr("d",e=>t(e.nodes)||""),this.showControlPoints&&this.layerGroup.selectAll(".thematika-control-point, .thematika-endpoint").data(this.bundlingData.nodes).attr("cx",t=>t.x).attr("cy",t=>t.y)}destroy(){this.simulation&&(this.simulation.stop(),this.simulation=void 0),super.destroy()}on(t,e){this.layerGroup&&this.layerGroup.selectAll(".thematika-line-bundled").on(t,function(t,r){e(t,{feature:r.feature,featureIndex:r.featureIndex,lineIndex:r.lineIndex,nodes:r.nodes})})}getSimulation(){return this.simulation}setBundlingStrength(t){this.bundlingStrength=Math.max(0,Math.min(1,t)),this.layerGroup&&this.updatePositions()}},t.LineTextLayer=class extends s{constructor(t){if(super(`line-text-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),Array.isArray(t.data)?this.data={type:"FeatureCollection",features:t.data}:"Feature"===t.data.type?this.data={type:"FeatureCollection",features:[t.data]}:this.data=t.data,this.validateData(this.data),this.textProperty=t.textProperty||"text",this.textAnchor=t.textAnchor||"middle",this.startOffset=t.startOffset||"50%","function"==typeof t.fontFamily)this.fontFamilyFunction=t.fontFamily;else{const e=t.fontFamily||"メイリオ, Meiryo, 'ＭＳ Ｐゴシック', MS Gothic, sans-serif";this.fontFamilyFunction=()=>e}if("function"==typeof t.fontSize)this.fontSizeFunction=t.fontSize;else{const e=t.fontSize||16;this.fontSizeFunction=()=>e}if("function"==typeof t.fontWeight)this.fontWeightFunction=t.fontWeight;else{const e=t.fontWeight||"normal";this.fontWeightFunction=()=>e}if(this.lineType=t.lineType||"straight",this.arcHeight=t.arcHeight||.3,this.arcControlPoint=t.arcControlPoint||"center",this.arcOffset=t.arcOffset||"perpendicular",this.smoothType=t.smoothType||"curveBasis",this.showGuidePath=t.showGuidePath||!1,this.guidePathStyle=t.guidePathStyle||{fill:"none",stroke:"#800080",strokeWidth:1,strokeDasharray:"5,5",opacity:.7},this.followPath=void 0===t.followPath||t.followPath,this.flipText=t.flipText||!1,"function"==typeof t.dx)this.dxFunction=t.dx;else{const e=t.dx||0;this.dxFunction=()=>e}if("function"==typeof t.dy)this.dyFunction=t.dy;else{const e=t.dy||0;this.dyFunction=()=>e}}validateData(t){if(!t||"FeatureCollection"!==t.type)throw new Error("LineTextLayer: データはFeatureCollectionである必要があります");if(!Array.isArray(t.features))throw new Error("LineTextLayer: featuresが配列ではありません");t.features.forEach((t,e)=>{if(!t.geometry)throw new Error(`LineTextLayer: フィーチャー[${e}]にgeometryが存在しません`);const r=t.geometry,{type:a,coordinates:n}=r;if("LineString"!==a&&"MultiLineString"!==a)throw new Error(`LineTextLayer: フィーチャー[${e}]は'LineString'または'MultiLineString'である必要があります`);"LineString"===a?this.validateCoordinates(n,e):"MultiLineString"===a&&n.forEach((t,r)=>{this.validateCoordinates(t,e,r)})})}validateCoordinates(t,e,r){const a=void 0!==r?`[${e}]のライン[${r}]`:`[${e}]`;if(!Array.isArray(t)||t.length<2)throw new Error(`LineTextLayer: フィーチャー${a}は少なくとも2点の座標が必要です`);t.forEach((t,e)=>{if(!Array.isArray(t)||t.length<2)throw new Error(`LineTextLayer: フィーチャー${a}の座標[${e}]は[経度, 緯度]の配列である必要があります`);const[r,n]=t;if(r<-180||r>180)throw new Error(`LineTextLayer: フィーチャー${a}の座標[${e}]の経度は-180から180の範囲である必要があります`);if(n<-90||n>90)throw new Error(`LineTextLayer: フィーチャー${a}の座標[${e}]の緯度は-90から90の範囲である必要があります`)})}setProjection(t){this.projection=t,this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("*").remove(),this.render(this.layerGroup))}render(t){this.layerGroup=this.createLayerGroup(t),this.projection?(this.showGuidePath&&this.renderGuidePaths(),this.renderUnifiedText()):console.warn("LineTextLayer: 投影法が設定されていません")}renderUnifiedText(){if(!this.layerGroup||!this.projection)return;const t=this.prepareAllTextLinesData();0!==t.length&&(this.followPath?this.renderTextPathUnified(t):this.renderSimpleTextUnified(t))}prepareAllTextLinesData(){const t=[];return this.data.features.forEach((e,r)=>{let a="";if(e.properties&&(a=e.properties[this.textProperty]||e.properties.name||""),!a)return;const n=e.geometry;if("LineString"===n.type){const i=n.coordinates,o=this.createLineTextData(e,r,i,a);o&&t.push(o)}else"MultiLineString"===n.type&&n.coordinates.forEach((n,i)=>{const o=this.createLineTextData(e,r,n,a,i);o&&t.push(o)})}),t}createLineTextData(t,e,r,a,n){if(r.length<2)return null;const i={feature:t,featureIndex:e,coordinates:r,textContent:a,lineIndex:n};if(this.followPath){let t=this.generateLineStringPath(r);this.flipText&&t&&(t=this.reversePath(t)),i.pathData=t}else{const t=r[Math.floor(r.length/2)],e=this.projection(t);e&&(i.centerPoint=e)}return i}renderTextPathUnified(t){if(!this.layerGroup)return;const e=this.layerGroup.append("defs"),r=this.layerGroup.append("g").attr("class","thematika-line-text-layer");t.forEach((t,r)=>{if(t.pathData){const r=`line-text-path-${this.id}-${t.featureIndex}${void 0!==t.lineIndex?`-${t.lineIndex}`:""}`;e.append("path").attr("id",r).attr("d",t.pathData).attr("fill","none").attr("stroke","none")}});const a=r.selectAll(".thematika-line-text").data(t.filter(t=>t.pathData)).enter().append("text").attr("font-family",(t,e)=>this.fontFamilyFunction(t.feature,t.featureIndex)).attr("font-size",(t,e)=>this.fontSizeFunction(t.feature,t.featureIndex)).attr("font-weight",(t,e)=>this.fontWeightFunction(t.feature,t.featureIndex)).attr("class",(t,e)=>["thematika-line-text",this.attr.className||"",t.feature.properties?.class||"",void 0!==t.lineIndex?`line-${t.lineIndex}`:"",`global-text-${e}`].filter(Boolean).join(" "));a.append("textPath").attr("href",(t,e)=>`#line-text-path-${this.id}-${t.featureIndex}${void 0!==t.lineIndex?`-${t.lineIndex}`:""}`).attr("startOffset",this.startOffset).attr("text-anchor",this.textAnchor).text((t,e)=>t.textContent),this.layerGroup&&this.applyAllStylesToElements(a,this.layerGroup)}renderSimpleTextUnified(t){if(!this.layerGroup)return;const e=this.layerGroup.append("g").attr("class","thematika-line-text-layer").selectAll(".thematika-line-text").data(t.filter(t=>t.centerPoint)).enter().append("text").attr("x",(t,e)=>t.centerPoint[0]+this.dxFunction(t.feature,t.featureIndex)).attr("y",(t,e)=>t.centerPoint[1]+this.dyFunction(t.feature,t.featureIndex)).attr("font-family",(t,e)=>this.fontFamilyFunction(t.feature,t.featureIndex)).attr("font-size",(t,e)=>this.fontSizeFunction(t.feature,t.featureIndex)).attr("font-weight",(t,e)=>this.fontWeightFunction(t.feature,t.featureIndex)).attr("text-anchor",this.textAnchor).attr("alignment-baseline","middle").attr("class",(t,e)=>["thematika-line-text",this.attr.className||"",t.feature.properties?.class||"",void 0!==t.lineIndex?`line-${t.lineIndex}`:"",`global-text-${e}`].filter(Boolean).join(" ")).text((t,e)=>t.textContent);this.layerGroup&&this.applyAllStylesToElements(e,this.layerGroup)}renderGuidePaths(){if(!this.layerGroup||!this.projection)return;const t=this.layerGroup.append("g").attr("class","thematika-line-text-guide").style("pointer-events","none"),e=t.append("defs"),r=`guide-start-${this.id}`;e.append("marker").attr("id",r).attr("viewBox","0 0 10 10").attr("refX",5).attr("refY",5).attr("markerWidth",6).attr("markerHeight",6).append("circle").attr("cx",5).attr("cy",5).attr("r",3).style("fill","#00ff00").style("stroke","#006600").style("stroke-width",1);const a=`guide-end-${this.id}`;e.append("marker").attr("id",a).attr("viewBox","0 0 10 10").attr("refX",5).attr("refY",5).attr("markerWidth",6).attr("markerHeight",6).append("circle").attr("cx",5).attr("cy",5).attr("r",3).style("fill","#ff0000").style("stroke","#660000").style("stroke-width",1),this.data.features.forEach((e,n)=>{const i=e.geometry;"LineString"===i.type?this.renderGuideLineString(t,i.coordinates,e,n,r,a):"MultiLineString"===i.type&&i.coordinates.forEach((i,o)=>{this.renderGuideLineString(t,i,e,n,r,a,o)})})}renderGuideLineString(t,e,r,a,n,i,o){if(!this.projection||e.length<2)return;const s=this.generateLineStringPath(e);if(!s)return;const l=t.append("path").attr("d",s).attr("class",()=>["thematika-line-text-guide-path",r.properties?.class||"",void 0!==o?`line-${o}`:""].filter(Boolean).join(" ")).attr("marker-start",`url(#${n})`).attr("marker-end",`url(#${i})`);Object.entries(this.guidePathStyle).forEach(([t,e])=>{"className"!==t&&("function"==typeof e?l.attr(t,e(r,a)):l.attr(t,e))})}on(t,e){this.layerGroup&&this.layerGroup.selectAll(".thematika-line-text").on(t,function(t,r){e(t,{feature:r.feature,featureIndex:r.featureIndex,coordinates:r.coordinates,lineIndex:r.lineIndex,textContent:r.textContent})})}generateSegmentPath(t,e){if(!this.projection)return"";const r=this.projection(t),a=this.projection(e);return r&&a?"straight"===this.lineType?`M${r[0]},${r[1]}L${a[0]},${a[1]}`:"arc"===this.lineType?this.generateArcPath(t,e,r,a):(this.lineType,`M${r[0]},${r[1]}L${a[0]},${a[1]}`):""}generateArcPath(t,e,r,a){if(!this.projection)return"";const n=this.calculateBaseControlPoint(t,e,r,a);if(!n)return"";const i=this.applyArcOffset(n,r,a);return`M${r[0]},${r[1]}Q${i[0]},${i[1]} ${a[0]},${a[1]}`}calculateBaseControlPoint(t,e,r,a){if(!this.projection)return null;switch(this.arcControlPoint){case"center":const r=[(t[0]+e[0])/2,(t[1]+e[1])/2];return this.projection(r);case"weighted":const a=.5,n=[t[0]+(e[0]-t[0])*a,t[1]+(e[1]-t[1])*a];return this.projection(n);default:return Array.isArray(this.arcControlPoint)?this.projection(this.arcControlPoint):null}}applyArcOffset(t,e,r){const a=r[0]-e[0],n=r[1]-e[1],i=Math.sqrt(a*a+n*n);let o=0,s=0;switch(this.arcOffset){case"perpendicular":o=-n/i*this.arcHeight*i,s=a/i*this.arcHeight*i;break;case"north":s=-this.arcHeight*i;break;case"south":s=this.arcHeight*i;break;case"east":o=this.arcHeight*i;break;case"west":o=-this.arcHeight*i;break;default:Array.isArray(this.arcOffset)&&(o=this.arcOffset[0]*i,s=this.arcOffset[1]*i)}return[t[0]+o,t[1]+s]}geoSmoothPath(t){if(!this.projection)return"";const e=t.map(t=>this.projection([t[0],t[1]])).filter(t=>null!==t);if(e.length<2)return"";const r=this.getCurveFunction();return a.line().x(t=>t[0]).y(t=>t[1]).curve(r)(e)||""}getCurveFunction(){switch(this.smoothType){case"curveBasis":default:return a.curveBasis;case"curveCardinal":return a.curveCardinal;case"curveCatmullRom":return a.curveCatmullRom;case"curveLinear":return a.curveLinear;case"curveMonotoneX":return a.curveMonotoneX;case"curveMonotoneY":return a.curveMonotoneY;case"curveNatural":return a.curveNatural;case"curveStep":return a.curveStep;case"curveStepAfter":return a.curveStepAfter;case"curveStepBefore":return a.curveStepBefore}}generateLineStringPath(t){if(!this.projection||t.length<2)return"";if("smooth"===this.lineType)return this.geoSmoothPath(t);{let e="";for(let r=0;r<t.length-1;r++){const a=this.generateSegmentPath(t[r],t[r+1]);if(0===r)e=a;else{e+=a.replace(/^M[^LQ]*/,"")}}return e}}reversePath(t){if(!t)return"";const e=t.match(/[MLQC][^MLQC]*/g);if(!e)return t;const r=[];if(e.forEach(t=>{const e=t[0],a=t.slice(1).trim().split(/[\s,]+/).map(Number);if("M"===e||"L"===e)for(let t=0;t<a.length;t+=2)void 0!==a[t]&&void 0!==a[t+1]&&r.push([a[t],a[t+1]]);else if("Q"===e)for(let t=2;t<a.length;t+=4)void 0!==a[t]&&void 0!==a[t+1]&&r.push([a[t],a[t+1]]);else if("C"===e)for(let t=4;t<a.length;t+=6)void 0!==a[t]&&void 0!==a[t+1]&&r.push([a[t],a[t+1]])}),r.length<2)return t;const a=[...r].reverse();let n=`M${a[0][0]},${a[0][1]}`;for(let t=1;t<a.length;t++)n+=`L${a[t][0]},${a[t][1]}`;return n}getData(){return this.data}},t.Map=class{constructor(t){if(this.width=t.width,this.height=t.height,this.container=e.select(t.container),this.container.empty())throw new Error(`Container not found: ${t.container}`);this.container.selectAll("svg.thematika-map").remove(),this.svg=this.container.append("svg").attr("width","100%").attr("height","100%").attr("class","thematika-map").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("preserveAspectRatio","xMidYMid meet"),this.initializeDefs(t.defs),this.svgGroup=this.svg.append("g").attr("class","thematika-main-group"),this.svgGroup.append("rect").attr("width","100%").attr("height","100%").attr("fill",t.backgroundColor||"#ffffff").attr("class","thematika-background"),this.projection=t.projection,this.layerManager=new o,this.layerManager.setContext(this.svgGroup,this.projection)}addLayer(t,e){this.layerManager.addLayer(t,e)}removeLayer(t){this.layerManager.removeLayer(t)}setLayerVisibility(t,e){this.layerManager.setLayerVisibility(t,e)}setLayerZIndex(t,e){this.layerManager.setLayerZIndex(t,e)}setProjection(t){this.projection=t,this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}resize(t,e){this.width=t,this.height=e,this.svg.attr("width",t).attr("height",e),this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}fitBounds(t,e=20){const[[r,a],[n,i]]=this.projection.invert?[this.projection([t[0],t[3]]),this.projection([t[2],t[1]])]:[[0,0],[this.width,this.height]],o=Math.min((this.width-2*e)/Math.abs(n-r),(this.height-2*e)/Math.abs(i-a)),s=[this.width/2-o*(r+n)/2,this.height/2-o*(a+i)/2];this.projection.scale(o).translate(s),this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}clearAllLayers(){this.layerManager.clearAllLayers()}getSVG(){return this.svg.node()}getProjection(){return this.projection}getLayerManager(){return this.layerManager}getSize(){return[this.width,this.height]}getLayerIds(){return this.layerManager.getLayerIds()}saveSVG(t){const e=this.svg.node();if(!e)throw new Error("SVG要素が見つかりません");const r=(new XMLSerializer).serializeToString(e),a=new Blob([r],{type:"image/svg+xml"}),n=URL.createObjectURL(a),i=document.createElement("a");i.href=n,i.download=`${t}.svg`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)}savePNG(t){const e=this.svg.node();if(!e)throw new Error("SVG要素が見つかりません");const r=(new XMLSerializer).serializeToString(e),a=document.createElement("canvas"),n=a.getContext("2d");if(!n)throw new Error("Canvas 2Dコンテキストを取得できません");const i=new Image,o=e.getBoundingClientRect();a.width=o.width||this.width,a.height=o.height||this.height,i.onload=()=>{n.drawImage(i,0,0),a.toBlob(e=>{if(!e)throw new Error("PNG Blobの生成に失敗しました");const r=URL.createObjectURL(e),a=document.createElement("a");a.href=r,a.download=`${t}.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r)})},i.onerror=()=>{throw new Error("画像の読み込みに失敗しました")};const s=new Blob([r],{type:"image/svg+xml"}),l=URL.createObjectURL(s);i.src=l}initializeDefs(t){t&&t.forEach(t=>{this.svg.call(t)})}},t.OutlineLayer=class extends s{constructor(t={}){super(`outline-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,{fill:"none",stroke:"#333333",strokeWidth:1,opacity:1,...t.attr},t.style||{}),this.createClipPath=t.createClipPath??!1,this.clipPathId=t.clipPathId||`outline-clip-${this.id}`}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderOutline())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderOutline()}renderOutline(){if(!this.layerGroup||!this.path)return;const t={type:"Sphere"},r=this.path(t);if(this.createClipPath&&r){const t=this.layerGroup.node()?.closest("svg");if(t){const a=e.select(t);a.insert("defs",":first-child").append("clipPath").attr("id",this.clipPathId).append("path").attr("d",r);const n=a.select(".thematika-main-group");n.empty()||n.attr("clip-path",this.getClipPathUrl())}}const a=this.layerGroup.append("g").attr("class","thematika-outline-layer").append("path").datum(t).attr("d",this.path).attr("class",()=>["thematika-outline",this.attr.className||""].filter(Boolean).join(" "));this.applyAllStylesToElement(a,this.layerGroup)}getClipPathId(){return this.clipPathId}getClipPathUrl(){return`url(#${this.clipPathId})`}},t.PointAnnotationLayer=class extends s{constructor(t){super(`point-annotation-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,this.annotationType=t.annotationType||"callout",this.textAccessor=t.textAccessor||this.getDefaultTextAccessor(),this.titleAccessor=t.titleAccessor,this.offsetAccessor=t.offsetAccessor,this.subjectOptions=t.subjectOptions||{},this.connectorOptions=t.connectorOptions||{},this.noteOptions=t.noteOptions||{wrap:100,align:"dynamic"}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderAnnotations()}on(t,e){this.layerGroup&&this.layerGroup.selectAll(".annotation").on(t,function(t,r){e(t,r.feature)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderAnnotations()}getData(){return this.data}getDefaultTextAccessor(){return(t,e)=>{if(t.properties)for(const[e,r]of Object.entries(t.properties))if("string"==typeof r&&r.trim())return r;return`Point ${e+1}`}}getTextValue(t,e){return"string"==typeof this.textAccessor?t.properties?.[this.textAccessor]||`Point ${e+1}`:this.textAccessor(t,e)}getTitleValue(t,e){if(this.titleAccessor)return"string"==typeof this.titleAccessor?t.properties?.[this.titleAccessor]:this.titleAccessor(t,e)}getOffsetValue(t,e){return this.offsetAccessor?this.offsetAccessor(t,e):[30,-20]}resolveStyleValue(t,e,r,a){return void 0===t?a:"function"==typeof t?t(e,r):t}getSubjectType(){if(this.subjectOptions.type)return this.subjectOptions.type;switch(this.annotationType){case"calloutCircle":case"badge":return"circle";case"calloutRect":return"rect";default:return"point"}}prepareAnnotationData(){if(!this.projection)return[];return this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const a=this.projection(r);if(!a)return null;const[n,i]=this.getOffsetValue(t,e),o=this.getTextValue(t,e),s=this.getTitleValue(t,e);return{feature:t,index:e,x:a[0],y:a[1],text:o,title:s,dx:n,dy:i}}).filter(t=>null!==t)}renderAnnotations(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("*").remove();this.prepareAnnotationData().forEach((t,e)=>{this.drawSingleAnnotation(t,e)});const t=this.layerGroup.selectAll(".annotation");this.applyAllStylesToElement(t,this.layerGroup)}drawSingleAnnotation(t,e){const r=this.layerGroup.append("g").attr("class","annotation thematika-point-annotation").attr("transform",`translate(${t.x}, ${t.y})`);switch(this.drawSubject(r,t),this.annotationType){case"callout":case"calloutCircle":case"calloutRect":default:this.drawConnector(r,t,"line"),this.drawNote(r,t);break;case"calloutElbow":this.drawConnector(r,t,"elbow"),this.drawNote(r,t);break;case"calloutCurve":this.drawConnector(r,t,"curve"),this.drawNote(r,t);break;case"label":this.drawLabel(r,t);break;case"badge":this.drawBadgeText(r,t)}}drawSubject(t,e){const r=this.getSubjectType(),a=e.feature,n=e.index,i=this.resolveStyleValue(this.subjectOptions.fill,a,n,"#e74c3c"),o=this.resolveStyleValue(this.subjectOptions.stroke,a,n,"white"),s=this.resolveStyleValue(this.subjectOptions.strokeWidth,a,n,1),l=this.resolveStyleValue(this.subjectOptions.strokeDasharray,a,n,"none");switch(r){case"point":this.drawPointSubject(t,e,{fill:i,stroke:o,strokeWidth:s,strokeDasharray:l});break;case"circle":this.drawCircleSubject(t,e,{fill:i,stroke:o,strokeWidth:s,strokeDasharray:l});break;case"rect":this.drawRectSubject(t,e,{fill:i,stroke:o,strokeWidth:s,strokeDasharray:l})}}drawPointSubject(t,e,r){const a=this.resolveStyleValue(this.subjectOptions.r,e.feature,e.index,3);t.append("circle").attr("class","annotation-subject").attr("r",a).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawCircleSubject(t,e,r){const a=this.resolveStyleValue(this.subjectOptions.r,e.feature,e.index,this.subjectOptions.radius||8);t.append("circle").attr("class","annotation-subject").attr("r",a).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawRectSubject(t,e,r){const a=this.resolveStyleValue(this.subjectOptions.width,e.feature,e.index,16),n=this.resolveStyleValue(this.subjectOptions.height,e.feature,e.index,16);t.append("rect").attr("class","annotation-subject").attr("x",-a/2).attr("y",-n/2).attr("width",a).attr("height",n).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawConnector(t,e,r){const a=this.resolveStyleValue(this.connectorOptions.stroke,e.feature,e.index,"#666"),n=this.resolveStyleValue(this.connectorOptions.strokeWidth,e.feature,e.index,1),i=this.resolveStyleValue(this.connectorOptions.strokeDasharray,e.feature,e.index,"none");switch(r){case"line":t.append("line").attr("class","annotation-connector").attr("x1",0).attr("y1",0).attr("x2",e.dx).attr("y2",e.dy).attr("stroke",a).attr("stroke-width",n).attr("stroke-dasharray",i);break;case"elbow":const r=`M 0,0 L ${e.dx,e.dx},${e.dy>0?0:e.dy} L ${e.dx},${e.dy}`;t.append("path").attr("class","annotation-connector").attr("d",r).attr("fill","none").attr("stroke",a).attr("stroke-width",n).attr("stroke-dasharray",i);break;case"curve":const o=`M 0,0 Q ${.5*e.dx},${0} ${e.dx},${e.dy}`;t.append("path").attr("class","annotation-connector").attr("d",o).attr("fill","none").attr("stroke",a).attr("stroke-width",n).attr("stroke-dasharray",i)}}drawLabel(t,e){t.append("text").attr("class","annotation-note-text").attr("x",0).attr("y",e.dy).attr("text-anchor","middle").attr("dominant-baseline","central").style("font-size",this.noteOptions.fontSize||"12px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("fill",this.noteOptions.textColor||"black").html(e.text)}drawBadgeText(t,e){t.append("text").attr("class","annotation-badge-text").attr("text-anchor","middle").attr("dominant-baseline","central").style("font-size",this.noteOptions.fontSize||"10px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("font-weight","bold").style("fill",this.noteOptions.textColor||"white").html(e.text.substring(0,3))}drawNote(t,e){const r=this.noteOptions.padding||4,a=t.append("rect").attr("class","annotation-note-bg").attr("fill",this.noteOptions.backgroundColor||"white").attr("stroke",this.noteOptions.borderColor||"#ccc").attr("stroke-width",this.noteOptions.borderWidth||1).attr("rx",this.noteOptions.borderRadius||2),n=t.append("text").attr("class","annotation-note-text").attr("x",e.dx).attr("y",e.dy).attr("text-anchor",this.getTextAnchor(e.dx)).attr("dominant-baseline",this.getBaseline(e.dy)).style("font-size",this.noteOptions.fontSize||"12px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("fill",this.noteOptions.textColor||"black");e.title?(n.append("tspan").attr("x",e.dx).attr("dy",0).style("font-weight","bold").html(e.title),n.append("tspan").attr("x",e.dx).attr("dy","1.2em").html(e.text)):n.html(e.text),setTimeout(()=>{const t=n.node()?.getBBox();t&&a.attr("x",t.x-r).attr("y",t.y-r).attr("width",t.width+2*r).attr("height",t.height+2*r)},0)}getTextAnchor(t){return t>0?"start":t<0?"end":"middle"}getBaseline(t){return t>0?"hanging":t<0?"alphabetic":"central"}},t.PointCircleLayer=class extends s{constructor(t){if(super(`point-circle-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,"function"==typeof t.r)this.radiusFunction=t.r;else{const e=t.r||5;this.radiusFunction=()=>e}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderCircles()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("circle").on(t,function(t,r){e(t,r)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderCircles()}renderCircles(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-circle-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const a=this.projection(r);return{feature:t,index:e,x:a?a[0]:0,y:a?a[1]:0,r:this.radiusFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y),e=this.layerGroup.append("g").attr("class","thematika-point-circle-layer").selectAll("circle").data(t).enter().append("circle").attr("cx",t=>t.x).attr("cy",t=>t.y).attr("r",t=>t.r).attr("class",t=>["thematika-point-circle",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(e,this.layerGroup)}getData(){return this.data}},t.PointSpikeLayer=class extends s{constructor(t){if(super(`point-spike-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,"function"==typeof t.length)this.lengthFunction=t.length;else{const e=t.length||50;this.lengthFunction=()=>e}this.direction=t.direction||"up"}render(t){this.layerGroup=this.createLayerGroup(t),this.renderSpikes()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("path").on(t,function(t,r){e(t,r)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderSpikes()}renderSpikes(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-spike-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const a=this.projection(r);return{feature:t,index:e,x:a?a[0]:0,y:a?a[1]:0,length:this.lengthFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y),e=this.layerGroup.append("g").attr("class","thematika-point-spike-layer").selectAll("path").data(t).enter().append("path").attr("transform",t=>`translate(${t.x},${t.y})`).attr("d",t=>this.generateSpikePath(t.length)).attr("class",t=>["thematika-point-spike",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(e,this.layerGroup)}generateSpikePath(t){const e=.2*t;switch(this.direction){case"up":default:return`M 0,0 L ${-e/2},0 L 0,${-t} L ${e/2},0 Z`;case"down":return`M 0,0 L ${-e/2},0 L 0,${t} L ${e/2},0 Z`;case"left":return`M 0,0 L 0,${-e/2} L ${-t},0 L 0,${e/2} Z`;case"right":return`M 0,0 L 0,${-e/2} L ${t},0 L 0,${e/2} Z`}}getData(){return this.data}},t.PointTextLayer=class extends s{constructor(t){if(super(`point-text-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,this.textProperty=t.textProperty||"text","function"==typeof t.dx)this.dxFunction=t.dx;else{const e=t.dx||0;this.dxFunction=()=>e}if("function"==typeof t.dy)this.dyFunction=t.dy;else{const e=t.dy||0;this.dyFunction=()=>e}if("function"==typeof t.rotate)this.rotateFunction=t.rotate;else{const e=t.rotate||0;this.rotateFunction=()=>e}if(this.lengthAdjust=t.lengthAdjust||"spacing",this.alignmentBaseline=t.alignmentBaseline||"middle",this.textAnchor=t.textAnchor||"start","function"==typeof t.fontFamily)this.fontFamilyFunction=t.fontFamily;else{const e=t.fontFamily||"メイリオ, Meiryo, 'ＭＳ Ｐゴシック', MS Gothic, sans-serif";this.fontFamilyFunction=()=>e}if("function"==typeof t.fontSize)this.fontSizeFunction=t.fontSize;else{const e=t.fontSize||16;this.fontSizeFunction=()=>e}if("function"==typeof t.fontWeight)this.fontWeightFunction=t.fontWeight;else{const e=t.fontWeight||"normal";this.fontWeightFunction=()=>e}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderTexts()}on(t,e){this.layerGroup&&this.layerGroup.selectAll("text").on(t,function(t,r){e(t,r)})}setProjection(t){this.projection=t,this.layerGroup&&this.renderTexts()}renderTexts(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-text-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const a=this.projection?this.projection(r):null;let n="";return t.properties&&(n=t.properties[this.textProperty]||t.properties.name||""),{feature:t,index:e,text:String(n),x:a?a[0]:0,y:a?a[1]:0,dx:this.dxFunction(t,e),dy:this.dyFunction(t,e),rotate:this.rotateFunction(t,e),fontFamily:this.fontFamilyFunction(t,e),fontSize:this.fontSizeFunction(t,e),fontWeight:this.fontWeightFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y&&""!==t.text),e=this.layerGroup.append("g").attr("class","thematika-point-text-layer").selectAll("text").data(t).enter().append("text").attr("x",t=>t.x).attr("y",t=>t.y).attr("dx",t=>t.dx).attr("dy",t=>t.dy).attr("transform",t=>0!==t.rotate?`rotate(${t.rotate}, ${t.x}, ${t.y})`:null).attr("lengthAdjust",this.lengthAdjust).attr("alignment-baseline",this.alignmentBaseline).attr("text-anchor",this.textAnchor).attr("font-family",t=>t.fontFamily).attr("font-size",t=>t.fontSize).attr("font-weight",t=>t.fontWeight).attr("class",t=>["thematika-point-text",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" ")).text(t=>t.text);this.applyAllStylesToElements(e,this.layerGroup)}getData(){return this.data}},t.TailwindPalettes=Q,t.TexturePresets=N,t.ViridissPalettes=Z,t.calculateOptimalZoom=function(t,e,r,a={}){try{const[n,i,o,s]=t;if(!Array.isArray(t)||4!==t.length)throw new Error("boundsは[west, south, east, north]の形式で指定してください");if(!t.every(t=>isFinite(t)))throw new Error("boundsの値は有効な数値で指定してください");if(n>=o||i>=s)throw new Error("無効な境界が指定されました（west < east, south < northである必要があります）");if(!isFinite(e)||!isFinite(r)||e<=0||r<=0)throw new Error("地図のサイズは正の数値で指定してください");const l=a.minZoom??0,c=a.maxZoom??18,h=a.tileSize??256,d=o-n,u=s-i,p=(s+i)/2*Math.PI/180,f=U*Math.cos(p)/360,y=d*f,g=u*111319.49079444444;let m=l;for(let t=l;t<=c;t++){const a=U/(h*Math.pow(2,t));if(!(y/a<=e&&g/a<=r))break;m=t}return Math.max(l,Math.min(c,m))}catch(t){throw new Error(`最適ズームレベルの計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.chainFilters=function(t){return t.map(t=>`url(#${t})`).join(" ")},t.checkColorBlindnessSafety=function(t){const e=["protanopia","deuteranopia","tritanopia"];for(const r of e){const e=t.map(t=>tt(t,r));for(let t=0;t<e.length;t++)for(let r=t+1;r<e.length;r++){if(rt(e[t],e[r])<50)return!1}}return!0},t.createBloom=$,t.createClipPolygon=function(t){const e=e=>{const a=r.geoPath(t.projection),n=e.append("clipPath").attr("id",t.id);if("Feature"===t.polygon.type){const e=a(t.polygon);e&&n.append("path").attr("d",e)}else"FeatureCollection"===t.polygon.type&&t.polygon.features.forEach((t,e)=>{const r=a(t);r&&n.append("path").attr("d",r).attr("class",`clip-path-${e}`)})};return e.url=()=>B(t.id),e},t.createCustomFilter=function(t,e){return r=>{r.append("defs").html(`<filter id="${t}">${e}</filter>`)}},t.createDesertTexture=W,t.createDotsTexture=T,t.createDropShadow=A,t.createForestTexture=R,t.createGaussianBlur=E,t.createLinesTexture=D,t.createMountainTexture=q,t.createOceanTexture=O,t.createPathsTexture=I,t.expandBbox=function(t,e=.1){const{width:r,height:a}=C(t),n=r*e,i=a*e;return{minX:t.minX-n,minY:t.minY-i,maxX:t.maxX+n,maxY:t.maxY+i}},t.generateOptimizedPalette=function(t,e){if(e<=t.colors.length){if("categorical"===t.type)return t.colors.slice(0,e);return Array.from({length:e},(r,a)=>Math.floor(a*(t.colors.length-1)/(e-1))).map(e=>t.colors[e])}return t.colors},t.generateTileUrls=function(t,e,r){try{const[a,n,i,o]=t;if(!Array.isArray(t)||4!==t.length)throw new Error("boundsは[west, south, east, north]の形式で指定してください");if(!t.every(t=>isFinite(t)))throw new Error("boundsの値は有効な数値で指定してください");if(a>=i||n>=o)throw new Error("無効な境界が指定されました（west < east, south < northである必要があります）");if(!(r.urlTemplate&&r.urlTemplate.includes("{x}")&&r.urlTemplate.includes("{y}")&&r.urlTemplate.includes("{z}")))throw new Error("URLテンプレートには{x}, {y}, {z}のプレースホルダーを含める必要があります");const s=r.minZoom??0,l=r.maxZoom??18,c=r.clampToBounds??!0;if(e<s||e>l)throw new Error(`ズームレベル${e}は許可範囲（${s}〜${l}）外です`);const h=Y(a,o,e),d=Y(i,n,e),u=Math.min(h.x,d.x),p=Math.max(h.x,d.x),f=Math.min(h.y,d.y),y=Math.max(h.y,d.y),g=[];for(let t=u;t<=p;t++)for(let s=f;s<=y;s++)try{const l=X(t,s,e);if(c){const t=l.west,e=l.east,r=l.south,s=l.north;if(e<=a||t>=i||s<=n||r>=o)continue}const h=r.urlTemplate.replace("{x}",t.toString()).replace("{y}",s.toString()).replace("{z}",e.toString());g.push({coordinate:{x:t,y:s,z:e},url:h,bounds:l})}catch(r){console.warn(`タイル(${t}, ${s}, ${e})の生成をスキップしました:`,r)}return 0===g.length&&console.warn("指定された範囲に有効なタイルが見つかりませんでした"),g}catch(t){throw new Error(`タイルURL生成に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.getBbox=function(t){const e=[];if("Feature"===t.type?e.push(...M(t.geometry)):"FeatureCollection"===t.type?t.features.forEach(t=>{e.push(...M(t.geometry))}):("coordinates"in t||"geometries"in t)&&e.push(...M(t)),0===e.length)return{minX:0,minY:0,maxX:0,maxY:0};const[r,a,n,i]=function(t){let e=1/0,r=1/0,a=-1/0,n=-1/0;for(const[i,o]of t)e=Math.min(e,i),r=Math.min(r,o),a=Math.max(a,i),n=Math.max(n,o);return[e,r,a,n]}(e);return{minX:r,minY:a,maxX:n,maxY:i}},t.getBboxCenter=function(t){return{x:(t.minX+t.maxX)/2,y:(t.minY+t.maxY)/2}},t.getBboxDimensions=C,t.getCentroid=L,t.getFilterUrl=B,t.getResolution=function(t,e=0,r=256){try{if(!isFinite(t)||t<0)throw new Error("無効なズームレベルが指定されました");if(!isFinite(e)||e<-90||e>90)throw new Error("無効な緯度が指定されました");if(!isFinite(r)||r<=0)throw new Error("無効なタイルサイズが指定されました");const a=e*Math.PI/180,n=U/(r*Math.pow(2,t));return n*Math.cos(a)}catch(t){throw new Error(`解像度の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.getTileBounds=X,t.getTileXYZ=Y,t.isValidGeoJSON=function(t){try{if(!t||"object"!=typeof t)return!1;return["Feature","FeatureCollection","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"].includes(t.type)}catch{return!1}},t.isValidTileCoordinate=function(t,e,r){if(!Number.isInteger(t)||!Number.isInteger(e)||!Number.isInteger(r))return!1;if(r<0||r>30)return!1;const a=Math.pow(2,r);return t>=0&&t<a&&e>=0&&e<a},t.logTestResult=function(t,e=!1){console.log("=== 座標変換テスト結果 ==="),console.log(`総座標数: ${t.totalCoords}`),console.log(`正常座標数: ${t.normalCoords}`),console.log(`異常座標数: ${t.abnormalCoords}`),console.log(t.summary),e&&t.abnormalCoords>0&&(console.warn("異常値の詳細:"),t.abnormalDetails.forEach((t,e)=>{console.warn(`  ${e+1}. ${t.featureName}: [${t.originalCoord}] → [${t.projectedCoord.map(t=>t.toFixed(2))}] (${t.outOfBounds.x}, ${t.outOfBounds.y})`)}))},t.merge=function(t){const e=[];return t.forEach(t=>{"Feature"===t.type?e.push(t):"FeatureCollection"===t.type?e.push(...t.features):("coordinates"in t||"geometries"in t)&&e.push({type:"Feature",properties:{},geometry:t})}),{type:"FeatureCollection",features:e}},t.mergeBbox=function(t,e){return{minX:Math.min(t.minX,e.minX),minY:Math.min(t.minY,e.minY),maxX:Math.max(t.maxX,e.maxX),maxY:Math.max(t.maxY,e.maxY)}},t.readCOG=async function(t,e={}){const{resampleMethod:r="nearest",imageIndex:a=0,samples:n=[0,1,2],pool:o,sizeLimit:s={maxWidth:512,maxHeight:512,onExceed:"resample"},outputWidth:l,outputHeight:c,bbox:h}=e,d=s.maxWidth??512,u=s.maxHeight??512,p=s.onExceed??"resample";try{const e=await i.fromUrl(t),s=await e.getImageCount();if(a>=s)throw new Error(`画像インデックス ${a} は範囲外です。利用可能なインデックス: 0-${s-1}`);const f=await e.getImage(a),y=f.getWidth(),g=f.getHeight();let m,x;try{m=f.getBoundingBox(),x=[m[0],m[1],m[2],m[3]]}catch(t){m=(await e.getImage(0)).getBoundingBox(),x=[m[0],m[1],m[2],m[3]]}let w=l??y,b=c??g,S=!1;if(w>d||b>u){if("error"===p)throw new Error(`画像サイズ（${y}x${g}）が制限（${d}x${u}）を超えています`);const t=y/g;w/b>t?(b=u,w=Math.floor(b*t)):(w=d,b=Math.floor(w/t)),S=!0}(l||c)&&(S=!0);const k={samples:n,pool:o,interleave:!0};if(h){const[t,e,r,a]=h,[n,i,o,s]=m,l=Math.floor((t-n)/(o-n)*y),c=Math.ceil((r-n)/(o-n)*y),d=Math.floor((s-a)/(s-i)*g),u=Math.ceil((s-e)/(s-i)*g);k.window=[Math.max(0,l),Math.max(0,d),Math.min(y,c),Math.min(g,u)],w=k.window[2]-k.window[0],b=k.window[3]-k.window[1];const p=n+k.window[0]/y*(o-n),f=n+k.window[2]/y*(o-n),S=s-k.window[1]/g*(s-i);x=[p,s-k.window[3]/g*(s-i),f,S]}if(S||w>d||b>u){const t=w/b;(w>d||b>u)&&(w/b>t?(b=u,w=Math.floor(b*t)):(w=d,b=Math.floor(w/t)),S=!0),k.width=w,k.height=b,k.resampleMethod=r}let v,M,L;try{v=await f.readRGB(k),M=v.width,L=v.height}catch(t){if(v=await f.readRasters(k),M=v.width,L=v.height,Array.isArray(v)){const t=Math.min(3,v.length),e=M*L,r=new Uint8Array(3*e);for(let a=0;a<e;a++){for(let e=0;e<t;e++)r[3*a+e]=v[e][a]||0;for(let e=t;e<3;e++)r[3*a+e]=0}v=r}}const C=document.createElement("canvas");C.width=M,C.height=L;const E=C.getContext("2d");if(!E)throw new Error("Canvas contextの取得に失敗しました");const A=E.createImageData(M,L),$=A.data,z=v,B=M*L;for(let t=0;t<B;t++){const e=4*t,r=3*t;if(r+2<z.length)$[e]=z[r]||0,$[e+1]=z[r+1]||0,$[e+2]=z[r+2]||0;else{const r=z[t]||0;$[e]=r,$[e+1]=r,$[e+2]=r}$[e+3]=255}E.putImageData(A,0,0);return{dataUri:C.toDataURL("image/png"),bounds:x,width:M,height:L,originalWidth:y,originalHeight:g,wasResampled:S}}catch(t){throw new Error(`COGの読み込みに失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.recommendPalette=function(t,e,r=!0){return Object.values(K).filter(a=>a.type===t&&(!(a.maxClasses&&e>a.maxClasses)&&!(r&&!a.colorBlindSafe))).map(t=>{let r=100,a=`${t.name} - ${t.description}`;if(t.maxClasses){r*=1-Math.abs(e-t.maxClasses)/t.maxClasses}return t.colorBlindSafe&&(r*=1.2,a+=" (色覚障害対応)"),{palette:t,score:r,reason:a}}).sort((t,e)=>e.score-t.score)},t.simulateColorBlindness=tt,t.testProjectionBounds=function(t,e){try{let r=1/0,a=-1/0,n=1/0,i=-1/0;e.features.forEach(e=>{V(e.geometry,"",t,0,0,t=>{const[e,o]=t;r=Math.min(r,e),a=Math.max(a,e),n=Math.min(n,o),i=Math.max(i,o)})});const o=[[r,n],[a,n],[a,i],[r,i]],s=o.map(e=>t(e)).filter(t=>null!==t);return s.length===o.length?{isValid:!0,message:"✅ 投影法の境界設定は正常です"}:{isValid:!1,message:`⚠️ 投影法で変換できない座標があります (${o.length-s.length}個)`}}catch(t){return{isValid:!1,message:`❌ 境界テスト中にエラーが発生しました: ${t instanceof Error?t.message:"Unknown error"}`}}},t.testProjectionTransform=function(t,e,r,a){let n=0,i=0;const o=[];a.features.forEach(a=>{const s=a.properties?.name||`Feature ${a.id||"unknown"}`;V(a.geometry,s,r,t,e,(t,e,r,a,s)=>{const l=r([t[0],t[1]]);l&&(n++,(l[0]<0||l[0]>a||l[1]<0||l[1]>s)&&(i++,o.push({featureName:e,originalCoord:[t[0],t[1]],projectedCoord:[l[0],l[1]],outOfBounds:{x:l[0]<0?"x < 0":l[0]>a?`x > ${a}`:"x OK",y:l[1]<0?"y < 0":l[1]>s?`y > ${s}`:"y OK"}})))})});const s=0===i;return{totalCoords:n,normalCoords:n-i,abnormalCoords:i,abnormalDetails:o,isValid:s,summary:s?`✅ すべての座標が正常範囲内です (0-${t} × 0-${e})`:`⚠️ ${i}個の座標が範囲外です`}},t.textures=F});
//# sourceMappingURL=thematika.umd.js.map
