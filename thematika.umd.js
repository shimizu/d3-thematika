!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-geo"),require("d3-shape"),require("d3-force"),require("geotiff")):"function"==typeof define&&define.amd?define(["exports","d3-selection","d3-geo","d3-shape","d3-force","geotiff"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Thematika={},t.d3,t.d3,t.d3,t.d3,t.GeoTIFF)}(this,function(t,e,r,n,i,a){"use strict";class s{constructor(){this.layerInstances=new Map}setContext(t,e){this.svgContainer=t,this.projection=e}addLayer(t,e){if(!this.svgContainer)throw new Error("SVG container not set. Call setContext() first.");this.projection&&this.isGeojsonLayer(e)&&e.setProjection(this.projection),e.zIndex=this.getNextZIndex(),e.render(this.svgContainer),this.layerInstances.set(t,e)}removeLayer(t){const e=this.layerInstances.get(t);e&&(e.destroy(),this.layerInstances.delete(t))}setLayerVisibility(t,e){const r=this.layerInstances.get(t);r&&r.setVisible(e)}setLayerZIndex(t,e){const r=this.layerInstances.get(t);if(r){const t=r.zIndex;r.setZIndex(e),t!==e&&this.reorderLayersOptimized()}}getLayer(t){return this.layerInstances.get(t)}getLayerIds(){return Array.from(this.layerInstances.keys())}clearAllLayers(){this.layerInstances.forEach(t=>t.destroy()),this.layerInstances.clear()}rerenderAllLayers(){if(this.svgContainer){Array.from(this.layerInstances.values()).sort((t,e)=>t.zIndex-e.zIndex).forEach(t=>{t.destroy(),this.projection&&this.isGeojsonLayer(t)&&t.setProjection(this.projection),t.render(this.svgContainer)})}}reorderLayersOptimized(){const t=[];if(Array.from(this.layerInstances.values()).filter(t=>t.isRendered()).forEach(e=>{const r=this.getLayerElement(e);r&&t.push({element:r,zIndex:e.zIndex})}),0===t.length)return;t.sort((t,e)=>t.zIndex-e.zIndex);const e=t[0].element.parentNode;e&&t.forEach(({element:t})=>{e.appendChild(t)})}updateProjection(t){this.projection=t,this.layerInstances.forEach(e=>{this.isGeojsonLayer(e)&&e.setProjection(t)})}getNextZIndex(){if(0===this.layerInstances.size)return 0;return Math.max(...Array.from(this.layerInstances.values()).map(t=>t.zIndex))+1}isGeojsonLayer(t){return"setProjection"in t}getLayerElement(t){if("element"in t)return t.element}}class o{constructor(t,e={},r){this.visible=!0,this.zIndex=0,this.id=t,this.attr={fill:"#cccccc",stroke:"#333333",strokeWidth:.5,opacity:1,...e},this.style=r}destroy(){this.element&&(this.element.remove(),this.element=void 0)}setVisible(t){this.visible=t,this.updateVisibility()}setZIndex(t){this.zIndex=t}isRendered(){return void 0!==this.element}getLayerGroup(){return this.element?e.select(this.element):null}updateVisibility(){if(!this.element)return;e.select(this.element).style("display",this.visible?"":"none")}createLayerGroup(t){const e=t.append("g").attr("class",`thematika-layer thematika-layer--${this.id}`).style("display",this.visible?"":"none");return this.element=e.node(),e}applyAttributesToElement(t,e){Object.entries(this.attr).forEach(([t,r])=>{if(void 0!==r){const n="function"==typeof r?r({},0):r;e.attr(t,n)}})}applyStylesToElement(t,e){this.style&&Object.entries(this.style).forEach(([t,r])=>{if(void 0!==r){const n="function"==typeof r?r({},0):r;e.style(t,n)}})}applyAllStylesToElement(t,e){this.applyAttributesToElement(t,e),this.applyStylesToElement(t,e)}applyAttributesToElements(t,e){Object.entries(this.attr).forEach(([r,n])=>{void 0!==n&&("function"==typeof n?t.attr(r,(t,e)=>n(t,e)):e.attr(r,n))})}applyStylesToElements(t,e){this.style&&Object.entries(this.style).forEach(([r,n])=>{void 0!==n&&("function"==typeof n?t.style(r,(t,e)=>n(t,e)):e.style(r,n))})}applyAllStylesToElements(t,e){this.applyAttributesToElements(t,e),this.applyStylesToElements(t,e)}}var l={value:()=>{}};function c(){for(var t,e=0,r=arguments.length,n={};e<r;++e){if(!(t=arguments[e]+"")||t in n||/[\s.]/.test(t))throw new Error("illegal type: "+t);n[t]=[]}return new h(n)}function h(t){this._=t}function d(t,e){for(var r,n=0,i=t.length;n<i;++n)if((r=t[n]).name===e)return r.value}function u(t,e,r){for(var n=0,i=t.length;n<i;++n)if(t[n].name===e){t[n]=l,t=t.slice(0,n).concat(t.slice(n+1));break}return null!=r&&t.push({name:e,value:r}),t}h.prototype=c.prototype={constructor:h,on:function(t,e){var r,n,i=this._,a=(n=i,(t+"").trim().split(/^|\s+/).map(function(t){var e="",r=t.indexOf(".");if(r>=0&&(e=t.slice(r+1),t=t.slice(0,r)),t&&!n.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:e}})),s=-1,o=a.length;if(!(arguments.length<2)){if(null!=e&&"function"!=typeof e)throw new Error("invalid callback: "+e);for(;++s<o;)if(r=(t=a[s]).type)i[r]=u(i[r],t.name,e);else if(null==e)for(r in i)i[r]=u(i[r],t.name,null);return this}for(;++s<o;)if((r=(t=a[s]).type)&&(r=d(i[r],t.name)))return r},copy:function(){var t={},e=this._;for(var r in e)t[r]=e[r].slice();return new h(t)},call:function(t,e){if((r=arguments.length-2)>0)for(var r,n,i=new Array(r),a=0;a<r;++a)i[a]=arguments[a+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(a=0,r=(n=this._[t]).length;a<r;++a)n[a].value.apply(e,i)},apply:function(t,e,r){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var n=this._[t],i=0,a=n.length;i<a;++i)n[i].value.apply(e,r)}};const f={passive:!1},p={capture:!0,passive:!1};function y(t){t.stopImmediatePropagation()}function g(t){t.preventDefault(),t.stopImmediatePropagation()}var m=t=>()=>t;function x(t,{sourceEvent:e,subject:r,target:n,identifier:i,active:a,x:s,y:o,dx:l,dy:c,dispatch:h}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},subject:{value:r,enumerable:!0,configurable:!0},target:{value:n,enumerable:!0,configurable:!0},identifier:{value:i,enumerable:!0,configurable:!0},active:{value:a,enumerable:!0,configurable:!0},x:{value:s,enumerable:!0,configurable:!0},y:{value:o,enumerable:!0,configurable:!0},dx:{value:l,enumerable:!0,configurable:!0},dy:{value:c,enumerable:!0,configurable:!0},_:{value:h}})}function w(t){return!t.ctrlKey&&!t.button}function b(){return this.parentNode}function S(t,e){return null==e?{x:t.x,y:t.y}:e}function v(){return navigator.maxTouchPoints||"ontouchstart"in this}function k(){var t,r,n,i,a=w,s=b,o=S,l=v,h={},d=c("start","drag","end"),u=0,k=0;function M(t){t.on("mousedown.drag",L).filter(l).on("touchstart.drag",$).on("touchmove.drag",E,f).on("touchend.drag touchcancel.drag",z).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function L(o,l){if(!i&&a.call(this,o,l)){var c,h,d,u=P(this,s.call(this,o,l),o,l,"mouse");if(u)e.select(o.view).on("mousemove.drag",A,p).on("mouseup.drag",C,p),c=o.view,h=c.document.documentElement,d=e.select(c).on("dragstart.drag",g,p),"onselectstart"in h?d.on("selectstart.drag",g,p):(h.__noselect=h.style.MozUserSelect,h.style.MozUserSelect="none"),y(o),n=!1,t=o.clientX,r=o.clientY,u("start",o)}}function A(e){if(g(e),!n){var i=e.clientX-t,a=e.clientY-r;n=i*i+a*a>k}h.mouse("drag",e)}function C(t){var r,i,a,s;e.select(t.view).on("mousemove.drag mouseup.drag",null),r=t.view,i=n,a=r.document.documentElement,s=e.select(r).on("dragstart.drag",null),i&&(s.on("click.drag",g,p),setTimeout(function(){s.on("click.drag",null)},0)),"onselectstart"in a?s.on("selectstart.drag",null):(a.style.MozUserSelect=a.__noselect,delete a.__noselect),g(t),h.mouse("end",t)}function $(t,e){if(a.call(this,t,e)){var r,n,i=t.changedTouches,o=s.call(this,t,e),l=i.length;for(r=0;r<l;++r)(n=P(this,o,t,e,i[r].identifier,i[r]))&&(y(t),n("start",t,i[r]))}}function E(t){var e,r,n=t.changedTouches,i=n.length;for(e=0;e<i;++e)(r=h[n[e].identifier])&&(g(t),r("drag",t,n[e]))}function z(t){var e,r,n=t.changedTouches,a=n.length;for(i&&clearTimeout(i),i=setTimeout(function(){i=null},500),e=0;e<a;++e)(r=h[n[e].identifier])&&(y(t),r("end",t,n[e]))}function P(t,r,n,i,a,s){var l,c,f,p=d.copy(),y=e.pointer(s||n,r);if(null!=(f=o.call(t,new x("beforestart",{sourceEvent:n,target:M,identifier:a,active:u,x:y[0],y:y[1],dx:0,dy:0,dispatch:p}),i)))return l=f.x-y[0]||0,c=f.y-y[1]||0,function n(s,o,d){var g,m=y;switch(s){case"start":h[a]=n,g=u++;break;case"end":delete h[a],--u;case"drag":y=e.pointer(d||o,r),g=u}p.call(s,t,new x(s,{sourceEvent:o,subject:f,target:M,identifier:a,active:g,x:y[0]+l,y:y[1]+c,dx:y[0]-m[0],dy:y[1]-m[1],dispatch:p}),i)}}return M.filter=function(t){return arguments.length?(a="function"==typeof t?t:m(!!t),M):a},M.container=function(t){return arguments.length?(s="function"==typeof t?t:m(t),M):s},M.subject=function(t){return arguments.length?(o="function"==typeof t?t:m(t),M):o},M.touchable=function(t){return arguments.length?(l="function"==typeof t?t:m(!!t),M):l},M.on=function(){var t=d.on.apply(d,arguments);return t===d?M:t},M.clickDistance=function(t){return arguments.length?(k=(t=+t)*t,M):Math.sqrt(k)},M}x.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};function M(t){const e=[];switch(t.type){case"Point":e.push(t.coordinates);break;case"LineString":case"MultiPoint":e.push(...t.coordinates);break;case"Polygon":t.coordinates.forEach(t=>e.push(...t));break;case"MultiLineString":t.coordinates.forEach(t=>e.push(...t));break;case"MultiPolygon":t.coordinates.forEach(t=>t.forEach(t=>e.push(...t)));break;case"GeometryCollection":t.geometries.forEach(t=>e.push(...M(t)))}return e}function L(t){const e=[];if("Feature"===t.type?e.push(...M(t.geometry)):"FeatureCollection"===t.type?t.features.forEach(t=>{e.push(...M(t.geometry))}):("coordinates"in t||"geometries"in t)&&e.push(...M(t)),0===e.length)return{x:0,y:0};let r=0,n=0;for(const[t,i]of e)r+=t,n+=i;return{x:r/e.length,y:n/e.length}}function A(t){return{width:t.maxX-t.minX,height:t.maxY-t.minY}}const C=134217729;function $(t,e,r,n,i){let a,s,o,l,c=e[0],h=n[0],d=0,u=0;h>c==h>-c?(a=c,c=e[++d]):(a=h,h=n[++u]);let f=0;if(d<t&&u<r)for(h>c==h>-c?(s=c+a,o=a-(s-c),c=e[++d]):(s=h+a,o=a-(s-h),h=n[++u]),a=s,0!==o&&(i[f++]=o);d<t&&u<r;)h>c==h>-c?(s=a+c,l=s-a,o=a-(s-l)+(c-l),c=e[++d]):(s=a+h,l=s-a,o=a-(s-l)+(h-l),h=n[++u]),a=s,0!==o&&(i[f++]=o);for(;d<t;)s=a+c,l=s-a,o=a-(s-l)+(c-l),c=e[++d],a=s,0!==o&&(i[f++]=o);for(;u<r;)s=a+h,l=s-a,o=a-(s-l)+(h-l),h=n[++u],a=s,0!==o&&(i[f++]=o);return 0===a&&0!==f||(i[f++]=a),f}function E(t){return new Float64Array(t)}const z=E(4),P=E(8),B=E(12),T=E(16),j=E(4);function G(t,e,r,n,i,a){const s=(e-a)*(r-i),o=(t-i)*(n-a),l=s-o,c=Math.abs(s+o);return Math.abs(l)>=33306690738754716e-32*c?l:-function(t,e,r,n,i,a,s){let o,l,c,h,d,u,f,p,y,g,m,x,w,b,S,v,k,M;const L=t-i,A=r-i,E=e-a,G=n-a;b=L*G,u=C*L,f=u-(u-L),p=L-f,u=C*G,y=u-(u-G),g=G-y,S=p*g-(b-f*y-p*y-f*g),v=E*A,u=C*E,f=u-(u-E),p=E-f,u=C*A,y=u-(u-A),g=A-y,k=p*g-(v-f*y-p*y-f*g),m=S-k,d=S-m,z[0]=S-(m+d)+(d-k),x=b+m,d=x-b,w=b-(x-d)+(m-d),m=w-v,d=w-m,z[1]=w-(m+d)+(d-v),M=x+m,d=M-x,z[2]=x-(M-d)+(m-d),z[3]=M;let _=function(t,e){let r=e[0];for(let n=1;n<t;n++)r+=e[n];return r}(4,z),F=22204460492503146e-32*s;if(_>=F||-_>=F)return _;if(d=t-L,o=t-(L+d)+(d-i),d=r-A,c=r-(A+d)+(d-i),d=e-E,l=e-(E+d)+(d-a),d=n-G,h=n-(G+d)+(d-a),0===o&&0===l&&0===c&&0===h)return _;if(F=11093356479670487e-47*s+33306690738754706e-32*Math.abs(_),_+=L*h+G*o-(E*c+A*l),_>=F||-_>=F)return _;b=o*G,u=C*o,f=u-(u-o),p=o-f,u=C*G,y=u-(u-G),g=G-y,S=p*g-(b-f*y-p*y-f*g),v=l*A,u=C*l,f=u-(u-l),p=l-f,u=C*A,y=u-(u-A),g=A-y,k=p*g-(v-f*y-p*y-f*g),m=S-k,d=S-m,j[0]=S-(m+d)+(d-k),x=b+m,d=x-b,w=b-(x-d)+(m-d),m=w-v,d=w-m,j[1]=w-(m+d)+(d-v),M=x+m,d=M-x,j[2]=x-(M-d)+(m-d),j[3]=M;const D=$(4,z,4,j,P);b=L*h,u=C*L,f=u-(u-L),p=L-f,u=C*h,y=u-(u-h),g=h-y,S=p*g-(b-f*y-p*y-f*g),v=E*c,u=C*E,f=u-(u-E),p=E-f,u=C*c,y=u-(u-c),g=c-y,k=p*g-(v-f*y-p*y-f*g),m=S-k,d=S-m,j[0]=S-(m+d)+(d-k),x=b+m,d=x-b,w=b-(x-d)+(m-d),m=w-v,d=w-m,j[1]=w-(m+d)+(d-v),M=x+m,d=M-x,j[2]=x-(M-d)+(m-d),j[3]=M;const I=$(D,P,4,j,B);b=o*h,u=C*o,f=u-(u-o),p=o-f,u=C*h,y=u-(u-h),g=h-y,S=p*g-(b-f*y-p*y-f*g),v=l*c,u=C*l,f=u-(u-l),p=l-f,u=C*c,y=u-(u-c),g=c-y,k=p*g-(v-f*y-p*y-f*g),m=S-k,d=S-m,j[0]=S-(m+d)+(d-k),x=b+m,d=x-b,w=b-(x-d)+(m-d),m=w-v,d=w-m,j[1]=w-(m+d)+(d-v),M=x+m,d=M-x,j[2]=x-(M-d)+(m-d),j[3]=M;const O=$(I,B,4,j,T);return T[O-1]}(t,e,r,n,i,a,c)}const _=Math.pow(2,-52),F=new Uint32Array(512);class D{static from(t,e=V,r=N){const n=t.length,i=new Float64Array(2*n);for(let a=0;a<n;a++){const n=t[a];i[2*a]=e(n),i[2*a+1]=r(n)}return new D(i)}constructor(t){const e=t.length>>1;if(e>0&&"number"!=typeof t[0])throw new Error("Expected coords to contain numbers.");this.coords=t;const r=Math.max(2*e-5,0);this._triangles=new Uint32Array(3*r),this._halfedges=new Int32Array(3*r),this._hashSize=Math.ceil(Math.sqrt(e)),this._hullPrev=new Uint32Array(e),this._hullNext=new Uint32Array(e),this._hullTri=new Uint32Array(e),this._hullHash=new Int32Array(this._hashSize),this._ids=new Uint32Array(e),this._dists=new Float64Array(e),this.update()}update(){const{coords:t,_hullPrev:e,_hullNext:r,_hullTri:n,_hullHash:i}=this,a=t.length>>1;let s=1/0,o=1/0,l=-1/0,c=-1/0;for(let e=0;e<a;e++){const r=t[2*e],n=t[2*e+1];r<s&&(s=r),n<o&&(o=n),r>l&&(l=r),n>c&&(c=n),this._ids[e]=e}const h=(s+l)/2,d=(o+c)/2;let u,f,p;for(let e=0,r=1/0;e<a;e++){const n=I(h,d,t[2*e],t[2*e+1]);n<r&&(u=e,r=n)}const y=t[2*u],g=t[2*u+1];for(let e=0,r=1/0;e<a;e++){if(e===u)continue;const n=I(y,g,t[2*e],t[2*e+1]);n<r&&n>0&&(f=e,r=n)}let m=t[2*f],x=t[2*f+1],w=1/0;for(let e=0;e<a;e++){if(e===u||e===f)continue;const r=R(y,g,m,x,t[2*e],t[2*e+1]);r<w&&(p=e,w=r)}let b=t[2*p],S=t[2*p+1];if(w===1/0){for(let e=0;e<a;e++)this._dists[e]=t[2*e]-t[0]||t[2*e+1]-t[1];W(this._ids,this._dists,0,a-1);const e=new Uint32Array(a);let r=0;for(let t=0,n=-1/0;t<a;t++){const i=this._ids[t],a=this._dists[i];a>n&&(e[r++]=i,n=a)}return this.hull=e.subarray(0,r),this.triangles=new Uint32Array(0),void(this.halfedges=new Uint32Array(0))}if(G(y,g,m,x,b,S)<0){const t=f,e=m,r=x;f=p,m=b,x=S,p=t,b=e,S=r}const v=function(t,e,r,n,i,a){const s=r-t,o=n-e,l=i-t,c=a-e,h=s*s+o*o,d=l*l+c*c,u=.5/(s*c-o*l);return{x:t+(c*h-o*d)*u,y:e+(s*d-l*h)*u}}(y,g,m,x,b,S);this._cx=v.x,this._cy=v.y;for(let e=0;e<a;e++)this._dists[e]=I(t[2*e],t[2*e+1],v.x,v.y);W(this._ids,this._dists,0,a-1),this._hullStart=u;let k=3;r[u]=e[p]=f,r[f]=e[u]=p,r[p]=e[f]=u,n[u]=0,n[f]=1,n[p]=2,i.fill(-1),i[this._hashKey(y,g)]=u,i[this._hashKey(m,x)]=f,i[this._hashKey(b,S)]=p,this.trianglesLen=0,this._addTriangle(u,f,p,-1,-1,-1);for(let a,s,o=0;o<this._ids.length;o++){const l=this._ids[o],c=t[2*l],h=t[2*l+1];if(o>0&&Math.abs(c-a)<=_&&Math.abs(h-s)<=_)continue;if(a=c,s=h,l===u||l===f||l===p)continue;let d=0;for(let t=0,e=this._hashKey(c,h);t<this._hashSize&&(d=i[(e+t)%this._hashSize],-1===d||d===r[d]);t++);d=e[d];let y,g=d;for(;y=r[g],G(c,h,t[2*g],t[2*g+1],t[2*y],t[2*y+1])>=0;)if(g=y,g===d){g=-1;break}if(-1===g)continue;let m=this._addTriangle(g,l,r[g],-1,-1,n[g]);n[l]=this._legalize(m+2),n[g]=m,k++;let x=r[g];for(;y=r[x],G(c,h,t[2*x],t[2*x+1],t[2*y],t[2*y+1])<0;)m=this._addTriangle(x,l,y,n[l],-1,n[x]),n[l]=this._legalize(m+2),r[x]=x,k--,x=y;if(g===d)for(;y=e[g],G(c,h,t[2*y],t[2*y+1],t[2*g],t[2*g+1])<0;)m=this._addTriangle(y,l,g,-1,n[g],n[y]),this._legalize(m+2),n[y]=m,r[g]=g,k--,g=y;this._hullStart=e[l]=g,r[g]=e[x]=l,r[l]=x,i[this._hashKey(c,h)]=l,i[this._hashKey(t[2*g],t[2*g+1])]=g}this.hull=new Uint32Array(k);for(let t=0,e=this._hullStart;t<k;t++)this.hull[t]=e,e=r[e];this.triangles=this._triangles.subarray(0,this.trianglesLen),this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}_hashKey(t,e){return Math.floor(function(t,e){const r=t/(Math.abs(t)+Math.abs(e));return(e>0?3-r:1+r)/4}(t-this._cx,e-this._cy)*this._hashSize)%this._hashSize}_legalize(t){const{_triangles:e,_halfedges:r,coords:n}=this;let i=0,a=0;for(;;){const s=r[t],o=t-t%3;if(a=o+(t+2)%3,-1===s){if(0===i)break;t=F[--i];continue}const l=s-s%3,c=o+(t+1)%3,h=l+(s+2)%3,d=e[a],u=e[t],f=e[c],p=e[h];if(O(n[2*d],n[2*d+1],n[2*u],n[2*u+1],n[2*f],n[2*f+1],n[2*p],n[2*p+1])){e[t]=p,e[s]=d;const n=r[h];if(-1===n){let e=this._hullStart;do{if(this._hullTri[e]===h){this._hullTri[e]=t;break}e=this._hullPrev[e]}while(e!==this._hullStart)}this._link(t,n),this._link(s,r[a]),this._link(a,h);const o=l+(s+1)%3;i<F.length&&(F[i++]=o)}else{if(0===i)break;t=F[--i]}}return a}_link(t,e){this._halfedges[t]=e,-1!==e&&(this._halfedges[e]=t)}_addTriangle(t,e,r,n,i,a){const s=this.trianglesLen;return this._triangles[s]=t,this._triangles[s+1]=e,this._triangles[s+2]=r,this._link(s,n),this._link(s+1,i),this._link(s+2,a),this.trianglesLen+=3,s}}function I(t,e,r,n){const i=t-r,a=e-n;return i*i+a*a}function O(t,e,r,n,i,a,s,o){const l=t-s,c=e-o,h=r-s,d=n-o,u=i-s,f=a-o,p=h*h+d*d,y=u*u+f*f;return l*(d*y-p*f)-c*(h*y-p*u)+(l*l+c*c)*(h*f-d*u)<0}function R(t,e,r,n,i,a){const s=r-t,o=n-e,l=i-t,c=a-e,h=s*s+o*o,d=l*l+c*c,u=.5/(s*c-o*l),f=(c*h-o*d)*u,p=(s*d-l*h)*u;return f*f+p*p}function W(t,e,r,n){if(n-r<=20)for(let i=r+1;i<=n;i++){const n=t[i],a=e[n];let s=i-1;for(;s>=r&&e[t[s]]>a;)t[s+1]=t[s--];t[s+1]=n}else{let i=r+1,a=n;U(t,r+n>>1,i),e[t[r]]>e[t[n]]&&U(t,r,n),e[t[i]]>e[t[n]]&&U(t,i,n),e[t[r]]>e[t[i]]&&U(t,r,i);const s=t[i],o=e[s];for(;;){do{i++}while(e[t[i]]<o);do{a--}while(e[t[a]]>o);if(a<i)break;U(t,i,a)}t[r+1]=t[a],t[a]=s,n-i+1>=a-r?(W(t,e,i,n),W(t,e,r,a-1)):(W(t,e,r,a-1),W(t,e,i,n))}}function U(t,e,r){const n=t[e];t[e]=t[r],t[r]=n}function V(t){return t[0]}function N(t){return t[1]}const q=1e-6;class Y{constructor(){this._x0=this._y0=this._x1=this._y1=null,this._=""}moveTo(t,e){this._+=`M${this._x0=this._x1=+t},${this._y0=this._y1=+e}`}closePath(){null!==this._x1&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")}lineTo(t,e){this._+=`L${this._x1=+t},${this._y1=+e}`}arc(t,e,r){const n=(t=+t)+(r=+r),i=e=+e;if(r<0)throw new Error("negative radius");null===this._x1?this._+=`M${n},${i}`:(Math.abs(this._x1-n)>q||Math.abs(this._y1-i)>q)&&(this._+="L"+n+","+i),r&&(this._+=`A${r},${r},0,1,1,${t-r},${e}A${r},${r},0,1,1,${this._x1=n},${this._y1=i}`)}rect(t,e,r,n){this._+=`M${this._x0=this._x1=+t},${this._y0=this._y1=+e}h${+r}v${+n}h${-r}Z`}value(){return this._||null}}class X{constructor(){this._=[]}moveTo(t,e){this._.push([t,e])}closePath(){this._.push(this._[0].slice())}lineTo(t,e){this._.push([t,e])}value(){return this._.length?this._:null}}class H{constructor(t,[e,r,n,i]=[0,0,960,500]){if(!((n=+n)>=(e=+e)&&(i=+i)>=(r=+r)))throw new Error("invalid bounds");this.delaunay=t,this._circumcenters=new Float64Array(2*t.points.length),this.vectors=new Float64Array(2*t.points.length),this.xmax=n,this.xmin=e,this.ymax=i,this.ymin=r,this._init()}update(){return this.delaunay.update(),this._init(),this}_init(){const{delaunay:{points:t,hull:e,triangles:r},vectors:n}=this;let i,a;const s=this.circumcenters=this._circumcenters.subarray(0,r.length/3*2);for(let n,o,l=0,c=0,h=r.length;l<h;l+=3,c+=2){const h=2*r[l],d=2*r[l+1],u=2*r[l+2],f=t[h],p=t[h+1],y=t[d],g=t[d+1],m=t[u],x=t[u+1],w=y-f,b=g-p,S=m-f,v=x-p,k=2*(w*v-b*S);if(Math.abs(k)<1e-9){if(void 0===i){i=a=0;for(const r of e)i+=t[2*r],a+=t[2*r+1];i/=e.length,a/=e.length}const r=1e9*Math.sign((i-f)*v-(a-p)*S);n=(f+m)/2-r*v,o=(p+x)/2+r*S}else{const t=1/k,e=w*w+b*b,r=S*S+v*v;n=f+(v*e-b*r)*t,o=p+(w*r-S*e)*t}s[c]=n,s[c+1]=o}let o,l,c,h=e[e.length-1],d=4*h,u=t[2*h],f=t[2*h+1];n.fill(0);for(let r=0;r<e.length;++r)h=e[r],o=d,l=u,c=f,d=4*h,u=t[2*h],f=t[2*h+1],n[o+2]=n[d]=c-f,n[o+3]=n[d+1]=u-l}render(t){const e=null==t?t=new Y:void 0,{delaunay:{halfedges:r,inedges:n,hull:i},circumcenters:a,vectors:s}=this;if(i.length<=1)return null;for(let e=0,n=r.length;e<n;++e){const n=r[e];if(n<e)continue;const i=2*Math.floor(e/3),s=2*Math.floor(n/3),o=a[i],l=a[i+1],c=a[s],h=a[s+1];this._renderSegment(o,l,c,h,t)}let o,l=i[i.length-1];for(let e=0;e<i.length;++e){o=l,l=i[e];const r=2*Math.floor(n[l]/3),c=a[r],h=a[r+1],d=4*o,u=this._project(c,h,s[d+2],s[d+3]);u&&this._renderSegment(c,h,u[0],u[1],t)}return e&&e.value()}renderBounds(t){const e=null==t?t=new Y:void 0;return t.rect(this.xmin,this.ymin,this.xmax-this.xmin,this.ymax-this.ymin),e&&e.value()}renderCell(t,e){const r=null==e?e=new Y:void 0,n=this._clip(t);if(null===n||!n.length)return;e.moveTo(n[0],n[1]);let i=n.length;for(;n[0]===n[i-2]&&n[1]===n[i-1]&&i>1;)i-=2;for(let t=2;t<i;t+=2)n[t]===n[t-2]&&n[t+1]===n[t-1]||e.lineTo(n[t],n[t+1]);return e.closePath(),r&&r.value()}*cellPolygons(){const{delaunay:{points:t}}=this;for(let e=0,r=t.length/2;e<r;++e){const t=this.cellPolygon(e);t&&(t.index=e,yield t)}}cellPolygon(t){const e=new X;return this.renderCell(t,e),e.value()}_renderSegment(t,e,r,n,i){let a;const s=this._regioncode(t,e),o=this._regioncode(r,n);0===s&&0===o?(i.moveTo(t,e),i.lineTo(r,n)):(a=this._clipSegment(t,e,r,n,s,o))&&(i.moveTo(a[0],a[1]),i.lineTo(a[2],a[3]))}contains(t,e,r){return(e=+e)==e&&(r=+r)==r&&this.delaunay._step(t,e,r)===t}*neighbors(t){const e=this._clip(t);if(e)for(const r of this.delaunay.neighbors(t)){const t=this._clip(r);if(t)t:for(let n=0,i=e.length;n<i;n+=2)for(let a=0,s=t.length;a<s;a+=2)if(e[n]===t[a]&&e[n+1]===t[a+1]&&e[(n+2)%i]===t[(a+s-2)%s]&&e[(n+3)%i]===t[(a+s-1)%s]){yield r;break t}}}_cell(t){const{circumcenters:e,delaunay:{inedges:r,halfedges:n,triangles:i}}=this,a=r[t];if(-1===a)return null;const s=[];let o=a;do{const r=Math.floor(o/3);if(s.push(e[2*r],e[2*r+1]),o=o%3==2?o-2:o+1,i[o]!==t)break;o=n[o]}while(o!==a&&-1!==o);return s}_clip(t){if(0===t&&1===this.delaunay.hull.length)return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];const e=this._cell(t);if(null===e)return null;const{vectors:r}=this,n=4*t;return this._simplify(r[n]||r[n+1]?this._clipInfinite(t,e,r[n],r[n+1],r[n+2],r[n+3]):this._clipFinite(t,e))}_clipFinite(t,e){const r=e.length;let n,i,a,s,o=null,l=e[r-2],c=e[r-1],h=this._regioncode(l,c),d=0;for(let u=0;u<r;u+=2)if(n=l,i=c,l=e[u],c=e[u+1],a=h,h=this._regioncode(l,c),0===a&&0===h)s=d,d=0,o?o.push(l,c):o=[l,c];else{let e,r,u,f,p;if(0===a){if(null===(e=this._clipSegment(n,i,l,c,a,h)))continue;[r,u,f,p]=e}else{if(null===(e=this._clipSegment(l,c,n,i,h,a)))continue;[f,p,r,u]=e,s=d,d=this._edgecode(r,u),s&&d&&this._edge(t,s,d,o,o.length),o?o.push(r,u):o=[r,u]}s=d,d=this._edgecode(f,p),s&&d&&this._edge(t,s,d,o,o.length),o?o.push(f,p):o=[f,p]}if(o)s=d,d=this._edgecode(o[0],o[1]),s&&d&&this._edge(t,s,d,o,o.length);else if(this.contains(t,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2))return[this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax,this.xmin,this.ymin];return o}_clipSegment(t,e,r,n,i,a){const s=i<a;for(s&&([t,e,r,n,i,a]=[r,n,t,e,a,i]);;){if(0===i&&0===a)return s?[r,n,t,e]:[t,e,r,n];if(i&a)return null;let o,l,c=i||a;8&c?(o=t+(r-t)*(this.ymax-e)/(n-e),l=this.ymax):4&c?(o=t+(r-t)*(this.ymin-e)/(n-e),l=this.ymin):2&c?(l=e+(n-e)*(this.xmax-t)/(r-t),o=this.xmax):(l=e+(n-e)*(this.xmin-t)/(r-t),o=this.xmin),i?(t=o,e=l,i=this._regioncode(t,e)):(r=o,n=l,a=this._regioncode(r,n))}}_clipInfinite(t,e,r,n,i,a){let s,o=Array.from(e);if((s=this._project(o[0],o[1],r,n))&&o.unshift(s[0],s[1]),(s=this._project(o[o.length-2],o[o.length-1],i,a))&&o.push(s[0],s[1]),o=this._clipFinite(t,o))for(let e,r=0,n=o.length,i=this._edgecode(o[n-2],o[n-1]);r<n;r+=2)e=i,i=this._edgecode(o[r],o[r+1]),e&&i&&(r=this._edge(t,e,i,o,r),n=o.length);else this.contains(t,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)&&(o=[this.xmin,this.ymin,this.xmax,this.ymin,this.xmax,this.ymax,this.xmin,this.ymax]);return o}_edge(t,e,r,n,i){for(;e!==r;){let r,a;switch(e){case 5:e=4;continue;case 4:e=6,r=this.xmax,a=this.ymin;break;case 6:e=2;continue;case 2:e=10,r=this.xmax,a=this.ymax;break;case 10:e=8;continue;case 8:e=9,r=this.xmin,a=this.ymax;break;case 9:e=1;continue;case 1:e=5,r=this.xmin,a=this.ymin}n[i]===r&&n[i+1]===a||!this.contains(t,r,a)||(n.splice(i,0,r,a),i+=2)}return i}_project(t,e,r,n){let i,a,s,o=1/0;if(n<0){if(e<=this.ymin)return null;(i=(this.ymin-e)/n)<o&&(s=this.ymin,a=t+(o=i)*r)}else if(n>0){if(e>=this.ymax)return null;(i=(this.ymax-e)/n)<o&&(s=this.ymax,a=t+(o=i)*r)}if(r>0){if(t>=this.xmax)return null;(i=(this.xmax-t)/r)<o&&(a=this.xmax,s=e+(o=i)*n)}else if(r<0){if(t<=this.xmin)return null;(i=(this.xmin-t)/r)<o&&(a=this.xmin,s=e+(o=i)*n)}return[a,s]}_edgecode(t,e){return(t===this.xmin?1:t===this.xmax?2:0)|(e===this.ymin?4:e===this.ymax?8:0)}_regioncode(t,e){return(t<this.xmin?1:t>this.xmax?2:0)|(e<this.ymin?4:e>this.ymax?8:0)}_simplify(t){if(t&&t.length>4){for(let e=0;e<t.length;e+=2){const r=(e+2)%t.length,n=(e+4)%t.length;(t[e]===t[r]&&t[r]===t[n]||t[e+1]===t[r+1]&&t[r+1]===t[n+1])&&(t.splice(r,2),e-=2)}t.length||(t=null)}return t}}const Z=2*Math.PI,Q=Math.pow;function K(t){return t[0]}function J(t){return t[1]}function tt(t,e,r){return[t+Math.sin(t+e)*r,e+Math.cos(t-e)*r]}class et{static from(t,e=K,r=J,n){return new et("length"in t?function(t,e,r,n){const i=t.length,a=new Float64Array(2*i);for(let s=0;s<i;++s){const i=t[s];a[2*s]=e.call(n,i,s,t),a[2*s+1]=r.call(n,i,s,t)}return a}(t,e,r,n):Float64Array.from(function*(t,e,r,n){let i=0;for(const a of t)yield e.call(n,a,i,t),yield r.call(n,a,i,t),++i}(t,e,r,n)))}constructor(t){this._delaunator=new D(t),this.inedges=new Int32Array(t.length/2),this._hullIndex=new Int32Array(t.length/2),this.points=this._delaunator.coords,this._init()}update(){return this._delaunator.update(),this._init(),this}_init(){const t=this._delaunator,e=this.points;if(t.hull&&t.hull.length>2&&function(t){const{triangles:e,coords:r}=t;for(let t=0;t<e.length;t+=3){const n=2*e[t],i=2*e[t+1],a=2*e[t+2];if((r[a]-r[n])*(r[i+1]-r[n+1])-(r[i]-r[n])*(r[a+1]-r[n+1])>1e-10)return!1}return!0}(t)){this.collinear=Int32Array.from({length:e.length/2},(t,e)=>e).sort((t,r)=>e[2*t]-e[2*r]||e[2*t+1]-e[2*r+1]);const t=this.collinear[0],r=this.collinear[this.collinear.length-1],n=[e[2*t],e[2*t+1],e[2*r],e[2*r+1]],i=1e-8*Math.hypot(n[3]-n[1],n[2]-n[0]);for(let t=0,r=e.length/2;t<r;++t){const r=tt(e[2*t],e[2*t+1],i);e[2*t]=r[0],e[2*t+1]=r[1]}this._delaunator=new D(e)}else delete this.collinear;const r=this.halfedges=this._delaunator.halfedges,n=this.hull=this._delaunator.hull,i=this.triangles=this._delaunator.triangles,a=this.inedges.fill(-1),s=this._hullIndex.fill(-1);for(let t=0,e=r.length;t<e;++t){const e=i[t%3==2?t-2:t+1];-1!==r[t]&&-1!==a[e]||(a[e]=t)}for(let t=0,e=n.length;t<e;++t)s[n[t]]=t;n.length<=2&&n.length>0&&(this.triangles=new Int32Array(3).fill(-1),this.halfedges=new Int32Array(3).fill(-1),this.triangles[0]=n[0],a[n[0]]=1,2===n.length&&(a[n[1]]=0,this.triangles[1]=n[1],this.triangles[2]=n[1]))}voronoi(t){return new H(this,t)}*neighbors(t){const{inedges:e,hull:r,_hullIndex:n,halfedges:i,triangles:a,collinear:s}=this;if(s){const e=s.indexOf(t);return e>0&&(yield s[e-1]),void(e<s.length-1&&(yield s[e+1]))}const o=e[t];if(-1===o)return;let l=o,c=-1;do{if(yield c=a[l],l=l%3==2?l-2:l+1,a[l]!==t)return;if(l=i[l],-1===l){const e=r[(n[t]+1)%r.length];return void(e!==c&&(yield e))}}while(l!==o)}find(t,e,r=0){if((t=+t)!=t||(e=+e)!=e)return-1;const n=r;let i;for(;(i=this._step(r,t,e))>=0&&i!==r&&i!==n;)r=i;return i}_step(t,e,r){const{inedges:n,hull:i,_hullIndex:a,halfedges:s,triangles:o,points:l}=this;if(-1===n[t]||!l.length)return(t+1)%(l.length>>1);let c=t,h=Q(e-l[2*t],2)+Q(r-l[2*t+1],2);const d=n[t];let u=d;do{let n=o[u];const d=Q(e-l[2*n],2)+Q(r-l[2*n+1],2);if(d<h&&(h=d,c=n),u=u%3==2?u-2:u+1,o[u]!==t)break;if(u=s[u],-1===u){if(u=i[(a[t]+1)%i.length],u!==n&&Q(e-l[2*u],2)+Q(r-l[2*u+1],2)<h)return u;break}}while(u!==d);return c}render(t){const e=null==t?t=new Y:void 0,{points:r,halfedges:n,triangles:i}=this;for(let e=0,a=n.length;e<a;++e){const a=n[e];if(a<e)continue;const s=2*i[e],o=2*i[a];t.moveTo(r[s],r[s+1]),t.lineTo(r[o],r[o+1])}return this.renderHull(t),e&&e.value()}renderPoints(t,e){void 0!==e||t&&"function"==typeof t.moveTo||(e=t,t=null),e=null==e?2:+e;const r=null==t?t=new Y:void 0,{points:n}=this;for(let r=0,i=n.length;r<i;r+=2){const i=n[r],a=n[r+1];t.moveTo(i+e,a),t.arc(i,a,e,0,Z)}return r&&r.value()}renderHull(t){const e=null==t?t=new Y:void 0,{hull:r,points:n}=this,i=2*r[0],a=r.length;t.moveTo(n[i],n[i+1]);for(let e=1;e<a;++e){const i=2*r[e];t.lineTo(n[i],n[i+1])}return t.closePath(),e&&e.value()}hullPolygon(){const t=new X;return this.renderHull(t),t.value()}renderTriangle(t,e){const r=null==e?e=new Y:void 0,{points:n,triangles:i}=this,a=2*i[t*=3],s=2*i[t+1],o=2*i[t+2];return e.moveTo(n[a],n[a+1]),e.lineTo(n[s],n[s+1]),e.lineTo(n[o],n[o+1]),e.closePath(),r&&r.value()}*trianglePolygons(){const{triangles:t}=this;for(let e=0,r=t.length/3;e<r;++e)yield this.trianglePolygon(e)}trianglePolygon(t){const e=new X;return this.renderTriangle(t,e),e.value()}}function rt(t){const e=e=>{const r=e.append("filter").attr("id",t.id);t.x&&r.attr("x",t.x),t.y&&r.attr("y",t.y),t.width&&r.attr("width",t.width),t.height&&r.attr("height",t.height),r.append("feGaussianBlur").attr("stdDeviation",t.stdDeviation)};return e.url=()=>st(t.id),e}function nt(t){const e=e=>{const r=e.append("defs").append("filter").attr("id",t.id).append("feDropShadow").attr("dx",t.dx).attr("dy",t.dy).attr("stdDeviation",t.stdDeviation);t.floodColor&&r.attr("flood-color",t.floodColor),void 0!==t.floodOpacity&&r.attr("flood-opacity",t.floodOpacity)};return e.url=()=>st(t.id),e}function it(t){const e=e=>{const r=e.append("defs").append("filter").attr("id",t.id).attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%");if(void 0!==t.threshold){const e=[.2126,.7152,.0722,0,t.threshold,.2126,.7152,.0722,0,t.threshold,.2126,.7152,.0722,0,t.threshold,0,0,0,1,0].join(" ");r.append("feColorMatrix").attr("values",e).attr("result","bright")}r.append("feGaussianBlur").attr("in",void 0!==t.threshold?"bright":"SourceGraphic").attr("stdDeviation",t.intensity).attr("result","bloom"),t.color&&(r.append("feFlood").attr("flood-color",t.color).attr("result","color"),r.append("feComposite").attr("in","color").attr("in2","bloom").attr("operator","in").attr("result","coloredBloom")),r.append("feMerge").selectAll("feMergeNode").data(["SourceGraphic",t.color?"coloredBloom":"bloom"]).enter().append("feMergeNode").attr("in",t=>t)};return e.url=()=>st(t.id),e}const at={lightBlur:()=>rt({id:"lightBlur",stdDeviation:2}),strongBlur:()=>rt({id:"strongBlur",stdDeviation:8}),standardDropShadow:()=>nt({id:"standardDropShadow",dx:3,dy:3,stdDeviation:2,floodColor:"#000000",floodOpacity:.3}),softDropShadow:()=>nt({id:"softDropShadow",dx:2,dy:2,stdDeviation:4,floodColor:"#000000",floodOpacity:.2}),standardBloom:()=>it({id:"standardBloom",intensity:4,threshold:.8}),strongBloom:()=>it({id:"strongBloom",intensity:8,threshold:.6,color:"#ffffff"})};function st(t){return`url(#${t})`}
/*!
     * Textures.js v1.2.3 (ESM)
     * SVG patterns for Data Visualization
     * https://github.com/riccardoscalco/textures
     * 
     * Copyright (c) Riccardo Scalco
     * Licensed under the MIT License
     * 
     * Included in d3-thematika under MIT License terms
     */
function ot(){return"".concat(Math.random().toString(36),"00000000000000000").replace(/[^a-z]+/g,"").slice(0,5)}function lt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function ct(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return lt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?lt(t,e):void 0}}(t))||e){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return s=t.done,t},e:function(t){o=!0,a=t},f:function(){try{s||null==r.return||r.return()}finally{if(o)throw a}}}}var ht={circles:function(){var t=20,e="",r=2,n=!1,i="#343434",a="#343434",s=0,o=ot(),l=function(l){var c=l.append("defs").append("pattern").attr("id",o).attr("patternUnits","userSpaceOnUse").attr("width",t).attr("height",t);if(e&&c.append("rect").attr("width",t).attr("height",t).attr("fill",e),c.append("circle").attr("cx",t/2).attr("cy",t/2).attr("r",r).attr("fill",i).attr("stroke",a).attr("stroke-width",s),n)for(var h=0,d=[[0,0],[0,t],[t,0],[t,t]];h<d.length;h++){var u=d[h];c.append("circle").attr("cx",u[0]).attr("cy",u[1]).attr("r",r).attr("fill",i).attr("stroke",a).attr("stroke-width",s)}};return l.heavier=function(t){return r*=0===arguments.length?2:2*t,l},l.lighter=function(t){return r/=0===arguments.length?2:2*t,l},l.thinner=function(e){return t*=0===arguments.length?2:2*e,l},l.thicker=function(e){return t/=0===arguments.length?2:2*e,l},l.background=function(t){return e=t,l},l.size=function(e){return t=e,l},l.complement=function(t){return n=0===arguments.length||t,l},l.radius=function(t){return r=t,l},l.fill=function(t){return i=t,l},l.stroke=function(t){return a=t,l},l.strokeWidth=function(t){return s=t,l},l.id=function(t){return 0===arguments.length?o:(o=t,l)},l.url=function(){return"url(#".concat(o,")")},l},lines:function(){var t=20,e="#343434",r=2,n="",i=ot(),a=["diagonal"],s="auto",o=function(e){var r=t;switch(e){case"0/8":case"vertical":default:return"M ".concat(r/2,", 0 l 0, ").concat(r);case"1/8":return"M ".concat(-r/4,",").concat(r," l ").concat(r/2,",").concat(-r," M ").concat(r/4,",").concat(r," l ").concat(r/2,",").concat(-r," M ").concat(3*r/4,",").concat(r," l ").concat(r/2,",").concat(-r);case"2/8":case"diagonal":return"M 0,".concat(r," l ").concat(r,",").concat(-r," M ").concat(-r/4,",").concat(r/4," l ").concat(r/2,",").concat(-r/2," M ").concat(3/4*r,",").concat(5/4*r," l ").concat(r/2,",").concat(-r/2);case"3/8":return"M 0,".concat(3/4*r," l ").concat(r,",").concat(-r/2," M 0,").concat(r/4," l ").concat(r,",").concat(-r/2," M 0,").concat(5*r/4," l ").concat(r,",").concat(-r/2);case"4/8":case"horizontal":return"M 0,".concat(r/2," l ").concat(r,",0");case"5/8":return"M 0,".concat(-r/4," l ").concat(r,",").concat(r/2,"M 0,").concat(r/4," l ").concat(r,",").concat(r/2," M 0,").concat(3*r/4," l ").concat(r,",").concat(r/2);case"6/8":return"M 0,0 l ".concat(r,",").concat(r," M ").concat(-r/4,",").concat(3/4*r," l ").concat(r/2,",").concat(r/2," M ").concat(3*r/4,",").concat(-r/4," l ").concat(r/2,",").concat(r/2);case"7/8":return"M ".concat(-r/4,",0 l ").concat(r/2,",").concat(r," M ").concat(r/4,",0 l ").concat(r/2,",").concat(r," M ").concat(3*r/4,",0 l ").concat(r/2,",").concat(r)}},l=function(l){var c=l.append("defs").append("pattern").attr("id",i).attr("patternUnits","userSpaceOnUse").attr("width",t).attr("height",t);n&&c.append("rect").attr("width",t).attr("height",t).attr("fill",n);var h,d=ct(a);try{for(d.s();!(h=d.n()).done;){var u=h.value;c.append("path").attr("d",o(u)).attr("stroke-width",r).attr("shape-rendering",s).attr("stroke",e).attr("stroke-linecap","square")}}catch(t){d.e(t)}finally{d.f()}};return l.heavier=function(t){return r*=0===arguments.length?2:2*t,l},l.lighter=function(t){return r/=0===arguments.length?2:2*t,l},l.thinner=function(e){return t*=0===arguments.length?2:2*e,l},l.thicker=function(e){return t/=0===arguments.length?2:2*e,l},l.background=function(t){return n=t,l},l.size=function(e){return t=e,l},l.orientation=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return 0===arguments.length||(a=e),l},l.shapeRendering=function(t){return s=t,l},l.stroke=function(t){return e=t,l},l.strokeWidth=function(t){return r=t,l},l.id=function(t){return 0===arguments.length?i:(i=t,l)},l.url=function(){return"url(#".concat(i,")")},l},paths:function(){var t=1,e=1,r=20,n="#343434",i=2,a="",s=function(t){return"M ".concat(t/4,",").concat(3*t/4,"l").concat(t/4,",").concat(-t/2,"l").concat(t/4,",").concat(t/2)},o=ot(),l="transparent",c="auto",h=function(h){var d=function(n){var i=r;switch(n){case"squares":return"M ".concat(i/4," ").concat(i/4," l ").concat(i/2," 0 l 0 ").concat(i/2," l ").concat(-i/2," 0 Z");case"nylon":return"M 0 ".concat(i/4," l ").concat(i/4," 0 l 0 ").concat(-i/4," M ").concat(3*i/4," ").concat(i," l 0 ").concat(-i/4," l ").concat(i/4," 0 M ").concat(i/4," ").concat(i/2," l 0 ").concat(i/4," l ").concat(i/4," 0 M ").concat(i/2," ").concat(i/4," l ").concat(i/4," 0 l 0 ").concat(i/4);case"waves":return"M 0 ".concat(i/2," c ").concat(i/8," ").concat(-i/4," , ").concat(3*i/8," ").concat(-i/4," , ").concat(i/2," 0 c ").concat(i/8," ").concat(i/4," , ").concat(3*i/8," ").concat(i/4," , ").concat(i/2," 0 M ").concat(-i/2," ").concat(i/2," c ").concat(i/8," ").concat(i/4," , ").concat(3*i/8," ").concat(i/4," , ").concat(i/2," 0 M ").concat(i," ").concat(i/2," c ").concat(i/8," ").concat(-i/4," , ").concat(3*i/8," ").concat(-i/4," , ").concat(i/2," 0");case"woven":return"M ".concat(i/4,",").concat(i/4,"l").concat(i/2,",").concat(i/2,"M").concat(3*i/4,",").concat(i/4,"l").concat(i/2,",").concat(-i/2," M").concat(i/4,",").concat(3*i/4,"l").concat(-i/2,",").concat(i/2,"M").concat(3*i/4,",").concat(5*i/4,"l").concat(i/2,",").concat(-i/2," M").concat(-i/4,",").concat(i/4,"l").concat(i/2,",").concat(-i/2);case"crosses":return"M ".concat(i/4,",").concat(i/4,"l").concat(i/2,",").concat(i/2,"M").concat(i/4,",").concat(3*i/4,"l").concat(i/2,",").concat(-i/2);case"caps":return"M ".concat(i/4,",").concat(3*i/4,"l").concat(i/4,",").concat(-i/2,"l").concat(i/4,",").concat(i/2);case"hexagons":return t=3,e=Math.sqrt(3),"M ".concat(i,",0 l ").concat(i,",0 l ").concat(i/2,",").concat(i*Math.sqrt(3)/2," l ").concat(-i/2,",").concat(i*Math.sqrt(3)/2," l ").concat(-i,",0 l ").concat(-i/2,",").concat(-i*Math.sqrt(3)/2," Z M 0,").concat(i*Math.sqrt(3)/2," l ").concat(i/2,",0 M ").concat(3*i,",").concat(i*Math.sqrt(3)/2," l ").concat(-i/2,",0");default:return n(i)}}(s),u=h.append("defs").append("pattern").attr("id",o).attr("patternUnits","userSpaceOnUse").attr("width",r*t).attr("height",r*e);a&&u.append("rect").attr("width",r*t).attr("height",r*e).attr("fill",a),u.append("path").attr("d",d).attr("fill",l).attr("stroke",n).attr("stroke-width",i).attr("stroke-linecap","square").attr("shape-rendering",c)};return h.heavier=function(t){return i*=0===arguments.length?2:2*t,h},h.lighter=function(t){return i/=0===arguments.length?2:2*t,h},h.thinner=function(t){return r*=0===arguments.length?2:2*t,h},h.thicker=function(t){return r/=0===arguments.length?2:2*t,h},h.background=function(t){return a=t,h},h.shapeRendering=function(t){return c=t,h},h.size=function(t){return r=t,h},h.d=function(t){return s=t,h},h.fill=function(t){return l=t,h},h.stroke=function(t){return n=t,h},h.strokeWidth=function(t){return i=t,h},h.id=function(t){return 0===arguments.length?o:(o=t,h)},h.url=function(){return"url(#".concat(o,")")},h}};function dt(t){const e=ht.circles().radius(t.radius||1).fill(t.fill||"#000").background(t.background||"#ffffff").size(t.size||4).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function ut(t){const e=ht.lines().orientation(...t.orientation||["diagonal"]).stroke(t.stroke||"#000").strokeWidth(t.strokeWidth||1).background(t.background||"#ffffff").size(t.size||4).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function ft(t){const e=ht.paths().d(t.d||"M 0,0 l 10,10 M 10,0 l -10,10").size(t.size||10).background(t.background||"#ffffff").fill(t.fill||"none").stroke(t.stroke||"#000").strokeWidth(t.strokeWidth||1).id(t.id),r=t=>{t.call(e)};return r.url=()=>e.url(),r}function pt(t={id:"ocean"}){const{intensity:e="medium"}=t,r={light:{size:6,strokeWidth:.5,background:"#e3f2fd"},medium:{size:4,strokeWidth:.8,background:"#bbdefb"},heavy:{size:3,strokeWidth:1.2,background:"#90caf9"}}[e];return ut({id:t.id,orientation:["horizontal"],stroke:"#1976d2",strokeWidth:r.strokeWidth,background:r.background,size:r.size})}function yt(t={id:"forest"}){const{density:e="medium"}=t,r={sparse:{size:8,radius:1,background:"#e8f5e8"},medium:{size:6,radius:1.5,background:"#c8e6c9"},dense:{size:4,radius:2,background:"#a5d6a7"}}[e];return dt({id:t.id,radius:r.radius,fill:"#2e7d32",background:r.background,size:r.size})}function gt(t={id:"desert"}){return ft({id:t.id,d:"M 0,5 Q 5,0 10,5 Q 15,10 20,5",size:20,background:"#fff8e1",fill:"none",stroke:"#ff8f00",strokeWidth:.8})}function mt(t={id:"mountain"}){return ft({id:t.id,d:"M 0,10 L 5,0 L 10,10 Z",size:10,background:"#efebe9",fill:"#5d4037",stroke:"#3e2723",strokeWidth:.5})}const xt={lightOcean:()=>pt({id:"lightOcean",intensity:"light"}),standardOcean:()=>pt({id:"standardOcean",intensity:"medium"}),heavyOcean:()=>pt({id:"heavyOcean",intensity:"heavy"}),sparseForest:()=>yt({id:"sparseForest",density:"sparse"}),standardForest:()=>yt({id:"standardForest",density:"medium"}),denseForest:()=>yt({id:"denseForest",density:"dense"}),desert:()=>gt({id:"desert"}),mountain:()=>mt({id:"mountain"}),simpleDots:()=>dt({id:"simpleDots",background:"#ffffff",fill:"#000000",size:4}),simpleLines:()=>ut({id:"simpleLines",background:"#ffffff",stroke:"#000000",orientation:["diagonal"]})};function wt(t,e,r,n,i,a){switch(t.type){case"Point":a(t.coordinates,e,r,n,i);break;case"LineString":case"MultiPoint":t.coordinates.forEach(t=>{a(t,e,r,n,i)});break;case"Polygon":t.coordinates.forEach(t=>{t.forEach(t=>{a(t,e,r,n,i)})});break;case"MultiLineString":t.coordinates.forEach(t=>{t.forEach(t=>{a(t,e,r,n,i)})});break;case"MultiPolygon":t.coordinates.forEach(t=>{t.forEach(t=>{t.forEach(t=>{a(t,e,r,n,i)})})});break;case"GeometryCollection":t.geometries.forEach(t=>{wt(t,e,r,n,i,a)})}}const bt=40075016.686;function St(t,e,r){try{if(!isFinite(t)||!isFinite(e)||!isFinite(r))throw new Error("無効な座標またはズームレベルが指定されました");if(t<-180||t>180)throw new Error(`経度は-180から180の範囲で指定してください: ${t}`);if(e<-85.051128779807||e>85.051128779807)throw new Error(`緯度はWeb Mercator投影法の有効範囲（-85.05〜85.05度）で指定してください: ${e}`);if(r<0||r>30)throw new Error(`ズームレベルは0から30の範囲で指定してください: ${r}`);const n=Math.pow(2,r),i=Math.floor((t+180)/360*n),a=e*Math.PI/180;return{x:i,y:Math.floor((1-Math.log(Math.tan(a)+1/Math.cos(a))/Math.PI)/2*n),z:r}}catch(t){throw new Error(`タイル座標の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}}function vt(t,e,r){try{if(!Number.isInteger(t)||!Number.isInteger(e)||!Number.isInteger(r))throw new Error("タイル座標は整数で指定してください");if(r<0||r>30)throw new Error(`ズームレベルは0から30の範囲で指定してください: ${r}`);const n=Math.pow(2,r);if(t<0||t>=n||e<0||e>=n)throw new Error(`タイル座標がズームレベル${r}の有効範囲外です: x=${t}, y=${e}`);const i=t/n*360-180,a=(t+1)/n*360-180,s=180*Math.atan(Math.sinh(Math.PI*(1-2*e/n)))/Math.PI,o=180*Math.atan(Math.sinh(Math.PI*(1-2*(e+1)/n)))/Math.PI;return{west:i,south:o,east:a,north:s,bounds:[i,o,a,s]}}catch(t){throw new Error(`タイル境界の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}}const kt={Set1:{name:"Set1",type:"categorical",colors:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],colorBlindSafe:!1,description:"鮮やかなカテゴリカルカラー（最大9クラス）",maxClasses:9},Set2:{name:"Set2",type:"categorical",colors:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],colorBlindSafe:!0,description:"パステル調カテゴリカルカラー（色覚障害対応、最大8クラス）",maxClasses:8},Set3:{name:"Set3",type:"categorical",colors:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],colorBlindSafe:!1,description:"薄い色調のカテゴリカルカラー（最大12クラス）",maxClasses:12},Blues:{name:"Blues",type:"sequential",colors:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],colorBlindSafe:!0,description:"青系連続カラー（色覚障害対応）",maxClasses:9},Greens:{name:"Greens",type:"sequential",colors:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],colorBlindSafe:!0,description:"緑系連続カラー（色覚障害対応）",maxClasses:9},Oranges:{name:"Oranges",type:"sequential",colors:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],colorBlindSafe:!0,description:"オレンジ系連続カラー（色覚障害対応）",maxClasses:9},YlOrRd:{name:"YlOrRd",type:"sequential",colors:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],colorBlindSafe:!0,description:"黄-オレンジ-赤系連続カラー（色覚障害対応）",maxClasses:9},YlGnBu:{name:"YlGnBu",type:"sequential",colors:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],colorBlindSafe:!0,description:"黄-緑-青系連続カラー（色覚障害対応）",maxClasses:9},RdYlBu:{name:"RdYlBu",type:"diverging",colors:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],colorBlindSafe:!1,description:"赤-黄-青系発散カラー",maxClasses:11},RdBu:{name:"RdBu",type:"diverging",colors:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],colorBlindSafe:!0,description:"赤-青系発散カラー（色覚障害対応）",maxClasses:11},BrBG:{name:"BrBG",type:"diverging",colors:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],colorBlindSafe:!0,description:"茶-緑系発散カラー（色覚障害対応）",maxClasses:11}},Mt={Viridis:{name:"Viridis",type:"sequential",colors:["#440154","#482777","#3f4a8a","#31678e","#26838f","#1f9d8a","#6cce5a","#b6de2b","#fee825"],colorBlindSafe:!0,description:"Viridis連続カラー（知覚的均一、色覚障害対応）",maxClasses:9},Plasma:{name:"Plasma",type:"sequential",colors:["#0d0887","#46039f","#7201a8","#9c179e","#bd3786","#d8576b","#ed7953","#fb9f3a","#fdca26","#f0f921"],colorBlindSafe:!0,description:"Plasma連続カラー（知覚的均一、色覚障害対応）",maxClasses:10},Inferno:{name:"Inferno",type:"sequential",colors:["#000004","#1b0c41","#4a0c6b","#781c6d","#a52c60","#cf4446","#ed6925","#fb9b06","#f7d03c","#fcffa4"],colorBlindSafe:!0,description:"Inferno連続カラー（知覚的均一、色覚障害対応）",maxClasses:10},Magma:{name:"Magma",type:"sequential",colors:["#000004","#180f3d","#440f76","#721f81","#9e2f7f","#cd4071","#f1605d","#fd9668","#feca8d","#fcfdbf"],colorBlindSafe:!0,description:"Magma連続カラー（知覚的均一、色覚障害対応）",maxClasses:10}},Lt={Prism:{name:"Prism",type:"categorical",colors:["#5F4690","#1D6996","#38A6A5","#0F8554","#73AF48","#EDAD08","#E17C05","#CC503E","#94346E","#6F4070","#994E95"],colorBlindSafe:!0,description:"CARTO Prism カテゴリカルカラー（色覚障害対応）",maxClasses:11},Safe:{name:"Safe",type:"categorical",colors:["#88CCEE","#CC6677","#DDCC77","#117733","#332288","#AA4499","#44AA99","#999933","#882255","#661100","#6699CC","#888888"],colorBlindSafe:!0,description:"CARTO Safe カテゴリカルカラー（色覚障害完全対応）",maxClasses:12},Vivid:{name:"Vivid",type:"categorical",colors:["#E58606","#5D69B1","#52BCA3","#99C945","#CC61B0","#24796C","#DAA51B","#2F8AC4","#764E9F","#ED645A","#CC3A8E","#A5AA99"],colorBlindSafe:!1,description:"CARTO Vivid カテゴリカルカラー（鮮やか）",maxClasses:12}},At={TailwindVivid:{name:"TailwindVivid",type:"categorical",colors:["#3B82F6","#EF4444","#10B981","#F59E0B","#8B5CF6","#EC4899","#06B6D4","#84CC16"],colorBlindSafe:!0,description:"Tailwind CSS ビビッドカラー（500シェード）",maxClasses:8},TailwindRich:{name:"TailwindRich",type:"categorical",colors:["#2563EB","#DC2626","#059669","#D97706","#7C3AED","#DB2777","#0891B2","#65A30D"],colorBlindSafe:!0,description:"Tailwind CSS リッチカラー（600シェード）",maxClasses:8},TailwindDeep:{name:"TailwindDeep",type:"categorical",colors:["#1D4ED8","#B91C1C","#047857","#B45309","#6D28D9","#BE185D","#0E7490","#4D7C0F"],colorBlindSafe:!0,description:"Tailwind CSS ディープカラー（700シェード）",maxClasses:8},TailwindDark:{name:"TailwindDark",type:"categorical",colors:["#1E40AF","#991B1B","#065F46","#92400E","#5B21B6","#9D174D","#155E75","#3F6212"],colorBlindSafe:!0,description:"Tailwind CSS ダークカラー（800シェード）",maxClasses:8},TailwindWarm:{name:"TailwindWarm",type:"categorical",colors:["#F97316","#EF4444","#F59E0B","#EAB308","#EC4899","#F43F5E","#D946EF","#A855F7"],colorBlindSafe:!1,description:"Tailwind CSS 暖色系（オレンジ・レッド・ピンク系）",maxClasses:8},TailwindCool:{name:"TailwindCool",type:"categorical",colors:["#3B82F6","#06B6D4","#0EA5E9","#10B981","#22C55E","#84CC16","#6366F1","#8B5CF6"],colorBlindSafe:!0,description:"Tailwind CSS 寒色系（ブルー・グリーン・パープル系）",maxClasses:8},TailwindNeon:{name:"TailwindNeon",type:"categorical",colors:["#06B6D4","#10B981","#84CC16","#EAB308","#F59E0B","#EC4899","#D946EF","#8B5CF6"],colorBlindSafe:!0,description:"Tailwind CSS ネオンカラー（明るく鮮やかな色調）",maxClasses:8},TailwindBlues:{name:"TailwindBlues",type:"sequential",colors:["#DBEAFE","#BFDBFE","#93C5FD","#60A5FA","#3B82F6","#2563EB","#1D4ED8","#1E40AF","#1E3A8A"],colorBlindSafe:!0,description:"Tailwind CSS ブルー系連続カラー",maxClasses:9},TailwindGreens:{name:"TailwindGreens",type:"sequential",colors:["#D1FAE5","#A7F3D0","#6EE7B7","#34D399","#10B981","#059669","#047857","#065F46","#064E3B"],colorBlindSafe:!0,description:"Tailwind CSS グリーン系連続カラー",maxClasses:9},TailwindPurples:{name:"TailwindPurples",type:"sequential",colors:["#EDE9FE","#DDD6FE","#C4B5FD","#A78BFA","#8B5CF6","#7C3AED","#6D28D9","#5B21B6","#4C1D95"],colorBlindSafe:!0,description:"Tailwind CSS パープル系連続カラー",maxClasses:9}},Ct={...kt,...Mt,...Lt,...At},$t={protanopia:[[.567,.433,0],[.558,.442,0],[0,.242,.758]],deuteranopia:[[.625,.375,0],[.7,.3,0],[0,.3,.7]],tritanopia:[[.95,.05,0],[0,.433,.567],[0,.475,.525]]};function Et(t,e){const r=zt(t);if(!r)return t;const n=$t[e],i=Math.round(n[0][0]*r.r+n[0][1]*r.g+n[0][2]*r.b),a=Math.round(n[1][0]*r.r+n[1][1]*r.g+n[1][2]*r.b),s=Math.round(n[2][0]*r.r+n[2][1]*r.g+n[2][2]*r.b);return function(t,e,r){return"#"+((1<<24)+(t<<16)+(e<<8)+r).toString(16).slice(1)}(Math.min(255,Math.max(0,i)),Math.min(255,Math.max(0,a)),Math.min(255,Math.max(0,s)))}function zt(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function Pt(t,e){const r=zt(t),n=zt(e);return r&&n?Math.sqrt(Math.pow(r.r-n.r,2)+Math.pow(r.g-n.g,2)+Math.pow(r.b-n.b,2)):0}t.AllPalettes=Ct,t.BaseLayer=o,t.CARTOPalettes=Lt,t.ColorBrewerPalettes=kt,t.FilterPresets=at,t.GeojsonLayer=class extends o{constructor(t){super(`geojson-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderFeatures())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderFeatures()}renderFeatures(){if(!this.layerGroup||!this.path)return;const t=this.layerGroup.append("g").attr("class","thematika-geojson-layer").selectAll("path").data(this.data.features).enter().append("path").attr("d",this.path).attr("class",t=>["thematika-feature",this.attr.className||"",t.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(t,this.layerGroup)}getData(){return this.data}},t.GraticuleLayer=class extends o{constructor(t={}){super(`graticule-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,{fill:"none",stroke:"#cccccc",strokeWidth:.5,opacity:.7,...t.attr||{}},t.style||{}),this.step=t.step||[10,10],this.extent=t.extent}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderGraticule())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderGraticule()}renderGraticule(){if(!this.layerGroup||!this.path)return;const t=r.geoGraticule().step(this.step);this.extent&&t.extent(this.extent);const e=t(),n=this.layerGroup.append("g").attr("class","thematika-graticule-layer").append("path").datum(e).attr("d",this.path).attr("class",()=>["thematika-graticule",this.attr.className||""].filter(Boolean).join(" "));this.applyAllStylesToElement(n,this.layerGroup)}},t.ImageLayer=class extends o{constructor(t,e){super(t,e.attr,e.style),this.src=e.src,this.bounds=e.bounds,this.showBboxMarkers=e.showBboxMarkers??!1}setProjection(t){if(this.projection=t,this.isRendered()){if(!this.element||!this.projection)return;const t=e.select(this.element);t.selectAll("image").remove(),t.selectAll(".bbox-marker").remove(),t.selectAll(".bbox-marker-label").remove(),this.loadImage(this.src).then(t=>{this.canUseDirectRendering(this.projection)?this.renderDirect(t):this.renderReprojected(t)}).catch(t=>{console.error("ImageLayer: 更新に失敗しました",t)})}}async render(t){if(!this.projection)return void console.warn("ImageLayer: 投影法が設定されていません");const e=t.append("g").attr("class",`image-layer ${this.attr.className||""}`).attr("id",`layer-${this.id}`);this.visible||e.style("display","none"),this.element=e.node();try{const t=await this.loadImage(this.src);this.canUseDirectRendering(this.projection)?await this.renderDirect(t):await this.renderReprojected(t)}catch(t){console.error("ImageLayer: 画像の描画に失敗しました",t)}}loadImage(t){return new Promise((e,r)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>e(n),n.onerror=()=>r(new Error(`画像の読み込みに失敗しました: ${t}`)),n.src=t})}canUseDirectRendering(t){return this.isEquirectangularProjection(t)}isEquirectangularProjection(t){const e=t.toString?t.toString():"";return e.includes("equirectangular")||e.includes("Equirectangular")}renderDirect(t){if(!this.element||!this.projection)return;const[r,n,i,a]=this.bounds,s=this.projection([r,a]),o=this.projection([i,a]),l=this.projection([r,n]),c=this.projection([i,n]);if(!s||!c)return void console.warn("ImageLayer: 境界が投影範囲外です");const h=s[0],d=s[1],u=Math.abs(c[0]-s[0]),f=Math.abs(c[1]-s[1]),p=e.select(this.element);this.imageElement=p.append("image").attr("x",h).attr("y",d).attr("width",u).attr("height",f).attr("href",t.src).attr("preserveAspectRatio","none"),this.showBboxMarkers&&this.addBboxMarkers(p,[s,o,l,c]),this.imageElement&&this.applyAllStylesToElement(this.imageElement,this.getLayerGroup())}async renderReprojected(t){if(this.element&&this.projection)try{const r=await this.reprojectImage(t),n=e.select(this.element);if(this.imageElement=n.append("image").attr("x",r.x).attr("y",r.y).attr("width",r.width).attr("height",r.height).attr("href",r.dataUrl).attr("preserveAspectRatio","none"),this.imageElement&&this.applyAllStylesToElement(this.imageElement,this.getLayerGroup()),this.showBboxMarkers){const[t,e,r,i]=this.bounds,a=this.projection([t,i]),s=this.projection([r,i]),o=this.projection([t,e]),l=this.projection([r,e]);this.addBboxMarkers(n,[a,s,o,l])}}catch(t){console.error("ImageLayer: 再投影に失敗しました",t)}}async reprojectImage(t){if(!this.projection)throw new Error("投影法が設定されていません");const[e,r,n,i]=this.bounds,a=this.calculateOutputBounds();if(!a)throw new Error("出力範囲の計算に失敗しました");const{minX:s,minY:o,width:l,height:c}=a,h=document.createElement("canvas"),d=h.getContext("2d");if(!d)throw new Error("Canvas contextの取得に失敗しました");h.width=t.width,h.height=t.height,d.drawImage(t,0,0);const u=d.getImageData(0,0,t.width,t.height),f=document.createElement("canvas"),p=f.getContext("2d");if(!p)throw new Error("Canvas contextの取得に失敗しました");f.width=l,f.height=c;const y=p.createImageData(l,c);for(let a=0;a<c;a++)for(let c=0;c<l;c++){const h=c+s,d=a+o;if(this.projection.invert)try{const s=this.projection.invert([h,d]);if(s&&s[0]>=e&&s[0]<=n&&s[1]>=r&&s[1]<=i){const o=(s[0]-e)/(n-e)*(t.width-1),h=(i-s[1])/(i-r)*(t.height-1),d=this.nearestNeighborInterpolate(u,o,h),f=4*(a*l+c);y.data[f]=d[0],y.data[f+1]=d[1],y.data[f+2]=d[2],y.data[f+3]=d[3]}}catch(t){}}return p.putImageData(y,0,0),{dataUrl:f.toDataURL(),x:s,y:o,width:l,height:c}}nearestNeighborInterpolate(t,e,r){const n=Math.round(e),i=Math.round(r);if(n<0||n>=t.width||i<0||i>=t.height)return[0,0,0,0];const a=4*(i*t.width+n);return[t.data[a],t.data[a+1],t.data[a+2],t.data[a+3]]}calculateOutputBounds(){if(!this.projection)return null;const[t,e,r,n]=this.bounds,i=[];for(let a=0;a<=20;a++){const s=a/20;i.push([t+(r-t)*s,n],[t+(r-t)*s,e],[t,e+(n-e)*s],[r,e+(n-e)*s])}const a=i.map(t=>this.projection(t)).filter(t=>null!==t);if(0===a.length)return null;const s=a.map(t=>t[0]),o=a.map(t=>t[1]),l=Math.floor(Math.min(...s)),c=Math.ceil(Math.max(...s)),h=Math.floor(Math.min(...o));return{minX:l,minY:h,width:c-l,height:Math.ceil(Math.max(...o))-h}}addBboxMarkers(t,e){const r=e.filter(t=>null!==t),n=["#e74c3c","#3498db","#2ecc71","#f39c12"],i=["NW","NE","SW","SE"];r.forEach((e,r)=>{const a=t.append("g").attr("class","bbox-marker").attr("transform",`translate(${e[0]}, ${e[1]})`);a.append("circle").attr("r",6).attr("fill","white").attr("stroke",n[r]||"#9b59b6").attr("stroke-width",2),a.append("circle").attr("r",4).attr("fill",n[r]||"#9b59b6"),a.append("text").attr("x",10).attr("y",4).attr("font-size","11px").attr("font-family","Arial, sans-serif").attr("fill",n[r]||"#9b59b6").attr("font-weight","bold").attr("class","bbox-marker-label").text(i[r]||`${r+1}`)})}},t.LayerManager=s,t.LegendLayer=class extends o{constructor(t){super(`legend-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.scale=t.scale,this.position=t.position,this.title=t.title,this.orientation=t.orientation||"vertical",this.itemSpacing=t.itemSpacing||20,this.fontSize=t.fontSize||12,this.width=t.width,this.height=t.height,this.symbolType=t.symbolType||this.inferSymbolType(),this.symbolSize=t.symbolSize||{fixed:16},this.sizeScale=t.sizeScale,this.gradientSteps=t.gradientSteps||256,this.enableDrag=!1!==t.enableDrag,this.showBackground=!1!==t.showBackground,this.overlapping=t.overlapping||!1,this.backgroundStyle={fill:"#ffffff",stroke:"#cccccc",strokeWidth:1,opacity:.9,rx:4,ry:4,padding:8,...t.backgroundStyle}}inferSymbolType(){return"continuous"===this.detectScaleType()?"gradient":"cell"}hasSizeScale(){return!!this.sizeScale}render(t){this.parentContainer=t,this.layerGroup=this.createLayerGroup(t),this.renderLegend(),this.renderBackground(),this.updatePositionTransform(),this.enableDrag&&this.setupDragBehavior(),this.setupResizeListener()}detectScaleType(){const t=this.scale;return"function"==typeof t.invertExtent?"quantized":"function"==typeof t.ticks?"continuous":"ordinal"}isColorValue(t){return"string"==typeof t&&(!!/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(t)||(!!/^rgba?\(/.test(t)||(!!/^hsla?\(/.test(t)||!!/^(red|green|blue|black|white|yellow|cyan|magenta|gray|grey|orange|purple|brown|pink)$/i.test(t))))}generateLegendData(){const t=this.detectScaleType();switch(t){case"continuous":return this.generateContinuousLegend();case"quantized":return this.generateQuantizedLegend();case"ordinal":return this.generateOrdinalLegend();default:throw new Error(`Unsupported scale type: ${t}`)}}generateContinuousLegend(){const t=this.scale,e=t.domain(),r=t.ticks?t.ticks(5):e;return{data:r,labels:r.map(t=>t.toString()),colors:r.map(e=>t(e))}}generateQuantizedLegend(){const t=this.scale,e=t.range(),r=e.length>0&&"number"==typeof e[0],n={data:e,labels:e.map(e=>{const r=t.invertExtent(e);return null!=r[0]&&null!=r[1]?`${r[0]} - ${r[1]}`:e.toString()}),colors:r?e.map(()=>"#0066cc"):e};return r&&(n.sizes=e),n}generateOrdinalLegend(){const t=this.scale,e=t.domain(),r=t.range(),n=r.length>0&&"number"==typeof r[0],i={data:e,labels:e.map(t=>t.toString()),colors:n?e.map(()=>"#0066cc"):e.map(e=>t(e))};return n&&(i.sizes=e.map(e=>t(e))),i}generateSizeScaleLegendData(){if(!this.sizeScale)throw new Error("Size scale is not defined");const t=this.sizeScale,e=t.domain(),r=t.range(),n=this.scale;return{data:e,labels:e.map(t=>t.toString()),colors:e.map(()=>{if("function"==typeof n)try{const t=n.domain();return n(t[0])||"#0066cc"}catch{return"#0066cc"}return"#0066cc"}),sizes:r}}renderLegend(){if(this.layerGroup)if(this.title&&this.renderTitle(),this.hasSizeScale())this.renderSizeScaleLegend();else switch(this.symbolType){case"cell":this.renderCellLegend();break;case"circle":this.renderCircleLegend();break;case"line":this.renderLineLegend();break;case"gradient":this.renderGradientLegend();break;default:throw new Error(`Unsupported symbol type: ${this.symbolType}`)}}renderTitle(){this.layerGroup&&this.title&&this.layerGroup.append("text").attr("class","thematika-legend-title").attr("x",0).attr("y",0).style("font-size",`${this.fontSize+2}px`).style("font-weight","bold").style("fill","#333").text(this.title)}renderCellLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),n=this.symbolSize.fixed||16;r.append("rect").attr("x",0).attr("y",0).attr("width",n).attr("height",n).attr("fill",(e,r)=>t.colors[r]).attr("stroke","#333").attr("stroke-width",.5),r.append("text").attr("x",n+4).attr("y",n/2).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderCircleLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),n=(this.symbolSize.fixed||16)/2;r.append("circle").attr("cx",n).attr("cy",n).attr("r",n).attr("fill",(e,r)=>t.colors[r]).attr("stroke","#333").attr("stroke-width",.5),r.append("text").attr("x",2*n+4).attr("y",n).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderLineLegend(){if(!this.layerGroup)return;const t=this.generateLegendData(),e=this.title?this.fontSize+10:0,r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item"),n=this.symbolSize.fixed||24;r.append("line").attr("x1",0).attr("y1",8).attr("x2",n).attr("y2",8).attr("stroke",(e,r)=>t.colors[r]).attr("stroke-width",2),r.append("text").attr("x",n+4).attr("y",8).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((e,r)=>t.labels[r]),this.positionItems(r,e,t.sizes)}renderGradientLegend(){if(!this.layerGroup)return;const t=this.scale,e=t.domain(),r=`gradient-${this.id}`,n=this.layerGroup.append("defs").append("linearGradient").attr("id",r).attr("x1","0%").attr("y1","0%").attr("x2","horizontal"===this.orientation?"100%":"0%").attr("y2","horizontal"===this.orientation?"0%":"100%"),i=this.gradientSteps;for(let r=0;r<=i;r++){const a=r/i,s=e[0]+a*(e[1]-e[0]);n.append("stop").attr("offset",100*a+"%").attr("stop-color",t(s))}const a=this.title?this.fontSize+10:0,s=this.width||200,o=this.height||20;this.layerGroup.append("rect").attr("x",0).attr("y",a).attr("width","horizontal"===this.orientation?s:o).attr("height","horizontal"===this.orientation?o:s).attr("fill",`url(#${r})`).attr("stroke","#333").attr("stroke-width",.5);const l=t.ticks?t.ticks(5):e,c=this.layerGroup.append("g").attr("transform",`translate(0, ${a})`);l.forEach((t,r)=>{const n=(t-e[0])/(e[1]-e[0]);c.append("text").attr("x","horizontal"===this.orientation?n*s:o+4).attr("y","horizontal"===this.orientation?o+16:n*s).attr("text-anchor","horizontal"===this.orientation?"middle":"start").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.toString())})}renderSizeScaleLegend(){if(!this.layerGroup)return;const t=this.generateSizeScaleLegendData(),e=this.title?this.fontSize+10:0;this.overlapping?this.renderOverlappingSizeScale(t,e):this.renderRegularSizeScale(t,e)}renderOverlappingSizeScale(t,e){if(!this.layerGroup||!t.sizes||0===t.sizes.length)return;const r=Math.max(...t.sizes);switch(this.symbolType){case"circle":default:this.renderOverlappingCircles(t,e,r);break;case"cell":this.renderOverlappingCells(t,e,r);break;case"line":this.renderOverlappingLines(t,e,r)}}renderOverlappingCircles(t,e,r){if(!this.layerGroup||!t.sizes)return;const n=r,i=n,a=e+2*n,s=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),o=this.layerGroup.append("g").attr("class","thematika-legend-symbols");s.forEach((t,e)=>{const r=a-t.size;o.append("circle").attr("cx",i).attr("cy",r).attr("r",t.size).attr("fill","none").attr("stroke","#333").attr("stroke-width",1)});const l=this.layerGroup.append("g").attr("class","thematika-legend-guidelines"),c=i+n+20,h=c-4;s.forEach((t,e)=>{const r=a-t.size-t.size,n=i;l.append("line").attr("x1",n).attr("y1",r).attr("x2",h).attr("y2",r).attr("stroke","#333").attr("stroke-width",1).attr("stroke-dasharray","3,3")});const d=this.layerGroup.append("g").attr("class","thematika-legend-labels");s.forEach((t,e)=>{const r=a-t.size-t.size;d.append("text").attr("x",c).attr("y",r).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderOverlappingCells(t,e,r){if(!this.layerGroup||!t.sizes)return;const n=Math.sqrt(r),i=n/2,a=e+n,s=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),o=this.layerGroup.append("g").attr("class","thematika-legend-symbols");s.forEach((t,e)=>{const r=Math.sqrt(t.size),n=a-r;o.append("rect").attr("x",i-r/2).attr("y",n).attr("width",r).attr("height",r).attr("fill","none").attr("stroke","#333").attr("stroke-width",1)});const l=this.layerGroup.append("g").attr("class","thematika-legend-guidelines"),c=i+n/2+20,h=c-4;s.forEach((t,e)=>{const r=Math.sqrt(t.size),n=a-r,s=i;l.append("line").attr("x1",s).attr("y1",n).attr("x2",h).attr("y2",n).attr("stroke","#333").attr("stroke-width",1).attr("stroke-dasharray","3,3")});const d=this.layerGroup.append("g").attr("class","thematika-legend-labels");s.forEach((t,e)=>{const r=Math.sqrt(t.size),n=a-r;d.append("text").attr("x",c).attr("y",n).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderOverlappingLines(t,e,r){if(!this.layerGroup||!t.sizes)return;const n=e+r/2+10,i=t.data.map((e,r)=>({data:e,label:t.labels[r],color:t.colors[r],size:t.sizes[r]})).sort((t,e)=>e.size-t.size),a=this.layerGroup.append("g").attr("class","thematika-legend-symbols");i.forEach((t,e)=>{a.append("line").attr("x1",0).attr("y1",n).attr("x2",30).attr("y2",n).attr("stroke",t.color).attr("stroke-width",t.size).attr("opacity",.8)});const s=this.layerGroup.append("g").attr("class","thematika-legend-labels"),o=this.fontSize+4;i.forEach((t,e)=>{s.append("text").attr("x",40).attr("y",n-r/2+e*o+this.fontSize).attr("dy","0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text(t.label)})}renderRegularSizeScale(t,e){if(!this.layerGroup||!t.sizes)return;const r=this.layerGroup.selectAll(".thematika-legend-item").data(t.data).enter().append("g").attr("class","thematika-legend-item");switch(this.symbolType){case"circle":default:this.renderRegularSizeCircles(r,t,e);break;case"cell":this.renderRegularSizeCells(r,t,e);break;case"line":this.renderRegularSizeLines(r,t,e)}}renderRegularSizeCircles(t,e,r){e.sizes&&(t.append("circle").attr("cx",(t,r)=>e.sizes[r]).attr("cy",(t,r)=>e.sizes[r]).attr("r",(t,r)=>e.sizes[r]).attr("fill",(t,r)=>e.colors[r]).attr("stroke","#333").attr("stroke-width",.5),t.append("text").attr("x",(t,r)=>2*e.sizes[r]+4).attr("y",(t,r)=>"horizontal"===this.orientation?0:e.sizes[r]).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes))}renderRegularSizeCells(t,e,r){e.sizes&&(t.append("rect").attr("x",0).attr("y",0).attr("width",(t,r)=>Math.sqrt(e.sizes[r])).attr("height",(t,r)=>Math.sqrt(e.sizes[r])).attr("fill",(t,r)=>e.colors[r]).attr("stroke","#333").attr("stroke-width",.5),t.append("text").attr("x",(t,r)=>Math.sqrt(e.sizes[r])+4).attr("y",(t,r)=>"horizontal"===this.orientation?0:Math.sqrt(e.sizes[r])/2).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes))}renderRegularSizeLines(t,e,r){if(!e.sizes)return;t.append("line").attr("x1",0).attr("y1",8).attr("x2",24).attr("y2",8).attr("stroke",(t,r)=>e.colors[r]).attr("stroke-width",(t,r)=>e.sizes[r]),t.append("text").attr("x",28).attr("y",(t,e)=>"horizontal"===this.orientation?0:8).attr("dy",(t,e)=>"horizontal"===this.orientation?0:"0.35em").style("font-size",`${this.fontSize}px`).style("fill","#333").text((t,r)=>e.labels[r]),this.positionItems(t,r,e.sizes)}positionItems(t,e,r){if("vertical"===this.orientation)t.attr("transform",(t,r)=>`translate(0, ${e+r*this.itemSpacing})`);else if(r&&this.hasSizeScale()){const n=Math.max(...r);t.attr("transform",(t,i)=>{const a=r[i];let s=0;return"circle"===this.symbolType?s=n-a:"cell"===this.symbolType&&(s=Math.sqrt(n)-Math.sqrt(a)),`translate(${i*this.itemSpacing}, ${e+s})`})}else t.attr("transform",(t,r)=>`translate(${r*this.itemSpacing}, ${e})`)}renderBackground(){if(!this.layerGroup)return;const t=this.calculateLegendBounds(),e=this.backgroundStyle.padding||8,r=this.showBackground?this.backgroundStyle.opacity||.9:0,n=this.layerGroup.insert("rect",":first-child").attr("class","thematika-legend-background").attr("x",t.x-e).attr("y",t.y-e).attr("width",t.width+2*e).attr("height",t.height+2*e).attr("fill",this.backgroundStyle.fill||"#ffffff").attr("stroke",this.backgroundStyle.stroke||"#cccccc").attr("stroke-width",this.backgroundStyle.strokeWidth||1).attr("opacity",r);this.backgroundStyle.rx&&n.attr("rx",this.backgroundStyle.rx),this.backgroundStyle.ry&&n.attr("ry",this.backgroundStyle.ry)}calculateLegendBounds(){if(!this.layerGroup)return{x:0,y:0,width:100,height:50};try{const t=this.layerGroup.node().getBBox();return{x:t.x,y:t.y,width:t.width,height:t.height}}catch(t){const e=this.generateLegendData().data.length,r=this.title?this.fontSize+10:0;return"vertical"===this.orientation?{x:0,y:0,width:150,height:r+e*this.itemSpacing}:{x:0,y:0,width:100*e,height:r+30}}}updatePositionTransform(){if(!this.layerGroup)return;const t=this.position.left,e=this.position.top;this.layerGroup.attr("transform",`translate(${t}, ${e})`)}setupDragBehavior(){if(!this.layerGroup)return;const t=k().on("start",()=>{this.layerGroup&&this.layerGroup.style("cursor","grabbing")}).on("drag",t=>{this.position.left+=t.dx,this.position.top+=t.dy,this.updatePositionTransform(),this.updateSliders()}).on("end",()=>{this.layerGroup&&this.layerGroup.style("cursor","grab")});this.layerGroup.style("cursor","grab").call(t)}updateSliders(){if("undefined"!=typeof window&&"undefined"!=typeof document){const t=document.getElementById("legend-x-slider"),e=document.getElementById("legend-y-slider"),r=document.getElementById("legend-x-value"),n=document.getElementById("legend-y-value");t&&e&&r&&n&&(t.value=this.position.left.toString(),e.value=this.position.top.toString(),r.textContent=this.position.left.toString(),n.textContent=this.position.top.toString())}}updateBackgroundOpacity(){if(!this.layerGroup)return;const t=this.layerGroup.select(".thematika-legend-background");if(!t.empty()){const e=this.showBackground?this.backgroundStyle.opacity||.9:0;t.attr("opacity",e)}}updateBackgroundStyles(){if(!this.layerGroup)return;const t=this.layerGroup.select(".thematika-legend-background");if(!t.empty()){const e=this.showBackground?this.backgroundStyle.opacity||.9:0;t.attr("fill",this.backgroundStyle.fill||"#ffffff").attr("stroke",this.backgroundStyle.stroke||"#cccccc").attr("stroke-width",this.backgroundStyle.strokeWidth||1).attr("opacity",e).attr("rx",this.backgroundStyle.rx||null).attr("ry",this.backgroundStyle.ry||null)}}setupResizeListener(){}},t.LineConnectionLayer=class extends o{constructor(t){super(`line-connection-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),Array.isArray(t.data)?this.data={type:"FeatureCollection",features:t.data}:"Feature"===t.data.type?this.data={type:"FeatureCollection",features:[t.data]}:this.data=t.data,this.validateData(this.data),this.lineType=t.lineType||"straight",this.arcHeight=t.arcHeight||.3,this.arcControlPoint=t.arcControlPoint||"center",this.arcOffset=t.arcOffset||"perpendicular",this.startArrow=t.startArrow||!1,this.endArrow=t.endArrow||!1,this.arrowSize=t.arrowSize||10,this.smoothType=t.smoothType||"curveBasis"}validateData(t){if(!t||"FeatureCollection"!==t.type)throw new Error("LineConnectionLayer: データはFeatureCollectionである必要があります");if(!Array.isArray(t.features))throw new Error("LineConnectionLayer: featuresが配列ではありません");t.features.forEach((t,e)=>{if(!t.geometry)throw new Error(`LineConnectionLayer: フィーチャー[${e}]にgeometryが存在しません`);const r=t.geometry,{type:n,coordinates:i}=r;if("LineString"!==n&&"MultiLineString"!==n)throw new Error(`LineConnectionLayer: フィーチャー[${e}]は'LineString'または'MultiLineString'である必要があります`);"LineString"===n?this.validateCoordinates(i,e):"MultiLineString"===n&&i.forEach((t,r)=>{this.validateCoordinates(t,e,r)})})}validateCoordinates(t,e,r){const n=void 0!==r?`[${e}]のライン[${r}]`:`[${e}]`;if(!Array.isArray(t)||t.length<2)throw new Error(`LineConnectionLayer: フィーチャー${n}は少なくとも2点の座標が必要です`);t.forEach((t,e)=>{if(!Array.isArray(t)||t.length<2)throw new Error(`LineConnectionLayer: フィーチャー${n}の座標[${e}]は[経度, 緯度]の配列である必要があります`);const[r,i]=t;if(r<-180||r>180)throw new Error(`LineConnectionLayer: フィーチャー${n}の座標[${e}]の経度は-180から180の範囲である必要があります`);if(i<-90||i>90)throw new Error(`LineConnectionLayer: フィーチャー${n}の座標[${e}]の緯度は-90から90の範囲である必要があります`)})}setProjection(t){this.projection=t,this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.layerGroup.selectAll("defs").remove(),this.createArrowMarkers(),this.renderLines())}render(t){this.layerGroup=this.createLayerGroup(t),this.createArrowMarkers(),this.renderLines()}createArrowMarkers(){if(!this.layerGroup||!this.startArrow&&!this.endArrow)return;const t=this.layerGroup.append("defs").attr("class","thematika-line-connection-defs");this.defs=t}renderLines(){if(!this.layerGroup||!this.path||!this.projection)return;const t=this.layerGroup.append("g").attr("class","thematika-line-connection-layer"),e=this.prepareAllLinesData();if(0===e.length)return;const r=t.selectAll(".thematika-line-path").data(e).enter().append("path").attr("class",(t,e)=>["thematika-line-path thematika-connection-line",this.attr.className||"",t.feature.properties?.class||"",void 0!==t.lineIndex?`line-${t.lineIndex}`:"",`global-line-${e}`].filter(Boolean).join(" ")).attr("d",t=>t.pathData).style("fill","none");super.applyAllStylesToElements(r,this.layerGroup),this.applyArrowMarkers(r)}prepareAllLinesData(){const t=[];return this.data.features.forEach((e,r)=>{const n=e.geometry;if("LineString"===n.type){const i=n.coordinates,a=this.generateLinePath(i);a&&t.push({feature:e,featureIndex:r,coordinates:i,pathData:a,needsStartArrow:this.startArrow,needsEndArrow:this.endArrow})}else"MultiLineString"===n.type&&n.coordinates.forEach((n,i)=>{const a=this.generateLinePath(n);a&&t.push({feature:e,featureIndex:r,coordinates:n,lineIndex:i,pathData:a,needsStartArrow:this.startArrow,needsEndArrow:this.endArrow})})}),t}applyArrowMarkers(t){if(!this.defs)return;const r=this;t.each(function(t,n){const i=e.select(this),a=i.style("stroke")||i.attr("stroke")||"#333";if(t.needsStartArrow){const t=`arrow-start-${r.id}-${n}`;r.createDynamicMarker(t,a,"start"),i.attr("marker-start",`url(#${t})`)}if(t.needsEndArrow){const t=`arrow-end-${r.id}-${n}`;r.createDynamicMarker(t,a,"end"),i.attr("marker-end",`url(#${t})`)}})}createDynamicMarker(t,e,r){if(!this.defs)return;this.defs.select(`#${t}`).remove();const n=this.defs.append("marker").attr("id",t).attr("viewBox","0 0 10 10").attr("markerWidth",this.arrowSize).attr("markerHeight",this.arrowSize);"start"===r?n.attr("refX",1).attr("refY",5).attr("orient","auto-start-reverse"):n.attr("refX",9).attr("refY",5).attr("orient","auto"),n.append("path").attr("d","M 0 0 L 10 5 L 0 10 z").style("fill",e)}generateSegmentPath(t,e){if(!this.projection)return"";const r=this.projection(t),n=this.projection(e);return r&&n?"straight"===this.lineType?`M${r[0]},${r[1]}L${n[0]},${n[1]}`:"arc"===this.lineType?this.generateArcPath(t,e,r,n):(this.lineType,`M${r[0]},${r[1]}L${n[0]},${n[1]}`):""}generateArcPath(t,e,r,n){if(!this.projection)return"";const i=this.calculateBaseControlPoint(t,e,r,n);if(!i)return"";const a=this.applyArcOffset(i,r,n);return`M${r[0]},${r[1]}Q${a[0]},${a[1]} ${n[0]},${n[1]}`}calculateBaseControlPoint(t,e,r,n){if(!this.projection)return null;switch(this.arcControlPoint){case"center":const r=[(t[0]+e[0])/2,(t[1]+e[1])/2];return this.projection(r);case"weighted":const n=.5,i=[t[0]+(e[0]-t[0])*n,t[1]+(e[1]-t[1])*n];return this.projection(i);default:return Array.isArray(this.arcControlPoint)?this.projection(this.arcControlPoint):null}}applyArcOffset(t,e,r){const n=r[0]-e[0],i=r[1]-e[1],a=Math.sqrt(n*n+i*i);let s=0,o=0;switch(this.arcOffset){case"perpendicular":s=-i/a*this.arcHeight*a,o=n/a*this.arcHeight*a;break;case"north":o=-this.arcHeight*a;break;case"south":o=this.arcHeight*a;break;case"east":s=this.arcHeight*a;break;case"west":s=-this.arcHeight*a;break;default:Array.isArray(this.arcOffset)&&(s=this.arcOffset[0]*a,o=this.arcOffset[1]*a)}return[t[0]+s,t[1]+o]}geoSmoothPath(t){if(!this.projection)return"";const e=t.map(t=>this.projection([t[0],t[1]])).filter(t=>null!==t);if(e.length<2)return"";const r=this.getCurveFunction();return n.line().x(t=>t[0]).y(t=>t[1]).curve(r)(e)||""}getCurveFunction(){switch(this.smoothType){case"curveBasis":default:return n.curveBasis;case"curveCardinal":return n.curveCardinal;case"curveCatmullRom":return n.curveCatmullRom;case"curveLinear":return n.curveLinear;case"curveMonotoneX":return n.curveMonotoneX;case"curveMonotoneY":return n.curveMonotoneY;case"curveNatural":return n.curveNatural;case"curveStep":return n.curveStep;case"curveStepAfter":return n.curveStepAfter;case"curveStepBefore":return n.curveStepBefore}}generateLinePath(t){if(!this.projection||t.length<2)return"";switch(this.lineType){case"straight":default:return this.generateStraightPath(t);case"arc":return this.generateArcLinePath(t);case"smooth":return this.generateSmoothPath(t)}}generateStraightPath(t){if(!this.projection)return"";const e=t.map(t=>this.projection(t)).filter(t=>null!==t);if(e.length<2)return"";let r=`M${e[0][0]},${e[0][1]}`;for(let t=1;t<e.length;t++)r+=`L${e[t][0]},${e[t][1]}`;return r}generateArcLinePath(t){if(!this.projection||t.length<2)return"";let e="";for(let r=0;r<t.length-1;r++){const n=this.generateSegmentPath(t[r],t[r+1]);if(0===r)e=n;else{e+=n.replace(/^M[^LQ]*/,"")}}return e}generateSmoothPath(t){return this.geoSmoothPath(t)}getData(){return this.data}},t.LineEdgeBundlingLayer=class extends o{constructor(t){super(`line-edgebundling-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),Array.isArray(t.data)?this.data={type:"FeatureCollection",features:t.data}:"Feature"===t.data.type?this.data={type:"FeatureCollection",features:[t.data]}:this.data=t.data,this.validateData(this.data),this.bundlingStrength=t.bundlingStrength??.85,this.forceStrength=t.forceStrength??20,this.segmentSteps=t.segmentSteps??"auto",this.showControlPoints=t.showControlPoints??!1,this.showOriginalLines=t.showOriginalLines??!1,this.animateForce=t.animateForce??!0,this.controlPointSize=t.controlPointSize??3,this.endpointSize=t.endpointSize??6}validateData(t){if(!t||"FeatureCollection"!==t.type)throw new Error("LineEdgeBundlingLayer: データはFeatureCollectionである必要があります");if(!Array.isArray(t.features))throw new Error("LineEdgeBundlingLayer: featuresが配列ではありません");t.features.forEach((t,e)=>{if(!t.geometry)throw new Error(`LineEdgeBundlingLayer: フィーチャー[${e}]にgeometryが存在しません`);const r=t.geometry,{type:n,coordinates:i}=r;if("LineString"!==n&&"MultiLineString"!==n)throw new Error(`LineEdgeBundlingLayer: フィーチャー[${e}]は'LineString'または'MultiLineString'である必要があります`);"LineString"===n?this.validateCoordinates(i,e):"MultiLineString"===n&&i.forEach((t,r)=>{this.validateCoordinates(t,e,r)})})}validateCoordinates(t,e,r){const n=void 0!==r?`[${e}]のライン[${r}]`:`[${e}]`;if(!Array.isArray(t)||t.length<2)throw new Error(`LineEdgeBundlingLayer: フィーチャー${n}は少なくとも2点の座標が必要です`);t.forEach((t,e)=>{if(!Array.isArray(t)||t.length<2)throw new Error(`LineEdgeBundlingLayer: フィーチャー${n}の座標[${e}]は[経度, 緯度]の配列である必要があります`);const[r,i]=t;if(r<-180||r>180)throw new Error(`LineEdgeBundlingLayer: フィーチャー${n}の座標[${e}]の経度は-180から180の範囲である必要があります`);if(i<-90||i>90)throw new Error(`LineEdgeBundlingLayer: フィーチャー${n}の座標[${e}]の緯度は-90から90の範囲である必要があります`)})}setProjection(t){this.projection=t,this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("*").remove(),this.simulation&&this.simulation.stop(),this.renderBundledLines())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderBundledLines()}renderBundledLines(){if(!this.layerGroup||!this.path||!this.projection)return;if(this.bundlingData=this.generateBundlingData(),!this.bundlingData||0===this.bundlingData.paths.length)return;const t=this.layerGroup.append("g").attr("class","thematika-line-edgebundling-layer");this.showOriginalLines&&this.renderOriginalLines(t),this.renderBundledPaths(t),this.showControlPoints&&this.renderControlPoints(t),this.startForceSimulation()}generateBundlingData(){const t={nodes:[],links:[],paths:[]},e=new Map;let r=0;return this.data.features.forEach((n,i)=>{const a=n.geometry;if("LineString"===a.type){const s=this.processLineString(a.coordinates,n,i,t,e,r);s&&(r=s.nextNodeId)}else"MultiLineString"===a.type&&a.coordinates.forEach((a,s)=>{const o=this.processLineString(a,n,i,t,e,r,s);o&&(r=o.nextNodeId)})}),t}processLineString(t,e,r,n,i,a,s){if(!this.projection||t.length<2)return null;const o=[];let l=a;const c=this.projection(t[0]),h=this.projection(t[t.length-1]);if(!c||!h)return null;const d=`${c[0]},${c[1]}`;if(!i.has(d)){const t={id:"node-"+l++,x:c[0],y:c[1],fx:c[0],fy:c[1],type:"endpoint",feature:e,featureIndex:r,lineIndex:s};i.set(d,t),n.nodes.push(t)}o.push(i.get(d));const u=Math.sqrt(Math.pow(h[0]-c[0],2)+Math.pow(h[1]-c[1],2)),f=this.calculateSegmentSteps(u);let p=i.get(d);for(let t=1;t<f;t++){const i=t/f,a={id:"node-"+l++,x:c[0]+i*(h[0]-c[0]),y:c[1]+i*(h[1]-c[1]),type:"control",feature:e,featureIndex:r,lineIndex:s};n.nodes.push(a),o.push(a),n.links.push({source:p.id,target:a.id}),p=a}const y=`${h[0]},${h[1]}`;if(!i.has(y)){const t={id:"node-"+l++,x:h[0],y:h[1],fx:h[0],fy:h[1],type:"endpoint",feature:e,featureIndex:r,lineIndex:s};i.set(y,t),n.nodes.push(t)}return o.push(i.get(y)),n.links.push({source:p.id,target:i.get(y).id}),n.paths.push({nodes:o,feature:e,featureIndex:r,lineIndex:s}),{nextNodeId:l}}calculateSegmentSteps(t){return"auto"===this.segmentSteps?Math.max(3,Math.min(10,Math.floor(t/50))):Math.max(2,this.segmentSteps)}renderOriginalLines(t){if(!this.path)return;t.append("g").attr("class","thematika-original-lines").selectAll("path").data(this.data.features).enter().append("path").attr("d",this.path).attr("class","thematika-line-original").style("fill","none").style("stroke","#999").style("stroke-width",1).style("opacity",.3)}renderBundledPaths(t){if(!this.bundlingData)return;const e=t.append("g").attr("class","thematika-bundled-lines"),r=n.line().curve(n.curveBundle.beta(this.bundlingStrength)).x(t=>t.x).y(t=>t.y),i=e.selectAll("path").data(this.bundlingData.paths).enter().append("path").attr("class",(t,e)=>["thematika-line-bundled",this.attr.className||"",t.feature.properties?.class||"",void 0!==t.lineIndex?`line-${t.lineIndex}`:"",`bundled-line-${e}`].filter(Boolean).join(" ")).attr("d",t=>r(t.nodes)||"").style("fill","none");super.applyAllStylesToElements(i,e)}renderControlPoints(t){if(!this.bundlingData)return;t.append("g").attr("class","thematika-control-points").selectAll("circle").data(this.bundlingData.nodes).enter().append("circle").attr("r",t=>"endpoint"===t.type?this.endpointSize:this.controlPointSize).attr("cx",t=>t.x).attr("cy",t=>t.y).attr("class",t=>"endpoint"===t.type?"thematika-endpoint":"thematika-control-point").style("fill",t=>"endpoint"===t.type?"#2d3436":"#4ecdc4").style("stroke","white").style("stroke-width",t=>"endpoint"===t.type?2:1)}startForceSimulation(){if(this.bundlingData)if(this.simulation&&this.simulation.stop(),this.simulation=i.forceSimulation(this.bundlingData.nodes).force("charge",i.forceManyBody().strength(this.forceStrength).distanceMax(100)).force("link",i.forceLink(this.bundlingData.links).id(t=>t.id).strength(.5).distance(0)).alphaDecay(.02),this.animateForce)this.simulation.on("tick",()=>this.updatePositions()),this.simulation.alpha(.3).restart();else{for(let t=0;t<300&&(this.simulation.tick(),!(this.simulation.alpha()<.01));t++);this.updatePositions()}}updatePositions(){if(!this.layerGroup||!this.bundlingData)return;const t=n.line().curve(n.curveBundle.beta(this.bundlingStrength)).x(t=>t.x).y(t=>t.y);this.layerGroup.selectAll(".thematika-line-bundled").data(this.bundlingData.paths).attr("d",e=>t(e.nodes)||""),this.showControlPoints&&this.layerGroup.selectAll(".thematika-control-point, .thematika-endpoint").data(this.bundlingData.nodes).attr("cx",t=>t.x).attr("cy",t=>t.y)}destroy(){this.simulation&&(this.simulation.stop(),this.simulation=void 0),super.destroy()}getSimulation(){if(this.animateForce)return this.simulation}setBundlingStrength(t){this.bundlingStrength=Math.max(0,Math.min(1,t)),this.layerGroup&&this.updatePositions()}},t.LineTextLayer=class extends o{constructor(t){if(super(`line-text-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),Array.isArray(t.data)?this.data={type:"FeatureCollection",features:t.data}:"Feature"===t.data.type?this.data={type:"FeatureCollection",features:[t.data]}:this.data=t.data,this.validateData(this.data),this.textProperty=t.textProperty||"text",this.textAnchor=t.textAnchor||"middle",this.startOffset=t.startOffset||"50%","function"==typeof t.fontFamily)this.fontFamilyFunction=t.fontFamily;else{const e=t.fontFamily||"メイリオ, Meiryo, 'ＭＳ Ｐゴシック', MS Gothic, sans-serif";this.fontFamilyFunction=()=>e}if("function"==typeof t.fontSize)this.fontSizeFunction=t.fontSize;else{const e=t.fontSize||16;this.fontSizeFunction=()=>e}if("function"==typeof t.fontWeight)this.fontWeightFunction=t.fontWeight;else{const e=t.fontWeight||"normal";this.fontWeightFunction=()=>e}if(this.lineType=t.lineType||"straight",this.arcHeight=t.arcHeight||.3,this.arcControlPoint=t.arcControlPoint||"center",this.arcOffset=t.arcOffset||"perpendicular",this.smoothType=t.smoothType||"curveBasis",this.showGuidePath=t.showGuidePath||!1,this.guidePathStyle=t.guidePathStyle||{fill:"none",stroke:"#800080",strokeWidth:1,strokeDasharray:"5,5",opacity:.7},this.followPath=void 0===t.followPath||t.followPath,this.flipText=t.flipText||!1,"function"==typeof t.dx)this.dxFunction=t.dx;else{const e=t.dx||0;this.dxFunction=()=>e}if("function"==typeof t.dy)this.dyFunction=t.dy;else{const e=t.dy||0;this.dyFunction=()=>e}}validateData(t){if(!t||"FeatureCollection"!==t.type)throw new Error("LineTextLayer: データはFeatureCollectionである必要があります");if(!Array.isArray(t.features))throw new Error("LineTextLayer: featuresが配列ではありません");t.features.forEach((t,e)=>{if(!t.geometry)throw new Error(`LineTextLayer: フィーチャー[${e}]にgeometryが存在しません`);const r=t.geometry,{type:n,coordinates:i}=r;if("LineString"!==n&&"MultiLineString"!==n)throw new Error(`LineTextLayer: フィーチャー[${e}]は'LineString'または'MultiLineString'である必要があります`);"LineString"===n?this.validateCoordinates(i,e):"MultiLineString"===n&&i.forEach((t,r)=>{this.validateCoordinates(t,e,r)})})}validateCoordinates(t,e,r){const n=void 0!==r?`[${e}]のライン[${r}]`:`[${e}]`;if(!Array.isArray(t)||t.length<2)throw new Error(`LineTextLayer: フィーチャー${n}は少なくとも2点の座標が必要です`);t.forEach((t,e)=>{if(!Array.isArray(t)||t.length<2)throw new Error(`LineTextLayer: フィーチャー${n}の座標[${e}]は[経度, 緯度]の配列である必要があります`);const[r,i]=t;if(r<-180||r>180)throw new Error(`LineTextLayer: フィーチャー${n}の座標[${e}]の経度は-180から180の範囲である必要があります`);if(i<-90||i>90)throw new Error(`LineTextLayer: フィーチャー${n}の座標[${e}]の緯度は-90から90の範囲である必要があります`)})}setProjection(t){this.projection=t,this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("*").remove(),this.render(this.layerGroup))}render(t){this.layerGroup=this.createLayerGroup(t),this.projection?(this.showGuidePath&&this.renderGuidePaths(),this.renderUnifiedText()):console.warn("LineTextLayer: 投影法が設定されていません")}renderUnifiedText(){if(!this.layerGroup||!this.projection)return;const t=this.prepareAllTextLinesData();0!==t.length&&(this.followPath?this.renderTextPathUnified(t):this.renderSimpleTextUnified(t))}prepareAllTextLinesData(){const t=[];return this.data.features.forEach((e,r)=>{let n="";if(e.properties&&(n=e.properties[this.textProperty]||e.properties.name||""),!n)return;const i=e.geometry;if("LineString"===i.type){const a=i.coordinates,s=this.createLineTextData(e,r,a,n);s&&t.push(s)}else"MultiLineString"===i.type&&i.coordinates.forEach((i,a)=>{const s=this.createLineTextData(e,r,i,n,a);s&&t.push(s)})}),t}createLineTextData(t,e,r,n,i){if(r.length<2)return null;const a={feature:t,featureIndex:e,coordinates:r,textContent:n,lineIndex:i};if(this.followPath){let t=this.generateLineStringPath(r);this.flipText&&t&&(t=this.reversePath(t)),a.pathData=t}else{const t=r[Math.floor(r.length/2)],e=this.projection(t);e&&(a.centerPoint=e)}return a}renderTextPathUnified(t){if(!this.layerGroup)return;const e=this.layerGroup.append("defs"),r=this.layerGroup.append("g").attr("class","thematika-line-text-layer");t.forEach((t,r)=>{if(t.pathData){const r=`line-text-path-${this.id}-${t.featureIndex}${void 0!==t.lineIndex?`-${t.lineIndex}`:""}`;e.append("path").attr("id",r).attr("d",t.pathData).attr("fill","none").attr("stroke","none")}});const n=r.selectAll(".thematika-line-text").data(t.filter(t=>t.pathData)).enter().append("text").attr("font-family",(t,e)=>this.fontFamilyFunction(t.feature,t.featureIndex)).attr("font-size",(t,e)=>this.fontSizeFunction(t.feature,t.featureIndex)).attr("font-weight",(t,e)=>this.fontWeightFunction(t.feature,t.featureIndex)).attr("class",(t,e)=>["thematika-line-text",this.attr.className||"",t.feature.properties?.class||"",void 0!==t.lineIndex?`line-${t.lineIndex}`:"",`global-text-${e}`].filter(Boolean).join(" "));n.append("textPath").attr("href",(t,e)=>`#line-text-path-${this.id}-${t.featureIndex}${void 0!==t.lineIndex?`-${t.lineIndex}`:""}`).attr("startOffset",this.startOffset).attr("text-anchor",this.textAnchor).text((t,e)=>t.textContent),this.layerGroup&&this.applyAllStylesToElements(n,this.layerGroup)}renderSimpleTextUnified(t){if(!this.layerGroup)return;const e=this.layerGroup.append("g").attr("class","thematika-line-text-layer").selectAll(".thematika-line-text").data(t.filter(t=>t.centerPoint)).enter().append("text").attr("x",(t,e)=>t.centerPoint[0]+this.dxFunction(t.feature,t.featureIndex)).attr("y",(t,e)=>t.centerPoint[1]+this.dyFunction(t.feature,t.featureIndex)).attr("font-family",(t,e)=>this.fontFamilyFunction(t.feature,t.featureIndex)).attr("font-size",(t,e)=>this.fontSizeFunction(t.feature,t.featureIndex)).attr("font-weight",(t,e)=>this.fontWeightFunction(t.feature,t.featureIndex)).attr("text-anchor",this.textAnchor).attr("alignment-baseline","middle").attr("class",(t,e)=>["thematika-line-text",this.attr.className||"",t.feature.properties?.class||"",void 0!==t.lineIndex?`line-${t.lineIndex}`:"",`global-text-${e}`].filter(Boolean).join(" ")).text((t,e)=>t.textContent);this.layerGroup&&this.applyAllStylesToElements(e,this.layerGroup)}renderGuidePaths(){if(!this.layerGroup||!this.projection)return;const t=this.layerGroup.append("g").attr("class","thematika-line-text-guide").style("pointer-events","none"),e=t.append("defs"),r=`guide-start-${this.id}`;e.append("marker").attr("id",r).attr("viewBox","0 0 10 10").attr("refX",5).attr("refY",5).attr("markerWidth",6).attr("markerHeight",6).append("circle").attr("cx",5).attr("cy",5).attr("r",3).style("fill","#00ff00").style("stroke","#006600").style("stroke-width",1);const n=`guide-end-${this.id}`;e.append("marker").attr("id",n).attr("viewBox","0 0 10 10").attr("refX",5).attr("refY",5).attr("markerWidth",6).attr("markerHeight",6).append("circle").attr("cx",5).attr("cy",5).attr("r",3).style("fill","#ff0000").style("stroke","#660000").style("stroke-width",1),this.data.features.forEach((e,i)=>{const a=e.geometry;"LineString"===a.type?this.renderGuideLineString(t,a.coordinates,e,i,r,n):"MultiLineString"===a.type&&a.coordinates.forEach((a,s)=>{this.renderGuideLineString(t,a,e,i,r,n,s)})})}renderGuideLineString(t,e,r,n,i,a,s){if(!this.projection||e.length<2)return;const o=this.generateLineStringPath(e);if(!o)return;const l=t.append("path").attr("d",o).attr("class",()=>["thematika-line-text-guide-path",r.properties?.class||"",void 0!==s?`line-${s}`:""].filter(Boolean).join(" ")).attr("marker-start",`url(#${i})`).attr("marker-end",`url(#${a})`);Object.entries(this.guidePathStyle).forEach(([t,e])=>{"className"!==t&&("function"==typeof e?l.attr(t,e(r,n)):l.attr(t,e))})}generateSegmentPath(t,e){if(!this.projection)return"";const r=this.projection(t),n=this.projection(e);return r&&n?"straight"===this.lineType?`M${r[0]},${r[1]}L${n[0]},${n[1]}`:"arc"===this.lineType?this.generateArcPath(t,e,r,n):(this.lineType,`M${r[0]},${r[1]}L${n[0]},${n[1]}`):""}generateArcPath(t,e,r,n){if(!this.projection)return"";const i=this.calculateBaseControlPoint(t,e,r,n);if(!i)return"";const a=this.applyArcOffset(i,r,n);return`M${r[0]},${r[1]}Q${a[0]},${a[1]} ${n[0]},${n[1]}`}calculateBaseControlPoint(t,e,r,n){if(!this.projection)return null;switch(this.arcControlPoint){case"center":const r=[(t[0]+e[0])/2,(t[1]+e[1])/2];return this.projection(r);case"weighted":const n=.5,i=[t[0]+(e[0]-t[0])*n,t[1]+(e[1]-t[1])*n];return this.projection(i);default:return Array.isArray(this.arcControlPoint)?this.projection(this.arcControlPoint):null}}applyArcOffset(t,e,r){const n=r[0]-e[0],i=r[1]-e[1],a=Math.sqrt(n*n+i*i);let s=0,o=0;switch(this.arcOffset){case"perpendicular":s=-i/a*this.arcHeight*a,o=n/a*this.arcHeight*a;break;case"north":o=-this.arcHeight*a;break;case"south":o=this.arcHeight*a;break;case"east":s=this.arcHeight*a;break;case"west":s=-this.arcHeight*a;break;default:Array.isArray(this.arcOffset)&&(s=this.arcOffset[0]*a,o=this.arcOffset[1]*a)}return[t[0]+s,t[1]+o]}geoSmoothPath(t){if(!this.projection)return"";const e=t.map(t=>this.projection([t[0],t[1]])).filter(t=>null!==t);if(e.length<2)return"";const r=this.getCurveFunction();return n.line().x(t=>t[0]).y(t=>t[1]).curve(r)(e)||""}getCurveFunction(){switch(this.smoothType){case"curveBasis":default:return n.curveBasis;case"curveCardinal":return n.curveCardinal;case"curveCatmullRom":return n.curveCatmullRom;case"curveLinear":return n.curveLinear;case"curveMonotoneX":return n.curveMonotoneX;case"curveMonotoneY":return n.curveMonotoneY;case"curveNatural":return n.curveNatural;case"curveStep":return n.curveStep;case"curveStepAfter":return n.curveStepAfter;case"curveStepBefore":return n.curveStepBefore}}generateLineStringPath(t){if(!this.projection||t.length<2)return"";if("smooth"===this.lineType)return this.geoSmoothPath(t);{let e="";for(let r=0;r<t.length-1;r++){const n=this.generateSegmentPath(t[r],t[r+1]);if(0===r)e=n;else{e+=n.replace(/^M[^LQ]*/,"")}}return e}}reversePath(t){if(!t)return"";const e=t.match(/[MLQC][^MLQC]*/g);if(!e)return t;const r=[];if(e.forEach(t=>{const e=t[0],n=t.slice(1).trim().split(/[\s,]+/).map(Number);if("M"===e||"L"===e)for(let t=0;t<n.length;t+=2)void 0!==n[t]&&void 0!==n[t+1]&&r.push([n[t],n[t+1]]);else if("Q"===e)for(let t=2;t<n.length;t+=4)void 0!==n[t]&&void 0!==n[t+1]&&r.push([n[t],n[t+1]]);else if("C"===e)for(let t=4;t<n.length;t+=6)void 0!==n[t]&&void 0!==n[t+1]&&r.push([n[t],n[t+1]])}),r.length<2)return t;const n=[...r].reverse();let i=`M${n[0][0]},${n[0][1]}`;for(let t=1;t<n.length;t++)i+=`L${n[t][0]},${n[t][1]}`;return i}getData(){return this.data}},t.Map=class{constructor(t){if(this.width=t.width,this.height=t.height,this.container=e.select(t.container),this.container.empty())throw new Error(`Container not found: ${t.container}`);this.container.selectAll("svg.thematika-map").remove(),this.svg=this.container.append("svg").attr("width","100%").attr("height","100%").attr("class","thematika-map").attr("viewBox",`0 0 ${this.width} ${this.height}`).attr("preserveAspectRatio","xMidYMid meet"),this.initializeDefs(t.defs),this.svgGroup=this.svg.append("g").attr("class","thematika-main-group"),this.svgGroup.append("rect").attr("width","100%").attr("height","100%").attr("fill",t.backgroundColor||"#ffffff").attr("class","thematika-background"),this.projection=t.projection,this.layerManager=new s,this.layerManager.setContext(this.svgGroup,this.projection)}addLayer(t,e){this.layerManager.addLayer(t,e)}removeLayer(t){this.layerManager.removeLayer(t)}setLayerVisibility(t,e){this.layerManager.setLayerVisibility(t,e)}setLayerZIndex(t,e){this.layerManager.setLayerZIndex(t,e)}setProjection(t){this.projection=t,this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}resize(t,e){this.width=t,this.height=e,this.svg.attr("width",t).attr("height",e),this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}fitBounds(t,e=20){const[[r,n],[i,a]]=this.projection.invert?[this.projection([t[0],t[3]]),this.projection([t[2],t[1]])]:[[0,0],[this.width,this.height]],s=Math.min((this.width-2*e)/Math.abs(i-r),(this.height-2*e)/Math.abs(a-n)),o=[this.width/2-s*(r+i)/2,this.height/2-s*(n+a)/2];this.projection.scale(s).translate(o),this.layerManager.updateProjection(this.projection),this.layerManager.rerenderAllLayers()}clearAllLayers(){this.layerManager.clearAllLayers()}getSVG(){return this.svg.node()}getProjection(){return this.projection}getLayerManager(){return this.layerManager}getSize(){return[this.width,this.height]}getLayerIds(){return this.layerManager.getLayerIds()}saveSVG(t){const e=this.svg.node();if(!e)throw new Error("SVG要素が見つかりません");const r=(new XMLSerializer).serializeToString(e),n=new Blob([r],{type:"image/svg+xml"}),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=`${t}.svg`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}savePNG(t){const e=this.svg.node();if(!e)throw new Error("SVG要素が見つかりません");const r=(new XMLSerializer).serializeToString(e),n=document.createElement("canvas"),i=n.getContext("2d");if(!i)throw new Error("Canvas 2Dコンテキストを取得できません");const a=new Image,s=e.getBoundingClientRect();n.width=s.width||this.width,n.height=s.height||this.height,a.onload=()=>{i.drawImage(a,0,0),n.toBlob(e=>{if(!e)throw new Error("PNG Blobの生成に失敗しました");const r=URL.createObjectURL(e),n=document.createElement("a");n.href=r,n.download=`${t}.png`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r)})},a.onerror=()=>{throw new Error("画像の読み込みに失敗しました")};const o=new Blob([r],{type:"image/svg+xml"}),l=URL.createObjectURL(o);a.src=l}initializeDefs(t){t&&t.forEach(t=>{this.svg.call(t)})}},t.OutlineLayer=class extends o{constructor(t={}){super(`outline-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,{fill:"none",stroke:"#333333",strokeWidth:1,opacity:1,...t.attr},t.style||{}),this.createClipPath=t.createClipPath??!1,this.clipPathId=t.clipPathId||`outline-clip-${this.id}`}setProjection(t){this.path=r.geoPath(t),this.layerGroup&&(this.layerGroup.selectAll("path").remove(),this.renderOutline())}render(t){this.layerGroup=this.createLayerGroup(t),this.renderOutline()}renderOutline(){if(!this.layerGroup||!this.path)return;const t={type:"Sphere"},r=this.path(t);if(this.createClipPath&&r){const t=this.layerGroup.node()?.closest("svg");if(t){const n=e.select(t);n.insert("defs",":first-child").append("clipPath").attr("id",this.clipPathId).append("path").attr("d",r);const i=n.select(".thematika-main-group");i.empty()||i.attr("clip-path",this.getClipPathUrl())}}const n=this.layerGroup.append("g").attr("class","thematika-outline-layer").append("path").datum(t).attr("d",this.path).attr("class",()=>["thematika-outline",this.attr.className||""].filter(Boolean).join(" "));this.applyAllStylesToElement(n,this.layerGroup)}getClipPathId(){return this.clipPathId}getClipPathUrl(){return`url(#${this.clipPathId})`}},t.PointAnnotationLayer=class extends o{constructor(t){super(`point-annotation-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,this.annotationType=t.annotationType||"callout",this.textAccessor=t.textAccessor||this.getDefaultTextAccessor(),this.titleAccessor=t.titleAccessor,this.offsetAccessor=t.offsetAccessor,this.subjectOptions=t.subjectOptions||{},this.connectorOptions=t.connectorOptions||{},this.noteOptions=t.noteOptions||{wrap:100,align:"dynamic"}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderAnnotations()}setProjection(t){this.projection=t,this.layerGroup&&this.renderAnnotations()}getData(){return this.data}getDefaultTextAccessor(){return(t,e)=>{if(t.properties)for(const[e,r]of Object.entries(t.properties))if("string"==typeof r&&r.trim())return r;return`Point ${e+1}`}}getTextValue(t,e){return"string"==typeof this.textAccessor?t.properties?.[this.textAccessor]||`Point ${e+1}`:this.textAccessor(t,e)}getTitleValue(t,e){if(this.titleAccessor)return"string"==typeof this.titleAccessor?t.properties?.[this.titleAccessor]:this.titleAccessor(t,e)}getOffsetValue(t,e){return this.offsetAccessor?this.offsetAccessor(t,e):[30,-20]}resolveStyleValue(t,e,r,n){return void 0===t?n:"function"==typeof t?t(e,r):t}getSubjectType(){if(this.subjectOptions.type)return this.subjectOptions.type;switch(this.annotationType){case"calloutCircle":case"badge":return"circle";case"calloutRect":return"rect";default:return"point"}}prepareAnnotationData(){if(!this.projection)return[];return this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const n=this.projection(r);if(!n)return null;const[i,a]=this.getOffsetValue(t,e),s=this.getTextValue(t,e),o=this.getTitleValue(t,e);return{feature:t,index:e,x:n[0],y:n[1],text:s,title:o,dx:i,dy:a}}).filter(t=>null!==t)}renderAnnotations(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("*").remove();this.prepareAnnotationData().forEach((t,e)=>{this.drawSingleAnnotation(t,e)});const t=this.layerGroup.selectAll(".annotation");this.applyAllStylesToElement(t,this.layerGroup)}drawSingleAnnotation(t,e){const r=this.layerGroup.append("g").attr("class","annotation thematika-point-annotation").attr("transform",`translate(${t.x}, ${t.y})`);switch(this.drawSubject(r,t),this.annotationType){case"callout":case"calloutCircle":case"calloutRect":default:this.drawConnector(r,t,"line"),this.drawNote(r,t);break;case"calloutElbow":this.drawConnector(r,t,"elbow"),this.drawNote(r,t);break;case"calloutCurve":this.drawConnector(r,t,"curve"),this.drawNote(r,t);break;case"label":this.drawLabel(r,t);break;case"badge":this.drawBadgeText(r,t)}}drawSubject(t,e){const r=this.getSubjectType(),n=e.feature,i=e.index,a=this.resolveStyleValue(this.subjectOptions.fill,n,i,"#e74c3c"),s=this.resolveStyleValue(this.subjectOptions.stroke,n,i,"white"),o=this.resolveStyleValue(this.subjectOptions.strokeWidth,n,i,1),l=this.resolveStyleValue(this.subjectOptions.strokeDasharray,n,i,"none");switch(r){case"point":this.drawPointSubject(t,e,{fill:a,stroke:s,strokeWidth:o,strokeDasharray:l});break;case"circle":this.drawCircleSubject(t,e,{fill:a,stroke:s,strokeWidth:o,strokeDasharray:l});break;case"rect":this.drawRectSubject(t,e,{fill:a,stroke:s,strokeWidth:o,strokeDasharray:l})}}drawPointSubject(t,e,r){const n=this.resolveStyleValue(this.subjectOptions.r,e.feature,e.index,3);t.append("circle").attr("class","annotation-subject").attr("r",n).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawCircleSubject(t,e,r){const n=this.resolveStyleValue(this.subjectOptions.r,e.feature,e.index,this.subjectOptions.radius||8);t.append("circle").attr("class","annotation-subject").attr("r",n).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawRectSubject(t,e,r){const n=this.resolveStyleValue(this.subjectOptions.width,e.feature,e.index,16),i=this.resolveStyleValue(this.subjectOptions.height,e.feature,e.index,16);t.append("rect").attr("class","annotation-subject").attr("x",-n/2).attr("y",-i/2).attr("width",n).attr("height",i).attr("fill",r.fill).attr("stroke",r.stroke).attr("stroke-width",r.strokeWidth).attr("stroke-dasharray",r.strokeDasharray)}drawConnector(t,e,r){const n=this.resolveStyleValue(this.connectorOptions.stroke,e.feature,e.index,"#666"),i=this.resolveStyleValue(this.connectorOptions.strokeWidth,e.feature,e.index,1),a=this.resolveStyleValue(this.connectorOptions.strokeDasharray,e.feature,e.index,"none");switch(r){case"line":t.append("line").attr("class","annotation-connector").attr("x1",0).attr("y1",0).attr("x2",e.dx).attr("y2",e.dy).attr("stroke",n).attr("stroke-width",i).attr("stroke-dasharray",a);break;case"elbow":const r=`M 0,0 L ${e.dx,e.dx},${e.dy>0?0:e.dy} L ${e.dx},${e.dy}`;t.append("path").attr("class","annotation-connector").attr("d",r).attr("fill","none").attr("stroke",n).attr("stroke-width",i).attr("stroke-dasharray",a);break;case"curve":const s=`M 0,0 Q ${.5*e.dx},${0} ${e.dx},${e.dy}`;t.append("path").attr("class","annotation-connector").attr("d",s).attr("fill","none").attr("stroke",n).attr("stroke-width",i).attr("stroke-dasharray",a)}}drawLabel(t,e){t.append("text").attr("class","annotation-note-text").attr("x",0).attr("y",e.dy).attr("text-anchor","middle").attr("dominant-baseline","central").style("font-size",this.noteOptions.fontSize||"12px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("fill",this.noteOptions.textColor||"black").html(e.text)}drawBadgeText(t,e){t.append("text").attr("class","annotation-badge-text").attr("text-anchor","middle").attr("dominant-baseline","central").style("font-size",this.noteOptions.fontSize||"10px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("font-weight","bold").style("fill",this.noteOptions.textColor||"white").html(e.text.substring(0,3))}drawNote(t,e){const r=this.noteOptions.padding||4,n=t.append("rect").attr("class","annotation-note-bg").attr("fill",this.noteOptions.backgroundColor||"white").attr("stroke",this.noteOptions.borderColor||"#ccc").attr("stroke-width",this.noteOptions.borderWidth||1).attr("rx",this.noteOptions.borderRadius||2),i=t.append("text").attr("class","annotation-note-text").attr("x",e.dx).attr("y",e.dy).attr("text-anchor",this.getTextAnchor(e.dx)).attr("dominant-baseline",this.getBaseline(e.dy)).style("font-size",this.noteOptions.fontSize||"12px").style("font-family",this.noteOptions.fontFamily||"Arial, sans-serif").style("fill",this.noteOptions.textColor||"black");e.title?(i.append("tspan").attr("x",e.dx).attr("dy",0).style("font-weight","bold").html(e.title),i.append("tspan").attr("x",e.dx).attr("dy","1.2em").html(e.text)):i.html(e.text),setTimeout(()=>{const t=i.node()?.getBBox();t&&n.attr("x",t.x-r).attr("y",t.y-r).attr("width",t.width+2*r).attr("height",t.height+2*r)},0)}getTextAnchor(t){return t>0?"start":t<0?"end":"middle"}getBaseline(t){return t>0?"hanging":t<0?"alphabetic":"central"}},t.PointCircleLayer=class extends o{constructor(t){if(super(`point-circle-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,"function"==typeof t.r)this.radiusFunction=t.r;else{const e=t.r||5;this.radiusFunction=()=>e}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderCircles()}setProjection(t){this.projection=t,this.layerGroup&&this.renderCircles()}renderCircles(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-circle-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const n=this.projection(r);return{feature:t,index:e,x:n?n[0]:0,y:n?n[1]:0,r:this.radiusFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y),e=this.layerGroup.append("g").attr("class","thematika-point-circle-layer").selectAll("circle").data(t).enter().append("circle").attr("cx",t=>t.x).attr("cy",t=>t.y).attr("r",t=>t.r).attr("class",t=>["thematika-point-circle",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(e,this.layerGroup)}getData(){return this.data}},t.PointSpikeLayer=class extends o{constructor(t){if(super(`point-spike-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,"function"==typeof t.length)this.lengthFunction=t.length;else{const e=t.length||50;this.lengthFunction=()=>e}this.direction=t.direction||"up"}render(t){this.layerGroup=this.createLayerGroup(t),this.renderSpikes()}setProjection(t){this.projection=t,this.layerGroup&&this.renderSpikes()}renderSpikes(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-spike-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const n=this.projection(r);return{feature:t,index:e,x:n?n[0]:0,y:n?n[1]:0,length:this.lengthFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y),e=this.layerGroup.append("g").attr("class","thematika-point-spike-layer").selectAll("path").data(t).enter().append("path").attr("transform",t=>`translate(${t.x},${t.y})`).attr("d",t=>this.generateSpikePath(t.length)).attr("class",t=>["thematika-point-spike",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(e,this.layerGroup)}generateSpikePath(t){const e=.2*t;switch(this.direction){case"up":default:return`M 0,0 L ${-e/2},0 L 0,${-t} L ${e/2},0 Z`;case"down":return`M 0,0 L ${-e/2},0 L 0,${t} L ${e/2},0 Z`;case"left":return`M 0,0 L 0,${-e/2} L ${-t},0 L 0,${e/2} Z`;case"right":return`M 0,0 L 0,${-e/2} L ${t},0 L 0,${e/2} Z`}}getData(){return this.data}},t.PointSymbolLayer=class extends o{constructor(t){if(super(`point-symbol-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,"function"==typeof t.size)this.sizeFunction=t.size;else{const e=t.size||64;this.sizeFunction=()=>e}if("function"==typeof t.symbolType)this.symbolTypeFunction=t.symbolType;else{const e=t.symbolType||n.symbolCross;this.symbolTypeFunction=()=>e}}render(t){this.layerGroup=this.createLayerGroup(t),this.renderSymbols()}setProjection(t){this.projection=t,this.layerGroup&&this.renderSymbols()}renderSymbols(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-symbol-layer").remove();const t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const n=this.projection(r);return{feature:t,index:e,x:n?n[0]:0,y:n?n[1]:0,size:this.sizeFunction(t,e),symbolType:this.symbolTypeFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y),e=this.layerGroup.append("g").attr("class","thematika-point-symbol-layer").selectAll("path").data(t).enter().append("path").attr("transform",t=>`translate(${t.x}, ${t.y})`).attr("d",t=>n.symbol().type(t.symbolType).size(t.size)()||"").attr("class",t=>["thematika-point-symbol",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" "));this.applyAllStylesToElements(e,this.layerGroup)}getData(){return this.data}},t.PointTextLayer=class extends o{constructor(t){if(super(`point-text-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,t.attr||{},t.style||{}),this.data=Array.isArray(t.data)?{type:"FeatureCollection",features:t.data}:t.data,this.textProperty=t.textProperty||"text","function"==typeof t.dx)this.dxFunction=t.dx;else{const e=t.dx||0;this.dxFunction=()=>e}if("function"==typeof t.dy)this.dyFunction=t.dy;else{const e=t.dy||0;this.dyFunction=()=>e}if("function"==typeof t.rotate)this.rotateFunction=t.rotate;else{const e=t.rotate||0;this.rotateFunction=()=>e}if(this.lengthAdjust=t.lengthAdjust||"spacing",this.alignmentBaseline=t.alignmentBaseline||"middle",this.textAnchor=t.textAnchor||"start","function"==typeof t.fontFamily)this.fontFamilyFunction=t.fontFamily;else{const e=t.fontFamily||"メイリオ, Meiryo, 'ＭＳ Ｐゴシック', MS Gothic, sans-serif";this.fontFamilyFunction=()=>e}if("function"==typeof t.fontSize)this.fontSizeFunction=t.fontSize;else{const e=t.fontSize||16;this.fontSizeFunction=()=>e}if("function"==typeof t.fontWeight)this.fontWeightFunction=t.fontWeight;else{const e=t.fontWeight||"normal";this.fontWeightFunction=()=>e}this.avoidOverlap=t.avoidOverlap||!1,this.showConnectors=t.showConnectors||!1,this.connectorStyle=t.connectorStyle,this.voronoiMargin=t.voronoiMargin||20}render(t){this.layerGroup=this.createLayerGroup(t),this.renderTexts()}setProjection(t){this.projection=t,this.layerGroup&&this.renderTexts()}renderTexts(){if(!this.layerGroup||!this.projection)return;this.layerGroup.selectAll("g.thematika-point-text-layer").remove(),this.layerGroup.selectAll("g.thematika-point-text-connectors").remove();let t=this.data.features.map((t,e)=>{let r;if("Point"===t.geometry.type)r=t.geometry.coordinates;else{const e=L(t);r=[e.x,e.y]}const n=this.projection?this.projection(r):null;let i="";return t.properties&&(i=t.properties[this.textProperty]||t.properties.name||""),{feature:t,index:e,text:String(i),x:n?n[0]:0,y:n?n[1]:0,dx:this.dxFunction(t,e),dy:this.dyFunction(t,e),rotate:this.rotateFunction(t,e),fontFamily:this.fontFamilyFunction(t,e),fontSize:this.fontSizeFunction(t,e),fontWeight:this.fontWeightFunction(t,e)}}).filter(t=>null!==t.x&&null!==t.y&&""!==t.text);if(this.avoidOverlap&&(t=this.calculateVoronoiPositions(t)),this.avoidOverlap&&this.showConnectors){const e=this.layerGroup.append("g").attr("class","thematika-point-text-connectors").selectAll("path").data(t.filter(t=>!1!==t.hasVoronoi)).enter().append("path").attr("d",t=>this.createCurvedPath(t.originalX||t.x,t.originalY||t.y,t.voronoiX||t.x,t.voronoiY||t.y)).attr("class","thematika-point-text-connector").attr("fill","none");if(this.connectorStyle){const t="function"==typeof this.connectorStyle;e.each((e,r,n)=>{const i=n[r],a=this.layerGroup.select(()=>i),s=t?this.connectorStyle(e.feature,e.index):this.connectorStyle;s&&"object"==typeof s&&Object.entries(s).forEach(([t,e])=>{a.style(t,e)})})}}const e=this.layerGroup.append("g").attr("class","thematika-point-text-layer").selectAll("text").data(t).enter().append("text").attr("x",t=>this.avoidOverlap&&void 0!==t.voronoiX?t.voronoiX:t.x).attr("y",t=>this.avoidOverlap&&void 0!==t.voronoiY?t.voronoiY:t.y).attr("dx",t=>t.dx).attr("dy",t=>t.dy).attr("transform",t=>{const e=this.avoidOverlap&&void 0!==t.voronoiX?t.voronoiX:t.x,r=this.avoidOverlap&&void 0!==t.voronoiY?t.voronoiY:t.y;return 0!==t.rotate?`rotate(${t.rotate}, ${e}, ${r})`:null}).attr("lengthAdjust",this.lengthAdjust).attr("alignment-baseline",this.alignmentBaseline).attr("text-anchor",this.textAnchor).attr("font-family",t=>t.fontFamily).attr("font-size",t=>t.fontSize).attr("font-weight",t=>t.fontWeight).attr("class",t=>["thematika-point-text",this.attr.className||"",t.feature.properties?.class||""].filter(Boolean).join(" ")).text(t=>t.text);this.applyAllStylesToElements(e,this.layerGroup)}calculateVoronoiPositions(t){if(!this.avoidOverlap||0===t.length)return t;const e=this.layerGroup?.node()?.closest("svg");if(!e)return t;const r=e.getBoundingClientRect(),n=r.width,i=r.height,a=et.from(t,t=>t.x,t=>t.y).voronoi([-this.voronoiMargin,-this.voronoiMargin,n+this.voronoiMargin,i+this.voronoiMargin]);return t.map((t,e)=>{const r=a.cellPolygon(e);if(r&&r.length>0){const e=function(t){for(var e,r,n=-1,i=t.length,a=0,s=0,o=t[i-1],l=0;++n<i;)e=o,o=t[n],l+=r=e[0]*o[1]-o[0]*e[1],a+=(e[0]+o[0])*r,s+=(e[1]+o[1])*r;return[a/(l*=3),s/l]}(r);return{...t,voronoiX:e[0],voronoiY:e[1],originalX:t.x,originalY:t.y,hasVoronoi:!0}}return{...t,voronoiX:t.x,voronoiY:t.y,originalX:t.x,originalY:t.y,hasVoronoi:!1}})}createCurvedPath(t,e,r,n){return`M${t},${e} Q${(t+r)/2+.1*(n-e)},${(e+n)/2-.1*(r-t)} ${r},${n}`}getData(){return this.data}},t.TailwindPalettes=At,t.TexturePresets=xt,t.ViridissPalettes=Mt,t.calculateOptimalZoom=function(t,e,r,n={}){try{const[i,a,s,o]=t;if(!Array.isArray(t)||4!==t.length)throw new Error("boundsは[west, south, east, north]の形式で指定してください");if(!t.every(t=>isFinite(t)))throw new Error("boundsの値は有効な数値で指定してください");if(i>=s||a>=o)throw new Error("無効な境界が指定されました（west < east, south < northである必要があります）");if(!isFinite(e)||!isFinite(r)||e<=0||r<=0)throw new Error("地図のサイズは正の数値で指定してください");const l=n.minZoom??0,c=n.maxZoom??18,h=n.tileSize??256,d=s-i,u=o-a,f=(o+a)/2*Math.PI/180,p=bt*Math.cos(f)/360,y=d*p,g=u*111319.49079444444;let m=l;for(let t=l;t<=c;t++){const n=bt/(h*Math.pow(2,t));if(!(y/n<=e&&g/n<=r))break;m=t}return Math.max(l,Math.min(c,m))}catch(t){throw new Error(`最適ズームレベルの計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.chainFilters=function(t){return t.map(t=>`url(#${t})`).join(" ")},t.checkColorBlindnessSafety=function(t){const e=["protanopia","deuteranopia","tritanopia"];for(const r of e){const e=t.map(t=>Et(t,r));for(let t=0;t<e.length;t++)for(let r=t+1;r<e.length;r++){if(Pt(e[t],e[r])<50)return!1}}return!0},t.createBloom=it,t.createClipPolygon=function(t){const e=e=>{const n=r.geoPath(t.projection),i=e.append("clipPath").attr("id",t.id);if("Feature"===t.polygon.type){const e=n(t.polygon);e&&i.append("path").attr("d",e)}else"FeatureCollection"===t.polygon.type&&t.polygon.features.forEach((t,e)=>{const r=n(t);r&&i.append("path").attr("d",r).attr("class",`clip-path-${e}`)})};return e.url=()=>st(t.id),e},t.createCustomFilter=function(t,e){return r=>{r.append("defs").html(`<filter id="${t}">${e}</filter>`)}},t.createDesertTexture=gt,t.createDotsTexture=dt,t.createDropShadow=nt,t.createForestTexture=yt,t.createGaussianBlur=rt,t.createLinesTexture=ut,t.createMountainTexture=mt,t.createOceanTexture=pt,t.createPathsTexture=ft,t.expandBbox=function(t,e=.1){const{width:r,height:n}=A(t),i=r*e,a=n*e;return{minX:t.minX-i,minY:t.minY-a,maxX:t.maxX+i,maxY:t.maxY+a}},t.generateOptimizedPalette=function(t,e){if(e<=t.colors.length){if("categorical"===t.type)return t.colors.slice(0,e);return Array.from({length:e},(r,n)=>Math.floor(n*(t.colors.length-1)/(e-1))).map(e=>t.colors[e])}return t.colors},t.generateTileUrls=function(t,e,r){try{const[n,i,a,s]=t;if(!Array.isArray(t)||4!==t.length)throw new Error("boundsは[west, south, east, north]の形式で指定してください");if(!t.every(t=>isFinite(t)))throw new Error("boundsの値は有効な数値で指定してください");if(n>=a||i>=s)throw new Error("無効な境界が指定されました（west < east, south < northである必要があります）");if(!(r.urlTemplate&&r.urlTemplate.includes("{x}")&&r.urlTemplate.includes("{y}")&&r.urlTemplate.includes("{z}")))throw new Error("URLテンプレートには{x}, {y}, {z}のプレースホルダーを含める必要があります");const o=r.minZoom??0,l=r.maxZoom??18,c=r.clampToBounds??!0;if(e<o||e>l)throw new Error(`ズームレベル${e}は許可範囲（${o}〜${l}）外です`);const h=St(n,s,e),d=St(a,i,e),u=Math.min(h.x,d.x),f=Math.max(h.x,d.x),p=Math.min(h.y,d.y),y=Math.max(h.y,d.y),g=[];for(let t=u;t<=f;t++)for(let o=p;o<=y;o++)try{const l=vt(t,o,e);if(c){const t=l.west,e=l.east,r=l.south,o=l.north;if(e<=n||t>=a||o<=i||r>=s)continue}const h=r.urlTemplate.replace("{x}",t.toString()).replace("{y}",o.toString()).replace("{z}",e.toString());g.push({coordinate:{x:t,y:o,z:e},url:h,bounds:l})}catch(r){console.warn(`タイル(${t}, ${o}, ${e})の生成をスキップしました:`,r)}return 0===g.length&&console.warn("指定された範囲に有効なタイルが見つかりませんでした"),g}catch(t){throw new Error(`タイルURL生成に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.getBbox=function(t){const e=[];if("Feature"===t.type?e.push(...M(t.geometry)):"FeatureCollection"===t.type?t.features.forEach(t=>{e.push(...M(t.geometry))}):("coordinates"in t||"geometries"in t)&&e.push(...M(t)),0===e.length)return{minX:0,minY:0,maxX:0,maxY:0};const[r,n,i,a]=function(t){let e=1/0,r=1/0,n=-1/0,i=-1/0;for(const[a,s]of t)e=Math.min(e,a),r=Math.min(r,s),n=Math.max(n,a),i=Math.max(i,s);return[e,r,n,i]}(e);return{minX:r,minY:n,maxX:i,maxY:a}},t.getBboxCenter=function(t){return{x:(t.minX+t.maxX)/2,y:(t.minY+t.maxY)/2}},t.getBboxDimensions=A,t.getCentroid=L,t.getFilterUrl=st,t.getResolution=function(t,e=0,r=256){try{if(!isFinite(t)||t<0)throw new Error("無効なズームレベルが指定されました");if(!isFinite(e)||e<-90||e>90)throw new Error("無効な緯度が指定されました");if(!isFinite(r)||r<=0)throw new Error("無効なタイルサイズが指定されました");const n=e*Math.PI/180,i=bt/(r*Math.pow(2,t));return i*Math.cos(n)}catch(t){throw new Error(`解像度の計算に失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.getTileBounds=vt,t.getTileXYZ=St,t.isValidGeoJSON=function(t){try{if(!t||"object"!=typeof t)return!1;return["Feature","FeatureCollection","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"].includes(t.type)}catch{return!1}},t.isValidTileCoordinate=function(t,e,r){if(!Number.isInteger(t)||!Number.isInteger(e)||!Number.isInteger(r))return!1;if(r<0||r>30)return!1;const n=Math.pow(2,r);return t>=0&&t<n&&e>=0&&e<n},t.logTestResult=function(t,e=!1){console.log("=== 座標変換テスト結果 ==="),console.log(`総座標数: ${t.totalCoords}`),console.log(`正常座標数: ${t.normalCoords}`),console.log(`異常座標数: ${t.abnormalCoords}`),console.log(t.summary),e&&t.abnormalCoords>0&&(console.warn("異常値の詳細:"),t.abnormalDetails.forEach((t,e)=>{console.warn(`  ${e+1}. ${t.featureName}: [${t.originalCoord}] → [${t.projectedCoord.map(t=>t.toFixed(2))}] (${t.outOfBounds.x}, ${t.outOfBounds.y})`)}))},t.merge=function(t){const e=[];return t.forEach(t=>{"Feature"===t.type?e.push(t):"FeatureCollection"===t.type?e.push(...t.features):("coordinates"in t||"geometries"in t)&&e.push({type:"Feature",properties:{},geometry:t})}),{type:"FeatureCollection",features:e}},t.mergeBbox=function(t,e){return{minX:Math.min(t.minX,e.minX),minY:Math.min(t.minY,e.minY),maxX:Math.max(t.maxX,e.maxX),maxY:Math.max(t.maxY,e.maxY)}},t.readCOG=async function(t,e={}){const{resampleMethod:r="nearest",imageIndex:n=0,samples:i=[0,1,2],pool:s,sizeLimit:o={maxWidth:512,maxHeight:512,onExceed:"resample"},outputWidth:l,outputHeight:c,bbox:h}=e,d=o.maxWidth??512,u=o.maxHeight??512,f=o.onExceed??"resample";try{const e=await a.fromUrl(t),o=await e.getImageCount();if(n>=o)throw new Error(`画像インデックス ${n} は範囲外です。利用可能なインデックス: 0-${o-1}`);const p=await e.getImage(n),y=p.getWidth(),g=p.getHeight();let m,x;try{m=p.getBoundingBox(),x=[m[0],m[1],m[2],m[3]]}catch(t){m=(await e.getImage(0)).getBoundingBox(),x=[m[0],m[1],m[2],m[3]]}let w=l??y,b=c??g,S=!1;if(w>d||b>u){if("error"===f)throw new Error(`画像サイズ（${y}x${g}）が制限（${d}x${u}）を超えています`);const t=y/g;w/b>t?(b=u,w=Math.floor(b*t)):(w=d,b=Math.floor(w/t)),S=!0}(l||c)&&(S=!0);const v={samples:i,pool:s,interleave:!0};if(h){const[t,e,r,n]=h,[i,a,s,o]=m,l=Math.floor((t-i)/(s-i)*y),c=Math.ceil((r-i)/(s-i)*y),d=Math.floor((o-n)/(o-a)*g),u=Math.ceil((o-e)/(o-a)*g);v.window=[Math.max(0,l),Math.max(0,d),Math.min(y,c),Math.min(g,u)],w=v.window[2]-v.window[0],b=v.window[3]-v.window[1];const f=i+v.window[0]/y*(s-i),p=i+v.window[2]/y*(s-i),S=o-v.window[1]/g*(o-a);x=[f,o-v.window[3]/g*(o-a),p,S]}if(S||w>d||b>u){const t=w/b;(w>d||b>u)&&(w/b>t?(b=u,w=Math.floor(b*t)):(w=d,b=Math.floor(w/t)),S=!0),v.width=w,v.height=b,v.resampleMethod=r}let k,M,L;try{k=await p.readRGB(v),M=k.width,L=k.height}catch(t){if(k=await p.readRasters(v),M=k.width,L=k.height,Array.isArray(k)){const t=Math.min(3,k.length),e=M*L,r=new Uint8Array(3*e);for(let n=0;n<e;n++){for(let e=0;e<t;e++)r[3*n+e]=k[e][n]||0;for(let e=t;e<3;e++)r[3*n+e]=0}k=r}}const A=document.createElement("canvas");A.width=M,A.height=L;const C=A.getContext("2d");if(!C)throw new Error("Canvas contextの取得に失敗しました");const $=C.createImageData(M,L),E=$.data,z=k,P=M*L;for(let t=0;t<P;t++){const e=4*t,r=3*t;if(r+2<z.length)E[e]=z[r]||0,E[e+1]=z[r+1]||0,E[e+2]=z[r+2]||0;else{const r=z[t]||0;E[e]=r,E[e+1]=r,E[e+2]=r}E[e+3]=255}C.putImageData($,0,0);return{dataUri:A.toDataURL("image/png"),bounds:x,width:M,height:L,originalWidth:y,originalHeight:g,wasResampled:S}}catch(t){throw new Error(`COGの読み込みに失敗しました: ${t instanceof Error?t.message:String(t)}`)}},t.recommendPalette=function(t,e,r=!0){return Object.values(Ct).filter(n=>n.type===t&&(!(n.maxClasses&&e>n.maxClasses)&&!(r&&!n.colorBlindSafe))).map(t=>{let r=100,n=`${t.name} - ${t.description}`;if(t.maxClasses){r*=1-Math.abs(e-t.maxClasses)/t.maxClasses}return t.colorBlindSafe&&(r*=1.2,n+=" (色覚障害対応)"),{palette:t,score:r,reason:n}}).sort((t,e)=>e.score-t.score)},t.simulateColorBlindness=Et,t.testProjectionBounds=function(t,e){try{let r=1/0,n=-1/0,i=1/0,a=-1/0;e.features.forEach(e=>{wt(e.geometry,"",t,0,0,t=>{const[e,s]=t;r=Math.min(r,e),n=Math.max(n,e),i=Math.min(i,s),a=Math.max(a,s)})});const s=[[r,i],[n,i],[n,a],[r,a]],o=s.map(e=>t(e)).filter(t=>null!==t);return o.length===s.length?{isValid:!0,message:"✅ 投影法の境界設定は正常です"}:{isValid:!1,message:`⚠️ 投影法で変換できない座標があります (${s.length-o.length}個)`}}catch(t){return{isValid:!1,message:`❌ 境界テスト中にエラーが発生しました: ${t instanceof Error?t.message:"Unknown error"}`}}},t.testProjectionTransform=function(t,e,r,n){let i=0,a=0;const s=[];n.features.forEach(n=>{const o=n.properties?.name||`Feature ${n.id||"unknown"}`;wt(n.geometry,o,r,t,e,(t,e,r,n,o)=>{const l=r([t[0],t[1]]);l&&(i++,(l[0]<0||l[0]>n||l[1]<0||l[1]>o)&&(a++,s.push({featureName:e,originalCoord:[t[0],t[1]],projectedCoord:[l[0],l[1]],outOfBounds:{x:l[0]<0?"x < 0":l[0]>n?`x > ${n}`:"x OK",y:l[1]<0?"y < 0":l[1]>o?`y > ${o}`:"y OK"}})))})});const o=0===a;return{totalCoords:i,normalCoords:i-a,abnormalCoords:a,abnormalDetails:s,isValid:o,summary:o?`✅ すべての座標が正常範囲内です (0-${t} × 0-${e})`:`⚠️ ${a}個の座標が範囲外です`}},t.textures=ht});
//# sourceMappingURL=thematika.umd.js.map
