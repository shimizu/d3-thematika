<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>d3-thematika Example Template</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/responsive.css">
</head>
<body>
    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2L2 7V12C2 16.97 5.54 21.5 12 23C18.46 21.5 22 16.97 22 12V7L12 2M12 20.47C6.57 19.28 4 15.53 4 12V8.27L12 4.61L20 8.27V12C20 15.53 17.43 19.28 12 20.47Z"/>
                </svg>
                d3-thematika
            </a>
            <div class="nav-links">
                <a href="examples.html" class="nav-link">Examples</a>
                <a href="https://docs.d3-thematika.com" class="nav-link">Documentation</a>
                <a href="https://github.com/shimizu/d3-thematika" class="nav-link">GitHub</a>
            </div>
        </div>
    </nav>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="main-container">
        <!-- „Éñ„É¨„ÉÉ„Éâ„ÇØ„É©„É† -->
        <nav class="breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="index.html">Home</a>
                </li>
                <li class="breadcrumb-item breadcrumb-separator">></li>
                <li class="breadcrumb-item">
                    <a href="examples.html">Examples</a>
                </li>
                <li class="breadcrumb-item breadcrumb-separator">></li>
                <li class="breadcrumb-item breadcrumb-current">GeoJSON Layer</li>
            </ol>
        </nav>

        <section>
            <h2 class="section-title">Styling „Éá„É¢</h2>
            
            <div class="info-box">
                <h3>üìä ‰ΩøÁî®„Éá„Éº„Çø & Ê©üËÉΩ</h3>
                <ul>
                    <li>GeoJSON„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅÆ‰∏ñÁïåÂú∞Âõ≥„Éá„Éº„Çø</li>
                    <li>D3.js„ÅÆ„Ç´„Çπ„Çø„É†ÊäïÂΩ±Ê≥ï„Å´„Çà„ÇãÂú∞Âõ≥Ë°®Á§∫</li>
                </ul>
            </div>


            <!-- „Éû„ÉÉ„ÉóË°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="map-wrapper">
                <div class="map-header">
                    <h3>Âú∞Âõ≥Ë°®Á§∫</h3>
                    <div class="download-buttons">
                        <button id="download-svg" class="download-button">SVG</button>
                        <button id="download-png" class="download-button">PNG</button>
                    </div>
                </div>
                <div id="map"></div>
            </div>
        </section>

        <!-- „Ç≥„Éº„Éâ„Çµ„É≥„Éó„É´ -->
        <section class="code-section">
            <h2 class="section-title">ÂÆüË£Ö„Çµ„É≥„Éó„É´</h2>
            
            <div class="code-header">
                <h3>GeojsonLayer„ÅÆ‰ΩøÁî®‰æã</h3>
                <button class="copy-button" onclick="copyCode()">„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº</button>
            </div>
            <div class="code-block">
                <pre id="sample-code">


                    
                </pre>
            </div>
        </section>
    </div>

    <!-- UMDÁâà„ÅÆ„É©„Ç§„Éñ„É©„É™„Çí‰ΩøÁî® -->
    <script src="./thematika.umd.js"></script>

    <script>
        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Âá¶ÁêÜ
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let map;
        let currentProjection = d3.geoEquirectangular();
        
        async function draw() {
            const container = document.querySelector("#map");
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Êó¢Â≠ò„ÅÆSVG„Çí„ÇØ„É™„Ç¢
            d3.select("#map").selectAll("*").remove();

            // ‰∏ñÁïåÂú∞Âõ≥„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            const geojson = await d3.json('./geojson/world.geojson');

            // ÊäïÂΩ±Ê≥ï„ÇíÂú∞Âõ≥„Éá„Éº„Çø„Å´Âêà„Çè„Åõ„Å¶Ë®≠ÂÆö
            currentProjection.fitExtent([[20, 20], [width-20, height-20]], geojson);

            // Âú∞Âõ≥„Çí‰ΩúÊàê
            map = new Thematika.Map({
                container: '#map',
                width: width,
                height: height,
                projection: currentProjection
            });

            // „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ÂÆöÁæ©
            const svg = d3.select("#map svg");
            const defs = svg.append("defs");
            
            // ÂõΩ„Åî„Å®„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥
            const gradient1 = defs.append("linearGradient")
                .attr("id", "country-gradient-1")
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", "0%").attr("y1", "0%")
                .attr("x2", "100%").attr("y2", "100%");
            
            gradient1.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", "#6366f1");
            
            gradient1.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", "#8b5cf6");
            
            const gradient2 = defs.append("linearGradient")
                .attr("id", "country-gradient-2")
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", "0%").attr("y1", "0%")
                .attr("x2", "100%").attr("y2", "100%");
            
            gradient2.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", "#ec4899");
            
            gradient2.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", "#f97316");

            // „Éâ„É≠„ÉÉ„Éó„Ç∑„É£„Éâ„Ç¶„Éï„Ç£„É´„Çø„Éº
            const filter = defs.append("filter")
                .attr("id", "drop-shadow")
                .attr("height", "130%");
            
            filter.append("feGaussianBlur")
                .attr("in", "SourceAlpha")
                .attr("stdDeviation", 3);
            
            filter.append("feOffset")
                .attr("dx", 0)
                .attr("dy", 2)
                .attr("result", "offsetblur");
            
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode");
            feMerge.append("feMergeNode")
                .attr("in", "SourceGraphic");

            // GeojsonLayer„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
            const worldLayer = new Thematika.GeojsonLayer({
                data: geojson,                
                attr: { 
                    "fill": (d, i) => i % 2 === 0 ? "url(#country-gradient-1)" : "url(#country-gradient-2)",
                    "filter": "url(#drop-shadow)",
                    "stroke": '#ffffff',
                    "stroke-width": 0.5,
                    "opacity": 0.8,
                    "cursor": "pointer"
                },
                on: {
                    "mouseover": function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("opacity", 1)
                            .attr("stroke-width", 2);
                    },
                    "mouseout": function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("opacity", 0.8)
                            .attr("stroke-width", 0.5);
                    }
                }
            });

            // OutlineLayer„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
            const outlineLayer = new Thematika.OutlineLayer({
                createClipPath: true,
                clipPathId: 'earth-outline-clip',
                attr: {
                    "fill": 'none',
                    "stroke": '#6366f1',
                    "stroke-width": 3,
                    "opacity": 0.5
                }
            });

            // GraticuleLayer„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
            const graticuleLayer = new Thematika.GraticuleLayer({
                step: [10, 10],
                attr: {
                    "fill": 'none',
                    "stroke": 'rgba(255, 255, 255, 0.1)',
                    "stroke-width": 0.5,
                    "stroke-dasharray": '2,3',
                    "opacity": 0.5
                }
            });

            // „É¨„Ç§„É§„Éº„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíÂú∞Âõ≥„Å´ËøΩÂä†
            map.addLayer('graticule', graticuleLayer);
            map.addLayer('world', worldLayer);
            map.addLayer('outline', outlineLayer);
        }


        // SVG„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩ
        document.getElementById('download-svg').addEventListener('click', () => {
            const mapElement = document.querySelector('#map svg');
            if (!mapElement) {
                alert('Âú∞Âõ≥„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(mapElement);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'map.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // PNG„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩ
        document.getElementById('download-png').addEventListener('click', () => {
            const mapElement = document.querySelector('#map svg');
            if (!mapElement) {
                alert('Âú∞Âõ≥„ÅåË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(mapElement);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            // SVG„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
            const svgRect = mapElement.getBoundingClientRect();
            canvas.width = svgRect.width;
            canvas.height = svgRect.height;
            
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'map.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            };
            
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            img.src = url;
        });

        // ÂàùÊúüÊèèÁîª
        draw();

        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÂØæÂøú
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                draw();
            }, 300);
        });
    </script>
</body>
</html>