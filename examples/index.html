<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartography ライブラリ テスト</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, sans-serif;
            background: #f8f9fa;
        }
        
        #map {
            width: 100%;
            aspect-ratio: 16/9;
            margin: 20px auto;
            display: block;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            position: relative;
        }
        
        .info {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
            color: #666;
        }
    </style>

</head>
<body>
    <div class="info">
        <h1>Cartography ライブラリ テスト</h1>
        <p>基本的な地図描画機能と新しいレイヤーシステムをテストします</p>
        <p>上の地図：従来のAPI、下の地図：新しいレイヤークラスベースAPI</p>
            </div>
    
    <div id="map"></div>
    
    <!-- D3.js CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>
    
    <!-- UMD版のライブラリを使用 -->
    <script src="./thematika.umd.js"></script>
    
    <script>

        // テクスチャとフィルターを定義
        /*
        const texture = Thematika.createDotsTexture({
            id: 'circleTexture',
            background: '#e0f7fa',
            size: 4,
            radius: 2
        });
        */

        // テクスチャをプリセットから取得
        const texture = Thematika.TexturePresets.lightOcean()
        



        // SVGフィルターを作成
        const effect = Thematika.FilterPresets.standardDropShadow()


        /*
        const shadowFilter = Thematika.createDropShadow({
            id: 'mapShadow',
            dx: 8,
            dy: 8,
            stdDeviation: 3,
            floodColor: '#000000',
            floodOpacity: 1
        });
        */
        
        async function draw() {
            const id = "#map"

           const geojson =  await d3.json("geojson/world.geojson");




            const width = document.querySelector(id).clientWidth ;
            const height = document.querySelector(id).clientHeight;

            // D3.jsの投影法を使用して地図の投影を設定（マージン付き）
            const projection = d3.geoEqualEarth()
                .fitExtent([[10, 10], [width-10, height-10]], geojson);

                

            // === 新しいAPI（レイヤークラスベース） ===
            const map = new Thematika.Map({
                container: '#map',
                width: width,
                height: height,
                defs: [texture, effect], 
                projection: projection
            });


            const fillStyles =["#1a3d1f", '#e0f7fa', texture.url()];

            // GeojsonLayerインスタンスを作成
            const worldLayer = new Thematika.GeojsonLayer({
                data: geojson,                
                attr: { 
                    fill:(d,i)=> fillStyles[i%3] , 
                    filter: effect.url(), 
                    stroke: '#1a3d1f',
                    strokeWidth: 0.8,
                    opacity: (d,i) => 0.9,
                }
            });




            // OutlineLayerインスタンスを作成（クリップパス機能付き）
            const outlineLayer = new Thematika.OutlineLayer({
                createClipPath: true,
                clipPathId: 'earth-outline-clip',
                attr: {
                    fill: 'none',
                    stroke: '#2c3e50',
                    strokeWidth: 2,
                    opacity: 0.8
                }
            });

            // GraticuleLayerインスタンスを作成
            const graticuleLayer = new Thematika.GraticuleLayer({
                step: [10, 10], // 10度間隔
                attr: {
                    fill: 'none',
                    stroke: '#000',
                    strokeWidth: 0.5,
                    strokeDasharray: '2, 2',
                    opacity: 0.9
                }
            });

            // レイヤーインスタンスを地図に追加
            map.addLayer('graticule', graticuleLayer);
            map.addLayer('outline', outlineLayer);
            map.addLayer('world_new', worldLayer);



            
        }

        draw()




    </script>
</body>
</html>