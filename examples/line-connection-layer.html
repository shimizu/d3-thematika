<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LineConnectionLayer - Simple Demo</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #map {
            border: 1px solid #ddd;
            background-color: #e6f3ff;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .control-group select {
            width: 200px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-container input[type="range"] {
            flex: 1;
        }
        .slider-container span {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LineConnectionLayer - Simple Demo</h1>
        <p>ニューヨークと東京をラインで接続するシンプルなデモです。</p>

        <div class="controls">
            <div class="control-group">
                <label for="projection-select">投影法:</label>
                <select id="projection-select" onchange="updateProjection()">
                    <option value="mercator" selected>Mercator</option>
                    <option value="equirectangular">Equirectangular</option>
                    <option value="naturalEarth1">Natural Earth</option>
                    <option value="orthographic">Orthographic</option>
                    <option value="azimuthalEqualArea">Azimuthal Equal Area</option>
                </select>
            </div>
            
            <div class="control-group">
                <button onclick="toggleLineType()">直線/アーク切り替え</button>
                <button onclick="changeColor()">色変更</button>
                <button onclick="logData()">データ確認</button>
            </div>
            
            <div class="control-group" id="arc-height-control" style="display: none;">
                <label>アーク高さ:</label>
                <div class="slider-container">
                    <input type="range" id="arc-height" min="0.0" max="1.0" step="0.01" value="0.3" oninput="updateArcHeight()">
                    <span id="arc-height-value">0.3</span>
                </div>
            </div>
            
            <div class="control-group" id="arc-control-point-control" style="display: none;">
                <label>制御点位置:</label>
                <select id="arc-control-point" onchange="updateArcControlPoint()">
                    <option value="center">中点</option>
                    <option value="weighted">重み付け</option>
                    <option value="north-pacific">カスタムポイント</option>
                </select>
            </div>
            
            <div class="control-group" id="arc-offset-control" style="display: none;">
                <label>オフセット方向:</label>
                <select id="arc-offset" onchange="updateArcOffset()">
                    <option value="perpendicular">垂直</option>
                    <option value="north">北</option>
                    <option value="south">南</option>
                    <option value="east">東</option>
                    <option value="west">西</option>
                </select>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="./thematika.umd.js"></script>
    <script>
        // ニューヨーク - 東京
        const connectionData = [
            { 
                start: [-74.0060, 40.7128], // ニューヨーク
                end: [139.6917, 35.6895],   // 東京
                properties: { name: 'NYC-Tokyo' } 
            }
        ];

        let mapInstance, lineLayer, worldLayer;
        let isArcType = false;
        let currentColor = '#ff6b35';
        let arcHeight = 0.3;
        let arcControlPoint = 'center';
        let arcOffset = 'perpendicular';
        let currentProjection = 'mercator';

        // 投影法を作成する関数
        function createProjection(type, width, height) {
            switch (type) {
                case 'mercator':
                    return d3.geoMercator()
                        .scale(120)
                        .translate([width / 2, height / 2]);
                case 'equirectangular':
                    return d3.geoEquirectangular()
                        .scale(120)
                        .translate([width / 2, height / 2]);
                case 'naturalEarth1':
                    return d3.geoNaturalEarth1()
                        .scale(120)
                        .translate([width / 2, height / 2]);
                case 'orthographic':
                    return d3.geoOrthographic()
                        .scale(200)
                        .translate([width / 2, height / 2])
                        .rotate([-50, -30]);
                case 'azimuthalEqualArea':
                    return d3.geoAzimuthalEqualArea()
                        .scale(150)
                        .translate([width / 2, height / 2])
                        .rotate([-50, -30]);
                default:
                    return d3.geoMercator()
                        .scale(120)
                        .translate([width / 2, height / 2]);
            }
        }

        // 地図初期化
        function initMap() {
            const width = 760;
            const height = 500;

            // 投影法設定
            const projection = createProjection(currentProjection, width, height);

            console.log('Creating map...');
            
            // 地図作成
            mapInstance = new Thematika.Map({
                container: '#map',
                width: width,
                height: height,
                projection: projection,
                backgroundColor: '#e6f3ff'
            });

            console.log('Map created:', mapInstance);

            // world.geojsonを読み込んでGeojsonLayerを追加
            loadWorldMap();
        }

        function createLineLayer() {
            console.log('Creating line layer...');
            console.log('Data:', connectionData);

            // 既存レイヤーを削除
            if (lineLayer) {
                mapInstance.removeLayer('connections');
            }

            // LineConnectionLayer作成
            lineLayer = new Thematika.LineConnectionLayer({
                data: connectionData,
                lineType: isArcType ? 'arc' : 'straight',
                arcHeight: arcHeight,
                arcControlPoint: arcControlPoint,
                arcOffset: arcOffset,
                style: {
                    stroke: currentColor,
                    strokeWidth: 2,
                    fill: 'none'
                }
            });


            // 地図に追加
            mapInstance.addLayer('connections', lineLayer);

        }

        function toggleLineType() {
            isArcType = !isArcType;
            console.log('Line type changed to:', isArcType ? 'arc' : 'straight');
            
            // アーク関連UIの表示/非表示
            const arcHeightControl = document.getElementById('arc-height-control');
            const arcControlPointControl = document.getElementById('arc-control-point-control');
            const arcOffsetControl = document.getElementById('arc-offset-control');
            
            if (isArcType) {
                arcHeightControl.style.display = 'block';
                arcControlPointControl.style.display = 'block';
                arcOffsetControl.style.display = 'block';
            } else {
                arcHeightControl.style.display = 'none';
                arcControlPointControl.style.display = 'none';
                arcOffsetControl.style.display = 'none';
            }
            
            createLineLayer();
        }

        function changeColor() {
            const colors = ['#ff6b35', '#f7931e', '#ffcc02', '#00a651', '#0071bc', '#2e3192'];
            const currentIndex = colors.indexOf(currentColor);
            currentColor = colors[(currentIndex + 1) % colors.length];
            console.log('Color changed to:', currentColor);
            createLineLayer();
        }

        function updateArcHeight() {
            const slider = document.getElementById('arc-height');
            const valueDisplay = document.getElementById('arc-height-value');
            
            arcHeight = parseFloat(slider.value);
            valueDisplay.textContent = arcHeight;
            
            console.log('Arc height changed to:', arcHeight);
            
            // アークモードの場合のみレイヤーを更新
            if (isArcType) {
                createLineLayer();
            }
        }

        function updateArcControlPoint() {
            const select = document.getElementById('arc-control-point');
            const selectedValue = select.value;
            
            // 特定の地点を座標で指定
            switch (selectedValue) {
                case 'north-pacific':
                    arcControlPoint = [28.143147457292145, 69.40268156017285]; // 北太平洋の一点
                    break;
                default:
                    arcControlPoint = selectedValue;
                    break;
            }
            
            console.log('Arc control point changed to:', arcControlPoint);
            
            // アークモードの場合のみレイヤーを更新
            if (isArcType) {
                createLineLayer();
            }
        }

        function updateArcOffset() {
            const select = document.getElementById('arc-offset');
            arcOffset = select.value;
            
            console.log('Arc offset changed to:', arcOffset);
            
            // アークモードの場合のみレイヤーを更新
            if (isArcType) {
                createLineLayer();
            }
        }

        function updateProjection() {
            const select = document.getElementById('projection-select');
            currentProjection = select.value;
            
            console.log('Projection changed to:', currentProjection);
            
            // 新しい投影法で地図を再作成
            initMap();
        }

        function loadWorldMap() {
            console.log('Loading world.geojson...');
            
            d3.json('geojson/world.geojson').then(function(worldData) {
                console.log('World data loaded:', worldData);
                
                // GeojsonLayerを作成
                worldLayer = new Thematika.GeojsonLayer({
                    data: worldData,
                    style: {
                        fill: '#f0f0f0',
                        stroke: '#999',
                        strokeWidth: 0.5
                    }
                });
                
                // 地図に追加
                mapInstance.addLayer('world', worldLayer);
                console.log('World layer added');
                
                // LineConnectionLayer作成
                createLineLayer();
                
            }).catch(function(error) {
                console.error('Error loading world.geojson:', error);
                // エラーが発生してもLineConnectionLayerは作成
                createLineLayer();
            });
        }

        function logData() {
            console.log('Current data:', connectionData);
            console.log('Map instance:', mapInstance);
            console.log('Line layer:', lineLayer);
            console.log('Line type:', isArcType ? 'arc' : 'straight');
            console.log('Color:', currentColor);
        }

        // ページ読み込み後に地図初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking Thematika...');
            console.log('Thematika:', typeof Thematika);
            console.log('Thematika.Map:', typeof Thematika.Map);
            console.log('Thematika.LineConnectionLayer:', typeof Thematika.LineConnectionLayer);
            
            initMap();
        });
    </script>
</body>
</html>