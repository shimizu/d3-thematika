<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LineConnectionLayer 矢印機能 - d3-thematika</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .description {
            color: #666;
            margin-bottom: 20px;
        }
        .map-container {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .control-group select,
        .control-group input[type="range"] {
            width: 200px;
        }
        .control-group input[type="checkbox"] {
            margin-right: 5px;
        }
        .code-example {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin-top: 20px;
        }
        .note {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
        }
        #map {
            width: 100%;
            height: 100%;            
            aspect-ratio: 5 / 3;
            background-color: #e6f3ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LineConnectionLayer 矢印機能デモ</h1>
        <p class="description">
            LineConnectionLayerの矢印機能を使用して、2点間の接続に方向性を持たせます。
            startArrowとendArrowプロパティで矢印の表示/非表示を制御できます。
        </p>

        <div class="note">
            <strong>機能概要:</strong> 
            <ul>
                <li>ベースマップ: 世界地図（GeojsonLayer）</li>
                <li>矢印付きライン: 主要都市間の接続</li>
                <li>制御: 開始/終了矢印の表示切り替え、矢印サイズ調整</li>
            </ul>
        </div>


        <div class="controls">
            <div class="control-group">
                <label for="projection-select">投影法:</label>
                <select id="projection-select">
                    <option value="equirectangular" selected>Equirectangular</option>
                    <option value="mercator">Mercator</option>
                    <option value="naturalEarth1">Natural Earth</option>
                    <option value="orthographic">Orthographic</option>
                    <option value="azimuthalEqualArea">Azimuthal Equal Area</option>
                </select>
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="start-arrow" checked>
                    開始点に矢印を表示
                </label>
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="end-arrow" checked>
                    終了点に矢印を表示
                </label>
            </div>
            <div class="control-group">
                <label for="arrow-size">矢印のサイズ:</label>
                <input type="range" id="arrow-size" min="5" max="20" value="10" step="1">
                <span id="arrow-size-value">10</span>
            </div>
            <div class="control-group">
                <label for="line-type">ラインタイプ:</label>
                <select id="line-type">
                    <option value="straight" selected>直線</option>
                    <option value="arc">曲線</option>
                </select>
            </div>
        </div>

        <div id="map"></div>

        <div class="code-example">
            <!-- サンプルコード -->
            <pre>// LineConnectionLayer矢印機能の使用例

// 都市間の接続データ
const connections = [
    {
        start: [139.6917, 35.6895], // 東京
        end: [-0.1276, 51.5074],    // ロンドン
        properties: { name: "Tokyo-London" }
    },
    {
        start: [-74.0060, 40.7128], // ニューヨーク
        end: [116.4074, 39.9042],   // 北京
        properties: { name: "NewYork-Beijing" }
    }
];

// 矢印付きラインレイヤーを作成
const connectionLayer = new Thematika.LineConnectionLayer({
    data: connections,
    lineType: 'arc',
    startArrow: true,  // 開始点に矢印
    endArrow: true,    // 終了点に矢印
    arrowSize: 10,     // 矢印のサイズ
    arcHeight: 0.3,
    attr: {
        stroke: '#ff4757',
        strokeWidth: 2,
        opacity: 0.8
    }
});

// 地図に追加
map.addLayer('connections', connectionLayer);

// 動的に矢印を制御
connectionLayer.updateStartArrow(false);  // 開始矢印を非表示
connectionLayer.updateEndArrow(true);     // 終了矢印を表示
connectionLayer.updateArrowSize(15);      // 矢印サイズを変更
        </div>
    </div>

    <!-- UMD版のライブラリを使用 -->
    <script src="./thematika.umd.js"></script>

    <script >
        
        // プロジェクション
        let currentProjection = d3.geoEquirectangular();
        let worldData = null;
        let startArrow = true;
        let endArrow = true;
        let arrowSize = 10;
        let lineType = 'arc';
        
        async function draw() {
            // 既存の地図を削除
            d3.select('#map').selectAll('*').remove();

            const id = "#map"
            const width = document.querySelector(id).clientWidth ;
            const height = document.querySelector(id).clientHeight;

            // 世界地図データを読み込み（初回のみ）
            if (!worldData) {
                worldData = await d3.json('./geojson/world.geojson');
            }
            const geojson = worldData;

            // 投影法を地図データに合わせて設定
            currentProjection.fitExtent([[10, 60], [width-10, height-20]], geojson);

            // 地図を作成
            const map = new Thematika.Map({
                container: '#map',
                width: width,
                height: height,
                projection: currentProjection
            });

            // ベース地図レイヤー
            const worldLayer = new Thematika.GeojsonLayer({
                data: geojson,                
                attr: { 
                    fill: '#f5f5f5',
                    stroke: '#ccc',
                    strokeWidth: 0.5,
                    opacity: 1
                }
            });

            // 主要都市間の接続データ
            const connections = [
                {
                    start: [139.6917, 35.6895], // 東京
                    end: [-0.1276, 51.5074],    // ロンドン
                    properties: { name: "Tokyo-London", type: "flight" }
                },
                {
                    start: [-74.0060, 40.7128], // ニューヨーク
                    end: [116.4074, 39.9042],   // 北京
                    properties: { name: "NewYork-Beijing", type: "flight" }
                },
                {
                    start: [2.3522, 48.8566],   // パリ
                    end: [151.2093, -33.8688],  // シドニー
                    properties: { name: "Paris-Sydney", type: "flight" }
                },
                {
                    start: [-122.4194, 37.7749], // サンフランシスコ
                    end: [139.6917, 35.6895],    // 東京
                    properties: { name: "SanFrancisco-Tokyo", type: "business" }
                }
            ];

            // 矢印付きLineConnectionLayer
            const connectionLayer = new Thematika.LineConnectionLayer({
                data: connections,
                lineType: lineType,
                arcHeight: 0.3,
                startArrow: startArrow,
                endArrow: endArrow,
                arrowSize: arrowSize,
                attr: {
                    stroke: '#ff4757',
                    strokeWidth: 2,
                    opacity: 0.8
                }
            });

            // レイヤーを地図に追加
            map.addLayer('world', worldLayer);
            map.addLayer('connections', connectionLayer);
        }

        draw();

        // 投影法切り替えの設定
        document.getElementById('projection-select').addEventListener('change', (e) => {
            const projectionName = e.target.value;
            switch(projectionName) {
                case 'equirectangular':
                    currentProjection = d3.geoEquirectangular();
                    break;
                case 'mercator':
                    currentProjection = d3.geoMercator();
                    break;
                case 'naturalEarth1':
                    currentProjection = d3.geoNaturalEarth1();
                    break;
                case 'orthographic':
                    currentProjection = d3.geoOrthographic();
                    break;
                case 'azimuthalEqualArea':
                    currentProjection = d3.geoAzimuthalEqualArea();
                    break;
            }
            draw();
        });

        // 矢印表示のコントロール
        document.getElementById('start-arrow').addEventListener('change', (e) => {
            startArrow = e.target.checked;
            draw();
        });

        document.getElementById('end-arrow').addEventListener('change', (e) => {
            endArrow = e.target.checked;
            draw();
        });

        // 矢印サイズのコントロール
        document.getElementById('arrow-size').addEventListener('input', (e) => {
            arrowSize = parseInt(e.target.value);
            document.getElementById('arrow-size-value').textContent = arrowSize;
            draw();
        });

        // ラインタイプのコントロール
        document.getElementById('line-type').addEventListener('change', (e) => {
            lineType = e.target.value;
            draw();
        });

        // リサイズイベントのハンドリング
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                draw();
            }, 250);
        });
    </script>
</body>
</html>