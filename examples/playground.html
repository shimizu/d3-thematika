<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Async JS Playground</title>
  <style>
    body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
    }
    
    .container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        align-items: flex-start;
    }
    
    #editor_container {
        flex: 0 0 auto;
        min-width: 200px;
    }
    
    #map_container {
        flex: 1 1 auto;
        min-width: 300px;
    }
    
    textarea { 
        width: 400px; 
        height: 400px; 
        font-size: 9px;
        font-family: monospace;
        box-sizing: border-box;
        resize: both;
    }
    
    pre { 
        background: #222; 
        color: #0f0; 
        padding: 10px; 
        height: 150px; 
        overflow: auto; 
    }
    
    button { 
        margin: 5px 0; 
        padding: 8px 16px;
        font-size: 14px;
    }

    #run {
        display: block
    }
    


    #map {
        width: 100%;
        aspect-ratio: 16/9;
        background: white;
        position: relative;
    }
    
    h1 {
        margin-top: 0;
    }
    
    h2 {
        margin-top: 0;
        font-size: 1.2em;
    }

  </style>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>


    <!-- UMD版のライブラリを使用 -->
    <script src="./thematika.umd.js"></script>

</head>
<body>
    <h1>Playground</h1>
    
    <div class="container">
        <div id="editor_container">
            <h2>Code Editor</h2>
<textarea id="editor"> // テクスチャをプリセットから取得
const texture = Thematika.TexturePresets.lightOcean()

// SVGフィルターをプリセットから取得
const effect = Thematika.FilterPresets.standardDropShadow()

//データ読み込み
const geojson =  await d3.json("geojson/world.geojson");

//mapエレメントのサイズを取得
const width = document.querySelector("#map").clientWidth ;
const height = document.querySelector("#map").clientHeight;

// D3.jsの投影法を使用して地図の投影を設定
const projection = d3.geoEqualEarth()
    .fitExtent([[0, 0], [width, height]], geojson);

// Thematika.Map インスタンスを作成
const map = new Thematika.Map({
    container: '#map',
    width: width,
    height: height,
    defs: [texture, effect], 
    projection: projection
});


const fillStyles =["#1a3d1f", '#e0f7fa', texture.url()];

// GeojsonLayerインスタンスを作成
const worldLayer = new Thematika.GeojsonLayer({
    data: geojson,                
    attr: { 
        fill:(d,i)=> fillStyles[i%3] , 
        filter: effect.url(), 
        stroke: '#1a3d1f',
        strokeWidth: 0.8,
        opacity: (d,i) => 0.9,
    }
});

// OutlineLayerインスタンスを作成（クリップパス機能付き）
const outlineLayer = new Thematika.OutlineLayer({
    createClipPath: true,
    clipPathId: 'earth-outline-clip',
    attr: {
        fill: 'none',
        stroke: '#2c3e50',
        strokeWidth: 2,
        opacity: 0.8
    }
});

// GraticuleLayerインスタンスを作成
const graticuleLayer = new Thematika.GraticuleLayer({
    step: [10, 10], // 10度間隔
    attr: {
        fill: 'none',
        stroke: '#000',
        strokeWidth: 0.5,
        strokeDasharray: '2, 2',
        opacity: 0.9
    }
});

// レイヤーインスタンスを地図に追加
map.addLayer('graticule', graticuleLayer);
map.addLayer('outline', outlineLayer);
map.addLayer('world_new', worldLayer);

</textarea>
            <button id="run">Run ▶</button>
        </div>

        <div id="map_container">
            <h2>Map Example</h2>
            <div id="map"></div>
        </div>
    </div>

    <div id="console_container">
        <h2>Console Output</h2>
        <pre id="console"></pre>
    </div>

  <script>
    const editor = document.getElementById('editor');
    const out     = document.getElementById('console');
    const runBtn  = document.getElementById('run');

    runBtn.addEventListener('click', async () => {
      out.textContent = '';
      // console.log キャッチ
      const _log = console.log;
      console.log = (...args) => {
        out.textContent += args.map(a => String(a)).join(' ') + '\n';
        _log.apply(console, args);
      };

      // ユーザーコードを async IIFE で eval
      const userCode = editor.value;
      const wrapped  = `(async ()=>{\n${userCode}\n})()`;

      try {
        await eval(wrapped);
      } catch (e) {
        console.log('Error:', e);
      }

      console.log = _log;
    });
  </script>
</body>
</html>
