<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Async JS Playground</title>
  <style>
    body {
        margin: 0;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f5f5f5;
    }
    
    .container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        align-items: stretch;
    }
    
    #editor_container {
        flex: 0 0 auto;
        min-width: 200px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }
    
    #map_container {
        flex: 1 1 auto;
        min-width: 300px;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #map_container h2 {
        margin-bottom: 15px;
        font-size: 1.3em;
        font-weight: 600;
    }
    
    textarea { 
        width: 400px; 
        flex: 1;
        min-height: 400px;
        font-size: 12px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        box-sizing: border-box;
        resize: both;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 12px;
        background: #fafafa;
        line-height: 1.5;
    }
    
    textarea:focus {
        outline: none;
        border-color: #4CAF50;
        background: white;
    }
    
    pre { 
        background: #1e1e1e; 
        color: #d4d4d4; 
        padding: 20px; 
        height: 60px; 
        overflow: auto;
        border-radius: 6px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 12px;
        line-height: 1.5;
        margin: 0;
        border: 1px solid #333;
    }
    
    button { 
        margin: 5px 0; 
        padding: 8px 16px;
        font-size: 14px;
    }

    #run {
        padding: 8px 20px;
        font-size: 14px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        height: 36px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.2s;
    }
    
    #run:hover {
        background: #45a049;
    }
    
    #run:active {
        background: #3d8b40;
    }
    


    #map {
        width: 100%;
        aspect-ratio: 16 / 9;
        background: white;
        position: relative;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
    }
    
    h1 {
        margin-top: 0;
        display: none;
    }
    
    #console_container {
        margin-top: 20px;
    }
    
    #console_container h2 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.1em;
        font-weight: 600;
        color: #666;
    }
    
    h2 {
        margin-top: 0;
        margin-bottom: 0;
        font-size: 1.2em;
    }
    
    .editor-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .editor-header h2 {
        margin: 0;
        font-size: 1.3em;
        font-weight: 600;
    }
    
    #example-selector {
        padding: 8px 12px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        height: 36px;
        min-width: 200px;
        cursor: pointer;
    }
    
    #example-selector:hover {
        border-color: #bbb;
    }

  </style>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>


    <!-- UMD版のライブラリを使用 -->
    <script src="./thematika.umd.js"></script>

</head>
<body>
    
    <div class="container">
        <div id="editor_container">
            <div class="editor-header">
                <h2>Code Editor</h2>
                <select id="example-selector">
                    <option value="default">Basic World Map</option>
                    <option value="graticule">Graticule Example</option>
                    <option value="outline">Outline Layer</option>
                    <option value="texture">Texture Fill</option>
                    <option value="projection">Different Projections</option>
                </select>
                <button id="run">Run ▶</button>
            </div>
<textarea id="editor"> // テクスチャをプリセットから取得
const texture = Thematika.TexturePresets.lightOcean()

// SVGフィルターをプリセットから取得
const effect = Thematika.FilterPresets.standardDropShadow()

//データ読み込み
const geojson =  await d3.json("geojson/world.geojson");

//mapエレメントのサイズを取得
const width = document.querySelector("#map").clientWidth ;
const height = document.querySelector("#map").clientHeight;

// D3.jsの投影法を使用して地図の投影を設定
const projection = d3.geoEquirectangular()
    .fitExtent([[15, 15], [width-15, height-15]], geojson);

// Thematika.Map インスタンスを作成
const map = new Thematika.Map({
    container: '#map',
    width: width,
    height: height,
    defs: [texture, effect], 
    projection: projection
});


const fillStyles =["#1a3d1f", '#e0f7fa', texture.url()];

// GeojsonLayerインスタンスを作成
const worldLayer = new Thematika.GeojsonLayer({
    data: geojson,                
    attr: { 
        "fill":(d,i)=> fillStyles[i%3] , 
        "filter": effect.url(), 
        "stroke": '#1a3d1f',
        "stroke-width": 0.8,
        "opacity": (d,i) => 0.9,
    }
});

// OutlineLayerインスタンスを作成（クリップパス機能付き）
const outlineLayer = new Thematika.OutlineLayer({
    createClipPath: true,
    clipPathId: 'earth-outline-clip',
    attr: {
        "fill": 'none',
        "stroke": '#2c3e50',
        "stroke-width": 2,
        "opacity": 0.8
    }
});

// GraticuleLayerインスタンスを作成
const graticuleLayer = new Thematika.GraticuleLayer({
    step: [10, 10], // 10度間隔
    attr: {
        "fill": 'none',
        "stroke": '#000',
        "stroke-width": 0.5,
        "stroke-dasharray": '2, 2',
        "opacity": 0.9
    }
});

// レイヤーインスタンスを地図に追加
map.addLayer('graticule', graticuleLayer);
map.addLayer('outline', outlineLayer);
map.addLayer('world_new', worldLayer);

</textarea>
        </div>

        <div id="map_container">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <h2>Map Example</h2>
                <button id="download-svg" style="padding: 6px 12px; font-size: 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">SVG</button>
                <button id="download-png" style="padding: 6px 12px; font-size: 12px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">PNG</button>
            </div>
            <div id="map"></div>
            
            <div id="console_container">
                <h2>Console Output</h2>
                <pre id="console"></pre>
            </div>
        </div>
    </div>

  <script>
    const editor = document.getElementById('editor');
    const out     = document.getElementById('console');
    const runBtn  = document.getElementById('run');

    async function run(){
        // ユーザーコードを async IIFE で eval
        const userCode = editor.value;
        const wrapped  = `(async ()=>{\n${userCode}\n})()`;

        try {
            await eval(wrapped);
        } catch (e) {
            console.log('Error:', e);
        }
    }

    run()

    runBtn.addEventListener('click', async () => {
      out.textContent = '';
      // console.log キャッチ
      const _log = console.log;
      console.log = (...args) => {
        out.textContent += args.map(a => String(a)).join(' ') + '\n';
        _log.apply(console, args);
      };

      // ユーザーコードを async IIFE で eval
      run();
      console.log = _log;
    });
    
    // SVGダウンロード機能
    document.getElementById('download-svg').addEventListener('click', () => {
        const mapElement = document.querySelector('#map svg');
        if (!mapElement) {
            alert('地図が表示されていません');
            return;
        }
        
        const svgData = new XMLSerializer().serializeToString(mapElement);
        const blob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'map.svg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    // PNGダウンロード機能
    document.getElementById('download-png').addEventListener('click', () => {
        const mapElement = document.querySelector('#map svg');
        if (!mapElement) {
            alert('地図が表示されていません');
            return;
        }
        
        const svgData = new XMLSerializer().serializeToString(mapElement);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        // SVGのサイズを取得
        const svgRect = mapElement.getBoundingClientRect();
        canvas.width = svgRect.width;
        canvas.height = svgRect.height;
        
        img.onload = () => {
            ctx.drawImage(img, 0, 0);
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'map.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        };
        
        const blob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        img.src = url;
    });
    
    // コード例の定義
    const codeExamples = {
      default: `// テクスチャをプリセットから取得
const texture = Thematika.TexturePresets.lightOcean()

// SVGフィルターをプリセットから取得
const effect = Thematika.FilterPresets.standardDropShadow()

//データ読み込み
const geojson =  await d3.json("geojson/world.geojson");

//mapエレメントのサイズを取得
const width = document.querySelector("#map").clientWidth ;
const height = document.querySelector("#map").clientHeight;

// D3.jsの投影法を使用して地図の投影を設定
const projection = d3.geoEquirectangular()
    .fitExtent([[15, 15], [width-15, height-15]], geojson);

// Thematika.Map インスタンスを作成
const map = new Thematika.Map({
    container: '#map',
    width: width,
    height: height,
    defs: [texture, effect], 
    projection: projection
});


const fillStyles =["#1a3d1f", '#e0f7fa', texture.url()];

// GeojsonLayerインスタンスを作成
const worldLayer = new Thematika.GeojsonLayer({
    data: geojson,                
    attr: { 
        "fill":(d,i)=> fillStyles[i%3] , 
        "filter": effect.url(), 
        "stroke": '#1a3d1f',
        "stroke-width": 0.8,
        "opacity": (d,i) => 0.9,
    }
});

// OutlineLayerインスタンスを作成（クリップパス機能付き）
const outlineLayer = new Thematika.OutlineLayer({
    createClipPath: true,
    clipPathId: 'earth-outline-clip',
    attr: {
        "fill": 'none',
        "stroke": '#2c3e50',
        "stroke-width": 2,
        "opacity": 0.8
    }
});

// GraticuleLayerインスタンスを作成
const graticuleLayer = new Thematika.GraticuleLayer({
    step: [10, 10], // 10度間隔
    attr: {
        "fill": 'none',
        "stroke": '#000',
        "stroke-width": 0.5,
        "stroke-dasharray": '2, 2',
        "opacity": 0.9
    }
});

// レイヤーインスタンスを地図に追加
map.addLayer('graticule', graticuleLayer);
map.addLayer('outline', outlineLayer);
map.addLayer('world_new', worldLayer);`,

      graticule: `// Graticule（経緯線）の例
const geojson = await d3.json("geojson/world.geojson");
const width = document.querySelector("#map").clientWidth;
const height = document.querySelector("#map").clientHeight;

const projection = d3.geoOrthographic()
    .fitExtent([[10, 10], [width-10, height-10]], geojson)
    .rotate([-20, -30]);

const map = new Thematika.Map({
    container: '#map',
    width: width,
    height: height,
    projection: projection
});

// Graticuleを前面に配置
const graticuleLayer = new Thematika.GraticuleLayer({
    step: [20, 20], // 20度間隔
    attr: {
        "fill": 'none',
        "stroke": '#4a90e2',
        "stroke-width": 1,
        "opacity": 0.5
    }
});

const worldLayer = new Thematika.GeojsonLayer({
    data: geojson,
    attr: { 
        "fill": '#f0f0f0',
        "stroke": '#333',
        "stroke-width": 0.5
    }
});

map.addLayer('world', worldLayer);
map.addLayer('graticule', graticuleLayer);`,

      outline: `// OutlineLayerの例
const geojson = await d3.json("geojson/world.geojson");
const width = document.querySelector("#map").clientWidth;
const height = document.querySelector("#map").clientHeight;

const projection = d3.geoNaturalEarth1()
    .fitExtent([[20, 20], [width-20, height-20]], geojson);

const map = new Thematika.Map({
    container: '#map',
    width: width,
    height: height,
    projection: projection,
    backgroundColor: '#e3f2fd'
});

// 太い輪郭線
const outlineLayer = new Thematika.OutlineLayer({
    attr: {
        "fill": 'none',
        "stroke": '#1976d2',
        "stroke-width": 4,
        strokeLinejoin: 'round'
    }
});

const worldLayer = new Thematika.GeojsonLayer({
    data: geojson,
    attr: { 
        "fill": '#ffffff',
        "stroke": '#666',
        "stroke-width": 0.5
    }
});

map.addLayer('world', worldLayer);
map.addLayer('outline', outlineLayer);`,

      texture: `// テクスチャフィルの例
const texture1 = Thematika.TexturePresets.standardForest();
const texture2 = Thematika.TexturePresets.simpleDots();

const geojson = await d3.json("geojson/world.geojson");
const width = document.querySelector("#map").clientWidth;
const height = document.querySelector("#map").clientHeight;

const projection = d3.geoMercator()
    .fitExtent([[20, 20], [width-20, height-20]], geojson)

const map = new Thematika.Map({
    container: '#map',
    width: width,
    height: height,
    defs: [texture1, texture2],
    projection: projection
});

const fillPatterns = [
    '#e8f5e9',
    texture1.url(),
    '#c8e6c9', 
    texture2.url()
];

const worldLayer = new Thematika.GeojsonLayer({
    data: geojson,
    attr: { 
        "fill": (d, i) => fillPatterns[i % fillPatterns.length],
        "stroke": '#2e7d32',
        "stroke-width": 0.8
    }
});

map.addLayer('world', worldLayer);`,

      projection: `// 異なる投影法の例
const geojson = await d3.json("geojson/world.geojson");
const width = document.querySelector("#map").clientWidth;
const height = document.querySelector("#map").clientHeight;

// Mollweide投影法
const projection = d3.geoInterruptedMollweideHemispheres()
    .fitExtent([[10, 10], [width-10, height-10]], geojson);

const map = new Thematika.Map({
    container: '#map',
    width: width,
    height: height,
    projection: projection
});

const worldLayer = new Thematika.GeojsonLayer({
    data: geojson,
    attr: { 
        "fill": '#ffeb3b',
        "stroke": '#f57f17',
        "stroke-width": 1,
        "opacity": 0.8
    }
});

const graticuleLayer = new Thematika.GraticuleLayer({
    step: [30, 30],
    attr: {
        "fill": 'none',
        "stroke": '#666',
        "stroke-width": 0.5,
        "stroke-dasharray": '2, 2',
        "opacity": 0.3
    }
});

// 太い輪郭線
const outlineLayer = new Thematika.OutlineLayer({
    attr: {
        "fill": 'none',
        "stroke": '#1976d2',
        "stroke-width": 4,
        strokeLinejoin: 'round',
    },
    createClipPath: true,

});

map.addLayer('graticule', graticuleLayer);
map.addLayer('world', worldLayer);
map.addLayer('outline', outlineLayer);


// 他の投影法の例:
// d3.geoWinkelTripel()
// d3.geoRobinson()
// d3.geoEckert4()
// d3.geoConicEqualArea()`
    };
    
    // セレクトボックスの変更イベント
    const selector = document.getElementById('example-selector');
    selector.addEventListener('change', (e) => {
        const selectedExample = e.target.value;
        if (codeExamples[selectedExample]) {
            editor.value = codeExamples[selectedExample];
            run(); // 自動実行
        }
    });
  </script>
</body>
</html>
