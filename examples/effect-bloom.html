<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Effect Bloom - d3-thematika</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/responsive.css">
    <script src="./js/common.js"></script>

</head>
<body>
    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2L2 7V12C2 16.97 5.54 21.5 12 23C18.46 21.5 22 16.97 22 12V7L12 2M12 20.47C6.57 19.28 4 15.53 4 12V8.27L12 4.61L20 8.27V12C20 15.53 17.43 19.28 12 20.47Z"/>
                </svg>
                d3-thematika
            </a>
            <div class="nav-links">
                <a href="examples.html" class="nav-link">Examples</a>
                <a href="docs/" class="nav-link">Docs</a>
                <a href="https://github.com/shimizu/d3-thematika" class="nav-link">GitHub</a>
            </div>
        </div>
    </nav>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="main-container">
        <!-- „Éñ„É¨„ÉÉ„Éâ„ÇØ„É©„É† -->
        <nav class="breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="index.html">Home</a>
                </li>
                <li class="breadcrumb-item breadcrumb-separator">></li>
                <li class="breadcrumb-item">
                    <a href="examples.html">Examples</a>
                </li>
                <li class="breadcrumb-item breadcrumb-separator">></li>
                <li class="breadcrumb-item breadcrumb-current">Bloom</li>
            </ol>
        </nav>

        <section>
            <h2 class="section-title">Bloom „Ç®„Éï„Çß„ÇØ„Éà „Éá„É¢</h2>
            
            <div class="info-box">
                <h3>üó∫ Bloom „Ç®„Éï„Çß„ÇØ„Éà</h3>
                <ul>
                    <li>ÁîªÂÉè: examples/img/bloom-img.png</li>
                    <li>ÁîªÂÉè„Å´„Ç∞„É¨„Ç§„Çπ„Ç±„Éº„É´„Ç®„Éï„Çß„ÇØ„Éà„ÇíÈÅ©Áî®</li>
                    <li>„É©„Ç§„É≥„Å´Bloome„Ç®„Éï„Çß„ÇØ„Éà„ÇíÈÅ©Áî®</li>
                </ul>
            </div>


            <!-- „Éû„ÉÉ„ÉóË°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="map-wrapper">
                <div class="map-header">
                    <h3>Âú∞Âõ≥Ë°®Á§∫</h3>
                    <div class="download-buttons">
                        <button id="download-svg" class="download-button">SVG</button>
                        <button id="download-png" class="download-button">PNG</button>
                    </div>
                </div>
                <div id="map"></div>
            </div>
        </section>

        <!-- „Ç≥„Éº„Éâ„Çµ„É≥„Éó„É´ -->
        <section class="code-section">
            <h2 class="section-title">ÂÆüË£Ö„Çµ„É≥„Éó„É´</h2>
            
            <div class="code-header">
                <h3>ImageLayer„ÅÆ‰ΩøÁî®‰æã</h3>
                <button class="copy-button" onclick="copyCode()">„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº</button>
            </div>
            <div class="code-block">
                <pre id="sample-code">//Âú∞ÁêÜ„Éá„Éº„ÇøÂèñÂæó
const aoi = await d3.json('./geojson/bloom/bloom-aoi.geojson');
const lineDemoData = await d3.json('./geojson/bloom/bloom-line.geojson');
const pointData = await d3.json('./geojson/bloom/bloom-point.geojson')

//Ë°®Á§∫ÁØÑÂõ≤„ÅÆ„Éá„Éº„Çø„Åã„Çâbbox„ÇíÂèñÂæó   
const bbox = Thematika.getBbox(aoi)

// ÊäïÂΩ±Ê≥ï„ÇíÂú∞Âõ≥„Éá„Éº„Çø„Å´Âêà„Çè„Åõ„Å¶Ë®≠ÂÆö
const currentProjection = d3.geoEquirectangular();
currentProjection.fitExtent([[10, 10], [width-10, height-10]], aoi);


//„Ç®„Éï„Çß„ÇØ„Éà„Éó„É™„Çª„ÉÉ„Éà
const bloom = Thematika.FilterPresets.standardBloom()
const grayscale = Thematika.FilterPresets.grayscale()

// Âú∞Âõ≥„Çí‰ΩúÊàê
const map = new Thematika.Map({
    container: '#map',
    width: width,
    height: height,
    projection: currentProjection,
    backgroundColor: '#0f172a',
    defs:[grayscale,bloom]
});

// „É©„Çπ„Çø„Éº„É¨„Ç§„É§„ÉºÔºàËÉåÊôØÁîªÂÉèÔºâ
const imageLayer = new Thematika.ImageLayer('raster', {
    src: './img/bloom-img.png',
    bounds: [bbox.minX, bbox.minY, bbox.maxX, bbox.maxY], // [west, south, east, north]
    attr:{
        "filter":grayscale.url()
    },
    style: { 
        "opacity": 1 // ÁîªÂÉè„ÅÆ‰∏çÈÄèÊòéÂ∫¶
    }
});

// ÁµåÁ∑ØÁ∑ö„É¨„Ç§„É§„Éº
const graticuleLayer = new Thematika.GraticuleLayer({
    step: [15, 15],
    attr: {
        "stroke": '#999999',
        "stroke-width": 0.5,
        "stroke-dasharray": '2,2'
    }
});

const bloomLineLayer = new Thematika.LineConnectionLayer({
    data:lineDemoData,
    lineType:"smooth",
    attr:{
        "filter": bloom.url(),
        "stroke": "#ff0000",
        "stroke-width": 6,
    }
})
const innerLineLayer = new Thematika.LineConnectionLayer({
    data:lineDemoData,
    lineType:"smooth",
    attr:{
        "stroke": "#ff0000",
        "stroke-width": 2,
        "opacity":0.9
    }
})

// PointAnnotationLayer„Çí‰ΩúÊàê
const annotationLayer = new Thematika.PointAnnotationLayer({
    data: pointData,
    annotationType: "callout",
    textAccessor: 'name',
    titleAccessor: undefined,
    offsetAccessor: (feature, index) => [30, -20],
    subjectOptions: {
        type: "circle",
        r: 20,
        width: 16,
        height: 16,
        fill: "none",
        stroke: "#ffffff",
        strokeWidth: 1.5,
        strokeDasharray: "2,2",
    },
    connectorOptions: {
        stroke: '#ffffff',
        strokeWidth: 1
    },
    noteOptions: {
        backgroundColor: "#ffffff",
        fontSize: '12px',
        textColor: '#000000',
        borderColor: '#cccccc',
        borderWidth: 1,
        padding: 2
    }
});


map.addLayer('graticuleLayer', graticuleLayer);
map.addLayer('imageLayer', imageLayer);
map.addLayer('bloomLineLayer', bloomLineLayer)
map.addLayer('innerLineLayer', innerLineLayer)
map.addLayer("anotationLayer", annotationLayer)</pre>
            </div>
        </section>
    </div>

    <!-- UMDÁâà„ÅÆ„É©„Ç§„Éñ„É©„É™„Çí‰ΩøÁî® -->
    <script src="./thematika.umd.js"></script>

    <script>
        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Âá¶ÁêÜ
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });


        let map;

        async function draw() {

            // Âú∞Âõ≥„ÅÆÂØ∏Ê≥ï„ÇíÂèñÂæó
            const mapElement = document.querySelector('#map');
            const width = mapElement.clientWidth;
            const height = mapElement.clientHeight;

            //Âú∞ÁêÜ„Éá„Éº„ÇøÂèñÂæó
            const aoi = await d3.json('./geojson/bloom/bloom-aoi.geojson');
            const lineDemoData = await d3.json('./geojson/bloom/bloom-line.geojson');
            const pointData = await d3.json('./geojson/bloom/bloom-point.geojson')

            //Ë°®Á§∫ÁØÑÂõ≤„ÅÆ„Éá„Éº„Çø„Åã„Çâbbox„ÇíÂèñÂæó   
            const bbox = Thematika.getBbox(aoi)

            // ÊäïÂΩ±Ê≥ï„ÇíÂú∞Âõ≥„Éá„Éº„Çø„Å´Âêà„Çè„Åõ„Å¶Ë®≠ÂÆö
            const currentProjection = d3.geoEquirectangular();
            currentProjection.fitExtent([[10, 10], [width-10, height-10]], aoi);


            //„Ç®„Éï„Çß„ÇØ„Éà„Éó„É™„Çª„ÉÉ„Éà
            const bloom = Thematika.FilterPresets.standardBloom()
            const grayscale = Thematika.FilterPresets.grayscale()

            // Âú∞Âõ≥„Çí‰ΩúÊàê
            map = new Thematika.Map({
                container: '#map',
                width: width,
                height: height,
                projection: currentProjection,
                backgroundColor: '#0f172a',
                defs:[grayscale,bloom]
            });

            // „É©„Çπ„Çø„Éº„É¨„Ç§„É§„ÉºÔºàËÉåÊôØÁîªÂÉèÔºâ
            const imageLayer = new Thematika.ImageLayer('raster', {
                src: './img/bloom-img.png',
                bounds: [bbox.minX, bbox.minY, bbox.maxX, bbox.maxY], // [west, south, east, north]
                attr:{
                    "filter":grayscale.url()
                },
                style: { 
                    "opacity": 1 // ÁîªÂÉè„ÅÆ‰∏çÈÄèÊòéÂ∫¶
                }
            });

            // ÁµåÁ∑ØÁ∑ö„É¨„Ç§„É§„Éº
            const graticuleLayer = new Thematika.GraticuleLayer({
                step: [15, 15],
                attr: {
                    "stroke": '#999999',
                    "stroke-width": 0.5,
                    "stroke-dasharray": '2,2'
                }
            });

            const bloomLineLayer = new Thematika.LineConnectionLayer({
                data:lineDemoData,
                lineType:"smooth",
                attr:{
                    "filter": bloom.url(),
                    "stroke": "#ff0000",
                    "stroke-width": 6,
                }
            })
            const innerLineLayer = new Thematika.LineConnectionLayer({
                data:lineDemoData,
                lineType:"smooth",
                attr:{
                    "stroke": "#ff0000",
                    "stroke-width": 2,
                    "opacity":0.9
                }
            })

            // PointAnnotationLayer„Çí‰ΩúÊàê
            const annotationLayer = new Thematika.PointAnnotationLayer({
                data: pointData,
                annotationType: "callout",
                textAccessor: 'name',
                titleAccessor: undefined,
                offsetAccessor: (feature, index) => [30, -20],
                subjectOptions: {
                    type: "circle",
                    r: 20,
                    width: 16,
                    height: 16,
                    fill: "none",
                    stroke: "#ffffff",
                    strokeWidth: 1.5,
                    strokeDasharray: "2,2",
                },
                connectorOptions: {
                    stroke: '#ffffff',
                    strokeWidth: 1
                },
                noteOptions: {
                    backgroundColor: "#ffffff",
                    fontSize: '12px',
                    textColor: '#000000',
                    borderColor: '#cccccc',
                    borderWidth: 1,
                    padding: 2
                }
            });


            map.addLayer('graticuleLayer', graticuleLayer);
            map.addLayer('imageLayer', imageLayer);
            map.addLayer('bloomLineLayer', bloomLineLayer)
            map.addLayer('innerLineLayer', innerLineLayer)
            map.addLayer("anotationLayer", annotationLayer)

        }


        // SVG„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩ
        document.getElementById('download-svg').addEventListener('click', () => {
            map.saveSVG("map.svg");
        });
        
        // PNG„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩ
        document.getElementById('download-png').addEventListener('click', () => {
            map.savePNG("map.png")
        });
        
        
        // ÂàùÊúüÂåñ
        draw();
    </script>
</body>
</html>