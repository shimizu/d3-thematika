<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COG Layer - d3-thematika</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/responsive.css">
    <script src="./js/common.js"></script>
    <style>
        /* cog-layer.htmlå›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            background-color: #e6f3ff;
        }
        
        .url-input {
            width: 100%;
            max-width: 500px;
            margin-bottom: 1rem;
        }
        
        .button-primary {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .button-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .aoi-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .aoi-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .aoi-input label {
            font-size: 0.9rem;
            color: var(--gray-light);
        }
        
        .aoi-input input {
            background: var(--dark);
            color: var(--white);
            border: 1px solid var(--dark-light);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }
        
        .aoi-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2L2 7V12C2 16.97 5.54 21.5 12 23C18.46 21.5 22 16.97 22 12V7L12 2M12 20.47C6.57 19.28 4 15.53 4 12V8.27L12 4.61L20 8.27V12C20 15.53 17.43 19.28 12 20.47Z"/>
                </svg>
                d3-thematika
            </a>
            <div class="nav-links">
                <a href="examples.html" class="nav-link">Examples</a>
                <a href="https://docs.d3-thematika.com" class="nav-link">Documentation</a>
                <a href="https://github.com/shimizu/d3-thematika" class="nav-link">GitHub</a>
            </div>
        </div>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-container">
        <!-- ãƒ–ãƒ¬ãƒƒãƒ‰ã‚¯ãƒ©ãƒ  -->
        <nav class="breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="index.html">Home</a>
                </li>
                <li class="breadcrumb-item breadcrumb-separator">></li>
                <li class="breadcrumb-item">
                    <a href="examples.html">Examples</a>
                </li>
                <li class="breadcrumb-item breadcrumb-separator">></li>
                <li class="breadcrumb-item breadcrumb-current">COG Layer</li>
            </ol>
        </nav>

        <section>
            <h2 class="section-title">COG (Cloud Optimized GeoTIFF) Layer ãƒ‡ãƒ¢</h2>
            
            <div class="info-box">
                <h3>ğŸ—º COGãƒ¬ã‚¤ãƒ¤ãƒ¼æ©Ÿèƒ½</h3>
                <ul>
                    <li>ãƒ‡ãƒ¼ã‚¿: ã‚µãƒ³ãƒ—ãƒ«COGãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆURLæŒ‡å®šï¼‰</li>
                    <li>ãƒ¬ã‚¤ãƒ¤ãƒ¼: ImageLayerï¼ˆCOGç”»åƒï¼‰ã€GraticuleLayerï¼ˆçµŒç·¯ç·šï¼‰</li>
                    <li>æ©Ÿèƒ½: COGèª­ã¿è¾¼ã¿ã€ã‚µã‚¤ã‚ºåˆ¶é™ã€ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°</li>
                </ul>
            </div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <div class="controls-panel">
                <div class="control-item">
                    <label for="projection-select">æŠ•å½±æ³•</label>
                    <select id="projection-select">
                        <option value="equirectangular" selected>Equirectangular</option>
                        <option value="mercator">Mercator</option>
                        <option value="naturalEarth1">Natural Earth</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="cog-url">COG URL</label>
                    <input type="text" id="cog-url" class="url-input" value="https://storage.googleapis.com/g3-open-resource/d3-thematika/cog/NE1_HR_SR_OB_DRv6_COG.tif">
                    <button id="load-cog" class="button-primary">èª­ã¿è¾¼ã¿</button>
                </div>
                
                <div class="control-item">
                    <label>AOI (å—ã‚¢ãƒ¡ãƒªã‚«)</label>
                    <div class="aoi-inputs">
                        <div class="aoi-input">
                            <label>è¥¿ç«¯</label>
                            <input type="number" id="aoi-west" value="-82" step="0.1">
                        </div>
                        <div class="aoi-input">
                            <label>æ±ç«¯</label>
                            <input type="number" id="aoi-east" value="-34" step="0.1">
                        </div>
                        <div class="aoi-input">
                            <label>å—ç«¯</label>
                            <input type="number" id="aoi-south" value="-56" step="0.1">
                        </div>
                        <div class="aoi-input">
                            <label>åŒ—ç«¯</label>
                            <input type="number" id="aoi-north" value="13" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="control-item">
                    <label for="max-size">æœ€å¤§ã‚µã‚¤ã‚ºåˆ¶é™</label>
                    <select id="max-size">
                        <option value="256">256Ã—256</option>
                        <option value="512" selected>512Ã—512</option>
                        <option value="1024">1024Ã—1024</option>
                        <option value="2048">2048Ã—2048</option>
                        <option value="4096">4096Ã—4096</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="on-exceed">åˆ¶é™è¶…éæ™‚ã®å‡¦ç†</label>
                    <select id="on-exceed">
                        <option value="resample" selected>è‡ªå‹•ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°</option>
                        <option value="error">ã‚¨ãƒ©ãƒ¼</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="resample-method">ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°æ–¹æ³•</label>
                    <select id="resample-method">
                        <option value="nearest">Nearest</option>
                        <option value="bilinear" selected>Bilinear</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="image-index">ç”»åƒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹</label>
                    <select id="image-index">
                        <option value="0" selected>0ï¼ˆæœ€é«˜è§£åƒåº¦ï¼‰</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label>è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="show-graticule" checked>
                        <label for="show-graticule">çµŒç·¯ç·šã‚’è¡¨ç¤º</label>
                    </div>
                </div>
                
                <div class="control-item" id="cog-info" style="display: none;">
                    <label>èª­ã¿è¾¼ã¿çµæœ</label>
                    <div id="cog-details"></div>
                </div>
            </div>

            <!-- ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="map-wrapper">
                <div class="map-header">
                    <h3>åœ°å›³è¡¨ç¤º</h3>
                    <div class="download-buttons">
                        <button id="download-svg" class="download-button">SVG</button>
                        <button id="download-png" class="download-button">PNG</button>
                    </div>
                </div>
                <div id="map"></div>
            </div>
        </section>

        <!-- ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ« -->
        <section class="code-section">
            <h2 class="section-title">å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«</h2>
            
            <div class="code-header">
                <h3>readCOGã®ä½¿ç”¨ä¾‹</h3>
                <button class="copy-button" onclick="copyCode()">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div class="code-block">
                <pre id="sample-code">// COGèª­ã¿è¾¼ã¿ã¨ImageLayerã®ä½¿ç”¨ä¾‹

// COGãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆå—ã‚¢ãƒ¡ãƒªã‚«ã®AOIæŒ‡å®šï¼‰
const cogResult = await Thematika.readCOG(
    'https://storage.googleapis.com/g3-open-resource/d3-thematika/cog/NE1_HR_SR_OB_DRv6_COG.tif',
    {
        image: 0,  // ç”»åƒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0=æœ€é«˜è§£åƒåº¦ï¼‰
        bbox: [-82, -56, -34, 13],  // [west, south, east, north]
        sizeLimit: {
            maxWidth: 512,
            maxHeight: 512,
            onExceed: 'resample'
        },
        resampleMethod: 'bilinear'
    }
);

console.log('èª­ã¿è¾¼ã¿çµæœ:', {
    width: cogResult.width,
    height: cogResult.height,
    originalWidth: cogResult.originalWidth,
    originalHeight: cogResult.originalHeight,
    wasResampled: cogResult.wasResampled,
    bounds: cogResult.bounds
});

// åœ°å›³ã‚’ä½œæˆ
const map = new Thematika.Map({
    container: '#map',
    width: 800,
    height: 600,
    projection: d3.geoMercator()
});

// ImageLayerã§COGã‚’è¡¨ç¤º
const imageLayer = new Thematika.ImageLayer('cog-image', {
    src: cogResult.dataUri,
    bounds: cogResult.bounds,
    attr: {
        opacity: 0.8
    }
});

// GraticuleLayerã‚’è¿½åŠ 
const graticuleLayer = new Thematika.GraticuleLayer({
    step: [10, 10],
    attr: {
        stroke: '#000',
        'stroke-width': 0.5,
        'stroke-dasharray': '2,2',
        opacity: 0.5
    }
});

// ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
map.addLayer('graticule', graticuleLayer);
map.addLayer('cog', imageLayer);
                </pre>
            </div>
        </section>
    </div>

    <!-- UMDç‰ˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ -->
    <script src="./thematika.umd.js"></script>

    <script>
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
        let currentProjection = d3.geoEquirectangular();
        let currentMap = null;
        
        async function draw(cogResult = null) {
            const id = "#map";
            
            // æ—¢å­˜ã®åœ°å›³ã‚’ã‚¯ãƒªã‚¢
            d3.select(id).selectAll('*').remove();
            
            const width = document.querySelector(id).clientWidth;
            const height = document.querySelector(id).clientHeight;
            
            // æŠ•å½±æ³•ã‚’è¨­å®š
            if (cogResult && cogResult.bounds) {
                const [west, south, east, north] = cogResult.bounds;
                const geoBounds = {
                    type: 'LineString',
                    coordinates: [[west, south], [east, north]]
                };
                currentProjection.fitExtent([[50, 50], [width-50, height-50]], geoBounds);
            } else {
                currentProjection
                    .scale(130)
                    .translate([width/2, height/2]);
            }
            
            // åœ°å›³ã‚’ä½œæˆ
            currentMap = new Thematika.Map({
                container: '#map',
                width: width,
                height: height,
                projection: currentProjection
            });
            
            // çµŒç·¯ç·šãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            if (document.getElementById('show-graticule').checked) {
                const graticuleLayer = new Thematika.GraticuleLayer({
                    step: [10, 10],
                    attr: {
                        "fill": 'none',
                        "stroke": '#000',
                        "stroke-width": 0.5,
                        "stroke-dasharray": '2,2',
                        "opacity": 0.5
                    }
                });
                currentMap.addLayer('graticule', graticuleLayer);
            }
            
            // COGç”»åƒã‚’è¡¨ç¤º
            if (cogResult) {
                const imageLayer = new Thematika.ImageLayer('cog-image', {
                    src: cogResult.dataUri,
                    bounds: cogResult.bounds,
                    attr: {
                        opacity: 0.9
                    }
                });
                currentMap.addLayer('cog', imageLayer);
                
                // æƒ…å ±ã‚’è¡¨ç¤º
                document.getElementById('cog-info').style.display = 'block';
                document.getElementById('cog-details').innerHTML = `
                    <ul>
                        <li>å…ƒã®ã‚µã‚¤ã‚º: ${cogResult.originalWidth} Ã— ${cogResult.originalHeight}</li>
                        <li>è¡¨ç¤ºã‚µã‚¤ã‚º: ${cogResult.width} Ã— ${cogResult.height}</li>
                        <li>ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°: ${cogResult.wasResampled ? 'ã‚ã‚Š' : 'ãªã—'}</li>
                    </ul>
                `;
            }
        }
        
        // COGèª­ã¿è¾¼ã¿é–¢æ•°
        async function loadCOG() {
            const url = document.getElementById('cog-url').value;
            const maxSize = parseInt(document.getElementById('max-size').value);
            const onExceed = document.getElementById('on-exceed').value;
            const resampleMethod = document.getElementById('resample-method').value;
            const imageIndex = parseInt(document.getElementById('image-index').value);
            
            // AOIã‚’å–å¾—
            const west = parseFloat(document.getElementById('aoi-west').value);
            const east = parseFloat(document.getElementById('aoi-east').value);
            const south = parseFloat(document.getElementById('aoi-south').value);
            const north = parseFloat(document.getElementById('aoi-north').value);
            
            try {
                // èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º
                document.getElementById('load-cog').disabled = true;
                document.getElementById('load-cog').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
                
                const cogResult = await Thematika.readCOG(url, {
                    imageIndex: imageIndex,
                    bbox: [west, south, east, north],
                    sizeLimit: {
                        maxWidth: maxSize,
                        maxHeight: maxSize,
                        onExceed: onExceed
                    },
                    resampleMethod: resampleMethod
                });
                
                // åœ°å›³ã‚’å†æç”»
                await draw(cogResult);
                
            } catch (error) {
                console.error('COGèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                document.getElementById('load-cog').disabled = false;
                document.getElementById('load-cog').textContent = 'èª­ã¿è¾¼ã¿';
            }
        }
        
        // ç”»åƒæ•°ç¢ºèªé–¢æ•°
        async function checkImages() {
            const url = document.getElementById('cog-url').value;
            
            try {                
                // ä¸€æ™‚çš„ã«readCOGã‚’ä½¿ã‚ãšã«ç›´æ¥geotiff.jsã§ãƒã‚§ãƒƒã‚¯
                const tiff = await GeoTIFF.fromUrl(url);
                const imageCount = await tiff.getImageCount();
                
                
                // é¸æŠè‚¢ã‚’æ›´æ–°
                const select = document.getElementById('image-index');
                select.innerHTML = '';
                
                for (let i = 0; i < imageCount; i++) {
                    const option = document.createElement('option');
                    option.value = i.toString();
                    option.textContent = i === 0 ? `${i}ï¼ˆæœ€é«˜è§£åƒåº¦ï¼‰` : `${i}ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ“ãƒ¥ãƒ¼ï¼‰`;
                    if (i === 3) option.selected = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3ã«å¤‰æ›´
                    select.appendChild(option);
                }
                
                //alert(`åˆ©ç”¨å¯èƒ½ãªç”»åƒæ•°: ${imageCount}\\nç”»åƒã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 0-${imageCount - 1}`);
                
            } catch (error) {
                console.error('ç”»åƒæ•°ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            } finally {
                console.log('ç”»åƒæ•°ç¢ºèªå®Œäº†');
            }
        }

        checkImages()
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('load-cog').addEventListener('click', loadCOG);
        
        document.getElementById('projection-select').addEventListener('change', (e) => {
            const projectionName = e.target.value;
            switch(projectionName) {
                case 'mercator':
                    currentProjection = d3.geoMercator();
                    break;
                case 'naturalEarth1':
                    currentProjection = d3.geoNaturalEarth1();
                    break;
                default:
                    currentProjection = d3.geoEquirectangular();
            }
            draw();
        });
        
        document.getElementById('show-graticule').addEventListener('change', () => {
            draw();
        });
        
        // SVGãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        document.getElementById('download-svg').addEventListener('click', () => {
            const mapElement = document.querySelector('#map svg');
            if (!mapElement) {
                alert('åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(mapElement);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'map.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // PNGãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        document.getElementById('download-png').addEventListener('click', () => {
            const mapElement = document.querySelector('#map svg');
            if (!mapElement) {
                alert('åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(mapElement);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            // SVGã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const svgRect = mapElement.getBoundingClientRect();
            canvas.width = svgRect.width;
            canvas.height = svgRect.height;
            
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'map.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            };
            
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            img.src = url;
        });
        
        // åˆæœŸæç”»
        draw();
    </script>
</body>
</html>