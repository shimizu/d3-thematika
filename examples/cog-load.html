<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COG Layer - d3-thematika</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/responsive.css">
    <script src="./js/common.js"></script>
    <style>
        /* cog-layer.html固有のスタイル */
        #map {
            background-color: #e6f3ff;
        }
        
        .url-input {
            width: 100%;
            max-width: 500px;
            margin-bottom: 1rem;
        }
        
        .button-primary {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .button-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .aoi-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .aoi-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .aoi-input label {
            font-size: 0.9rem;
            color: var(--gray-light);
        }
        
        .aoi-input input {
            background: var(--dark);
            color: var(--white);
            border: 1px solid var(--dark-light);
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.9rem;
        }
        
        .aoi-input input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2L2 7V12C2 16.97 5.54 21.5 12 23C18.46 21.5 22 16.97 22 12V7L12 2M12 20.47C6.57 19.28 4 15.53 4 12V8.27L12 4.61L20 8.27V12C20 15.53 17.43 19.28 12 20.47Z"/>
                </svg>
                d3-thematika
            </a>
            <div class="nav-links">
                <a href="examples.html" class="nav-link">Examples</a>
                <a href="https://docs.d3-thematika.com" class="nav-link">Documentation</a>
                <a href="https://github.com/shimizu/d3-thematika" class="nav-link">GitHub</a>
            </div>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="main-container">
        <!-- ブレッドクラム -->
        <nav class="breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="index.html">Home</a>
                </li>
                <li class="breadcrumb-item breadcrumb-separator">></li>
                <li class="breadcrumb-item">
                    <a href="examples.html">Examples</a>
                </li>
                <li class="breadcrumb-item breadcrumb-separator">></li>
                <li class="breadcrumb-item breadcrumb-current">COG Layer</li>
            </ol>
        </nav>

        <section>
            <h2 class="section-title">COG (Cloud Optimized GeoTIFF) Layer デモ</h2>
            
            <div class="info-box">
                <h3>🗺 COGレイヤー機能</h3>
                <ul>
                    <li>データ: サンプルCOGファイル（URL指定）</li>
                    <li>レイヤー: ImageLayer（COG画像）、GraticuleLayer（経緯線）</li>
                    <li>機能: COG読み込み、サイズ制限、リサンプリング</li>
                </ul>
            </div>

            <!-- コントロールパネル -->
            <div class="controls-panel">
                <div class="control-item">
                    <label for="projection-select">投影法</label>
                    <select id="projection-select">
                        <option value="equirectangular" selected>Equirectangular</option>
                        <option value="mercator">Mercator</option>
                        <option value="naturalEarth1">Natural Earth</option>
                    </select>
                </div>

                <div class="control-item">
                    <label for="cog-url">COG URL</label>
                    <input type="text" id="cog-url" class="url-input" value="https://storage.googleapis.com/g3-open-resource/d3-thematika/cog/NE1_HR_SR_OB_DRv6_COG.tif">
                    <button id="load-cog" class="button-primary">読み込み</button>
                </div>
                
                <div class="control-item">
                    <label>AOI (南アメリカ)</label>
                    <div class="aoi-inputs">
                        <div class="aoi-input">
                            <label>西端</label>
                            <input type="number" id="aoi-west" value="-82" step="0.1">
                        </div>
                        <div class="aoi-input">
                            <label>東端</label>
                            <input type="number" id="aoi-east" value="-34" step="0.1">
                        </div>
                        <div class="aoi-input">
                            <label>南端</label>
                            <input type="number" id="aoi-south" value="-56" step="0.1">
                        </div>
                        <div class="aoi-input">
                            <label>北端</label>
                            <input type="number" id="aoi-north" value="13" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="control-item">
                    <label for="max-size">最大サイズ制限</label>
                    <select id="max-size">
                        <option value="256">256×256</option>
                        <option value="512" selected>512×512</option>
                        <option value="1024">1024×1024</option>
                        <option value="2048">2048×2048</option>
                        <option value="4096">4096×4096</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="on-exceed">制限超過時の処理</label>
                    <select id="on-exceed">
                        <option value="resample" selected>自動リサンプリング</option>
                        <option value="error">エラー</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="resample-method">リサンプリング方法</label>
                    <select id="resample-method">
                        <option value="nearest">Nearest</option>
                        <option value="bilinear" selected>Bilinear</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label for="image-index">画像インデックス</label>
                    <select id="image-index">
                        <option value="0" selected>0（最高解像度）</option>
                    </select>
                </div>
                
                <div class="control-item">
                    <label>表示オプション</label>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="show-graticule" checked>
                        <label for="show-graticule">経緯線を表示</label>
                    </div>
                </div>
                
                <div class="control-item" id="cog-info" style="display: none;">
                    <label>読み込み結果</label>
                    <div id="cog-details"></div>
                </div>
            </div>

            <!-- マップ表示エリア -->
            <div class="map-wrapper">
                <div class="map-header">
                    <h3>地図表示</h3>
                    <div class="download-buttons">
                        <button id="download-svg" class="download-button">SVG</button>
                        <button id="download-png" class="download-button">PNG</button>
                    </div>
                </div>
                <div id="map"></div>
            </div>
        </section>

        <!-- コードサンプル -->
        <section class="code-section">
            <h2 class="section-title">実装サンプル</h2>
            
            <div class="code-header">
                <h3>readCOGの使用例</h3>
                <button class="copy-button" onclick="copyCode()">コードをコピー</button>
            </div>
            <div class="code-block">
                <pre id="sample-code">// COG読み込みとImageLayerの使用例

// COGファイルを読み込み（南アメリカのAOI指定）
const cogResult = await Thematika.readCOG(
    'https://storage.googleapis.com/g3-open-resource/d3-thematika/cog/NE1_HR_SR_OB_DRv6_COG.tif',
    {
        image: 0,  // 画像インデックス（0=最高解像度）
        bbox: [-82, -56, -34, 13],  // [west, south, east, north]
        sizeLimit: {
            maxWidth: 512,
            maxHeight: 512,
            onExceed: 'resample'
        },
        resampleMethod: 'bilinear'
    }
);

console.log('読み込み結果:', {
    width: cogResult.width,
    height: cogResult.height,
    originalWidth: cogResult.originalWidth,
    originalHeight: cogResult.originalHeight,
    wasResampled: cogResult.wasResampled,
    bounds: cogResult.bounds
});

// 地図を作成
const map = new Thematika.Map({
    container: '#map',
    width: 800,
    height: 600,
    projection: d3.geoMercator()
});

// ImageLayerでCOGを表示
const imageLayer = new Thematika.ImageLayer('cog-image', {
    src: cogResult.dataUri,
    bounds: cogResult.bounds,
    attr: {
        opacity: 0.8
    }
});

// GraticuleLayerを追加
const graticuleLayer = new Thematika.GraticuleLayer({
    step: [10, 10],
    attr: {
        stroke: '#000',
        'stroke-width': 0.5,
        'stroke-dasharray': '2,2',
        opacity: 0.5
    }
});

// レイヤーを地図に追加
map.addLayer('graticule', graticuleLayer);
map.addLayer('cog', imageLayer);
                </pre>
            </div>
        </section>
    </div>

    <!-- UMD版のライブラリを使用 -->
    <script src="./thematika.umd.js"></script>

    <script>
        // ナビゲーションバーのスクロール処理
        window.addEventListener('scroll', function() {
            const navbar = document.getElementById('navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });

        // プロジェクション
        let currentProjection = d3.geoEquirectangular();
        let currentMap = null;
        
        async function draw(cogResult = null) {
            const id = "#map";
            
            // 既存の地図をクリア
            d3.select(id).selectAll('*').remove();
            
            const width = document.querySelector(id).clientWidth;
            const height = document.querySelector(id).clientHeight;
            
            // 投影法を設定
            if (cogResult && cogResult.bounds) {
                const [west, south, east, north] = cogResult.bounds;
                const geoBounds = {
                    type: 'LineString',
                    coordinates: [[west, south], [east, north]]
                };
                currentProjection.fitExtent([[50, 50], [width-50, height-50]], geoBounds);
            } else {
                currentProjection
                    .scale(130)
                    .translate([width/2, height/2]);
            }
            
            // 地図を作成
            currentMap = new Thematika.Map({
                container: '#map',
                width: width,
                height: height,
                projection: currentProjection
            });
            
            // 経緯線レイヤーを追加
            if (document.getElementById('show-graticule').checked) {
                const graticuleLayer = new Thematika.GraticuleLayer({
                    step: [10, 10],
                    attr: {
                        "fill": 'none',
                        "stroke": '#000',
                        "stroke-width": 0.5,
                        "stroke-dasharray": '2,2',
                        "opacity": 0.5
                    }
                });
                currentMap.addLayer('graticule', graticuleLayer);
            }
            
            // COG画像を表示
            if (cogResult) {
                const imageLayer = new Thematika.ImageLayer('cog-image', {
                    src: cogResult.dataUri,
                    bounds: cogResult.bounds,
                    attr: {
                        opacity: 0.9
                    }
                });
                currentMap.addLayer('cog', imageLayer);
                
                // 情報を表示
                document.getElementById('cog-info').style.display = 'block';
                document.getElementById('cog-details').innerHTML = `
                    <ul>
                        <li>元のサイズ: ${cogResult.originalWidth} × ${cogResult.originalHeight}</li>
                        <li>表示サイズ: ${cogResult.width} × ${cogResult.height}</li>
                        <li>リサンプリング: ${cogResult.wasResampled ? 'あり' : 'なし'}</li>
                    </ul>
                `;
            }
        }
        
        // COG読み込み関数
        async function loadCOG() {
            const url = document.getElementById('cog-url').value;
            const maxSize = parseInt(document.getElementById('max-size').value);
            const onExceed = document.getElementById('on-exceed').value;
            const resampleMethod = document.getElementById('resample-method').value;
            const imageIndex = parseInt(document.getElementById('image-index').value);
            
            // AOIを取得
            const west = parseFloat(document.getElementById('aoi-west').value);
            const east = parseFloat(document.getElementById('aoi-east').value);
            const south = parseFloat(document.getElementById('aoi-south').value);
            const north = parseFloat(document.getElementById('aoi-north').value);
            
            try {
                // 読み込み中表示
                document.getElementById('load-cog').disabled = true;
                document.getElementById('load-cog').textContent = '読み込み中...';
                
                const cogResult = await Thematika.readCOG(url, {
                    imageIndex: imageIndex,
                    bbox: [west, south, east, north],
                    sizeLimit: {
                        maxWidth: maxSize,
                        maxHeight: maxSize,
                        onExceed: onExceed
                    },
                    resampleMethod: resampleMethod
                });
                
                // 地図を再描画
                await draw(cogResult);
                
            } catch (error) {
                console.error('COG読み込みエラー:', error);
                alert(`エラー: ${error.message}`);
            } finally {
                document.getElementById('load-cog').disabled = false;
                document.getElementById('load-cog').textContent = '読み込み';
            }
        }
        
        // 画像数確認関数
        async function checkImages() {
            const url = document.getElementById('cog-url').value;
            
            try {                
                // 一時的にreadCOGを使わずに直接geotiff.jsでチェック
                const tiff = await GeoTIFF.fromUrl(url);
                const imageCount = await tiff.getImageCount();
                
                
                // 選択肢を更新
                const select = document.getElementById('image-index');
                select.innerHTML = '';
                
                for (let i = 0; i < imageCount; i++) {
                    const option = document.createElement('option');
                    option.value = i.toString();
                    option.textContent = i === 0 ? `${i}（最高解像度）` : `${i}（オーバービュー）`;
                    if (i === 3) option.selected = true; // デフォルトは3に変更
                    select.appendChild(option);
                }
                
                //alert(`利用可能な画像数: ${imageCount}\\n画像インデックス: 0-${imageCount - 1}`);
                
            } catch (error) {
                console.error('画像数確認エラー:', error);
                alert(`エラー: ${error.message}`);
            } finally {
                console.log('画像数確認完了');
            }
        }

        checkImages()
        
        // イベントリスナー
        document.getElementById('load-cog').addEventListener('click', loadCOG);
        
        document.getElementById('projection-select').addEventListener('change', (e) => {
            const projectionName = e.target.value;
            switch(projectionName) {
                case 'mercator':
                    currentProjection = d3.geoMercator();
                    break;
                case 'naturalEarth1':
                    currentProjection = d3.geoNaturalEarth1();
                    break;
                default:
                    currentProjection = d3.geoEquirectangular();
            }
            draw();
        });
        
        document.getElementById('show-graticule').addEventListener('change', () => {
            draw();
        });
        
        // SVGダウンロード機能
        document.getElementById('download-svg').addEventListener('click', () => {
            const mapElement = document.querySelector('#map svg');
            if (!mapElement) {
                alert('地図が表示されていません');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(mapElement);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'map.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        // PNGダウンロード機能
        document.getElementById('download-png').addEventListener('click', () => {
            const mapElement = document.querySelector('#map svg');
            if (!mapElement) {
                alert('地図が表示されていません');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(mapElement);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            // SVGのサイズを取得
            const svgRect = mapElement.getBoundingClientRect();
            canvas.width = svgRect.width;
            canvas.height = svgRect.height;
            
            img.onload = () => {
                ctx.drawImage(img, 0, 0);
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'map.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            };
            
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            img.src = url;
        });
        
        // 初期描画
        draw();
    </script>
</body>
</html>